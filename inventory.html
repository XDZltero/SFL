<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒŒåŒ…èˆ‡è£å‚™</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      padding-top: 60px;
    }

    #topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #f5f5f5;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      font-size: 0.95em;
    }

    #userInfo { margin-bottom: 1em; }

    #container {
      display: flex;
      gap: 40px;
    }

    #equipped, #items {
      border: 1px solid #ccc;
      padding: 1em;
      flex: 1;
      min-height: 300px;
    }

    h2 { margin-top: 0; }
    input, button { padding: 6px; margin: 5px; }

    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 1.5em;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <span>ğŸ‘¤ ç©å®¶åç¨±ï¼š<span id="userEmail">è¼‰å…¥ä¸­...</span></span>
    <div>
      <button onclick="location.href='index.html'">ğŸ”™ è¿”å›ä¸»é </button>
      <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
    </div>
  </div>

  <div id="loadingOverlay">â³ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>

  <h1>ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</h1>

  <div id="userInfo">(å°šæœªè¼‰å…¥)</div>

  <div id="container">
    <div id="equipped">
      <h2>ğŸ›¡ï¸ è£å‚™ä¸­</h2>
      <pre id="equipBlock">å°šæœªè¼‰å…¥</pre>
    </div>
    <div id="items">
      <h2>ğŸ“¦ èƒŒåŒ…å…§å®¹</h2>
      <pre id="itemBlock">å°šæœªè¼‰å…¥</pre>
    </div>
  </div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    const loading = document.getElementById("loadingOverlay");
    const nicknameSpan = document.getElementById("userEmail");
    const userInfo = document.getElementById("userInfo");
    const equipBlock = document.getElementById("equipBlock");
    const itemBlock = document.getElementById("itemBlock");

    function showLoading(show) {
      loading.style.display = show ? "flex" : "none";
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        location.href = "/SFL/login.html";
      });
    }

    window.logout = logout;

    function waitForUser() {
      return new Promise(resolve => {
        const unsub = firebase.auth().onAuthStateChanged(user => {
          unsub();
          resolve(user);
        });
      });
    }

    async function loadInventory(userId) {
      try {
        const res1 = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
        const userData = await res1.json();

        if (userData.error) {
          userInfo.innerText = "âŒ ç„¡æ³•å–å¾—è§’è‰²è³‡è¨Š";
          return;
        }

        nicknameSpan.innerText = userData.nickname || userId;

        let info = `ğŸ§ ä½¿ç”¨è€…ï¼š${userData.nickname || userId}\n`;
        info += `ğŸ”¢ ç­‰ç´šï¼š${userData.level}ï¼ˆEXP: ${userData.exp}ï¼‰\n`;
        info += `ğŸ’ª èƒ½åŠ›ï¼š\n`;
        for (const [k, v] of Object.entries(userData.base_stats || {})) {
          info += `  - ${k.toUpperCase()}ï¼š${v}\n`;
        }
        userInfo.innerText = info;

        let equipText = "";
        for (const [slot, item] of Object.entries(userData.equipment || {})) {
          equipText += `  - ${slot}ï¼š${item || "ç„¡"}\n`;
        }
        equipBlock.innerText = equipText;

        const res2 = await fetch(`${API_BASE}/inventory?user=${encodeURIComponent(userId)}`);
        const inv = await res2.json();
        const items = inv.items || {};

        let itemText = "";
        for (const [name, count] of Object.entries(items)) {
          itemText += `  - ${name} x ${count}\n`;
        }
        itemBlock.innerText = itemText || "ï¼ˆç„¡ç‰©å“ï¼‰";
      } catch (err) {
        userInfo.innerText = "âŒ è¼‰å…¥éŒ¯èª¤ï¼š" + err.message;
        console.error(err);
      }
    }

    // ä¸»æµç¨‹
    (async () => {
      showLoading(true);
      const user = await waitForUser();
      if (!user) {
        location.href = "/SFL/login.html";
        return;
      }

      await loadInventory(user.email);
      showLoading(false);
    })();
  </script>
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("footer-placeholder").innerHTML = html;
      })
      .catch(err => console.warn("è¼‰å…¥ footer å¤±æ•—", err));
  </script>
</body>
</html>
