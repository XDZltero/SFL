<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/inventory.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">è¼‰å…¥ä¸­...</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <h1 class="fancy-title">ğŸŒŒ å¡ç‰‡çŸ©é™£ç³»çµ±</h1>
  <div class="top-grid">
    <div class="stats-section">
      <h2 class="fancy-subtitle">ğŸ§¬ è§’è‰²å±¬æ€§</h2>
      <div id="statsDisplay"></div>
    </div>
    
    <div class="equipment-section">
      <h2 class="fancy-subtitle">ğŸ“ å¡ç‰‡æ’æ§½</h2>
      <div id="equipmentDisplay"></div>
    </div>
  </div>
  
  <div class="btn-group">
    <button class="square-btn" onclick="openCraftUI()">ğŸ’» è£½ä½œç«¯æœ«</button>
    <button class="square-btn" onclick="openEquipUI()">ğŸš€ æ’æ§½ç®¡ç†</button>
  </div>
  
  <div class="items-section">
    <h2 class="fancy-subtitle">ğŸ“¦ æŒæœ‰é“å…·</h2>
    <div class="item-grid" id="itemGrid"></div>
  </div>
  
  <div id="dialogContainer"></div>
  <div id="loadingSpinner" class="loading-spinner">è™•ç†ä¸­...</div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    let token = null;
    let userData = {};
    let userItems = {};
    let equipData = [];
    let itemMeta = [];
    let cardData = [];
    let userCards = {};

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      const spinner = document.getElementById("loadingSpinner");
      if (loading) loading.style.display = show ? "flex" : "none";
      if (spinner) spinner.style.display = show ? "block" : "none";
    }

    async function authFetch(url, options = {}) {
      return fetch(url, {
        ...options,
        headers: {
          ...(options.headers || {}),
          Authorization: `Bearer ${token}`,
        },
      });
    }

    async function loadGameData() {
      try {
        const [equipRes, itemRes, cardRes] = await Promise.all([
          fetch("parameter/equips.json"),
          fetch("parameter/items.json"),
          fetch("parameter/cards_data.json")
        ]);

        equipData = await equipRes.json();
        itemMeta = await itemRes.json();
        cardData = await cardRes.json();
      } catch (error) {
        console.error("è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—:", error);
        alert("è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
      }
    }

    async function loadUserData() {
      try {
        const [statusRes, itemsRes, cardsRes] = await Promise.all([
          authFetch(`${API_BASE}/status`),
          authFetch(`${API_BASE}/user_items`),
          authFetch(`${API_BASE}/user_cards`)
        ]);

        userData = await statusRes.json();
        userItems = itemsRes.ok ? await itemsRes.json() : {};
        userCards = cardsRes.ok ? await cardsRes.json() : {};

        if (!itemsRes.ok) userItems = userData.items || {};
        if (!cardsRes.ok) userCards = userData.cards_owned || {};

        renderPage();
      } catch (error) {
        console.error("è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:", error);
        alert("è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—");
      }
    }

    async function runMain() {
      showLoading(true);
      try {
        await loadGameData();
        await loadUserData();
      } catch (error) {
        console.error("åˆå§‹åŒ–éŒ¯èª¤:", error);
        alert("é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
      } finally {
        showLoading(false);
      }
    }

    // ç›£è½ Firebase auth token
    window.addEventListener("message", async (e) => {
      if (e.data?.token) {
        token = e.data.token;
        await runMain();
      } else {
        console.warn("âš ï¸ æœªæ”¶åˆ°æœ‰æ•ˆ tokenï¼Œç„¡æ³•å•Ÿå‹•");
      }
    });

    // å°ä¸‹é é¢å‡½æ•¸ç•™çµ¦ä½ è‡ªè¡Œè£œä¸Š token
    window.openCraftUI = openCraftUI;
    window.openEquipUI = openEquipUI;
    window.closeDialog = closeDialog;
    window.craftCard = craftCard;
    window.saveEquipment = saveEquipment;
  </script>
</body>
</html>
