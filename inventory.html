<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒŒåŒ…èˆ‡è£å‚™</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet"/>
</head>
<body>
  <script src="js/loading.js"></script>
  <div id="loading-placeholder"></div>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") {
          startPageLoadingProgress();
        }
      });
  </script>
  <h1 class="fancy-title">ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</h1>
  <div id="userInfo">(å°šæœªè¼‰å…¥)</div>
  <div id="container">
    <div id="equipped">
      <h2>ğŸ›¡ï¸ è£å‚™ä¸­</h2>
      <pre id="equipBlock">å°šæœªè¼‰å…¥</pre>
    </div>
    <div id="items">
      <h2>ğŸ“¦ èƒŒåŒ…å…§å®¹</h2>
      <pre id="itemBlock">å°šæœªè¼‰å…¥</pre>
    </div>
    <div id="cards">
      <h2>ğŸƒ æŒæœ‰å¡ç‰‡</h2>
      <pre id="cardBlock">å°šæœªè¼‰å…¥</pre>
    </div>
  </div>
  <script>
    const API_BASE = "https://sfl-9cb8.onrender.com";
    let userId = null;
    const userInfo = document.getElementById("userInfo");
    const equipBlock = document.getElementById("equipBlock");
    const itemBlock = document.getElementById("itemBlock");
    const cardBlock = document.getElementById("cardBlock");
    
    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (!loading) return;
      loading.style.display = show ? "flex" : "none";
    }
    
    async function loadInventory(userId) {
      showLoading(true);
      try {
        // è¼‰å…¥ä½¿ç”¨è€…åŸºæœ¬è³‡è¨Š
        const res1 = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
        const userData = await res1.json();
        if (userData.error) {
          userInfo.innerText = "âŒ ç„¡æ³•å–å¾—è§’è‰²è³‡è¨Š";
          return;
        }
        
        // å‚³éä½¿ç”¨è€…åç¨±çµ¦çˆ¶è¦–çª—
        window.parent.postMessage({
          nickname: userData.nickname || userId,
          user: userId
        }, "*");
        
        // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
        let info = `ğŸ§ ä½¿ç”¨è€…ï¼š${userData.nickname || userId}\n`;
        info += `ğŸ”¢ ç­‰ç´šï¼š${userData.level}ï¼ˆEXP: ${userData.exp}ï¼‰\n`;
        info += `ğŸ’ª èƒ½åŠ›ï¼š\n`;
        for (const [k, v] of Object.entries(userData.base_stats || {})) {
          info += `  - ${k.toUpperCase()}ï¼š${v}\n`;
        }
        userInfo.innerText = info;
        
        // é¡¯ç¤ºè£å‚™è³‡è¨Š
        let equipText = "";
        for (const [slot, item] of Object.entries(userData.equipment || {})) {
          equipText += `  - ä½ç½®${slot}ï¼š${item || "ç„¡"}\n`;
        }
        equipBlock.innerText = equipText;
        
        // è¼‰å…¥ç‰©å“è³‡è¨Š - ä¿®æ­£ï¼šä½¿ç”¨ user_items ç«¯é»
        const res2 = await fetch(`${API_BASE}/user_items?user=${encodeURIComponent(userId)}`);
        const itemData = await res2.json();
        
        let itemText = "";
        if (itemData.error) {
          itemText = "ï¼ˆç„¡ç‰©å“æˆ–è¼‰å…¥å¤±æ•—ï¼‰";
        } else {
          // itemData ç›´æ¥å°±æ˜¯ç‰©å“å­—å…¸
          const items = itemData;
          if (Object.keys(items).length === 0) {
            itemText = "ï¼ˆç„¡ç‰©å“ï¼‰";
          } else {
            for (const [name, count] of Object.entries(items)) {
              itemText += `  - ${name} x ${count}\n`;
            }
          }
        }
        itemBlock.innerText = itemText;
        
        // è¼‰å…¥å¡ç‰‡è³‡è¨Š
        const res3 = await fetch(`${API_BASE}/user_cards?user=${encodeURIComponent(userId)}`);
        const cardData = await res3.json();
        
        let cardText = "";
        if (cardData.error) {
          cardText = "ï¼ˆç„¡å¡ç‰‡æˆ–è¼‰å…¥å¤±æ•—ï¼‰";
        } else {
          if (Object.keys(cardData).length === 0) {
            cardText = "ï¼ˆç„¡å¡ç‰‡ï¼‰";
          } else {
            for (const [cardId, level] of Object.entries(cardData)) {
              cardText += `  - ${cardId} (Lv.${level})\n`;
            }
          }
        }
        cardBlock.innerText = cardText;
        
      } catch (err) {
        userInfo.innerText = "âŒ è¼‰å…¥éŒ¯èª¤ï¼š" + err.message;
        console.error(err);
      } finally {
        showLoading(false);
      }
    }
    
    // ç›£è½ä¾†è‡ªçˆ¶è¦–çª—çš„ä½¿ç”¨è€…è³‡è¨Š
    window.addEventListener("message", async (e) => {
      if (e.data?.user) {
        userId = e.data.user;
        await loadInventory(userId);
      }
    });
  </script>
</body>
</html>
