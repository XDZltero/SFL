<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>背包與裝備</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet"/>
</head>
<body>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") {
          startPageLoadingProgress();
        }
      });
  </script>

  <h1 class="fancy-title">🎒 背包與裝備管理</h1>
  <div id="userInfo">(尚未載入)</div>
  <div id="container">
    <div id="equipped">
      <h2>🛡️ 裝備中</h2>
      <pre id="equipBlock">尚未載入</pre>
    </div>
    <div id="items">
      <h2>📦 背包內容</h2>
      <pre id="itemBlock">尚未載入</pre>
    </div>
  </div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    let userId = null;

    const userInfo = document.getElementById("userInfo");
    const equipBlock = document.getElementById("equipBlock");
    const itemBlock = document.getElementById("itemBlock");
    const backBtn = document.getElementById("btnBack");
    const logoutBtn = document.getElementById("btnLogout");

    backBtn.onclick = () => window.parent.loadPage("index_test.html");
    logoutBtn.onclick = () => window.parent.logout();

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (loading) loading.style.display = show ? "flex" : "none";
    }

    async function loadInventory() {
      try {
        const res1 = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
        const userData = await res1.json();

        if (userData.error) {
          userInfo.innerText = "❌ 無法取得角色資訊";
          return;
        }

        let info = `🧍 使用者：${userData.nickname || userId}\n`;
        info += `🔢 等級：${userData.level}（EXP: ${userData.exp}）\n`;
        info += `💪 能力：\n`;
        for (const [k, v] of Object.entries(userData.base_stats || {})) {
          info += `  - ${k.toUpperCase()}：${v}\n`;
        }
        userInfo.innerText = info;

        let equipText = "";
        for (const [slot, item] of Object.entries(userData.equipment || {})) {
          equipText += `  - ${slot}：${item || "無"}\n`;
        }
        equipBlock.innerText = equipText || "（無裝備）";

        const res2 = await fetch(`${API_BASE}/inventory?user=${encodeURIComponent(userId)}`);
        const inv = await res2.json();
        const items = inv.items || {};

        let itemText = "";
        for (const [name, count] of Object.entries(items)) {
          itemText += `  - ${name} x ${count}\n`;
        }
        itemBlock.innerText = itemText || "（無物品）";
      } catch (err) {
        userInfo.innerText = "❌ 載入錯誤：" + err.message;
        console.error(err);
      }
    }

    window.addEventListener("message", async (e) => {
      console.log("📩 收到 parent 傳入：", e.data);
      if (e.data?.user) {
        userId = e.data.user;
        showLoading(true);
        await loadInventory();
        showLoading(false);
      }
    });
  </script>
</body>
</html>
