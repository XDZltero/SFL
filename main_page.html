<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>主頁</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet" />
</head>
<body>
  <script src="js/loading.js"></script>
  <div id="loading-placeholder"></div>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") {
          startPageLoadingProgress();
        }
      });
  </script>

  <h1 class="fancy-title">👾 「此世已被遺忘，但仍有祂在覬覦著。」 👾</h1>
  <pre id="statusBlock">正在載入角色資料...</pre>

  <div>
    <button onclick="window.parent.loadPage('upgrade.html')">🧠 技能與升級頁面</button>
    <button onclick="window.parent.loadPage('inventory.html')">🎒 背包與裝備管理</button>
  </div>

  <div>
    <h3>＜副本＞</h3>
    <button onclick="window.parent.loadPage('dungeons.html')">🗡️ 前往副本入口</button>
  </div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    const statusBlock = document.getElementById("statusBlock");
    let levelExp = {};
    let authToken = null;
    let nickname = null;

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (loading) loading.style.display = show ? "flex" : "none";
    }

    function percent(val) {
      return Math.round(val * 100) + "%";
    }

    function calcTotal(base, equip) {
      return base + (equip || 0);
    }

    function formatStats(data) {
      const b = data.base_stats;
      const e = data.equipment_stats || {};
      const total_hp = calcTotal(b.hp, e.hp);
      const total_atk = calcTotal(b.attack, e.attack);
      const total_shield = calcTotal(b.shield, e.shield);
      const total_luck = calcTotal(b.luck, e.luck);
      const total_accuracy = calcTotal(b.accuracy, e.accuracy);
      const total_evade = calcTotal(b.evade, e.evade);
      const levelMaxExp = levelExp[data.level] || 1;
      const progress = percent(data.exp / levelMaxExp);

      return `玩家名稱: ${data.nickname}
等級: ${data.level}
經驗值: ${data.exp} (${progress})
生命值: ${total_hp} (${b.hp} + ${e.hp || 0})
攻擊力: ${total_atk} (${b.attack} + ${e.attack || 0})
護盾值: ${total_shield} (${b.shield} + ${e.shield || 0})
幸運值: ${total_luck} (${b.luck} + ${e.luck || 0})
命中率: ${percent(total_accuracy)} (${b.accuracy} + ${e.accuracy || 0})
迴避率: ${percent(total_evade)} (${b.evade} + ${e.evade || 0})
攻擊速度: ${b.atk_speed}
額外傷害加成: ${b.other_bonus ?? 0}
剩餘能力值點數: ${data.stat_points}
剩餘技能點: ${data.skill_points}`;
    }

    async function callApi(path, method = "GET", body = null) {
      if (!authToken) throw new Error("尚未取得驗證 token");
      const headers = {
        "Authorization": `Bearer ${authToken}`,
        "Content-Type": "application/json"
      };
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(`${API_BASE}${path}`, options);
      if (!res.ok) throw new Error("API 錯誤");
      return res.json();
    }

    async function loadStatus() {
      showLoading(true);
      try {
        const expRes = await fetch("parameter/level_exp.json");
        levelExp = await expRes.json();

        const data = await callApi("/status");
        statusBlock.innerText = formatStats(data);
      } catch (err) {
        console.error("載入角色失敗", err);
        statusBlock.innerText = "❌ 載入角色資料失敗，請稍後再試。";
      } finally {
        showLoading(false);
      }
    }

    // ✅ 接收 index.html 傳來的 token 與 nickname
    window.addEventListener("message", (e) => {
      if (e.data?.token) {
        authToken = e.data.token;
        nickname = e.data.nickname;
        loadStatus();
      }
    });
  </script>
</body>
</html>
