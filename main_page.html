<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸»é </title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet" />
</head>
<body>
  <script src="js/loading.js"></script>
  <div id="loading-placeholder"></div>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") {
          startPageLoadingProgress();
        }
      });
  </script>

  <h1 class="fancy-title">ğŸ‘¾ ã€Œæ­¤ä¸–å·²è¢«éºå¿˜ï¼Œä½†ä»æœ‰ç¥‚åœ¨è¦¬è¦¦è‘—ã€‚ã€ ğŸ‘¾</h1>

  <pre id="statusBlock">æ­£åœ¨è¼‰å…¥è§’è‰²è³‡æ–™...</pre>

  <div>
    <button onclick="window.parent.loadPage('upgrade.html')">ğŸ§  æŠ€èƒ½èˆ‡å‡ç´šé é¢</button>
    <button onclick="window.parent.loadPage('inventory.html')">ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</button>
  </div>

  <div>
    <h3>ï¼œå‰¯æœ¬ï¼</h3>
    <button onclick="window.parent.loadPage('dungeons.html')">ğŸ—¡ï¸ å‰å¾€å‰¯æœ¬å…¥å£</button>
  </div>

  <script type="module">
    import { auth, SecureAPI } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const API_BASE = "https://sfl-9cb8.onrender.com";
    const statusBlock = document.getElementById("statusBlock");
    let levelExp = {};

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (!loading) return;
      loading.style.display = show ? "flex" : "none";
    }

    function percent(val) {
      return Math.round(val * 100) + "%";
    }

    function calcTotal(base, equip) {
      return base + (equip || 0);
    }

    function formatStats(data) {
      const b = data.base_stats;
      const e = data.equipment_stats || {};
      const total_hp = calcTotal(b.hp, e.hp);
      const total_atk = calcTotal(b.attack, e.attack);
      const total_shield = calcTotal(b.shield, e.shield);
      const total_luck = calcTotal(b.luck, e.luck);
      const total_accuracy = calcTotal(b.accuracy, e.accuracy);
      const total_evade = calcTotal(b.evade, e.evade);
      const levelMaxExp = levelExp[data.level] || 1;
      const progress = percent(data.exp / levelMaxExp);

      return `ç©å®¶åç¨±: ${data.nickname}
ç­‰ç´š: ${data.level}
ç¶“é©—å€¼: ${data.exp} (${progress})
ç”Ÿå‘½å€¼: ${total_hp} (${b.hp} + ${e.hp || 0})
æ”»æ“ŠåŠ›: ${total_atk} (${b.attack} + ${e.attack || 0})
è­·ç›¾å€¼: ${total_shield} (${b.shield} + ${e.shield || 0})
å¹¸é‹å€¼: ${total_luck} (${b.luck} + ${e.luck || 0})
å‘½ä¸­ç‡: ${percent(total_accuracy)} (${b.accuracy} + ${e.accuracy || 0})
è¿´é¿ç‡: ${percent(total_evade)} (${b.evade} + ${e.evade || 0})
æ”»æ“Šé€Ÿåº¦: ${b.atk_speed}
é¡å¤–å‚·å®³åŠ æˆ: ${b.other_bonus ?? 0}
å‰©é¤˜èƒ½åŠ›å€¼é»æ•¸: ${data.stat_points}
å‰©é¤˜æŠ€èƒ½é»: ${data.skill_points}`;
    }

    async function loadStatus() {
      showLoading(true);
      try {
        // è¼‰å…¥ç¶“é©—å€¼è¡¨ï¼ˆå…¬é–‹APIï¼‰
        const expRes = await fetch("parameter/level_exp.json");
        levelExp = await expRes.json();

        // ä½¿ç”¨SecureAPIå–å¾—ä½¿ç”¨è€…ç‹€æ…‹
        const res = await SecureAPI.get(`${API_BASE}/status`);
        const data = await res.json();

        if (res.ok) {
          // å‚³çµ¦çˆ¶è¦–çª—æ›´æ–° topbar ä½¿ç”¨è€…åç¨±
          window.parent.postMessage({
            nickname: data.nickname || data.user_id
          }, "*");
          
          statusBlock.innerText = formatStats(data);
        } else {
          statusBlock.innerText = "âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼š" + (data.error || "æœªçŸ¥éŒ¯èª¤");
        }
      } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—", err);
        statusBlock.innerText = "âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      } finally {
        showLoading(false);
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadStatus();
      } else {
        window.parent.location.href = "/SFL/login.html";
      }
    });
  </script>
</body>
</html>
