<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸»é </title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet" />
</head>
<body>
  <script src="js/loading.js"></script>
  <div id="loading-placeholder"></div>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") {
          startPageLoadingProgress();
        }
      });
  </script>

  <h1 class="fancy-title">ğŸ‘¾ ã€Œæ­¤ä¸–å·²è¢«éºå¿˜ï¼Œä½†ä»æœ‰ç¥‚åœ¨è¦¬è¦¦è‘—ã€‚ã€ ğŸ‘¾</h1>
  <pre id="statusBlock">æ­£åœ¨è¼‰å…¥è§’è‰²è³‡æ–™...</pre>

  <div>
    <button onclick="window.parent.loadPage('upgrade.html')">ğŸ§  æŠ€èƒ½èˆ‡å‡ç´šé é¢</button>
    <button onclick="window.parent.loadPage('inventory.html')">ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</button>
  </div>

  <div>
    <h3>ï¼œå‰¯æœ¬ï¼</h3>
    <button onclick="window.parent.loadPage('dungeons.html')">ğŸ—¡ï¸ å‰å¾€å‰¯æœ¬å…¥å£</button>
  </div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    const statusBlock = document.getElementById("statusBlock");
    let levelExp = {};
    let authToken = null;
    let nickname = null;

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (loading) loading.style.display = show ? "flex" : "none";
    }

    function percent(val) {
      return Math.round(val * 100) + "%";
    }

    function calcTotal(base, equip) {
      return base + (equip || 0);
    }

    function formatStats(data) {
      const b = data.base_stats;
      const e = data.equipment_stats || {};
      const total_hp = calcTotal(b.hp, e.hp);
      const total_atk = calcTotal(b.attack, e.attack);
      const total_shield = calcTotal(b.shield, e.shield);
      const total_luck = calcTotal(b.luck, e.luck);
      const total_accuracy = calcTotal(b.accuracy, e.accuracy);
      const total_evade = calcTotal(b.evade, e.evade);
      const levelMaxExp = levelExp[data.level] || 1;
      const progress = percent(data.exp / levelMaxExp);

      return `ç©å®¶åç¨±: ${data.nickname}
ç­‰ç´š: ${data.level}
ç¶“é©—å€¼: ${data.exp} (${progress})
ç”Ÿå‘½å€¼: ${total_hp} (${b.hp} + ${e.hp || 0})
æ”»æ“ŠåŠ›: ${total_atk} (${b.attack} + ${e.attack || 0})
è­·ç›¾å€¼: ${total_shield} (${b.shield} + ${e.shield || 0})
å¹¸é‹å€¼: ${total_luck} (${b.luck} + ${e.luck || 0})
å‘½ä¸­ç‡: ${percent(total_accuracy)} (${b.accuracy} + ${e.accuracy || 0})
è¿´é¿ç‡: ${percent(total_evade)} (${b.evade} + ${e.evade || 0})
æ”»æ“Šé€Ÿåº¦: ${b.atk_speed}
é¡å¤–å‚·å®³åŠ æˆ: ${b.other_bonus ?? 0}
å‰©é¤˜èƒ½åŠ›å€¼é»æ•¸: ${data.stat_points}
å‰©é¤˜æŠ€èƒ½é»: ${data.skill_points}`;
    }

    async function callApi(path, method = "GET", body = null) {
      if (!authToken) throw new Error("å°šæœªå–å¾—é©—è­‰ token");
      const headers = {
        "Authorization": `Bearer ${authToken}`,
        "Content-Type": "application/json"
      };
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const res = await fetch(`${API_BASE}${path}`, options);
      if (!res.ok) throw new Error("API éŒ¯èª¤");
      return res.json();
    }

    async function loadStatus() {
      showLoading(true);
      try {
        const expRes = await fetch("parameter/level_exp.json");
        levelExp = await expRes.json();

        const data = await callApi("/status");
        statusBlock.innerText = formatStats(data);
      } catch (err) {
        console.error("è¼‰å…¥è§’è‰²å¤±æ•—", err);
        statusBlock.innerText = "âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      } finally {
        showLoading(false);
      }
    }

    // âœ… æ¥æ”¶ index.html å‚³ä¾†çš„ token èˆ‡ nickname
    window.addEventListener("message", (e) => {
      if (e.data?.token) {
        authToken = e.data.token;
        nickname = e.data.nickname;
        loadStatus();
      }
    });
  </script>
</body>
</html>
