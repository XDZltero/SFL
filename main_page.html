<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸»é </title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet" />
</head>
<body>
  <script src="js/loading.js"></script>
  <div id="loading-placeholder"></div>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") {
          startPageLoadingProgress();
        }
      });
  </script>

  <h1 class="fancy-title">ğŸ‘¾ ã€Œæ­¤ä¸–å·²è¢«éºå¿˜ï¼Œä½†ä»æœ‰ç¥‚åœ¨è¦¬è¦¦è‘—ã€‚ã€ ğŸ‘¾</h1>

  <pre id="statusBlock">æ­£åœ¨è¼‰å…¥è§’è‰²è³‡æ–™...</pre>

  <!-- ğŸš€ ç«‹å³å¯¦æ–½ï¼šå¿«å–ç‹€æ…‹é¡¯ç¤ºï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰ -->
  <div id="cacheStatus" style="display:none; background: rgba(0,255,255,0.1); padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 0.8em;">
    <strong>ğŸš€ å¿«å–ç‹€æ…‹ï¼š</strong>
    <span id="cacheInfo">è¼‰å…¥ä¸­...</span>
    <button onclick="showCacheDetails()" style="margin-left: 10px; padding: 2px 8px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ“Š è©³æƒ…</button>
    <button onclick="clearAllCaches()" style="margin-left: 5px; padding: 2px 8px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ—‘ï¸ æ¸…é™¤</button>
  </div>

  <div>
    <button onclick="window.parent.loadPage('upgrade.html')">ğŸ§  æŠ€èƒ½èˆ‡å‡ç´šé é¢</button>
    <button onclick="window.parent.loadPage('inventory.html')">ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</button>
  </div>

  <div>
    <h3>ï¼œå‰¯æœ¬ï¼</h3>
    <button onclick="window.parent.loadPage('dungeons.html')">ğŸ—¡ï¸ å‰å¾€å‰¯æœ¬å…¥å£</button>
    <button onclick="window.parent.loadPage('world_boss.html')">ğŸ—¡ï¸ ä¸–ç•Œç‹(æ¸¬è©¦ä¸­)</button>
  </div>

  <script type="module">
    import { auth, SecureAPI, getCacheStats } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const statusBlock = document.getElementById("statusBlock");
    const cacheStatusDiv = document.getElementById("cacheStatus");
    const cacheInfoSpan = document.getElementById("cacheInfo");
    
    let levelExp = {};
    let loadTimes = [];

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šé–‹ç™¼æ¨¡å¼æª¢æ¸¬
    const isDevelopment = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' ||
                         window.location.search.includes('debug=true');
    
    if (isDevelopment) {
      cacheStatusDiv.style.display = 'block';
      console.log('ğŸ”§ é–‹ç™¼æ¨¡å¼å·²å•Ÿç”¨');
    }

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (!loading) return;
      loading.style.display = show ? "flex" : "none";
    }

    function percent(val) {
      return Math.round(val * 100) + "%";
    }

    function calcTotal(base, equip) {
      return base + (equip || 0);
    }

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šä½¿ç”¨å¿«å–çš„è£å‚™æ•¸å€¼è¨ˆç®—
    function calculateEquipmentBonus(equipment, equipData) {
      const bonus = {};
      
      if (!equipment || !equipData) return bonus;
      
      for (let slot = 1; slot <= 5; slot++) {
        const equippedCard = equipment[slot];
        if (!equippedCard) continue;

        const cardId = Object.keys(equippedCard)[0];
        const cardLevel = equippedCard[cardId];
        
        // ğŸš€ æ”¯æ´å…©ç¨®è³‡æ–™æ ¼å¼
        let equipInfo;
        if (Array.isArray(equipData)) {
          equipInfo = equipData.find(e => e.id === cardId);
        } else {
          equipInfo = Object.values(equipData).find(e => e.id === cardId);
        }

        if (equipInfo?.value?.[cardLevel]) {
          const cardStats = equipInfo.value[cardLevel];
          for (const [stat, value] of Object.entries(cardStats)) {
            bonus[stat] = (bonus[stat] || 0) + value;
          }
        }
      }

      return bonus;
    }

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šå¿«é€Ÿæ ¼å¼åŒ–ç‹€æ…‹è³‡æ–™
    async function formatStats(data) {
      try {
        const b = data.base_stats;
        
        // ğŸš€ ä¸¦è¡Œè¼‰å…¥è£å‚™è³‡æ–™
        let e = {};
        try {
          const equipRes = await SecureAPI.getStaticData('equips_table');
          e = calculateEquipmentBonus(data.equipment || {}, equipRes);
        } catch (equipError) {
          console.warn('è¼‰å…¥è£å‚™è³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', equipError);
        }
        
        const levelMaxExp = levelExp[data.level] || 1;
        const progress = percent(data.exp / levelMaxExp);

        return `ç©å®¶åç¨±: ${data.nickname}
ç­‰ç´š: ${data.level}
ç¶“é©—å€¼: ${data.exp} (${progress})
ç”Ÿå‘½å€¼: ${calcTotal(b.hp, e.hp)} (${b.hp} + ${e.hp || 0})
æ”»æ“ŠåŠ›: ${calcTotal(b.attack, e.attack)} (${b.attack} + ${e.attack || 0})
è­·ç›¾å€¼: ${calcTotal(b.shield, e.shield)} (${b.shield} + ${e.shield || 0})
å¹¸é‹å€¼: ${calcTotal(b.luck, e.luck)} (${b.luck} + ${e.luck || 0})
å‘½ä¸­ç‡: ${percent(calcTotal(b.accuracy, e.accuracy))} (${percent(b.accuracy)} + ${percent(e.accuracy || 0)})
è¿´é¿ç‡: ${percent(calcTotal(b.evade, e.evade))} (${percent(b.evade)} + ${percent(e.evade || 0)})
æ”»æ“Šé€Ÿåº¦: ${b.atk_speed}
é¡å¤–å‚·å®³åŠ æˆ: ${calcTotal(b.other_bonus || 0, e.other_bonus || 0)}
å‰©é¤˜èƒ½åŠ›å€¼é»æ•¸: ${data.stat_points}
å‰©é¤˜æŠ€èƒ½é»: ${data.skill_points}`;
      } catch (error) {
        console.error('æ ¼å¼åŒ–ç‹€æ…‹è³‡æ–™å¤±æ•—:', error);
        return `æ ¼å¼åŒ–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
      }
    }

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šå„ªåŒ–çš„è¼‰å…¥ç‹€æ…‹è³‡æ–™
    async function loadStatus(forceRefresh = false) {
      const startTime = Date.now();
      showLoading(true);
      
      try {
        // ğŸš€ ä¸¦è¡Œè¼‰å…¥è³‡æ–™ï¼Œå„ªå…ˆè¼‰å…¥ç¶“é©—å€¼è¡¨
        const expPromise = SecureAPI.getStaticData('exp_table');
        const userPromise = SecureAPI.getStatus(forceRefresh);

        // å…ˆè¼‰å…¥ç¶“é©—å€¼è¡¨
        levelExp = await expPromise;
        
        // å†è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        const userRes = await userPromise;
        let userData;
        
        if (userRes.cached) {
          console.log('ğŸš€ ä½¿ç”¨è€…è³‡æ–™ä¾†è‡ªå¿«å–');
        }
        
        userData = await userRes.json();

        const loadTime = Date.now() - startTime;
        loadTimes.push(loadTime);
        
        // ä¿æŒæœ€è¿‘10æ¬¡è¼‰å…¥æ™‚é–“
        if (loadTimes.length > 10) {
          loadTimes.shift();
        }

        if (userData) {
          // ğŸš€ ç«‹å³é¡¯ç¤ºåŸºæœ¬è³‡è¨Šï¼Œç•°æ­¥è¼‰å…¥è©³ç´°è³‡è¨Š
          statusBlock.innerText = `ç©å®¶åç¨±: ${userData.nickname}\nç­‰ç´š: ${userData.level}\nè¼‰å…¥ä¸­è©³ç´°è³‡è¨Š...`;
          
          // å‚³éä½¿ç”¨è€…åç¨±çµ¦çˆ¶è¦–çª—
          window.parent.postMessage({
            nickname: userData.nickname || userData.user_id
          }, "*");
          
          // ğŸš€ ç•°æ­¥æ ¼å¼åŒ–å®Œæ•´ç‹€æ…‹
          formatStats(userData).then(formattedStats => {
            statusBlock.innerText = formattedStats;
          }).catch(error => {
            console.error('æ ¼å¼åŒ–å¤±æ•—:', error);
            statusBlock.innerText += '\nâš ï¸ éƒ¨åˆ†è³‡è¨Šè¼‰å…¥å¤±æ•—';
          });
          
        } else {
          statusBlock.innerText = "âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼šç„¡æ³•ç²å–ä½¿ç”¨è€…è³‡æ–™";
        }
        
        // ğŸš€ æ›´æ–°å¿«å–ç‹€æ…‹
        updateCacheStatus(loadTime, userRes.cached);
        
      } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—", err);
        statusBlock.innerText = `âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼š${err.message}`;
        
        // ğŸš€ ç¶²è·¯éŒ¯èª¤æ™‚çš„æ™ºèƒ½é‡è©¦
        if (err.message.includes('fetch') || err.message.includes('network')) {
          console.log('ğŸ”„ åµæ¸¬åˆ°ç¶²è·¯éŒ¯èª¤ï¼Œ10ç§’å¾Œè‡ªå‹•é‡è©¦...');
          setTimeout(() => {
            if (statusBlock.innerText.includes('âŒ')) {
              loadStatus(true);
            }
          }, 10000);
        }
        
      } finally {
        showLoading(false);
      }
    }

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šå¿«å–ç‹€æ…‹æ›´æ–°
    function updateCacheStatus(loadTime = 0, wasCached = false) {
      if (!isDevelopment) return;

      try {
        const stats = getCacheStats();
        const avgLoadTime = loadTimes.length > 0 ? 
          Math.round(loadTimes.reduce((a, b) => a + b, 0) / loadTimes.length) : 0;
        
        const statusText = `å¿«å–é …ç›®: ${stats.total} | ` +
                          `è¼‰å…¥: ${loadTime}ms${wasCached ? ' (å¿«å–)' : ' (API)'} | ` +
                          `å¹³å‡: ${avgLoadTime}ms | ` +
                          `è¨˜æ†¶é«”: ${Math.round(stats.memory / 1024)}KB`;
        
        cacheInfoSpan.textContent = statusText;
        
        // ğŸš€ å¿«å–å‘½ä¸­ç‡é¡è‰²æŒ‡ç¤º
        if (wasCached) {
          cacheInfoSpan.style.color = '#4ecdc4'; // ç¶ è‰²ï¼šå¿«å–å‘½ä¸­
        } else {
          cacheInfoSpan.style.color = '#ffd93d'; // é»ƒè‰²ï¼šAPIå‘¼å«
        }
        
      } catch (error) {
        console.warn('æ›´æ–°å¿«å–ç‹€æ…‹å¤±æ•—:', error);
        cacheInfoSpan.textContent = 'å¿«å–ç‹€æ…‹ç²å–å¤±æ•—';
      }
    }

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šå…¨åŸŸå‡½æ•¸
    window.showCacheDetails = () => {
      try {
        const stats = getCacheStats();
        const avgLoadTime = loadTimes.length > 0 ? 
          Math.round(loadTimes.reduce((a, b) => a + b, 0) / loadTimes.length) : 0;
        
        const details = `
å¿«å–çµ±è¨ˆè©³æƒ…ï¼š

ğŸ“Š ç¸½é …ç›®æ•¸: ${stats.total}
ğŸ“ å¿«å–éµ: ${stats.keys.join(', ') || 'ç„¡'}
ğŸ’¾ è¨˜æ†¶é«”ä½¿ç”¨: ${Math.round(stats.memory / 1024)} KB
â±ï¸ å¹³å‡è¼‰å…¥æ™‚é–“: ${avgLoadTime} ms
ğŸ“ˆ æœ€è¿‘è¼‰å…¥æ™‚é–“: ${loadTimes.join(', ')} ms
ğŸ—‘ï¸ éæœŸé …ç›®: ${stats.expired}

è©³ç´°è³‡è¨Šè«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å° (F12)
        `.trim();
        
        alert(details);
        
        // åœ¨æ§åˆ¶å°è¼¸å‡ºè©³ç´°è³‡è¨Š
        console.group('ğŸš€ å¿«å–è©³ç´°çµ±è¨ˆ');
        console.table(stats);
        console.log('è¼‰å…¥æ™‚é–“æ­·å²:', loadTimes);
        console.groupEnd();
        
      } catch (error) {
        alert('ç²å–å¿«å–è©³æƒ…å¤±æ•—: ' + error.message);
      }
    };

    window.clearAllCaches = () => {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¿«å–å—ï¼Ÿ\né€™å°‡æ¸…é™¤å‰ç«¯å’Œå¾Œç«¯çš„æ‰€æœ‰å¿«å–è³‡æ–™ã€‚')) {
        try {
          // æ¸…é™¤å‰ç«¯å¿«å–
          SecureAPI.clearCache();
          
          // æ¸…é™¤å¾Œç«¯å¿«å–
          fetch('https://sfl-9cb8.onrender.com/clear_cache', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
              console.log('å¾Œç«¯å¿«å–æ¸…é™¤çµæœ:', data);
            })
            .catch(err => {
              console.warn('æ¸…é™¤å¾Œç«¯å¿«å–å¤±æ•—:', err);
            });
          
          // é‡ç½®è¼‰å…¥æ™‚é–“çµ±è¨ˆ
          loadTimes = [];
          
          alert('å¿«å–å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°è¼‰å…¥è³‡æ–™ã€‚');
          updateCacheStatus();
          
          // é‡æ–°è¼‰å…¥è³‡æ–™
          setTimeout(() => loadStatus(true), 1000);
          
        } catch (error) {
          alert('æ¸…é™¤å¿«å–å¤±æ•—: ' + error.message);
        }
      }
    };

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šæ™ºèƒ½é‡æ–°æ•´ç†
    window.smartRefresh = () => {
      console.log('ğŸ”„ æ™ºèƒ½é‡æ–°æ•´ç†ï¼šæ¸…é™¤ä½¿ç”¨è€…å¿«å–ä¸¦é‡æ–°è¼‰å…¥');
      SecureAPI.clearUserCache();
      loadStatus(true);
    };

    // ğŸš€ é é¢å¯è¦‹æ€§APIï¼šæ™ºèƒ½è³‡æ–™æ›´æ–°
    let lastVisibilityChange = Date.now();
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        const timeSinceHidden = Date.now() - lastVisibilityChange;
        
        if (timeSinceHidden > 60000) { // è¶…é1åˆ†é˜
          console.log('ğŸ”„ é é¢é‡æ–°å¯è¦‹ä¸”è¶…é1åˆ†é˜ï¼Œé‡æ–°è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™');
          loadStatus(true);
        } else if (timeSinceHidden > 30000) { // è¶…é30ç§’
          console.log('ğŸ”„ é é¢é‡æ–°å¯è¦‹ï¼Œæª¢æŸ¥è³‡æ–™æ–°é®®åº¦');
          // æª¢æŸ¥å¿«å–æ˜¯å¦é‚„æœ‰æ•ˆï¼Œç„¡æ•ˆå‰‡é‡æ–°è¼‰å…¥
          setTimeout(() => {
            if (statusBlock.innerText.includes('è¼‰å…¥ä¸­')) {
              loadStatus(false); // å…è¨±ä½¿ç”¨å¿«å–
            }
          }, 100);
        }
      } else {
        lastVisibilityChange = Date.now();
      }
    });

    // ğŸš€ å®šæœŸæ›´æ–°å¿«å–ç‹€æ…‹é¡¯ç¤º
    if (isDevelopment) {
      setInterval(() => {
        updateCacheStatus(0, false);
      }, 5000);
    }

    // ğŸš€ ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadStatus();
      } else {
        window.parent.location.href = "/SFL/login.html";
      }
    });

    // ğŸš€ å…¨åŸŸéŒ¯èª¤è™•ç†
    window.addEventListener('error', (event) => {
      console.error('é é¢éŒ¯èª¤:', event.error);
      if (isDevelopment) {
        cacheInfoSpan.style.color = '#ff6b6b';
        cacheInfoSpan.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°';
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('æœªè™•ç†çš„PromiseéŒ¯èª¤:', event.reason);
      
      // ğŸš€ æ™ºèƒ½éŒ¯èª¤æ¢å¾©
      if (event.reason && event.reason.message) {
        const message = event.reason.message.toLowerCase();
        
        if (message.includes('fetch') || message.includes('network')) {
          console.log('ğŸ”„ ç¶²è·¯éŒ¯èª¤ï¼Œå°‡åœ¨5ç§’å¾Œè‡ªå‹•é‡è©¦');
          setTimeout(() => smartRefresh(), 5000);
          
        } else if (message.includes('token') || message.includes('auth')) {
          console.log('ğŸ”’ èªè­‰éŒ¯èª¤ï¼Œé‡æ–°å°å‘åˆ°ç™»å…¥é é¢');
          window.parent.location.href = "/SFL/login.html";
          
        } else if (message.includes('cache')) {
          console.log('ğŸ§¹ å¿«å–éŒ¯èª¤ï¼Œæ¸…é™¤å¿«å–å¾Œé‡è©¦');
          SecureAPI.clearCache();
          setTimeout(() => loadStatus(true), 1000);
        }
      }
    });

    // ğŸš€ ç«‹å³å¯¦æ–½ï¼šæ•ˆèƒ½ç›£æ§ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
    if (isDevelopment) {
      // ç›£æ§é é¢è¼‰å…¥æ•ˆèƒ½
      window.addEventListener('load', () => {
        setTimeout(() => {
          const nav = performance.getEntriesByType('navigation')[0];
          if (nav) {
            console.log(`ğŸ“Š é é¢è¼‰å…¥æ•ˆèƒ½: ${Math.round(nav.loadEventEnd - nav.loadEventStart)}ms`);
          }
        }, 1000);
      });
    }
  </script>
</body>
</html>
