<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>次元商店 2.0</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet"/>
  <link href="css/shop.css" rel="stylesheet"/>
</head>
<body>
  <!-- 載入畫面 -->
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <h1 class="fancy-title">🏪 次元商店 2.0</h1>

  <!-- 玩家狀態區 -->
  <div class="user-section-row">
    <div class="user-currency half">
      <h2 class="fancy-subtitle">👤 玩家資訊</h2>
      <div id="playerInfo">
        <div class="currency-item">
          <span class="currency-name">暱稱:</span>
          <span class="currency-amount" id="playerName">載入中...</span>
        </div>
        <div class="currency-item">
          <span class="currency-name">等級:</span>
          <span class="currency-amount" id="playerLevel">載入中...</span>
        </div>
        <div class="currency-item">
          <span class="currency-name">上次進店:</span>
          <span class="currency-amount" id="lastVisit">載入中...</span>
        </div>
      </div>
    </div>

    <div class="user-currency half">
      <h2 class="fancy-subtitle">💰 貨幣道具</h2>
      <div id="playerCurrency">載入中...</div>
    </div>
  </div>

  <!-- 重置狀態顯示 -->
  <div class="reset-timer">
    <h3>🔄 商店重置狀態</h3>
    <div id="resetStatus">
      <div class="timer-item" id="resetInfo">載入中...</div>
    </div>
  </div>

  <!-- 商品分類篩選 -->
  <div class="shop-filters">
    <button class="filter-btn active" data-category="all">
      🛍️ 全部商品 <span class="category-count" id="count-all">0</span>
    </button>
    <button class="filter-btn" data-category="free">
      🎁 免費商品 <span class="category-count" id="count-free">0</span>
    </button>
    <button class="filter-btn" data-category="limited">
      ⏰ 限時商品 <span class="category-count" id="count-limited">0</span>
    </button>
    <button class="filter-btn" data-category="unlimited">
      ♾️ 無限商品 <span class="category-count" id="count-unlimited">0</span>
    </button>
    <button class="filter-btn" data-category="special">
      ⭐ 特殊商品 <span class="category-count" id="count-special">0</span>
    </button>
  </div>

  <!-- 商品列表 -->
  <div class="items-section">
    <div class="item-grid" id="shopGrid">載入中...</div>
  </div>

  <!-- 購買對話框 -->
  <div id="purchaseDialog" class="dialog-overlay" style="display: none;">
    <div class="purchase-dialog">
      <h3>🛒 購買確認</h3>
      <div id="dialogContent">載入中...</div>
      <div class="btn-group">
        <button id="confirmBtn" class="square-btn" style="background: #4CAF50;">✅ 確認</button>
        <button id="cancelBtn" class="square-btn" style="background: #f44336;">❌ 取消</button>
      </div>
    </div>
  </div>

  <!-- 載入指示器 -->
  <div id="loadingIndicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 10000;">
    <div style="text-align: center;">
      <div style="margin-bottom: 10px;">⏳</div>
      <div>處理中...</div>
    </div>
  </div>

  <script type="module">
    import { auth, SecureAPI } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const API_BASE = "https://sfl-9cb8.onrender.com";
    
    // 🏪 商店狀態管理
    class ShopManager {
      constructor() {
        this.shopData = {
          items: [],
          playerData: {},
          playerItems: {},
          shopStatus: {},
          itemMeta: {}
        };
        this.ui = {
          currentFilter: 'all',
          purchasing: false
        };
      }

      // 🔄 初始化商店
      async initialize() {
        try {
          this.showLoading(true);
          await this.loadAllData();
          this.renderAll();
          this.bindEvents();
          console.log('🏪 商店初始化完成');
        } catch (error) {
          console.error('❌ 商店初始化失敗:', error);
          this.showError('商店載入失敗，請重新整理頁面');
        } finally {
          this.showLoading(false);
        }
      }

      // 📊 載入所有資料
      async loadAllData() {
        const [shopItems, playerRes, itemsRes, shopStatusRes] = await Promise.all([
          fetch("parameter/shop_items.json").then(r => r.json()),
          SecureAPI.getStatus(false).then(r => r.json()),
          SecureAPI.getStaticData('items_table'),
          fetch(`${API_BASE}/shop_status`, {
            headers: await this.getAuthHeaders()
          }).then(r => r.json())
        ]);

        this.shopData.items = shopItems;
        this.shopData.playerData = playerRes;
        this.shopData.itemMeta = Array.isArray(itemsRes) 
          ? itemsRes.reduce((acc, item) => ({ ...acc, [item.id]: item }), {})
          : itemsRes;
        this.shopData.shopStatus = shopStatusRes;

        // 載入玩家道具
        const itemsResponse = await SecureAPI.get(`${API_BASE}/user_items`, false);
        if (itemsResponse.ok) {
          const itemsData = await itemsResponse.json();
          this.shopData.playerItems = itemsData.items || {};
        }
      }

      // 🎨 渲染所有介面
      renderAll() {
        this.renderPlayerInfo();
        this.renderPlayerCurrency();
        this.renderResetStatus();
        this.renderShopItems();
        this.updateCategoryCounts();
      }

      // 👤 渲染玩家資訊
      renderPlayerInfo() {
        const { playerData, shopStatus } = this.shopData;
        
        document.getElementById('playerName').textContent = playerData.nickname || '未知玩家';
        document.getElementById('playerLevel').textContent = `Lv.${playerData.level || 1}`;
        
        const lastVisit = shopStatus.last_visit_time 
          ? new Date(shopStatus.last_visit_time * 1000).toLocaleString('zh-TW')
          : '首次進店';
        document.getElementById('lastVisit').textContent = lastVisit;
      }

      // 💰 渲染玩家貨幣
      renderPlayerCurrency() {
        const currencies = ['world_boss_token', 'daily_coin', 'chaos_breath'];
        let html = '';
        
        currencies.forEach(currencyId => {
          const meta = this.shopData.itemMeta[currencyId];
          const amount = this.shopData.playerItems[currencyId] || 0;
          const name = meta?.name || currencyId;
          
          html += `
            <div class="currency-item">
              <span class="currency-name">${name}:</span>
              <span class="currency-amount">${amount}</span>
            </div>
          `;
        });
        
        document.getElementById('playerCurrency').innerHTML = html;
      }

      // 🔄 渲染重置狀態
      renderResetStatus() {
        const { shopStatus } = this.shopData;
        let statusHtml = '';

        if (shopStatus.reset_performed) {
          const resets = [];
          if (shopStatus.reset_performed.daily) resets.push('每日');
          if (shopStatus.reset_performed.weekly) resets.push('每週');
          if (shopStatus.reset_performed.monthly) resets.push('每月');
          
          if (resets.length > 0) {
            statusHtml = `🔄 已執行重置: ${resets.join('、')}`;
          } else {
            statusHtml = '✅ 無需重置';
          }
        } else {
          statusHtml = '✅ 商店狀態正常';
        }

        document.getElementById('resetInfo').innerHTML = statusHtml;
      }

      // 🛍️ 渲染商品列表
      renderShopItems() {
        const { items, shopStatus } = this.shopData;
        
        // 篩選商品
        let filteredItems = items;
        if (this.ui.currentFilter !== 'all') {
          filteredItems = items.filter(item => this.getItemCategory(item) === this.ui.currentFilter);
        }

        // 排序商品
        filteredItems.sort((a, b) => {
          const aCanBuy = this.canPurchaseItem(a).canPurchase;
          const bCanBuy = this.canPurchaseItem(b).canPurchase;
          if (aCanBuy !== bCanBuy) return bCanBuy ? -1 : 1;
          return (a.sort || 999) - (b.sort || 999);
        });

        let html = '';
        filteredItems.forEach(item => {
          html += this.renderShopItem(item);
        });

        document.getElementById('shopGrid').innerHTML = html || 
          '<div class="shop-item-card">此分類暫無商品</div>';
      }

      // 🎯 渲染單個商品
      renderShopItem(item) {
        const { canPurchase, reason } = this.canPurchaseItem(item);
        const purchases = this.shopData.shopStatus.purchases?.[item.id] || {};
        
        // 決定卡片樣式
        let cardClasses = ['shop-item-card'];
        if (!canPurchase) cardClasses.push('sold-out');
        if (this.isFreeItem(item)) cardClasses.push('free');
        if (item.type === 'bundle') cardClasses.push('bundle');
        
        // 商品標題
        const specialLabel = this.getSpecialLabel(item);
        const title = `${specialLabel}${item.name}`;

        // 獲得物品顯示
        const rewardHtml = this.renderItemRewards(item);

        // 消費顯示
        const costHtml = this.renderItemCost(item);

        // 購買限制顯示
        const limitHtml = this.renderItemLimits(item, purchases);

        // 購買按鈕
        const buttonHtml = canPurchase 
          ? `<button class="square-btn purchase-btn" data-item-id="${item.id}">
              ${this.isFreeItem(item) ? '🎁 領取' : '💰 購買'}
             </button>`
          : `<div class="error-message">❌ ${reason}</div>`;

        return `
          <div class="${cardClasses.join(' ')}">
            <div class="shop-item-name">${title}</div>
            <div class="shop-item-desc">${item.description}</div>
            ${rewardHtml}
            ${limitHtml}
            ${costHtml}
            ${buttonHtml}
          </div>
        `;
      }

      // 🎁 渲染商品獎勵
      renderItemRewards(item) {
        if (item.type === 'bundle' && item.items) {
          const itemList = item.items
            .map(i => `${this.getItemName(i.item_id)} x${i.quantity}`)
            .join('、');
          return `<div class="shop-item-desc">📦 獲得：${itemList}</div>`;
        } else if (item.item_id) {
          return `<div class="shop-item-desc">📦 獲得：${this.getItemName(item.item_id)} x${item.quantity}</div>`;
        }
        return '';
      }

      // 💸 渲染商品費用
      renderItemCost(item) {
        if (this.isFreeItem(item)) {
          return '<div style="color: #4CAF50; text-align: center; margin: 10px 0;">💰 免費</div>';
        }

        let html = '<div class="shop-item-cost">';
        Object.entries(item.cost).forEach(([costItem, amount]) => {
          const owned = this.shopData.playerItems[costItem] || 0;
          const sufficient = owned >= amount;
          html += `
            <div class="cost-item">
              <span class="cost-name">${this.getItemName(costItem)}:</span>
              <div>
                <span class="cost-amount">${amount}</span>
                <span class="cost-owned ${sufficient ? '' : 'cost-insufficient'}">(有: ${owned})</span>
              </div>
            </div>
          `;
        });
        html += '</div>';
        return html;
      }

      // 📊 渲染購買限制
      renderItemLimits(item, purchases) {
        let limits = [];

        if (item.limit_per_account > 0) {
          const total = purchases.total_purchased || 0;
          limits.push(`總計: ${total}/${item.limit_per_account}`);
        }

        if (item.reset_type !== 'none' && item.limit_per_reset > 0) {
          const resetKey = `${item.reset_type}_purchased`;
          const purchased = purchases[resetKey] || 0;
          const typeName = { daily: '今日', weekly: '本週', monthly: '本月' }[item.reset_type];
          limits.push(`${typeName}: ${purchased}/${item.limit_per_reset}`);
        }

        if (item.limit_per_reset === -1) {
          limits.push('♾️ 無限購買');
        }

        return limits.length > 0 
          ? `<div class="shop-item-limit">${limits.join(' | ')}</div>`
          : '';
      }

      // ✅ 檢查是否可購買
      canPurchaseItem(item) {
        const purchases = this.shopData.shopStatus.purchases?.[item.id] || {};
        const playerLevel = this.shopData.playerData.level || 1;

        // 檢查等級限制
        if (playerLevel < (item.required_level || 1)) {
          return {
            canPurchase: false,
            reason: `等級不足 (需要Lv.${item.required_level}，目前Lv.${playerLevel})`
          };
        }

        // 檢查總購買限制
        if (item.limit_per_account > 0 && 
            (purchases.total_purchased || 0) >= item.limit_per_account) {
          return { canPurchase: false, reason: '已達總購買上限' };
        }

        // 檢查週期購買限制
        if (item.reset_type !== 'none' && item.limit_per_reset > 0) {
          const resetKey = `${item.reset_type}_purchased`;
          if ((purchases[resetKey] || 0) >= item.limit_per_reset) {
            const typeName = { daily: '今日', weekly: '本週', monthly: '本月' }[item.reset_type];
            return { canPurchase: false, reason: `已達${typeName}購買上限` };
          }
        }

        // 檢查貨幣是否足夠
        if (!this.isFreeItem(item)) {
          for (const [costItem, costAmount] of Object.entries(item.cost)) {
            const owned = this.shopData.playerItems[costItem] || 0;
            if (owned < costAmount) {
              return { 
                canPurchase: false, 
                reason: `${this.getItemName(costItem)} 不足` 
              };
            }
          }
        }

        return { canPurchase: true };
      }

      // 🔄 更新分類計數
      updateCategoryCounts() {
        const categories = ['all', 'free', 'limited', 'unlimited', 'special'];
        const items = this.shopData.items;
        
        categories.forEach(category => {
          let count;
          if (category === 'all') {
            count = items.length;
          } else {
            count = items.filter(item => this.getItemCategory(item) === category).length;
          }
          
          const countEl = document.getElementById(`count-${category}`);
          if (countEl) countEl.textContent = count;
        });
      }

      // 🏷️ 獲取商品分類
      getItemCategory(item) {
        if (this.isFreeItem(item)) return 'free';
        if (item.limit_per_reset === -1) return 'unlimited';
        if (item.reset_type !== 'none') return 'limited';
        if (item.special > 0) return 'special';
        return 'normal';
      }

      // 🎯 工具方法
      isFreeItem(item) {
        return !item.cost || Object.keys(item.cost).length === 0;
      }

      getItemName(itemId) {
        return this.shopData.itemMeta[itemId]?.name || itemId;
      }

      getSpecialLabel(item) {
        const labels = { 1: '【稀有】', 2: '【超稀有】', 3: '【罕見】' };
        return labels[item.special] || '';
      }

      async getAuthHeaders() {
        const user = auth.currentUser;
        if (!user) throw new Error('未登入');
        const token = await user.getIdToken();
        return {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        };
      }

      // 🛒 購買流程
      async openPurchaseDialog(itemId) {
        const item = this.shopData.items.find(i => i.id === itemId);
        if (!item) return;

        const { canPurchase, reason } = this.canPurchaseItem(item);
        if (!canPurchase) {
          alert(`無法購買：${reason}`);
          return;
        }

        // 渲染對話框內容
        const rewardHtml = this.renderItemRewards(item);
        const costHtml = this.renderItemCost(item);
        
        document.getElementById('dialogContent').innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong>${item.name}</strong>
          </div>
          ${rewardHtml}
          ${costHtml}
        `;

        // 顯示對話框
        document.getElementById('purchaseDialog').style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // 綁定確認按鈕
        document.getElementById('confirmBtn').onclick = () => this.confirmPurchase(itemId);
      }

      async confirmPurchase(itemId) {
        if (this.ui.purchasing) return;
        
        this.ui.purchasing = true;
        this.showLoading(true);

        try {
          const response = await fetch(`${API_BASE}/shop_purchase_new`, {
            method: 'POST',
            headers: await this.getAuthHeaders(),
            body: JSON.stringify({ item_id: itemId })
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // 更新本地資料
            if (result.player_items) {
              this.shopData.playerItems = result.player_items;
            }
            if (result.shop_status) {
              this.shopData.shopStatus = result.shop_status;
            }

            // 顯示成功訊息
            const item = this.shopData.items.find(i => i.id === itemId);
            alert(`✅ 購買成功！\n\n${item.name}`);

            // 重新渲染
            this.renderAll();
            this.closePurchaseDialog();

          } else {
            alert(`❌ 購買失敗：${result.error || result.message || '未知錯誤'}`);
          }

        } catch (error) {
          console.error('購買錯誤:', error);
          alert('❌ 購買過程發生錯誤');
        } finally {
          this.ui.purchasing = false;
          this.showLoading(false);
        }
      }

      closePurchaseDialog() {
        document.getElementById('purchaseDialog').style.display = 'none';
        document.body.style.overflow = '';
      }

      // 🎯 UI 工具方法
      showLoading(show) {
        const loading = document.getElementById("loadingOverlay");
        const indicator = document.getElementById("loadingIndicator");
        if (loading) loading.style.display = show ? "flex" : "none";
        if (indicator) indicator.style.display = show ? "block" : "none";
      }

      showError(message) {
        alert(message);
      }

      // 🔗 綁定事件
      bindEvents() {
        // 分類篩選
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            this.ui.currentFilter = btn.dataset.category;
            
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            this.renderShopItems();
            this.updateCategoryCounts();
          });
        });

        // 購買按鈕（事件委派）
        document.getElementById('shopGrid').addEventListener('click', (e) => {
          if (e.target.classList.contains('purchase-btn')) {
            e.preventDefault();
            this.openPurchaseDialog(e.target.dataset.itemId);
          }
        });

        // 對話框取消按鈕
        document.getElementById('cancelBtn').addEventListener('click', () => {
          this.closePurchaseDialog();
        });

        // 對話框背景點擊關閉
        document.getElementById('purchaseDialog').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            this.closePurchaseDialog();
          }
        });
      }
    }

    // 🚀 全域初始化
    const shopManager = new ShopManager();

    // 🎵 音樂控制
    if (window.parent?.postMessage) {
      window.parent.postMessage({ command: "switchToShopMusic" }, "*");
    }

    // 🔐 認證狀態監聽
    onAuthStateChanged(auth, (user) => {
      if (user) {
        shopManager.initialize();
      } else {
        window.parent.location.href = "/SFL/login.html";
      }
    });
  </script>

  <style>
    .dialog-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .purchase-dialog {
      background: linear-gradient(135deg, rgba(15, 15, 35, 0.95) 0%, rgba(25, 25, 55, 0.95) 100%);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn-group .square-btn {
      flex: 1;
    }

    .error-message {
      color: #ff6b6b;
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 8px;
    }

    .purchase-btn {
      width: 100%;
      margin-top: 10px;
    }
  </style>
</body>
</html>
