<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/inventory.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">è¼‰å…¥ä¸­...</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <h1 class="fancy-title">ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</h1>
  <div class="top-grid">
    <div class="stats-section">
      <h2 class="fancy-subtitle">ğŸ§¬ è§’è‰²å±¬æ€§</h2>
      <div id="statsDisplay"></div>
    </div>
    
    <div class="equipment-section">
      <h2 class="fancy-subtitle">ğŸ›¡ï¸ è£å‚™ä¸­</h2>
      <div id="equipmentDisplay"></div>
    </div>
  </div>
  
  <div class="btn-group">
    <button class="square-btn" onclick="openCraftUI()">ğŸ§ª è£½ä½œçµ‚ç«¯</button>
    <button class="square-btn" onclick="openEquipUI()">ğŸ§· é‘²åµŒå¡ç‰‡</button>
  </div>
  
  <div class="items-section">
    <h2 class="fancy-subtitle">ğŸ“¦ æŒæœ‰é“å…·</h2>
    <div class="item-grid" id="itemGrid"></div>
  </div>
  
  <div id="dialogContainer"></div>
  <div id="loadingSpinner" class="loading-spinner">è™•ç†ä¸­...</div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    let userId = null;
    let userData = {};
    let userItems = {};
    let equipData = [];
    let itemMeta = [];
    let cardData = [];
    let userCards = {};

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      const spinner = document.getElementById("loadingSpinner");
      if (loading) loading.style.display = show ? "flex" : "none";
      if (spinner) spinner.style.display = show ? "block" : "none";
    }

    async function loadGameData() {
      try {
        const [equipRes, itemRes, cardRes] = await Promise.all([
          fetch("parameter/equips.json"),
          fetch("parameter/items.json"),
          fetch("parameter/cards_data.json")
        ]);
        
        equipData = await equipRes.json();
        itemMeta = await itemRes.json();
        cardData = await cardRes.json();
      } catch (error) {
        console.error("è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—:", error);
        alert("è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
      }
    }

    async function loadUserData() {
      try {
        const [statusRes, itemsRes, cardsRes] = await Promise.all([
          fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`),
          fetch(`${API_BASE}/user_items?user=${encodeURIComponent(userId)}`),
          fetch(`${API_BASE}/user_cards?user=${encodeURIComponent(userId)}`)
        ]);
        
        userData = await statusRes.json();
        userItems = itemsRes.ok ? await itemsRes.json() : {};
        userCards = cardsRes.ok ? await cardsRes.json() : {};
        
        // å¦‚æœ API ä¸å­˜åœ¨ï¼Œå¾ userData ä¸­å–å¾—è³‡æ–™
        if (!itemsRes.ok) {
          userItems = userData.items || {};
        }
        if (!cardsRes.ok) {
          userCards = userData.cards_owned || {};
        }
        
        renderPage();
      } catch (error) {
        console.error("è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:", error);
        alert("è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—");
      }
    }

    function calculateEquipmentBonus() {
      const bonus = {};
      const equipment = userData.equipment || {};
      
      for (let slot = 1; slot <= 5; slot++) {
        const equippedCard = equipment[slot];
        if (!equippedCard) continue;
        
        const cardId = Object.keys(equippedCard)[0];
        const cardLevel = equippedCard[cardId];
        const equipInfo = equipData.find(e => e.id === cardId);
        
        if (equipInfo && equipInfo.value && equipInfo.value[cardLevel]) {
          const cardStats = equipInfo.value[cardLevel];
          for (const [stat, value] of Object.entries(cardStats)) {
            bonus[stat] = (bonus[stat] || 0) + value;
          }
        }
      }
      
      return bonus;
    }

    function renderStats() {
      const baseStats = userData.base_stats || {};
      const equipBonus = calculateEquipmentBonus();
      const statsEl = document.getElementById("statsDisplay");
      
      const statsList = [
        { key: "hp", label: "ç”Ÿå‘½å€¼", isPercent: false },
        { key: "attack", label: "æ”»æ“ŠåŠ›", isPercent: false },
        { key: "shield", label: "è­·ç›¾", isPercent: true },
        { key: "evade", label: "é–ƒé¿", isPercent: true },
        { key: "accuracy", label: "å‘½ä¸­", isPercent: true },
        { key: "other_bonus", label: "å…¶ä»–åŠ æˆ", isPercent: true },
        { key: "luck", label: "é‹æ°£å€¼", isPercent: false },
        { key: "atk_speed", label: "æ”»æ“Šé€Ÿåº¦", isPercent: false }
      ];
      
      let html = "";
      statsList.forEach(({ key, label, isPercent }) => {
        const base = baseStats[key] || 0;
        const bonus = equipBonus[key] || 0;
        const total = base + bonus;
        
        const displayValue = isPercent ? `${(total * 100).toFixed(1)}%` : total;
        const bonusDisplay = bonus > 0 ? ` (+${isPercent ? (bonus * 100).toFixed(1) + '%' : bonus})` : '';
        
        html += `
          <div class="stat-item">
            <span>${label}:</span>
            <span>${displayValue} (${isPercent ? (base * 100).toFixed(1) + '%' : base}${bonusDisplay})</span>
          </div>
        `;
      });
      
      statsEl.innerHTML = html;
    }

    function renderEquipment() {
      const equipment = userData.equipment || {};
      const equipEl = document.getElementById("equipmentDisplay");
      
      let html = "";
      for (let slot = 1; slot <= 5; slot++) {
        const equippedCard = equipment[slot];
        
        if (!equippedCard) {
          html += `
            <div class="equipment-slot empty">
              æ¬„ä½ ${slot}: ç„¡è£å‚™
            </div>
          `;
        } else {
          const cardId = Object.keys(equippedCard)[0];
          const cardLevel = equippedCard[cardId];
          const equipInfo = equipData.find(e => e.id === cardId);
          
          if (equipInfo) {
            const stats = equipInfo.value[cardLevel] || {};
            const statsText = Object.entries(stats)
              .map(([key, value]) => `${key}: +${['shield','evade','accuracy','other_bonus'].includes(key) ? (value*100).toFixed(1)+'%' : value}`)
              .join(", ");
              
            html += `
              <div class="equipment-slot">
                <strong>æ¬„ä½ ${slot}: ${equipInfo.name} (Lv.${cardLevel})</strong><br>
                <span class="materials-list">æ•ˆæœ: ${statsText}</span>
              </div>
            `;
          }
        }
      }
      
      equipEl.innerHTML = html;
    }

    function renderItems() {
      const itemEl = document.getElementById("itemGrid");
      let html = "";
    
      Object.entries(userItems).forEach(([id, count]) => {
        const meta = itemMeta.find(m => m.id === id) || { name: id, description: "", special: 0 };

        let cardClass = "item-card";
        let rarityLabel = "";
        let nameColor = "#333"; // default for æ™®é€šé“å…·
        
        if (meta.special === 1) {
          cardClass += " rare";
          rarityLabel = "ã€ç¨€æœ‰ã€‘";
          nameColor = "#00bfff"; // æ·ºè—è‰²
        } else if (meta.special === 2) {
          cardClass += " super-rare";
          rarityLabel = "ã€è¶…ç¨€æœ‰ã€‘";
          nameColor = "#ff69b4"; // æ¡ƒç´…è‰²
        }
    
        html += `
          <div class="${cardClass}">
            <div class="item-name" style="color: ${nameColor}">${rarityLabel}${meta.name}</div>
            <div class="item-desc">${meta.description}</div>
            <div class="item-count">æŒæœ‰æ•¸é‡: <span class="count-highlight">${count}</span></div>
          </div>
        `;
      });
    
      itemEl.innerHTML = html || '<div class="item-card">æš«ç„¡é“å…·</div>';
    }

    function renderPage() {
      renderStats();
      renderEquipment();
      renderItems();
    }

    async function openCraftUI() {
      const dialog = document.getElementById("dialogContainer");
      
      let html = `
        <div class='dialog-box'>
          <h3>ğŸ§ª å¡ç‰‡è£½ä½œèˆ‡å‡ç´š</h3>
          <div class="scroll-content">
      `;
      
      cardData.forEach(card => {
        const currentLevel = userCards[card.id] || 0;
        const maxLevel = card.levels.length;
        const isMaxed = currentLevel >= maxLevel;
        const canCraft = userData.level >= card.require_level;
        
        if (!canCraft) {
          html += `
            <div class="craft-item">
              <strong>${card.name}</strong> (éœ€è¦ç­‰ç´š: ${card.require_level})<br>
              <span style="color: red;">ç­‰ç´šä¸è¶³ï¼Œç„¡æ³•è£½ä½œ</span>
            </div>
          `;
          return;
        }
        
        const nextLevel = currentLevel + 1;
        const levelData = card.levels[currentLevel]; // 0-based index
        
        if (isMaxed) {
          html += `
            <div class="craft-item">
              <strong>${card.name}</strong> Lv.${currentLevel} (å·²æ»¿ç´š)<br>
              <span class="materials-list">${card.description}</span>
            </div>
          `;
        } else if (levelData) {
          const materials = Object.entries(levelData.materials)
          .map(([matId, qty]) => {
            const owned = userItems[matId] || 0;
            const color = owned >= qty ? "green" : "red";
            const meta = itemMeta.find(m => m.id === matId);
            const itemName = meta ? meta.name : matId;  // è‹¥æ‰¾ä¸åˆ°å°±ç”¨åŸ ID
            return `<span style="color: ${color}">${itemName} x${qty} (${owned})</span>`;
          }).join(", ");
          
          const hasAllMaterials = Object.entries(levelData.materials)
            .every(([matId, qty]) => (userItems[matId] || 0) >= qty);
          
          const successRate = (levelData.chance * 100).toFixed(0);
          
          html += `
            <div class="craft-item">
              <strong>${card.name}</strong> Lv.${currentLevel} â†’ Lv.${nextLevel}<br>
              <span class="materials-list">${card.description}</span><br>
              <span class="materials-list">æ‰€éœ€ææ–™: ${materials}</span><br>
              <span class="materials-list">æˆåŠŸç‡: ${successRate}%</span><br>
              ${hasAllMaterials ? 
                `<button class="square-btn" onclick="craftCard('${card.id}', ${currentLevel})">${currentLevel === 0 ? 'è£½ä½œ' : 'å‡ç´š'}</button>` :
                '<span style="color: red">ææ–™ä¸è¶³</span>'
              }
            </div>
          `;
        }
      });
      
      html += `
          </div> <!-- scroll-content -->
          <div class="btn-group">
            <button class="square-btn" onclick="closeDialog()">é—œé–‰</button>
          </div>
        </div>
      `;
      
      dialog.innerHTML = html;
      dialog.style.display = "flex";
      document.body.style.overflow = "hidden";
      document.body.classList.add("dialog-open");
    }

    async function craftCard(cardId, currentLevel) {
      const card = cardData.find(c => c.id === cardId);
      const levelData = card.levels[currentLevel];
      
      if (!levelData) {
        alert("âŒ è³‡æ–™éŒ¯èª¤");
        return;
      }
      
      // æª¢æŸ¥ææ–™
      for (const [matId, qty] of Object.entries(levelData.materials)) {
        if ((userItems[matId] || 0) < qty) {
          alert("âŒ ææ–™ä¸è¶³");
          return;
        }
      }
      
      if (!confirm(`ç¢ºå®šè¦${currentLevel === 0 ? 'è£½ä½œ' : 'å‡ç´š'} ${card.name} å—ï¼Ÿ\næˆåŠŸç‡: ${(levelData.chance * 100).toFixed(0)}%`)) {
        return;
      }
      
      showLoading(true);
      
      try {
        const response = await fetch(`${API_BASE}/craft_card`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user: userId,
            card_id: cardId,
            materials: levelData.materials,
            success_rate: levelData.chance
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          if (result.success) {
            alert(`âœ… ${currentLevel === 0 ? 'è£½ä½œ' : 'å‡ç´š'}æˆåŠŸï¼`);
            userCards[cardId] = currentLevel + 1;
          } else {
            alert(`âŒ ${result.message || 'è£½ä½œå¤±æ•—ï¼Œææ–™å·²æ¶ˆè€—'}`);
          }
          
          // é‡æ–°è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™ä»¥æ›´æ–°é“å…·æ•¸é‡
          await loadUserData();
          closeDialog();
        } else {
          alert(result.error || "è£½ä½œå¤±æ•—");
        }
      } catch (error) {
        console.error("è£½ä½œéŒ¯èª¤:", error);
        alert("è£½ä½œéç¨‹ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        showLoading(false);
      }
    }

    function openEquipUI() {
      const dialog = document.getElementById("dialogContainer");
      const equipment = userData.equipment || {};
      
      let html = `
        <div class='dialog-box'>
          <h3>ğŸ§· è£å‚™ç®¡ç†</h3>
      `;
      
      // é¡¯ç¤ºè£å‚™æ§½ä½
      for (let slot = 1; slot <= 5; slot++) {
        html += `
          <div class="equip-item">
            <label><strong>æ¬„ä½ ${slot}:</strong></label><br>
            <select id="equip_slot_${slot}" style="width: 100%; margin-top: 5px;">
              <option value="">ç„¡è£å‚™</option>
        `;
        
        // æ·»åŠ å¯è£å‚™çš„å¡ç‰‡é¸é …
        Object.entries(userCards).forEach(([cardId, level]) => {
          if (level > 0) {
            const cardInfo = equipData.find(e => e.id === cardId);
            const cardName = cardInfo ? cardInfo.name : cardId;
            const isEquipped = equipment[slot]?.[cardId];
            const isEquippedElsewhere = Object.values(equipment).some(eq => eq && eq[cardId] && equipment[slot] !== eq);
            
            if (!isEquippedElsewhere || isEquipped) {
              html += `<option value="${cardId}" ${isEquipped ? 'selected' : ''}>${cardName} Lv.${level}</option>`;
            }
          }
        });
        
        html += `
            </select>
          </div>
        `;
      }
      
      html += `
          <div class="btn-group">
            <button class="square-btn" onclick="saveEquipment()">âœ… å„²å­˜è£å‚™</button>
            <button class="square-btn" onclick="closeDialog()">å–æ¶ˆ</button>
          </div>
        </div>
      `;
      
      dialog.innerHTML = html;
      dialog.style.display = "flex";
      document.body.style.overflow = "hidden";
      document.body.classList.add("dialog-open");
    }

    async function saveEquipment() {
      const newEquipment = {};
      
      for (let slot = 1; slot <= 5; slot++) {
        const selectEl = document.getElementById(`equip_slot_${slot}`);
        const cardId = selectEl.value;
        
        if (cardId && userCards[cardId]) {
          newEquipment[slot] = { [cardId]: userCards[cardId] };
        }
      }
      
      showLoading(true);
      
      try {
        const response = await fetch(`${API_BASE}/save_equipment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user: userId,
            equipment: newEquipment
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          userData.equipment = newEquipment;
          renderPage();
          closeDialog();
          alert("âœ… è£å‚™æ›´æ–°æˆåŠŸ");
        } else {
          alert(result.error || result.message || "è£å‚™æ›´æ–°å¤±æ•—");
        }
      } catch (error) {
        console.error("å„²å­˜è£å‚™éŒ¯èª¤:", error);
        alert("å„²å­˜è£å‚™æ™‚ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        showLoading(false);
      }
    }

    function closeDialog() {
      document.body.style.overflow = "";
      document.body.classList.remove("dialog-open");
      document.getElementById("dialogContainer").style.display = "none";
    }

    // å…¨åŸŸå‡½æ•¸
    window.openCraftUI = openCraftUI;
    window.openEquipUI = openEquipUI;
    window.closeDialog = closeDialog;
    window.craftCard = craftCard;
    window.saveEquipment = saveEquipment;

    async function runMain() {
      console.log("âš™ï¸ runMain userId =", userId);
      showLoading(true);
      
      try {
        await loadGameData();
        await loadUserData();
      } catch (error) {
        console.error("åˆå§‹åŒ–éŒ¯èª¤:", error);
        alert("é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
      } finally {
        showLoading(false);
      }
    }

    // ç›£è½ä¾†è‡ªçˆ¶é é¢çš„è¨Šæ¯
    window.addEventListener("message", async (e) => {
      if (e.data?.user) {
        userId = e.data.user;
        await runMain();
      } else {
        console.warn("âš ï¸ æœªæ”¶åˆ°æœ‰æ•ˆ userï¼Œç„¡æ³•å•Ÿå‹•");
      }
    });
  </script>
</body>
</html>
