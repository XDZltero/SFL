<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<link href="css/inventory.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">âš¡ åˆå§‹åŒ–è£å‚™ç³»çµ± âš¡</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <!-- é ‚éƒ¨æ¬„ä½ -->
  <div id="topbar">
    <div class="user-info">
      <span id="userInfo">ğŸ”Œ ç³»çµ±é€£æ¥ä¸­...</span>
    </div>
    <div class="controls">
      <button onclick="location.reload()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>
  </div>

  <div class="main-container">
    <h1 class="fancy-title">ğŸ’ CYBER INVENTORY</h1>
    
    <!-- è§’è‰²å±¬æ€§å€åŸŸ -->
    <div class="section">
      <h2 class="fancy-subtitle">ğŸ§¬ è§’è‰²æ•¸æ“šåˆ†æ</h2>
      <div class="stats-grid" id="statsDisplay"></div>
    </div>
    
    <!-- è£å‚™å€åŸŸ -->
    <div class="section">
      <h2 class="fancy-subtitle">ğŸ›¡ï¸ è£å‚™é…ç½®ç³»çµ±</h2>
      <div class="equipment-grid" id="equipmentDisplay"></div>
    </div>
    
    <!-- é“å…·å€åŸŸ -->
    <div class="section">
      <h2 class="fancy-subtitle">ğŸ“¦ æ•¸æ“šå­˜å„²åº«</h2>
      <div class="item-grid" id="itemGrid"></div>
    </div>
    
    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="action-buttons">
      <button class="cyber-btn craft" onclick="openCraftUI()">ğŸ§ª è£½ä½œçµ‚ç«¯</button>
      <button class="cyber-btn" onclick="openEquipUI()">ğŸ”§ è£å‚™çµ‚ç«¯</button>
    </div>
  </div>
  
  <!-- å°è©±æ¡†å®¹å™¨ -->
  <div id="dialogContainer"></div>
  
  <!-- è¼‰å…¥å‹•ç•« -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner-icon">âš™ï¸</div>
    <div>ç³»çµ±è™•ç†ä¸­...</div>
  </div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    let userId = null;
    let userData = {};
    let userItems = {};
    let equipData = [];
    let itemMeta = [];
    let cardData = [];
    let userCards = {};

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      const spinner = document.getElementById("loadingSpinner");
      if (loading) loading.style.display = show ? "flex" : "none";
      if (spinner) spinner.style.display = show ? "block" : "none";
    }

    async function loadGameData() {
      try {
        const [equipRes, itemRes, cardRes] = await Promise.all([
          fetch("parameter/equips.json"),
          fetch("parameter/items.json"),
          fetch("parameter/cards_data.json")
        ]);
        
        equipData = await equipRes.json();
        itemMeta = await itemRes.json();
        cardData = await cardRes.json();
      } catch (error) {
        console.error("è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—:", error);
        alert("âš ï¸ è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
      }
    }

    async function loadUserData() {
      try {
        const [statusRes, itemsRes, cardsRes] = await Promise.all([
          fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`),
          fetch(`${API_BASE}/user_items?user=${encodeURIComponent(userId)}`),
          fetch(`${API_BASE}/user_cards?user=${encodeURIComponent(userId)}`)
        ]);
        
        userData = await statusRes.json();
        userItems = itemsRes.ok ? await itemsRes.json() : {};
        userCards = cardsRes.ok ? await cardsRes.json() : {};
        
        // å¦‚æœ API ä¸å­˜åœ¨ï¼Œå¾ userData ä¸­å–å¾—è³‡æ–™
        if (!itemsRes.ok) {
          userItems = userData.items || {};
        }
        if (!cardsRes.ok) {
          userCards = userData.cards_owned || {};
        }
        
        // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
        document.getElementById("userInfo").textContent = `ğŸ® ${userId} - Lv.${userData.level || 1}`;
        
        renderPage();
      } catch (error) {
        console.error("è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:", error);
        alert("âš ï¸ è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—");
      }
    }

    function calculateEquipmentBonus() {
      const bonus = {};
      const equipment = userData.equipment || {};
      
      for (let slot = 1; slot <= 5; slot++) {
        const equippedCard = equipment[slot];
        if (!equippedCard) continue;
        
        const cardId = Object.keys(equippedCard)[0];
        const cardLevel = equippedCard[cardId];
        const equipInfo = equipData.find(e => e.id === cardId);
        
        if (equipInfo && equipInfo.value && equipInfo.value[cardLevel]) {
          const cardStats = equipInfo.value[cardLevel];
          for (const [stat, value] of Object.entries(cardStats)) {
            bonus[stat] = (bonus[stat] || 0) + value;
          }
        }
      }
      
      return bonus;
    }

    function renderStats() {
      const baseStats = userData.base_stats || {};
      const equipBonus = calculateEquipmentBonus();
      const statsEl = document.getElementById("statsDisplay");
      
      const statsList = [
        { key: "hp", label: "âš¡ ç”Ÿå‘½å€¼", isPercent: false, icon: "â¤ï¸" },
        { key: "attack", label: "âš”ï¸ æ”»æ“ŠåŠ›", isPercent: false, icon: "ğŸ—¡ï¸" },
        { key: "shield", label: "ğŸ›¡ï¸ è­·ç›¾", isPercent: true
