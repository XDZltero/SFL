<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>背包與裝備管理</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<link href="css/inventory.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">⚡ 初始化裝備系統 ⚡</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <!-- 頂部欄位 -->
  <div id="topbar">
    <div class="user-info">
      <span id="userInfo">🔌 系統連接中...</span>
    </div>
    <div class="controls">
      <button onclick="location.reload()">🔄 重新載入</button>
    </div>
  </div>

  <div class="main-container">
    <h1 class="fancy-title">🎒 CYBER INVENTORY</h1>
    
    <!-- 角色屬性區域 -->
    <div class="section">
      <h2 class="fancy-subtitle">🧬 角色數據分析</h2>
      <div class="stats-grid" id="statsDisplay"></div>
    </div>
    
    <!-- 裝備區域 -->
    <div class="section">
      <h2 class="fancy-subtitle">🛡️ 裝備配置系統</h2>
      <div class="equipment-grid" id="equipmentDisplay"></div>
    </div>
    
    <!-- 道具區域 -->
    <div class="section">
      <h2 class="fancy-subtitle">📦 數據存儲庫</h2>
      <div class="item-grid" id="itemGrid"></div>
    </div>
    
    <!-- 操作按鈕 -->
    <div class="action-buttons">
      <button class="cyber-btn craft" onclick="openCraftUI()">🧪 製作終端</button>
      <button class="cyber-btn" onclick="openEquipUI()">🔧 裝備終端</button>
    </div>
  </div>
  
  <!-- 對話框容器 -->
  <div id="dialogContainer"></div>
  
  <!-- 載入動畫 -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner-icon">⚙️</div>
    <div>系統處理中...</div>
  </div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    let userId = null;
    let userData = {};
    let userItems = {};
    let equipData = [];
    let itemMeta = [];
    let cardData = [];
    let userCards = {};

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      const spinner = document.getElementById("loadingSpinner");
      if (loading) loading.style.display = show ? "flex" : "none";
      if (spinner) spinner.style.display = show ? "block" : "none";
    }

    async function loadGameData() {
      try {
        const [equipRes, itemRes, cardRes] = await Promise.all([
          fetch("parameter/equips.json"),
          fetch("parameter/items.json"),
          fetch("parameter/cards_data.json")
        ]);
        
        equipData = await equipRes.json();
        itemMeta = await itemRes.json();
        cardData = await cardRes.json();
      } catch (error) {
        console.error("載入遊戲資料失敗:", error);
        alert("⚠️ 載入遊戲資料失敗，請重新整理頁面");
      }
    }

    async function loadUserData() {
      try {
        const [statusRes, itemsRes, cardsRes] = await Promise.all([
          fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`),
          fetch(`${API_BASE}/user_items?user=${encodeURIComponent(userId)}`),
          fetch(`${API_BASE}/user_cards?user=${encodeURIComponent(userId)}`)
        ]);
        
        userData = await statusRes.json();
        userItems = itemsRes.ok ? await itemsRes.json() : {};
        userCards = cardsRes.ok ? await cardsRes.json() : {};
        
        // 如果 API 不存在，從 userData 中取得資料
        if (!itemsRes.ok) {
          userItems = userData.items || {};
        }
        if (!cardsRes.ok) {
          userCards = userData.cards_owned || {};
        }
        
        // 更新用戶信息顯示
        document.getElementById("userInfo").textContent = `🎮 ${userId} - Lv.${userData.level || 1}`;
        
        renderPage();
      } catch (error) {
        console.error("載入使用者資料失敗:", error);
        alert("⚠️ 載入使用者資料失敗");
      }
    }

    function calculateEquipmentBonus() {
      const bonus = {};
      const equipment = userData.equipment || {};
      
      for (let slot = 1; slot <= 5; slot++) {
        const equippedCard = equipment[slot];
        if (!equippedCard) continue;
        
        const cardId = Object.keys(equippedCard)[0];
        const cardLevel = equippedCard[cardId];
        const equipInfo = equipData.find(e => e.id === cardId);
        
        if (equipInfo && equipInfo.value && equipInfo.value[cardLevel]) {
          const cardStats = equipInfo.value[cardLevel];
          for (const [stat, value] of Object.entries(cardStats)) {
            bonus[stat] = (bonus[stat] || 0) + value;
          }
        }
      }
      
      return bonus;
    }

    function renderStats() {
      const baseStats = userData.base_stats || {};
      const equipBonus = calculateEquipmentBonus();
      const statsEl = document.getElementById("statsDisplay");
      
      const statsList = [
        { key: "hp", label: "⚡ 生命值", isPercent: false, icon: "❤️" },
        { key: "attack", label: "⚔️ 攻擊力", isPercent: false, icon: "🗡️" },
        { key: "shield", label: "🛡️ 護盾", isPercent: true
