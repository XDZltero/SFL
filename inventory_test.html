<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="/js/firebase-init.js"></script>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; padding: 20px; }
    .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .item-card { border: 1px solid #aaa; padding: 10px; border-radius: 10px; background: #fdfdfd; white-space: pre-wrap; }
    .item-card.rare { border-color: #4cc3ff; background: #eaf7ff; }
    .item-card.super-rare { border-color: #ff6ec7; background: #ffeafb; }
    #dialogContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; }
    .dialog-box { background: white; padding: 20px; border-radius: 10px; max-width: 600px; width: 90%; }
  </style>
</head>
<body>
  <h1>ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</h1>
  <div id="userInfo">å°šæœªç™»å…¥</div>
  <div id="statsBlock"></div>
  <div id="equipSlots"></div>
  <div class="item-grid" id="itemGrid"></div>
  <button onclick="openCraftUI()">ğŸ§ª è£½ä½œå¡ç‰‡</button>
  <button onclick="openEquipUI()">ğŸ§· è£å‚™å¡ç‰‡</button>
  <div id="dialogContainer"></div>

  <script>
    const db = firebase.firestore();
    let userId, userData, userItems, equips = [], itemMeta = [], cardData = [];

    async function init() {
      firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
          alert("è«‹å…ˆç™»å…¥ï¼");
          window.parent.location.href = "/SFL/login.html";
          return;
        }

        userId = user.email;
        document.getElementById("userInfo").innerText = `ğŸ‘¤ ${userId}`;

        const [userSnap, equipsSnap, itemsSnap, userItemsSnap, cardsRes] = await Promise.all([
          db.collection("users").doc(userId).get(),
          db.collection("equips").get(),
          db.collection("items").get(),
          db.collection("user_items").doc(userId).get(),
          fetch("parameter/cards_data.json").then(r => r.json())
        ]);

        userData = userSnap.data();
        equips = equipsSnap.docs.map(d => d.data());
        itemMeta = itemsSnap.docs.map(d => d.data());
        userItems = userItemsSnap.exists ? userItemsSnap.data() : {};
        cardData = cardsRes;

        renderPage();
      });
    }

    function renderPage() {
      const equipBonus = {}, base = userData.base_stats || {};
      const statsEl = document.getElementById("statsBlock");
      const equipEl = document.getElementById("equipSlots");
      const equipsMap = Object.fromEntries(equips.map(e => [e.id, e]));

      for (let i = 1; i <= 5; i++) {
        const slot = userData.equipment?.[i];
        if (!slot) continue;
        const [cardId, lvl] = Object.entries(slot)[0];
        const card = equipsMap[cardId];
        if (card?.value?.[lvl]) {
          for (const [k, v] of Object.entries(card.value[lvl])) {
            equipBonus[k] = (equipBonus[k] || 0) + v;
          }
        }
      }

      statsEl.innerHTML = "<h3>ğŸ§¬ èƒ½åŠ›å€¼</h3>" + Object.entries(base).map(([k, v]) => {
        const bonus = equipBonus[k] || 0;
        const total = v + bonus;
        return `<p>${k.toUpperCase()}: ${['shield','evade','accuracy','other_bonus'].includes(k) ? (total*100).toFixed(1)+'%' : total} (${v} +${bonus})</p>`;
      }).join("");

      equipEl.innerHTML = "<h3>ğŸ›¡ï¸ è£å‚™ä¸­</h3>";
      for (let i = 1; i <= 5; i++) {
        const slot = userData.equipment?.[i];
        if (!slot) {
          equipEl.innerHTML += `<div>æ¬„ä½ ${i}ï¼šç„¡è£å‚™</div>`;
        } else {
          const [cardId, lvl] = Object.entries(slot)[0];
          const card = equipsMap[cardId];
          const bonusStr = Object.entries(card.value[lvl] || {}).map(([k,v]) => `${k}+${v}`).join(", ");
          equipEl.innerHTML += `<div>æ¬„ä½ ${i}ï¼š${card.name}ï¼ˆLv.${lvl}ï¼‰<br>æ•ˆæœï¼š${bonusStr}</div>`;
        }
      }

      const itemEl = document.getElementById("itemGrid");
      itemEl.innerHTML = Object.entries(userItems).map(([id, count]) => {
        const meta = itemMeta.find(m => m.id === id) || {};
        const cls = meta.special === 1 ? "item-card rare" : meta.special === 2 ? "item-card super-rare" : "item-card";
        const label = meta.special === 1 ? "ã€ç¨€æœ‰ã€‘" : meta.special === 2 ? "ã€è¶…ç¨€æœ‰ã€‘" : "";
        return `<div class="${cls}">${label}${meta.name || id}\n${meta.description || ""}\næŒæœ‰æ•¸é‡: ${count}</div>`;
      }).join("");
    }

    function openCraftUI() {
      const dialog = document.getElementById("dialogContainer");
      dialog.style.display = "flex";
      const html = cardData.map(card => {
        const ownedLvl = userData.cards_owned?.[card.id] || 0;
        const maxed = ownedLvl >= 5;
        const enough = Object.entries(card.materials).every(([k, v]) => (userItems[k] || 0) >= v);
        const matList = Object.entries(card.materials).map(([k,v]) => `${k} x${v}`).join(', ');
        const action = maxed ? "<span style='color:gray'>å·²é”æœ€å¤§ç­‰ç´š</span>" :
                       enough ? `<button onclick="craftCard('${card.id}')">${ownedLvl ? 'å‡ç´š' : 'è£½ä½œ'}</button>` :
                       "<span style='color:red'>ææ–™ä¸è¶³</span>";
        return `<li><b>${card.name}</b> Lv.${ownedLvl || 0}<br>${card.description}<br>ğŸ”§ ${matList}<br>${action}</li>`;
      }).join('<hr>');
      dialog.innerHTML = `<div class='dialog-box'><h3>å¯è£½ä½œ/å‡ç´šå¡ç‰‡</h3><ul>${html}</ul><br><button onclick='closeDialog()'>é—œé–‰</button></div>`;
    }

    async function craftCard(cardId) {
      const card = cardData.find(c => c.id === cardId);
      const currentLvl = userData.cards_owned?.[cardId] || 0;
      if (currentLvl >= 5) return alert("âŒ å·²é”æœ€å¤§ç­‰ç´š");
      for (const [mat, qty] of Object.entries(card.materials)) {
        if ((userItems[mat] || 0) < qty) return alert("âŒ ææ–™ä¸è¶³");
        userItems[mat] -= qty;
      }
      if (!userData.cards_owned) userData.cards_owned = {};
      userData.cards_owned[cardId] = currentLvl + 1;
      await db.collection("users").doc(userId).set(userData);
      await db.collection("user_items").doc(userId).set(userItems);
      alert(currentLvl ? "âœ… å‡ç´šæˆåŠŸ" : "âœ… è£½ä½œæˆåŠŸ");
      closeDialog();
      location.reload();
    }

    function openEquipUI() {
      const owned = userData.cards_owned || {};
      const equipsMap = Object.fromEntries(equips.map(e => [e.id, e]));
      let html = "<div class='dialog-box'><h3>è£å‚™å¡ç‰‡</h3>";
      for (let i = 1; i <= 5; i++) {
        html += `<label>æ¬„ä½ ${i}: <select id='equip_slot_${i}'><option value=''>ç„¡</option>`;
        for (const [id, lvl] of Object.entries(owned)) {
          const name = equipsMap[id]?.name || id;
          const sel = userData.equipment?.[i]?.[id] ? "selected" : "";
          html += `<option value='${id}' ${sel}>${name} Lv.${lvl}</option>`;
        }
        html += "</select></label><br>";
      }
      html += `<button onclick='saveEquip()'>å„²å­˜</button> <button onclick='closeDialog()'>å–æ¶ˆ</button></div>`;
      document.getElementById("dialogContainer").innerHTML = html;
      document.getElementById("dialogContainer").style.display = "flex";
    }

    async function saveEquip() {
      const newEquip = {};
      for (let i = 1; i <= 5; i++) {
        const val = document.getElementById(`equip_slot_${i}`).value;
        if (val) newEquip[i] = { [val]: userData.cards_owned[val] };
      }
      userData.equipment = newEquip;
      await db.collection("users").doc(userId).update({ equipment: newEquip });
      alert("âœ… è£å‚™æ›´æ–°æˆåŠŸ");
      closeDialog();
      location.reload();
    }

    function closeDialog() {
      document.getElementById("dialogContainer").style.display = "none";
    }

    init();
  </script>
</body>
</html>
