<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>ä¸–ç•Œç‹ç®¡ç†å“¡å¹³å°</title>
<link rel="icon" href="favicon.ico" />
<link href="css/style.css" rel="stylesheet"/>
<link href="css/admin_world_boss.css" rel="stylesheet"/>
</head>
<body class="admin-mode">

<!-- ç®¡ç†å“¡æ¨™é¡Œæ¬„ -->
<div class="admin-header">
  <div class="admin-title">ğŸ”§ ä¸–ç•Œç‹ç®¡ç†å“¡å¹³å° ğŸ”§</div>
  <div class="admin-user">ç®¡ç†å“¡: <span id="adminEmail">è¼‰å…¥ä¸­...</span></div>
  <button class="admin-back-btn" onclick="goBack()">ğŸ”™ è¿”å›ä¸»é </button>
</div>

<!-- è¼‰å…¥é®ç½© -->
<div id="loadingOverlay">
  <div class="battle-loading-container">
    <div class="battle-icon">âš™ï¸</div>
    <div class="normal-title">è¼‰å…¥ç®¡ç†å“¡é¢æ¿</div>
    <div class="loading-text">æ­£åœ¨é©—è­‰ç®¡ç†å“¡æ¬Šé™...</div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
</div>

<!-- ä¸»è¦ç®¡ç†å€åŸŸ -->
<div class="admin-container">
  
  <!-- ä¸–ç•Œç‹ç‹€æ…‹ç›£æ§ -->
  <div class="admin-section">
    <h2 class="section-title">ğŸ“Š ä¸–ç•Œç‹ç‹€æ…‹ç›£æ§</h2>
    
    <div class="status-grid">
      <div class="status-card">
        <div class="status-label">ç•¶å‰è¡€é‡</div>
        <div class="status-value" id="currentHp">è¼‰å…¥ä¸­...</div>
        <div class="status-subtitle">/ <span id="maxHp">999,999,999</span></div>
      </div>
      
      <div class="status-card">
        <div class="status-label">ç•¶å‰éšæ®µ</div>
        <div class="status-value" id="currentPhase">1</div>
        <div class="status-subtitle">å…± 3 éšæ®µ</div>
      </div>
      
      <div class="status-card">
        <div class="status-label">åƒèˆ‡è€…æ•¸é‡</div>
        <div class="status-value" id="totalParticipants">0</div>
        <div class="status-subtitle">ç¸½æŒ‘æˆ°è€…</div>
      </div>
      
      <div class="status-card">
        <div class="status-label">ç¸½å‚·å®³</div>
        <div class="status-value" id="totalDamage">0</div>
        <div class="status-subtitle">ç´¯ç©å‚·å®³</div>
      </div>
    </div>
    
    <!-- ä¸–ç•Œç‹è¡€é‡æ¢ -->
    <div class="admin-hp-container">
      <div class="admin-hp-bar">
        <div class="admin-hp-fill" id="adminHpFill" style="width: 100%;"></div>
        <div class="admin-hp-text" id="adminHpText">100%</div>
      </div>
    </div>
  </div>

  <!-- ä¸–ç•Œç‹æ§åˆ¶é¢æ¿ -->
  <div class="admin-section">
    <h2 class="section-title">âš™ï¸ ä¸–ç•Œç‹æ§åˆ¶é¢æ¿</h2>
    
    <div class="control-grid">
      <!-- è¡€é‡èª¿æ•´ -->
      <div class="control-card">
        <h3>ğŸ’š è¡€é‡èª¿æ•´</h3>
        <div class="control-group">
          <label>è¨­å®šè¡€é‡:</label>
          <input type="number" id="setHpInput" placeholder="è¼¸å…¥è¡€é‡å€¼" min="0" max="999999999">
          <button class="admin-btn primary" onclick="setWorldBossHp()">è¨­å®šè¡€é‡</button>
        </div>
        <div class="control-group">
          <label>è¡€é‡èª¿æ•´:</label>
          <div class="hp-buttons">
            <button class="admin-btn" onclick="adjustHp(-1000000)">-100è¬</button>
            <button class="admin-btn" onclick="adjustHp(-100000)">-10è¬</button>
            <button class="admin-btn" onclick="adjustHp(-10000)">-1è¬</button>
            <button class="admin-btn success" onclick="adjustHp(10000)">+1è¬</button>
            <button class="admin-btn success" onclick="adjustHp(100000)">+10è¬</button>
            <button class="admin-btn success" onclick="adjustHp(1000000)">+100è¬</button>
          </div>
        </div>
      </div>

      <!-- é‡ç½®åŠŸèƒ½ -->
      <div class="control-card">
        <h3>ğŸ”„ é‡ç½®åŠŸèƒ½</h3>
        <div class="control-group">
          <button class="admin-btn warning" onclick="resetWorldBossHp()">é‡ç½®è¡€é‡</button>
          <button class="admin-btn danger" onclick="resetAllPlayers()">æ¸…é™¤ç©å®¶æ•¸æ“š</button>
          <button class="admin-btn danger" onclick="fullReset()">å®Œå…¨é‡ç½®</button>
        </div>
        <div class="reset-warning">
          âš ï¸ é‡ç½®æ“ä½œä¸å¯é€†ï¼Œè«‹è¬¹æ…ä½¿ç”¨
        </div>
      </div>

      <!-- éšæ®µæ§åˆ¶ -->
      <div class="control-card">
        <h3>âš¡ éšæ®µæ§åˆ¶</h3>
        <div class="phase-buttons">
          <button class="admin-btn" onclick="forcePhase(1)">å¼·åˆ¶ç¬¬ä¸€éšæ®µ</button>
          <button class="admin-btn" onclick="forcePhase(2)">å¼·åˆ¶ç¬¬äºŒéšæ®µ</button>
          <button class="admin-btn" onclick="forcePhase(3)">å¼·åˆ¶ç¬¬ä¸‰éšæ®µ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç©å®¶ç®¡ç† -->
  <div class="admin-section">
    <h2 class="section-title">ğŸ‘¥ ç©å®¶ç®¡ç†</h2>
    
    <div class="player-controls">
      <div class="search-bar">
        <input type="text" id="playerSearchInput" placeholder="æœå°‹ç©å®¶æš±ç¨±æˆ–ID" onkeyup="searchPlayers(event)">
        <button class="admin-btn" onclick="searchPlayers()">ğŸ” æœå°‹</button>
        <button class="admin-btn" onclick="refreshPlayerList()">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
      
      <div class="bulk-actions">
        <select id="bulkActionSelect">
          <option value="">æ‰¹é‡æ“ä½œ</option>
          <option value="reset_damage">é‡ç½®å‚·å®³</option>
          <option value="remove_cooldown">ç§»é™¤å†·å»</option>
          <option value="delete_player">åˆªé™¤ç©å®¶</option>
        </select>
        <button class="admin-btn warning" onclick="executeBulkAction()">åŸ·è¡Œæ‰¹é‡æ“ä½œ</button>
      </div>
    </div>

    <div class="player-list" id="playerList">
      è¼‰å…¥ç©å®¶è³‡æ–™ä¸­...
    </div>
  </div>

  <!-- ç³»çµ±æ—¥èªŒ -->
  <div class="admin-section">
    <h2 class="section-title">ğŸ“‹ ç³»çµ±æ—¥èªŒ</h2>
    <div class="log-container" id="systemLog">
      <div class="log-entry">ç³»çµ±å•Ÿå‹•å®Œæˆ</div>
    </div>
    <button class="admin-btn" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
  </div>

  <!-- çµ±è¨ˆæ•¸æ“š -->
  <div class="admin-section">
    <h2 class="section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</h2>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">ä»Šæ—¥æŒ‘æˆ°æ¬¡æ•¸</div>
        <div class="stat-value" id="todayChallenges">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ç¸½æŒ‘æˆ°æ¬¡æ•¸</div>
        <div class="stat-value" id="totalChallenges">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å¹³å‡å‚·å®³</div>
        <div class="stat-value" id="avgDamage">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">æœ€é«˜å–®æ¬¡å‚·å®³</div>
        <div class="stat-value" id="maxSingleDamage">0</div>
      </div>
    </div>
  </div>
</div>

<!-- ç¢ºèªå°è©±æ¡† -->
<div class="confirm-dialog" id="confirmDialog" style="display: none;">
  <div class="confirm-content">
    <div class="confirm-title">ç¢ºèªæ“ä½œ</div>
    <div class="confirm-message" id="confirmMessage">ä½ ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
    <div class="confirm-buttons">
      <button class="admin-btn" onclick="closeConfirmDialog()">å–æ¶ˆ</button>
      <button class="admin-btn danger" id="confirmButton" onclick="executeConfirmedAction()">ç¢ºèª</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, SecureAPI } from "./js/firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const API_BASE = "https://sfl-9cb8.onrender.com";
const ADMIN_EMAIL = "xdzltero@gmail.com";

let worldBossData = null;
let playersData = [];
let selectedPlayers = [];
let pendingAction = null;

// æ¬Šé™æª¢æŸ¥
function checkAdminPermission(userEmail) {
  return userEmail === ADMIN_EMAIL;
}

// è¼‰å…¥é€²åº¦
function updateLoadingProgress() {
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += Math.random() * 15 + 5;
    if (progress > 100) progress = 100;
    
    progressBar.style.width = progress + "%";
    progressText.textContent = Math.round(progress) + "%";
    
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        document.getElementById("loadingOverlay").style.display = "none";
      }, 500);
    }
  }, 100);
}

// æ—¥èªŒåŠŸèƒ½
function addLog(message, type = 'info') {
  const logContainer = document.getElementById("systemLog");
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = document.createElement("div");
  logEntry.className = `log-entry ${type}`;
  logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
  logContainer.insertBefore(logEntry, logContainer.firstChild);
  
  // é™åˆ¶æ—¥èªŒæ•¸é‡
  const entries = logContainer.querySelectorAll('.log-entry');
  if (entries.length > 50) {
    entries[entries.length - 1].remove();
  }
}

// è¼‰å…¥ä¸–ç•Œç‹æ•¸æ“š
async function loadWorldBossData() {
  try {
    const response = await SecureAPI.get(`${API_BASE}/admin/world_boss_status`);
    if (response.ok) {
      worldBossData = await response.json();
      updateWorldBossDisplay();
      addLog("ä¸–ç•Œç‹æ•¸æ“šè¼‰å…¥æˆåŠŸ", "success");
    } else {
      throw new Error("è¼‰å…¥ä¸–ç•Œç‹æ•¸æ“šå¤±æ•—");
    }
  } catch (error) {
    addLog(`è¼‰å…¥ä¸–ç•Œç‹æ•¸æ“šå¤±æ•—: ${error.message}`, "error");
    console.error(error);
  }
}

// æ›´æ–°ä¸–ç•Œç‹é¡¯ç¤º
function updateWorldBossDisplay() {
  if (!worldBossData) return;
  
  document.getElementById("currentHp").textContent = worldBossData.current_hp.toLocaleString();
  document.getElementById("maxHp").textContent = worldBossData.max_hp.toLocaleString();
  document.getElementById("currentPhase").textContent = worldBossData.current_phase;
  document.getElementById("totalParticipants").textContent = worldBossData.total_participants.toLocaleString();
  document.getElementById("totalDamage").textContent = worldBossData.total_damage_dealt.toLocaleString();
  
  // æ›´æ–°è¡€é‡æ¢
  const percentage = Math.max(0, (worldBossData.current_hp / worldBossData.max_hp) * 100);
  document.getElementById("adminHpFill").style.width = percentage + "%";
  document.getElementById("adminHpText").textContent = percentage.toFixed(1) + "%";
}

// è¼‰å…¥ç©å®¶æ•¸æ“š
async function loadPlayersData() {
  try {
    const response = await SecureAPI.get(`${API_BASE}/admin/world_boss_players`);
    if (response.ok) {
      playersData = await response.json();
      updatePlayerList();
      updateStatistics();
      addLog(`è¼‰å…¥äº† ${playersData.length} ä½ç©å®¶æ•¸æ“š`, "success");
    } else {
      throw new Error("è¼‰å…¥ç©å®¶æ•¸æ“šå¤±æ•—");
    }
  } catch (error) {
    addLog(`è¼‰å…¥ç©å®¶æ•¸æ“šå¤±æ•—: ${error.message}`, "error");
    console.error(error);
  }
}

// æ›´æ–°ç©å®¶åˆ—è¡¨
function updatePlayerList(filteredData = null) {
  const listContainer = document.getElementById("playerList");
  const data = filteredData || playersData;
  
  if (!data || data.length === 0) {
    listContainer.innerHTML = '<div class="no-data">æš«ç„¡ç©å®¶æ•¸æ“š</div>';
    return;
  }
  
  let html = `
    <div class="player-header">
      <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
      <span>æ’å</span>
      <span>ç©å®¶</span>
      <span>ç´¯ç©å‚·å®³</span>
      <span>æŒ‘æˆ°æ¬¡æ•¸</span>
      <span>æœ€å¾ŒæŒ‘æˆ°</span>
      <span>æ“ä½œ</span>
    </div>
  `;
  
  data.forEach((player, index) => {
    const lastChallenge = player.last_challenge_time ? 
      new Date(player.last_challenge_time * 1000).toLocaleString() : 'å¾æœªæŒ‘æˆ°';
    
    html += `
      <div class="player-row">
        <input type="checkbox" class="player-checkbox" value="${player.user_id}">
        <span class="rank">#${index + 1}</span>
        <span class="nickname">${player.nickname}</span>
        <span class="damage">${player.total_damage.toLocaleString()}</span>
        <span class="challenges">${player.challenge_count}</span>
        <span class="last-challenge">${lastChallenge}</span>
        <span class="actions">
          <button class="mini-btn" onclick="editPlayer('${player.user_id}')">ç·¨è¼¯</button>
          <button class="mini-btn danger" onclick="removePlayer('${player.user_id}')">åˆªé™¤</button>
        </span>
      </div>
    `;
  });
  
  listContainer.innerHTML = html;
}

// æ›´æ–°çµ±è¨ˆæ•¸æ“š
function updateStatistics() {
  if (!playersData || playersData.length === 0) return;
  
  const totalChallenges = playersData.reduce((sum, p) => sum + (p.challenge_count || 0), 0);
  const totalDamage = playersData.reduce((sum, p) => sum + (p.total_damage || 0), 0);
  const avgDamage = totalChallenges > 0 ? Math.round(totalDamage / totalChallenges) : 0;
  const maxDamage = Math.max(...playersData.map(p => p.total_damage || 0));
  
  // è¨ˆç®—ä»Šæ—¥æŒ‘æˆ°æ¬¡æ•¸
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayTimestamp = today.getTime() / 1000;
  const todayChallenges = playersData.filter(p => 
    p.last_challenge_time && p.last_challenge_time >= todayTimestamp
  ).length;
  
  document.getElementById("todayChallenges").textContent = todayChallenges.toLocaleString();
  document.getElementById("totalChallenges").textContent = totalChallenges.toLocaleString();
  document.getElementById("avgDamage").textContent = avgDamage.toLocaleString();
  document.getElementById("maxSingleDamage").textContent = maxDamage.toLocaleString();
}

// æœå°‹ç©å®¶
function searchPlayers(event) {
  if (event && event.key !== 'Enter') return;
  
  const searchTerm = document.getElementById("playerSearchInput").value.toLowerCase();
  if (!searchTerm) {
    updatePlayerList();
    return;
  }
  
  const filtered = playersData.filter(player =>
    player.nickname.toLowerCase().includes(searchTerm) ||
    player.user_id.toLowerCase().includes(searchTerm)
  );
  
  updatePlayerList(filtered);
  addLog(`æœå°‹åˆ° ${filtered.length} ä½ç©å®¶`);
}

// åˆ·æ–°ç©å®¶åˆ—è¡¨
function refreshPlayerList() {
  loadPlayersData();
  addLog("é‡æ–°è¼‰å…¥ç©å®¶åˆ—è¡¨");
}

// å…¨é¸åŠŸèƒ½
function toggleSelectAll() {
  const selectAll = document.getElementById("selectAll");
  const checkboxes = document.querySelectorAll(".player-checkbox");
  
  checkboxes.forEach(cb => {
    cb.checked = selectAll.checked;
  });
}

// è¨­å®šä¸–ç•Œç‹è¡€é‡
async function setWorldBossHp() {
  const newHp = parseInt(document.getElementById("setHpInput").value);
  if (isNaN(newHp) || newHp < 0) {
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„è¡€é‡å€¼");
    return;
  }
  
  showConfirmDialog(`ç¢ºå®šè¦å°‡ä¸–ç•Œç‹è¡€é‡è¨­å®šç‚º ${newHp.toLocaleString()} å—ï¼Ÿ`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/set_world_boss_hp`, { hp: newHp });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`ä¸–ç•Œç‹è¡€é‡å·²è¨­å®šç‚º ${newHp.toLocaleString()}`, "success");
        await loadWorldBossData();
        document.getElementById("setHpInput").value = "";
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`è¨­å®šè¡€é‡å¤±æ•—: ${error.message}`, "error");
      alert("è¨­å®šè¡€é‡å¤±æ•—: " + error.message);
    }
  });
}

// èª¿æ•´è¡€é‡
async function adjustHp(amount) {
  const action = amount > 0 ? "å¢åŠ " : "æ¸›å°‘";
  const absAmount = Math.abs(amount);
  
  showConfirmDialog(`ç¢ºå®šè¦${action} ${absAmount.toLocaleString()} è¡€é‡å—ï¼Ÿ`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/adjust_world_boss_hp`, { amount });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`${action}äº† ${absAmount.toLocaleString()} è¡€é‡`, "success");
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`èª¿æ•´è¡€é‡å¤±æ•—: ${error.message}`, "error");
      alert("èª¿æ•´è¡€é‡å¤±æ•—: " + error.message);
    }
  });
}

// é‡ç½®ä¸–ç•Œç‹è¡€é‡
async function resetWorldBossHp() {
  showConfirmDialog("ç¢ºå®šè¦é‡ç½®ä¸–ç•Œç‹è¡€é‡åˆ°æ»¿è¡€ç‹€æ…‹å—ï¼Ÿ", async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/reset_world_boss_hp`, {});
      const result = await response.json();
      
      if (response.ok) {
        addLog("ä¸–ç•Œç‹è¡€é‡å·²é‡ç½®", "success");
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`é‡ç½®è¡€é‡å¤±æ•—: ${error.message}`, "error");
      alert("é‡ç½®è¡€é‡å¤±æ•—: " + error.message);
    }
  });
}

// æ¸…é™¤æ‰€æœ‰ç©å®¶æ•¸æ“š
async function resetAllPlayers() {
  showConfirmDialog("âš ï¸ å±éšªæ“ä½œï¼šç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç©å®¶çš„ä¸–ç•Œç‹æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼", async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/reset_all_players`, {});
      const result = await response.json();
      
      if (response.ok) {
        addLog("æ‰€æœ‰ç©å®¶æ•¸æ“šå·²æ¸…é™¤", "warning");
        await loadPlayersData();
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`æ¸…é™¤ç©å®¶æ•¸æ“šå¤±æ•—: ${error.message}`, "error");
      alert("æ¸…é™¤ç©å®¶æ•¸æ“šå¤±æ•—: " + error.message);
    }
  });
}

// å®Œå…¨é‡ç½®
async function fullReset() {
  showConfirmDialog("âš ï¸ æ¥µåº¦å±éšªï¼šç¢ºå®šè¦å®Œå…¨é‡ç½®ä¸–ç•Œç‹ç³»çµ±å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰æ•¸æ“šä¸”ä¸å¯é€†ï¼", async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/full_reset_world_boss`, {});
      const result = await response.json();
      
      if (response.ok) {
        addLog("ä¸–ç•Œç‹ç³»çµ±å·²å®Œå…¨é‡ç½®", "warning");
        await loadWorldBossData();
        await loadPlayersData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`å®Œå…¨é‡ç½®å¤±æ•—: ${error.message}`, "error");
      alert("å®Œå…¨é‡ç½®å¤±æ•—: " + error.message);
    }
  });
}

// å¼·åˆ¶éšæ®µåˆ‡æ›
async function forcePhase(phase) {
  showConfirmDialog(`ç¢ºå®šè¦å¼·åˆ¶åˆ‡æ›åˆ°ç¬¬ ${phase} éšæ®µå—ï¼Ÿ`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/force_world_boss_phase`, { phase });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`å¼·åˆ¶åˆ‡æ›åˆ°ç¬¬ ${phase} éšæ®µ`, "success");
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`éšæ®µåˆ‡æ›å¤±æ•—: ${error.message}`, "error");
      alert("éšæ®µåˆ‡æ›å¤±æ•—: " + error.message);
    }
  });
}

// æ‰¹é‡æ“ä½œ
function executeBulkAction() {
  const action = document.getElementById("bulkActionSelect").value;
  const selected = Array.from(document.querySelectorAll(".player-checkbox:checked")).map(cb => cb.value);
  
  if (!action) {
    alert("è«‹é¸æ“‡æ‰¹é‡æ“ä½œ");
    return;
  }
  
  if (selected.length === 0) {
    alert("è«‹é¸æ“‡è¦æ“ä½œçš„ç©å®¶");
    return;
  }
  
  const actionNames = {
    'reset_damage': 'é‡ç½®å‚·å®³',
    'remove_cooldown': 'ç§»é™¤å†·å»',
    'delete_player': 'åˆªé™¤ç©å®¶'
  };
  
  showConfirmDialog(`ç¢ºå®šè¦å° ${selected.length} ä½ç©å®¶åŸ·è¡Œã€Œ${actionNames[action]}ã€æ“ä½œå—ï¼Ÿ`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/bulk_action`, {
        action,
        players: selected
      });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`æ‰¹é‡æ“ä½œã€Œ${actionNames[action]}ã€åŸ·è¡ŒæˆåŠŸï¼Œå½±éŸ¿ ${selected.length} ä½ç©å®¶`, "success");
        await loadPlayersData();
        document.getElementById("selectAll").checked = false;
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`æ‰¹é‡æ“ä½œå¤±æ•—: ${error.message}`, "error");
      alert("æ‰¹é‡æ“ä½œå¤±æ•—: " + error.message);
    }
  });
}

// ç·¨è¼¯ç©å®¶
async function editPlayer(userId) {
  const player = playersData.find(p => p.user_id === userId);
  if (!player) return;
  
  const newDamage = prompt(`ç·¨è¼¯ ${player.nickname} çš„ç´¯ç©å‚·å®³:`, player.total_damage);
  if (newDamage === null) return;
  
  const damage = parseInt(newDamage);
  if (isNaN(damage) || damage < 0) {
    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å‚·å®³å€¼");
    return;
  }
  
  try {
    const response = await SecureAPI.post(`${API_BASE}/admin/edit_player`, {
      user_id: userId,
      total_damage: damage
    });
    const result = await response.json();
    
    if (response.ok) {
      addLog(`å·²ç·¨è¼¯ç©å®¶ ${player.nickname} çš„å‚·å®³ç‚º ${damage.toLocaleString()}`, "success");
      await loadPlayersData();
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    addLog(`ç·¨è¼¯ç©å®¶å¤±æ•—: ${error.message}`, "error");
    alert("ç·¨è¼¯ç©å®¶å¤±æ•—: " + error.message);
  }
}

// ç§»é™¤ç©å®¶
async function removePlayer(userId) {
  const player = playersData.find(p => p.user_id === userId);
  if (!player) return;
  
  showConfirmDialog(`ç¢ºå®šè¦åˆªé™¤ç©å®¶ ${player.nickname} çš„æ‰€æœ‰ä¸–ç•Œç‹æ•¸æ“šå—ï¼Ÿ`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/remove_player`, { user_id: userId });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`å·²åˆªé™¤ç©å®¶ ${player.nickname}`, "warning");
        await loadPlayersData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`åˆªé™¤ç©å®¶å¤±æ•—: ${error.message}`, "error");
      alert("åˆªé™¤ç©å®¶å¤±æ•—: " + error.message);
    }
  });
}

// ç¢ºèªå°è©±æ¡†
function showConfirmDialog(message, action) {
  document.getElementById("confirmMessage").textContent = message;
  document.getElementById("confirmDialog").style.display = "flex";
  pendingAction = action;
}

function closeConfirmDialog() {
  document.getElementById("confirmDialog").style.display = "none";
  pendingAction = null;
}

function executeConfirmedAction() {
  if (pendingAction) {
    pendingAction();
  }
  closeConfirmDialog();
}

// æ¸…é™¤æ—¥èªŒ
function clearLog() {
  document.getElementById("systemLog").innerHTML = '<div class="log-entry">æ—¥èªŒå·²æ¸…é™¤</div>';
}

// è¿”å›ä¸»é 
function goBack() {
  window.parent.loadPage('main_page.html');
}

// å…¨åŸŸå‡½æ•¸
window.setWorldBossHp = setWorldBossHp;
window.adjustHp = adjustHp;
window.resetWorldBossHp = resetWorldBossHp;
window.resetAllPlayers = resetAllPlayers;
window.fullReset = fullReset;
window.forcePhase = forcePhase;
window.searchPlayers = searchPlayers;
window.refreshPlayerList = refreshPlayerList;
window.toggleSelectAll = toggleSelectAll;
window.executeBulkAction = executeBulkAction;
window.editPlayer = editPlayer;
window.removePlayer = removePlayer;
window.closeConfirmDialog = closeConfirmDialog;
window.executeConfirmedAction = executeConfirmedAction;
window.clearLog = clearLog;
window.goBack = goBack;

// åˆå§‹åŒ–
async function initAdmin() {
  updateLoadingProgress();
  
  // è¼‰å…¥æ•¸æ“š
  await Promise.all([
    loadWorldBossData(),
    loadPlayersData()
  ]);
  
  // æ¯30ç§’è‡ªå‹•æ›´æ–°
  setInterval(() => {
    loadWorldBossData();
  }, 30000);
  
  addLog("ç®¡ç†å“¡å¹³å°åˆå§‹åŒ–å®Œæˆ", "success");
}

// ç›£è½ç™»å…¥ç‹€æ…‹
onAuthStateChanged(auth, async (user) => {
  if (user) {
    if (checkAdminPermission(user.email)) {
      document.getElementById("adminEmail").textContent = user.email;
      await initAdmin();
    } else {
      alert("ä½ æ²’æœ‰ç®¡ç†å“¡æ¬Šé™ï¼");
      window.parent.loadPage('main_page.html');
    }
  } else {
    window.parent.location.href = "/SFL/login.html";
  }
});
</script>
</body>
</html>
