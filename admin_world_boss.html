<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>世界王管理員平台</title>
<link rel="icon" href="favicon.ico" />
<link href="css/style.css" rel="stylesheet"/>
<link href="css/admin_world_boss.css" rel="stylesheet"/>
</head>
<body class="admin-mode">

<!-- 管理員標題欄 -->
<div class="admin-header">
  <div class="admin-title">🔧 世界王管理員平台 🔧</div>
  <div class="admin-user">管理員: <span id="adminEmail">載入中...</span></div>
  <button class="admin-back-btn" onclick="goBack()">🔙 返回主頁</button>
</div>

<!-- 載入遮罩 -->
<div id="loadingOverlay">
  <div class="battle-loading-container">
    <div class="battle-icon">⚙️</div>
    <div class="normal-title">載入管理員面板</div>
    <div class="loading-text">正在驗證管理員權限...</div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-text" id="progressText">0%</div>
  </div>
</div>

<!-- 主要管理區域 -->
<div class="admin-container">
  
  <!-- 世界王狀態監控 -->
  <div class="admin-section">
    <h2 class="section-title">📊 世界王狀態監控</h2>
    
    <div class="status-grid">
      <div class="status-card">
        <div class="status-label">當前血量</div>
        <div class="status-value" id="currentHp">載入中...</div>
        <div class="status-subtitle">/ <span id="maxHp">999,999,999</span></div>
      </div>
      
      <div class="status-card">
        <div class="status-label">當前階段</div>
        <div class="status-value" id="currentPhase">1</div>
        <div class="status-subtitle">共 3 階段</div>
      </div>
      
      <div class="status-card">
        <div class="status-label">參與者數量</div>
        <div class="status-value" id="totalParticipants">0</div>
        <div class="status-subtitle">總挑戰者</div>
      </div>
      
      <div class="status-card">
        <div class="status-label">總傷害</div>
        <div class="status-value" id="totalDamage">0</div>
        <div class="status-subtitle">累積傷害</div>
      </div>
    </div>
    
    <!-- 世界王血量條 -->
    <div class="admin-hp-container">
      <div class="admin-hp-bar">
        <div class="admin-hp-fill" id="adminHpFill" style="width: 100%;"></div>
        <div class="admin-hp-text" id="adminHpText">100%</div>
      </div>
    </div>
  </div>

  <!-- 世界王控制面板 -->
  <div class="admin-section">
    <h2 class="section-title">⚙️ 世界王控制面板</h2>
    
    <div class="control-grid">
      <!-- 血量調整 -->
      <div class="control-card">
        <h3>💚 血量調整</h3>
        <div class="control-group">
          <label>設定血量:</label>
          <input type="number" id="setHpInput" placeholder="輸入血量值" min="0" max="999999999">
          <button class="admin-btn primary" onclick="setWorldBossHp()">設定血量</button>
        </div>
        <div class="control-group">
          <label>血量調整:</label>
          <div class="hp-buttons">
            <button class="admin-btn" onclick="adjustHp(-1000000)">-100萬</button>
            <button class="admin-btn" onclick="adjustHp(-100000)">-10萬</button>
            <button class="admin-btn" onclick="adjustHp(-10000)">-1萬</button>
            <button class="admin-btn success" onclick="adjustHp(10000)">+1萬</button>
            <button class="admin-btn success" onclick="adjustHp(100000)">+10萬</button>
            <button class="admin-btn success" onclick="adjustHp(1000000)">+100萬</button>
          </div>
        </div>
      </div>

      <!-- 重置功能 -->
      <div class="control-card">
        <h3>🔄 重置功能</h3>
        <div class="control-group">
          <button class="admin-btn warning" onclick="resetWorldBossHp()">重置血量</button>
          <button class="admin-btn danger" onclick="resetAllPlayers()">清除玩家數據</button>
          <button class="admin-btn danger" onclick="fullReset()">完全重置</button>
        </div>
        <div class="reset-warning">
          ⚠️ 重置操作不可逆，請謹慎使用
        </div>
      </div>

      <!-- 階段控制 -->
      <div class="control-card">
        <h3>⚡ 階段控制</h3>
        <div class="phase-buttons">
          <button class="admin-btn" onclick="forcePhase(1)">強制第一階段</button>
          <button class="admin-btn" onclick="forcePhase(2)">強制第二階段</button>
          <button class="admin-btn" onclick="forcePhase(3)">強制第三階段</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 玩家管理 -->
  <div class="admin-section">
    <h2 class="section-title">👥 玩家管理</h2>
    
    <div class="player-controls">
      <div class="search-bar">
        <input type="text" id="playerSearchInput" placeholder="搜尋玩家暱稱或ID" onkeyup="searchPlayers(event)">
        <button class="admin-btn" onclick="searchPlayers()">🔍 搜尋</button>
        <button class="admin-btn" onclick="refreshPlayerList()">🔄 重新整理</button>
      </div>
      
      <div class="bulk-actions">
        <select id="bulkActionSelect">
          <option value="">批量操作</option>
          <option value="reset_damage">重置傷害</option>
          <option value="remove_cooldown">移除冷卻</option>
          <option value="delete_player">刪除玩家</option>
        </select>
        <button class="admin-btn warning" onclick="executeBulkAction()">執行批量操作</button>
      </div>
    </div>

    <div class="player-list" id="playerList">
      載入玩家資料中...
    </div>
  </div>

  <!-- 系統日誌 -->
  <div class="admin-section">
    <h2 class="section-title">📋 系統日誌</h2>
    <div class="log-container" id="systemLog">
      <div class="log-entry">系統啟動完成</div>
    </div>
    <button class="admin-btn" onclick="clearLog()">清除日誌</button>
  </div>

  <!-- 統計數據 -->
  <div class="admin-section">
    <h2 class="section-title">📈 統計數據</h2>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">今日挑戰次數</div>
        <div class="stat-value" id="todayChallenges">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">總挑戰次數</div>
        <div class="stat-value" id="totalChallenges">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">平均傷害</div>
        <div class="stat-value" id="avgDamage">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">最高單次傷害</div>
        <div class="stat-value" id="maxSingleDamage">0</div>
      </div>
    </div>
  </div>
</div>

<!-- 確認對話框 -->
<div class="confirm-dialog" id="confirmDialog" style="display: none;">
  <div class="confirm-content">
    <div class="confirm-title">確認操作</div>
    <div class="confirm-message" id="confirmMessage">你確定要執行此操作嗎？</div>
    <div class="confirm-buttons">
      <button class="admin-btn" onclick="closeConfirmDialog()">取消</button>
      <button class="admin-btn danger" id="confirmButton" onclick="executeConfirmedAction()">確認</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, SecureAPI } from "./js/firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const API_BASE = "https://sfl-9cb8.onrender.com";
const ADMIN_EMAIL = "xdzltero@gmail.com";

let worldBossData = null;
let playersData = [];
let selectedPlayers = [];
let pendingAction = null;

// 權限檢查
function checkAdminPermission(userEmail) {
  return userEmail === ADMIN_EMAIL;
}

// 載入進度
function updateLoadingProgress() {
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += Math.random() * 15 + 5;
    if (progress > 100) progress = 100;
    
    progressBar.style.width = progress + "%";
    progressText.textContent = Math.round(progress) + "%";
    
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        document.getElementById("loadingOverlay").style.display = "none";
      }, 500);
    }
  }, 100);
}

// 日誌功能
function addLog(message, type = 'info') {
  const logContainer = document.getElementById("systemLog");
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = document.createElement("div");
  logEntry.className = `log-entry ${type}`;
  logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;
  logContainer.insertBefore(logEntry, logContainer.firstChild);
  
  // 限制日誌數量
  const entries = logContainer.querySelectorAll('.log-entry');
  if (entries.length > 50) {
    entries[entries.length - 1].remove();
  }
}

// 載入世界王數據
async function loadWorldBossData() {
  try {
    const response = await SecureAPI.get(`${API_BASE}/admin/world_boss_status`);
    if (response.ok) {
      worldBossData = await response.json();
      updateWorldBossDisplay();
      addLog("世界王數據載入成功", "success");
    } else {
      throw new Error("載入世界王數據失敗");
    }
  } catch (error) {
    addLog(`載入世界王數據失敗: ${error.message}`, "error");
    console.error(error);
  }
}

// 更新世界王顯示
function updateWorldBossDisplay() {
  if (!worldBossData) return;
  
  document.getElementById("currentHp").textContent = worldBossData.current_hp.toLocaleString();
  document.getElementById("maxHp").textContent = worldBossData.max_hp.toLocaleString();
  document.getElementById("currentPhase").textContent = worldBossData.current_phase;
  document.getElementById("totalParticipants").textContent = worldBossData.total_participants.toLocaleString();
  document.getElementById("totalDamage").textContent = worldBossData.total_damage_dealt.toLocaleString();
  
  // 更新血量條
  const percentage = Math.max(0, (worldBossData.current_hp / worldBossData.max_hp) * 100);
  document.getElementById("adminHpFill").style.width = percentage + "%";
  document.getElementById("adminHpText").textContent = percentage.toFixed(1) + "%";
}

// 載入玩家數據
async function loadPlayersData() {
  try {
    const response = await SecureAPI.get(`${API_BASE}/admin/world_boss_players`);
    if (response.ok) {
      playersData = await response.json();
      updatePlayerList();
      updateStatistics();
      addLog(`載入了 ${playersData.length} 位玩家數據`, "success");
    } else {
      throw new Error("載入玩家數據失敗");
    }
  } catch (error) {
    addLog(`載入玩家數據失敗: ${error.message}`, "error");
    console.error(error);
  }
}

// 更新玩家列表
function updatePlayerList(filteredData = null) {
  const listContainer = document.getElementById("playerList");
  const data = filteredData || playersData;
  
  if (!data || data.length === 0) {
    listContainer.innerHTML = '<div class="no-data">暫無玩家數據</div>';
    return;
  }
  
  let html = `
    <div class="player-header">
      <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
      <span>排名</span>
      <span>玩家</span>
      <span>累積傷害</span>
      <span>挑戰次數</span>
      <span>最後挑戰</span>
      <span>操作</span>
    </div>
  `;
  
  data.forEach((player, index) => {
    const lastChallenge = player.last_challenge_time ? 
      new Date(player.last_challenge_time * 1000).toLocaleString() : '從未挑戰';
    
    html += `
      <div class="player-row">
        <input type="checkbox" class="player-checkbox" value="${player.user_id}">
        <span class="rank">#${index + 1}</span>
        <span class="nickname">${player.nickname}</span>
        <span class="damage">${player.total_damage.toLocaleString()}</span>
        <span class="challenges">${player.challenge_count}</span>
        <span class="last-challenge">${lastChallenge}</span>
        <span class="actions">
          <button class="mini-btn" onclick="editPlayer('${player.user_id}')">編輯</button>
          <button class="mini-btn danger" onclick="removePlayer('${player.user_id}')">刪除</button>
        </span>
      </div>
    `;
  });
  
  listContainer.innerHTML = html;
}

// 更新統計數據
function updateStatistics() {
  if (!playersData || playersData.length === 0) return;
  
  const totalChallenges = playersData.reduce((sum, p) => sum + (p.challenge_count || 0), 0);
  const totalDamage = playersData.reduce((sum, p) => sum + (p.total_damage || 0), 0);
  const avgDamage = totalChallenges > 0 ? Math.round(totalDamage / totalChallenges) : 0;
  const maxDamage = Math.max(...playersData.map(p => p.total_damage || 0));
  
  // 計算今日挑戰次數
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayTimestamp = today.getTime() / 1000;
  const todayChallenges = playersData.filter(p => 
    p.last_challenge_time && p.last_challenge_time >= todayTimestamp
  ).length;
  
  document.getElementById("todayChallenges").textContent = todayChallenges.toLocaleString();
  document.getElementById("totalChallenges").textContent = totalChallenges.toLocaleString();
  document.getElementById("avgDamage").textContent = avgDamage.toLocaleString();
  document.getElementById("maxSingleDamage").textContent = maxDamage.toLocaleString();
}

// 搜尋玩家
function searchPlayers(event) {
  if (event && event.key !== 'Enter') return;
  
  const searchTerm = document.getElementById("playerSearchInput").value.toLowerCase();
  if (!searchTerm) {
    updatePlayerList();
    return;
  }
  
  const filtered = playersData.filter(player =>
    player.nickname.toLowerCase().includes(searchTerm) ||
    player.user_id.toLowerCase().includes(searchTerm)
  );
  
  updatePlayerList(filtered);
  addLog(`搜尋到 ${filtered.length} 位玩家`);
}

// 刷新玩家列表
function refreshPlayerList() {
  loadPlayersData();
  addLog("重新載入玩家列表");
}

// 全選功能
function toggleSelectAll() {
  const selectAll = document.getElementById("selectAll");
  const checkboxes = document.querySelectorAll(".player-checkbox");
  
  checkboxes.forEach(cb => {
    cb.checked = selectAll.checked;
  });
}

// 設定世界王血量
async function setWorldBossHp() {
  const newHp = parseInt(document.getElementById("setHpInput").value);
  if (isNaN(newHp) || newHp < 0) {
    alert("請輸入有效的血量值");
    return;
  }
  
  showConfirmDialog(`確定要將世界王血量設定為 ${newHp.toLocaleString()} 嗎？`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/set_world_boss_hp`, { hp: newHp });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`世界王血量已設定為 ${newHp.toLocaleString()}`, "success");
        await loadWorldBossData();
        document.getElementById("setHpInput").value = "";
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`設定血量失敗: ${error.message}`, "error");
      alert("設定血量失敗: " + error.message);
    }
  });
}

// 調整血量
async function adjustHp(amount) {
  const action = amount > 0 ? "增加" : "減少";
  const absAmount = Math.abs(amount);
  
  showConfirmDialog(`確定要${action} ${absAmount.toLocaleString()} 血量嗎？`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/adjust_world_boss_hp`, { amount });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`${action}了 ${absAmount.toLocaleString()} 血量`, "success");
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`調整血量失敗: ${error.message}`, "error");
      alert("調整血量失敗: " + error.message);
    }
  });
}

// 重置世界王血量
async function resetWorldBossHp() {
  showConfirmDialog("確定要重置世界王血量到滿血狀態嗎？", async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/reset_world_boss_hp`, {});
      const result = await response.json();
      
      if (response.ok) {
        addLog("世界王血量已重置", "success");
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`重置血量失敗: ${error.message}`, "error");
      alert("重置血量失敗: " + error.message);
    }
  });
}

// 清除所有玩家數據
async function resetAllPlayers() {
  showConfirmDialog("⚠️ 危險操作：確定要清除所有玩家的世界王數據嗎？此操作不可逆！", async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/reset_all_players`, {});
      const result = await response.json();
      
      if (response.ok) {
        addLog("所有玩家數據已清除", "warning");
        await loadPlayersData();
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`清除玩家數據失敗: ${error.message}`, "error");
      alert("清除玩家數據失敗: " + error.message);
    }
  });
}

// 完全重置
async function fullReset() {
  showConfirmDialog("⚠️ 極度危險：確定要完全重置世界王系統嗎？這將清除所有數據且不可逆！", async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/full_reset_world_boss`, {});
      const result = await response.json();
      
      if (response.ok) {
        addLog("世界王系統已完全重置", "warning");
        await loadWorldBossData();
        await loadPlayersData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`完全重置失敗: ${error.message}`, "error");
      alert("完全重置失敗: " + error.message);
    }
  });
}

// 強制階段切換
async function forcePhase(phase) {
  showConfirmDialog(`確定要強制切換到第 ${phase} 階段嗎？`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/force_world_boss_phase`, { phase });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`強制切換到第 ${phase} 階段`, "success");
        await loadWorldBossData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`階段切換失敗: ${error.message}`, "error");
      alert("階段切換失敗: " + error.message);
    }
  });
}

// 批量操作
function executeBulkAction() {
  const action = document.getElementById("bulkActionSelect").value;
  const selected = Array.from(document.querySelectorAll(".player-checkbox:checked")).map(cb => cb.value);
  
  if (!action) {
    alert("請選擇批量操作");
    return;
  }
  
  if (selected.length === 0) {
    alert("請選擇要操作的玩家");
    return;
  }
  
  const actionNames = {
    'reset_damage': '重置傷害',
    'remove_cooldown': '移除冷卻',
    'delete_player': '刪除玩家'
  };
  
  showConfirmDialog(`確定要對 ${selected.length} 位玩家執行「${actionNames[action]}」操作嗎？`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/bulk_action`, {
        action,
        players: selected
      });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`批量操作「${actionNames[action]}」執行成功，影響 ${selected.length} 位玩家`, "success");
        await loadPlayersData();
        document.getElementById("selectAll").checked = false;
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`批量操作失敗: ${error.message}`, "error");
      alert("批量操作失敗: " + error.message);
    }
  });
}

// 編輯玩家
async function editPlayer(userId) {
  const player = playersData.find(p => p.user_id === userId);
  if (!player) return;
  
  const newDamage = prompt(`編輯 ${player.nickname} 的累積傷害:`, player.total_damage);
  if (newDamage === null) return;
  
  const damage = parseInt(newDamage);
  if (isNaN(damage) || damage < 0) {
    alert("請輸入有效的傷害值");
    return;
  }
  
  try {
    const response = await SecureAPI.post(`${API_BASE}/admin/edit_player`, {
      user_id: userId,
      total_damage: damage
    });
    const result = await response.json();
    
    if (response.ok) {
      addLog(`已編輯玩家 ${player.nickname} 的傷害為 ${damage.toLocaleString()}`, "success");
      await loadPlayersData();
    } else {
      throw new Error(result.error);
    }
  } catch (error) {
    addLog(`編輯玩家失敗: ${error.message}`, "error");
    alert("編輯玩家失敗: " + error.message);
  }
}

// 移除玩家
async function removePlayer(userId) {
  const player = playersData.find(p => p.user_id === userId);
  if (!player) return;
  
  showConfirmDialog(`確定要刪除玩家 ${player.nickname} 的所有世界王數據嗎？`, async () => {
    try {
      const response = await SecureAPI.post(`${API_BASE}/admin/remove_player`, { user_id: userId });
      const result = await response.json();
      
      if (response.ok) {
        addLog(`已刪除玩家 ${player.nickname}`, "warning");
        await loadPlayersData();
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      addLog(`刪除玩家失敗: ${error.message}`, "error");
      alert("刪除玩家失敗: " + error.message);
    }
  });
}

// 確認對話框
function showConfirmDialog(message, action) {
  document.getElementById("confirmMessage").textContent = message;
  document.getElementById("confirmDialog").style.display = "flex";
  pendingAction = action;
}

function closeConfirmDialog() {
  document.getElementById("confirmDialog").style.display = "none";
  pendingAction = null;
}

function executeConfirmedAction() {
  if (pendingAction) {
    pendingAction();
  }
  closeConfirmDialog();
}

// 清除日誌
function clearLog() {
  document.getElementById("systemLog").innerHTML = '<div class="log-entry">日誌已清除</div>';
}

// 返回主頁
function goBack() {
  window.parent.loadPage('main_page.html');
}

// 全域函數
window.setWorldBossHp = setWorldBossHp;
window.adjustHp = adjustHp;
window.resetWorldBossHp = resetWorldBossHp;
window.resetAllPlayers = resetAllPlayers;
window.fullReset = fullReset;
window.forcePhase = forcePhase;
window.searchPlayers = searchPlayers;
window.refreshPlayerList = refreshPlayerList;
window.toggleSelectAll = toggleSelectAll;
window.executeBulkAction = executeBulkAction;
window.editPlayer = editPlayer;
window.removePlayer = removePlayer;
window.closeConfirmDialog = closeConfirmDialog;
window.executeConfirmedAction = executeConfirmedAction;
window.clearLog = clearLog;
window.goBack = goBack;

// 初始化
async function initAdmin() {
  updateLoadingProgress();
  
  // 載入數據
  await Promise.all([
    loadWorldBossData(),
    loadPlayersData()
  ]);
  
  // 每30秒自動更新
  setInterval(() => {
    loadWorldBossData();
  }, 30000);
  
  addLog("管理員平台初始化完成", "success");
}

// 監聽登入狀態
onAuthStateChanged(auth, async (user) => {
  if (user) {
    if (checkAdminPermission(user.email)) {
      document.getElementById("adminEmail").textContent = user.email;
      await initAdmin();
    } else {
      alert("你沒有管理員權限！");
      window.parent.loadPage('main_page.html');
    }
  } else {
    window.parent.location.href = "/SFL/login.html";
  }
});
</script>
</body>
</html>
