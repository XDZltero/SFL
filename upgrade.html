<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‡ç´šèˆ‡æŠ€èƒ½é é¢</title>
  <link rel="icon" href="favicon.ico" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="js/firebase-init.js"></script>

  <link href="css/style.css" rel="stylesheet"/>
  <link href="css/normalStyle.css" rel="stylesheet"/>
</head>
<body>
<div id="initialOverlay">è¼‰å…¥ä¸­...</div>
<div id="loading-placeholder"></div>
<script src="js/loading.js"></script>
<script>
  fetch("loadingOverlay.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("loading-placeholder").innerHTML = html;
      document.getElementById("initialOverlay")?.remove();
      if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      runMain();
    });
</script>

<h1 class="fancy-title">ğŸ¤© å‡ç´šèˆ‡æŠ€èƒ½ç®¡ç†</h1>
<hr>

<h2 class="fancy-subtitle"><span class="emoji">ğŸ“Š</span> åˆ†é…èƒ½åŠ›é»</h2>
<div class="card" style="display: flex; gap: 40px; align-items: flex-start;">
  <div>
    <strong>ç›®å‰èƒ½åŠ›å€¼ï¼š</strong>
    <ul id="currentStats"></ul>
  </div>
  <div>
    <div><strong>å‰©é¤˜èƒ½åŠ›é»æ•¸ï¼š<span id="remainingPoints" class="remaining-points">0</span></strong></div>
    <div id="base_stats"></div>
    <div class="btn-group">
      <button class="square-btn" onclick="resetStats()">é‡ç½®</button>
      <button class="square-btn" onclick="submitLevelUp()">âœ… ç¢ºèªå‡ç´š</button>
    </div>
  </div>
</div>

<hr>
<h2 class="fancy-subtitle"><span class="emoji">ğŸ”€</span> æŠ€èƒ½é»åˆ†é…</h2>
<div class="card">
  <div><strong>å‰©é¤˜æŠ€èƒ½é»æ•¸ï¼š<span id="remainingSkillPoints" class="remaining-points">0</span></strong></div>
  <div class="btn-row">
    <button class="square-btn" onclick="resetSkills()">é‡ç½®æŠ€èƒ½</button>
    <button class="square-btn" onclick="submitSkills()">âœ… å„²å­˜æŠ€èƒ½</button>
  </div>
  <div id="skillList"></div>
</div>

<script type="module">
  const API_BASE = "https://sfl-9cb8.onrender.com";
  const baseStatsEl = document.getElementById("base_stats");
  const remainingPointsEl = document.getElementById("remainingPoints");
  let userId = null;
  let userStats = {};
  let alloc = { hp: 0, attack: 0, luck: 0, atk_speed: 0 };
  const statFields = [
    { key: "hp", label: "ç”Ÿå‘½å€¼ï¼ˆ+5ï¼‰" },
    { key: "attack", label: "æ”»æ“ŠåŠ›" },
    { key: "luck", label: "é‹æ°£å€¼" },
    { key: "atk_speed", label: "æ”»æ“Šé€Ÿåº¦" }
  ];

  function logout() {
    firebase.auth().signOut().then(() => {
      window.parent.location.href = "/SFL/login.html";
    });
  }
  function showLoading(show) {
    const loading = document.getElementById("loadingOverlay");
    if (loading) loading.style.display = show ? "flex" : "none";
  }
  function renderStats() {
    if (!userStats.base_stats) return;
    const stats = userStats.base_stats;
    document.getElementById("currentStats").innerHTML = `
      <li>ç”Ÿå‘½å€¼ï¼š${stats.hp}</li>
      <li>æ”»æ“ŠåŠ›ï¼š${stats.attack}</li>
      <li>é‹æ°£å€¼ï¼š${stats.luck}</li>
      <li>æ”»æ“Šé€Ÿåº¦ï¼š${stats.atk_speed}</li>
    `;
    let html = "";
    statFields.forEach(({ key, label }) => {
      html += `
        <div class="stat-control">
          <label>${label}ï¼š</label>
          <button onclick="adjust('${key}', -1)">-</button>
          <span id="val_${key}">${alloc[key]}</span>
          <button onclick="adjust('${key}', 1)">+</button>
        </div>`;
    });
    baseStatsEl.innerHTML = html;
    remainingPointsEl.innerText = userStats.stat_points;
  }
  function adjust(stat, delta) {
    const current = alloc[stat];
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    const remaining = userStats.stat_points - totalAlloc;
    if (delta > 0 && remaining > 0) alloc[stat]++;
    else if (delta < 0 && current > 0) alloc[stat]--;
    document.getElementById(`val_${stat}`).innerText = alloc[stat];
    remainingPointsEl.innerText = userStats.stat_points - Object.values(alloc).reduce((a, b) => a + b, 0);
  }
  function resetStats() {
    Object.keys(alloc).forEach(k => {
      alloc[k] = 0;
      document.getElementById(`val_${k}`).innerText = "0";
    });
    remainingPointsEl.innerText = userStats.stat_points;
  }
  async function submitLevelUp() {
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    if (totalAlloc === 0) return alert("è«‹å…ˆåˆ†é…èƒ½åŠ›é»ï¼");
    if (!confirm("æ˜¯å¦ç¢ºå®šåˆ†é…èƒ½åŠ›é»ï¼Ÿ")) return;
    showLoading(true);
    try {
      const res = await fetch(`${API_BASE}/levelup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user: userId, allocate: alloc })
      });
      const data = await res.json();
      if (res.ok) {
        alert("èƒ½åŠ›å€¼å·²åˆ†é…å®Œç•¢ï¼");
        await loadStatus();
        resetStats();
      } else {
        alert(data.error || "å‡ç´šå¤±æ•—");
      }
    } catch (err) {
      alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
    } finally {
      showLoading(false);
    }
  }
  async function loadStatus() {
    if (!userId) return;
    showLoading(true);
    try {
      const res = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
      const data = await res.json();
      userStats = data;
      renderStats();
    } catch (err) {
      console.error("âŒ è¼‰å…¥éŒ¯èª¤ï¼š" + err.message);
    } finally {
      showLoading(false);
    }
  }
  async function waitForUser() {
    return new Promise(resolve => {
      const unsub = firebase.auth().onAuthStateChanged(user => {
        unsub();
        resolve(user);
      });
    });
  }
  async function runMain() {
    showLoading(true);
    const user = await waitForUser();
    if (!user) {
      window.parent.location.href = "/SFL/login.html";
      return;
    }
    userId = user.email;
    try {
      const res = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
      const data = await res.json();
      window.parent.postMessage({ nickname: data.nickname || userId }, "*");
      await loadStatus();
      await loadAllSkills();
    } catch (err) {
      console.error("âŒ ç™¼ç”ŸéŒ¯èª¤", err);
    } finally {
      showLoading(false);
    }
  }
  window.logout = logout;
  window.adjust = adjust;
  window.resetStats = resetStats;
  window.submitLevelUp = submitLevelUp;
  window.resetSkills = resetSkills;
  window.submitSkills = submitSkills;
  window.runMain = runMain;
  let skillAlloc = {};
  let remainingSkillPoints = 0;
  let originalSkills = {};
  let skillPoints = 0;
  let allSkills = [];
</script>
</body>
</html>
