<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‡ç´šèˆ‡æŠ€èƒ½é é¢</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet"/>
  <link href="css/normalStyle.css" rel="stylesheet"/>
</head>
<body>
<div id="initialOverlay">è¼‰å…¥ä¸­...</div>
<div id="loading-placeholder"></div>
<script src="js/loading.js"></script>
<script>
  fetch("loadingOverlay.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("loading-placeholder").innerHTML = html;
      document.getElementById("initialOverlay")?.remove();
      if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
    });
</script>

<h1 class="fancy-title">ğŸ”© å‡ç´šèˆ‡æŠ€èƒ½ç®¡ç†</h1>
<hr>

<h2 class="fancy-subtitle"><span class="emoji">ğŸ“Š</span> åˆ†é…èƒ½åŠ›é»</h2>
<div class="card" style="display: flex; gap: 40px; align-items: flex-start;">
  <div>
    <strong>ç›®å‰èƒ½åŠ›å€¼ï¼š</strong>
    <ul id="currentStats"></ul>
  </div>
  <div>
    <div><strong>å‰©é¤˜èƒ½åŠ›é»æ•¸ï¼š<span id="remainingPoints" class="remaining-points">0</span></strong></div>
    <div id="base_stats"></div>
    <div class="btn-group">
      <button id="btnResetStats" class="square-btn">é‡ç½®</button>
      <button id="btnSubmitLevel" class="square-btn">âœ… ç¢ºèªå‡ç´š</button>
    </div>
  </div>
</div>

<hr>

<h2 class="fancy-subtitle"><span class="emoji">ğŸ”€</span> æŠ€èƒ½é»åˆ†é…</h2>
<div class="card">
  <div><strong>å‰©é¤˜æŠ€èƒ½é»æ•¸ï¼š<span id="remainingSkillPoints" class="remaining-points">0</span></strong></div>
  <div class="btn-row">
    <button id="btnResetSkills" class="square-btn">é‡ç½®æŠ€èƒ½</button>
    <button id="btnSubmitSkills" class="square-btn">âœ… å„²å­˜æŠ€èƒ½</button>
  </div>
  <div id="skillList"></div>
</div>

<script type="module">
  const API_BASE = "https://sfl-9cb8.onrender.com";
  let authToken = null;
  let userStats = {};
  let alloc = { hp: 0, attack: 0, luck: 0, atk_speed: 0 };
  let skillAlloc = {};
  let allSkills = [];
  let remainingSkillPoints = 0;

  const statFields = [
    { key: "hp", label: "ç”Ÿå‘½å€¼ï¼ˆ+5ï¼‰" },
    { key: "attack", label: "æ”»æ“ŠåŠ›" },
    { key: "luck", label: "é‹æ°£å€¼" },
    { key: "atk_speed", label: "æ”»æ“Šé€Ÿåº¦" }
  ];

  async function callApi(path, method = "GET", body = null) {
    const headers = {
      "Authorization": `Bearer ${authToken}`,
      "Content-Type": "application/json"
    };
    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);
    const res = await fetch(`${API_BASE}${path}`, options);
    return res.json();
  }

  function renderStats() {
    const stats = userStats.base_stats;
    document.getElementById("currentStats").innerHTML = `
      <li>ç”Ÿå‘½å€¼ï¼š${stats.hp}</li>
      <li>æ”»æ“ŠåŠ›ï¼š${stats.attack}</li>
      <li>é‹æ°£å€¼ï¼š${stats.luck}</li>
      <li>æ”»æ“Šé€Ÿåº¦ï¼š${stats.atk_speed}</li>
    `;

    let html = "";
    statFields.forEach(({ key, label }) => {
      html += `
        <div class="stat-control" data-stat="${key}">
          <label>${label}ï¼š</label>
          <button class="minus">-</button>
          <span id="val_${key}">${alloc[key]}</span>
          <button class="plus">+</button>
        </div>
      `;
    });
    base_stats.innerHTML = html;
    remainingPoints.innerText = userStats.stat_points;

    statFields.forEach(({ key }) => {
      const container = base_stats.querySelector(`.stat-control[data-stat="${key}"]`);
      container.querySelector(".minus").onclick = () => adjust(key, -1);
      container.querySelector(".plus").onclick = () => adjust(key, 1);
    });
  }

  function adjust(stat, delta) {
    const current = alloc[stat];
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    const remaining = userStats.stat_points - totalAlloc;
    if (delta > 0 && remaining > 0) alloc[stat]++;
    else if (delta < 0 && current > 0) alloc[stat]--;
    document.getElementById(`val_${stat}`).innerText = alloc[stat];
    remainingPoints.innerText = userStats.stat_points - Object.values(alloc).reduce((a, b) => a + b, 0);
  }

  function resetStats() {
    Object.keys(alloc).forEach(k => {
      alloc[k] = 0;
      document.getElementById(`val_${k}`).innerText = "0";
    });
    remainingPoints.innerText = userStats.stat_points;
  }

  async function submitLevelUp() {
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    if (totalAlloc === 0) return alert("è«‹å…ˆåˆ†é…èƒ½åŠ›é»ï¼");
    if (!confirm("æ˜¯å¦ç¢ºå®šåˆ†é…èƒ½åŠ›é»ï¼Ÿ")) return;
    showLoading(true);
    try {
      const res = await callApi("/levelup", "POST", { allocate: alloc });
      if (res.message) {
        alert("èƒ½åŠ›å€¼å·²åˆ†é…å®Œç•¢ï¼");
        await runMain();
        resetStats();
      } else {
        alert(res.error || "å‡ç´šå¤±æ•—");
      }
    } catch (err) {
      alert(`éŒ¯èª¤ï¼š${err.message}`);
    } finally {
      showLoading(false);
    }
  }

  function renderSkills() {
    skillList.innerHTML = "";
    skillList.className = "skill-row";
    const typeMap = { atk: "ã€è¼¸å‡ºå‹ã€‘", heal: "ã€æ²»ç™‚å‹ã€‘", buff: "ã€å¢ç›Šå‹ã€‘" };
    const elemMap = { pyro: "ç«", hydro: "æ°´", nature: "è‡ªç„¶", electro: "é›·", light: "å…‰", dark: "æš—", all: "å…¨", none: "ç„¡" };

    allSkills.sort((a, b) => (a.sort || 999) - (b.sort || 999)).forEach(skill => {
      const currentLevel = skillAlloc[skill.id] ?? 0;
      const isLocked = userStats.level < skill.learnlvl;
      const card = document.createElement("div");
      card.className = "skill-card";
      card.innerHTML = `
        <strong>${typeMap[skill.type] || "ã€å…¶ä»–ã€‘"} ${skill.name}</strong>
        <p>${skill.description}</p>
        <p>ç­‰ç´šä¸Šé™ï¼š${skill.maxlvl} ã€€å‡çµï¼š${skill.cd} å›åˆ</p>
        <p>å€ç‡ï¼š${(skill.multiplier + (currentLevel - 1) * (skill.multiplierperlvl || 0)).toFixed(2)} å±¬æ€§ï¼š${skill.element.map(e => elemMap[e] || e).join("/")}</p>
      `;

      const controls = document.createElement("div");
      controls.className = "skill-controls";

      const minus = document.createElement("button");
      minus.textContent = "-";
      minus.disabled = currentLevel === 0 || isLocked;
      minus.onclick = () => {
        if (skillAlloc[skill.id] > 0) {
          skillAlloc[skill.id]--;
          remainingSkillPoints++;
          renderSkills();
        }
      };

      const value = document.createElement("span");
      value.textContent = currentLevel;
      value.style.margin = "0 8px";
      value.style.color = "#ffd93d";
      value.style.fontWeight = "bold";

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.disabled = isLocked || currentLevel >= skill.maxlvl || remainingSkillPoints <= 0;
      plus.onclick = () => {
        if (skillAlloc[skill.id] < skill.maxlvl && remainingSkillPoints > 0) {
          skillAlloc[skill.id]++;
          remainingSkillPoints--;
          renderSkills();
        }
      };

      controls.appendChild(minus);
      controls.appendChild(value);
      controls.appendChild(plus);
      card.appendChild(controls);

      if (isLocked) {
        const tip = document.createElement("span");
        tip.style.color = "red";
        tip.style.marginLeft = "10px";
        tip.textContent = `ç­‰ç´šé”è‡³ ${skill.learnlvl} ç­‰è§£é–`;
        card.appendChild(tip);
      }

      skillList.appendChild(card);
    });
    remainingSkillPointsEl.innerText = remainingSkillPoints;
  }

  function resetSkills() {
    allSkills.forEach(skill => skillAlloc[skill.id] = 0);
    const spent = Object.values(userStats.skills || {}).reduce((s, v) => s + (v || 0), 0);
    remainingSkillPoints = userStats.skill_points + spent;
    renderSkills();
  }

  async function submitSkills() {
    showLoading(true);
    try {
      const res = await callApi("/skills_save", "POST", { skills: skillAlloc });
      if (res.message) {
        alert("æŠ€èƒ½å„²å­˜æˆåŠŸï¼");
        await runMain();
      } else {
        alert(res.error || "å„²å­˜å¤±æ•—");
      }
    } catch (err) {
      alert(`éŒ¯èª¤ï¼š${err.message}`);
    } finally {
      showLoading(false);
    }
  }

  document.getElementById("btnResetStats").onclick = resetStats;
  document.getElementById("btnSubmitLevel").onclick = submitLevelUp;
  document.getElementById("btnResetSkills").onclick = resetSkills;
  document.getElementById("btnSubmitSkills").onclick = submitSkills;

  async function runMain() {
    try {
      userStats = await callApi("/status");
      const skillRes = await fetch(`${API_BASE}/skills_full`);
      allSkills = await skillRes.json();
      skillAlloc = {};
      allSkills.forEach(skill => skillAlloc[skill.id] = userStats.skills?.[skill.id] ?? 0);
      resetSkills();
      renderStats();
      renderSkills();
    } catch (err) {
      console.error("runMain éŒ¯èª¤ï¼š", err);
      alert("è¼‰å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦");
    }
  }

  window.addEventListener("message", async (e) => {
    if (e.data?.token) {
      authToken = e.data.token;
      await runMain();
    }
  });
</script>
</body>
</html>
