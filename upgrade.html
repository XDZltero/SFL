<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>升級與技能頁面</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet"/>
  <link href="css/normalStyle.css" rel="stylesheet"/>
</head>
<body>
<div id="initialOverlay">載入中...</div>
<div id="loading-placeholder"></div>
<script src="js/loading.js"></script>
<script>
  fetch("loadingOverlay.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("loading-placeholder").innerHTML = html;
      document.getElementById("initialOverlay")?.remove();
      if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
    });
</script>

<h1 class="fancy-title">🔩 升級與技能管理</h1>
<hr>

<h2 class="fancy-subtitle"><span class="emoji">📊</span> 分配能力點</h2>
<div class="card" style="display: flex; gap: 40px; align-items: flex-start;">
  <div>
    <strong>目前能力值：</strong>
    <ul id="currentStats"></ul>
  </div>
  <div>
    <div><strong>剩餘能力點數：<span id="remainingPoints" class="remaining-points">0</span></strong></div>
    <div id="base_stats"></div>
    <div class="btn-group">
      <button id="btnResetStats" class="square-btn">重置</button>
      <button id="btnSubmitLevel" class="square-btn">✅ 確認升級</button>
    </div>
  </div>
</div>

<hr>

<h2 class="fancy-subtitle"><span class="emoji">🔀</span> 技能點分配</h2>
<div class="card">
  <div><strong>剩餘技能點數：<span id="remainingSkillPoints" class="remaining-points">0</span></strong></div>
  <div class="btn-row">
    <button id="btnResetSkills" class="square-btn">重置技能</button>
    <button id="btnSubmitSkills" class="square-btn">✅ 儲存技能</button>
  </div>
  <div id="skillList"></div>
</div>

<script type="module">
  const API_BASE = "https://sfl-9cb8.onrender.com";
  let authToken = null;
  let userStats = {};
  let alloc = { hp: 0, attack: 0, luck: 0, atk_speed: 0 };
  let skillAlloc = {};
  let allSkills = [];
  let remainingSkillPoints = 0;

  const statFields = [
    { key: "hp", label: "生命值（+5）" },
    { key: "attack", label: "攻擊力" },
    { key: "luck", label: "運氣值" },
    { key: "atk_speed", label: "攻擊速度" }
  ];

  async function callApi(path, method = "GET", body = null) {
    const headers = {
      "Authorization": `Bearer ${authToken}`,
      "Content-Type": "application/json"
    };
    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);
    const res = await fetch(`${API_BASE}${path}`, options);
    return res.json();
  }

  function renderStats() {
    const stats = userStats.base_stats;
    document.getElementById("currentStats").innerHTML = `
      <li>生命值：${stats.hp}</li>
      <li>攻擊力：${stats.attack}</li>
      <li>運氣值：${stats.luck}</li>
      <li>攻擊速度：${stats.atk_speed}</li>
    `;

    let html = "";
    statFields.forEach(({ key, label }) => {
      html += `
        <div class="stat-control" data-stat="${key}">
          <label>${label}：</label>
          <button class="minus">-</button>
          <span id="val_${key}">${alloc[key]}</span>
          <button class="plus">+</button>
        </div>
      `;
    });
    base_stats.innerHTML = html;
    remainingPoints.innerText = userStats.stat_points;

    statFields.forEach(({ key }) => {
      const container = base_stats.querySelector(`.stat-control[data-stat="${key}"]`);
      container.querySelector(".minus").onclick = () => adjust(key, -1);
      container.querySelector(".plus").onclick = () => adjust(key, 1);
    });
  }

  function adjust(stat, delta) {
    const current = alloc[stat];
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    const remaining = userStats.stat_points - totalAlloc;
    if (delta > 0 && remaining > 0) alloc[stat]++;
    else if (delta < 0 && current > 0) alloc[stat]--;
    document.getElementById(`val_${stat}`).innerText = alloc[stat];
    remainingPoints.innerText = userStats.stat_points - Object.values(alloc).reduce((a, b) => a + b, 0);
  }

  function resetStats() {
    Object.keys(alloc).forEach(k => {
      alloc[k] = 0;
      document.getElementById(`val_${k}`).innerText = "0";
    });
    remainingPoints.innerText = userStats.stat_points;
  }

  async function submitLevelUp() {
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    if (totalAlloc === 0) return alert("請先分配能力點！");
    if (!confirm("是否確定分配能力點？")) return;
    showLoading(true);
    try {
      const res = await callApi("/levelup", "POST", { allocate: alloc });
      if (res.message) {
        alert("能力值已分配完畢！");
        await runMain();
        resetStats();
      } else {
        alert(res.error || "升級失敗");
      }
    } catch (err) {
      alert(`錯誤：${err.message}`);
    } finally {
      showLoading(false);
    }
  }

  function renderSkills() {
    skillList.innerHTML = "";
    skillList.className = "skill-row";
    const typeMap = { atk: "【輸出型】", heal: "【治療型】", buff: "【增益型】" };
    const elemMap = { pyro: "火", hydro: "水", nature: "自然", electro: "雷", light: "光", dark: "暗", all: "全", none: "無" };

    allSkills.sort((a, b) => (a.sort || 999) - (b.sort || 999)).forEach(skill => {
      const currentLevel = skillAlloc[skill.id] ?? 0;
      const isLocked = userStats.level < skill.learnlvl;
      const card = document.createElement("div");
      card.className = "skill-card";
      card.innerHTML = `
        <strong>${typeMap[skill.type] || "【其他】"} ${skill.name}</strong>
        <p>${skill.description}</p>
        <p>等級上限：${skill.maxlvl} 　凍結：${skill.cd} 回合</p>
        <p>倍率：${(skill.multiplier + (currentLevel - 1) * (skill.multiplierperlvl || 0)).toFixed(2)} 屬性：${skill.element.map(e => elemMap[e] || e).join("/")}</p>
      `;

      const controls = document.createElement("div");
      controls.className = "skill-controls";

      const minus = document.createElement("button");
      minus.textContent = "-";
      minus.disabled = currentLevel === 0 || isLocked;
      minus.onclick = () => {
        if (skillAlloc[skill.id] > 0) {
          skillAlloc[skill.id]--;
          remainingSkillPoints++;
          renderSkills();
        }
      };

      const value = document.createElement("span");
      value.textContent = currentLevel;
      value.style.margin = "0 8px";
      value.style.color = "#ffd93d";
      value.style.fontWeight = "bold";

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.disabled = isLocked || currentLevel >= skill.maxlvl || remainingSkillPoints <= 0;
      plus.onclick = () => {
        if (skillAlloc[skill.id] < skill.maxlvl && remainingSkillPoints > 0) {
          skillAlloc[skill.id]++;
          remainingSkillPoints--;
          renderSkills();
        }
      };

      controls.appendChild(minus);
      controls.appendChild(value);
      controls.appendChild(plus);
      card.appendChild(controls);

      if (isLocked) {
        const tip = document.createElement("span");
        tip.style.color = "red";
        tip.style.marginLeft = "10px";
        tip.textContent = `等級達至 ${skill.learnlvl} 等解鎖`;
        card.appendChild(tip);
      }

      skillList.appendChild(card);
    });
    remainingSkillPointsEl.innerText = remainingSkillPoints;
  }

  function resetSkills() {
    allSkills.forEach(skill => skillAlloc[skill.id] = 0);
    const spent = Object.values(userStats.skills || {}).reduce((s, v) => s + (v || 0), 0);
    remainingSkillPoints = userStats.skill_points + spent;
    renderSkills();
  }

  async function submitSkills() {
    showLoading(true);
    try {
      const res = await callApi("/skills_save", "POST", { skills: skillAlloc });
      if (res.message) {
        alert("技能儲存成功！");
        await runMain();
      } else {
        alert(res.error || "儲存失敗");
      }
    } catch (err) {
      alert(`錯誤：${err.message}`);
    } finally {
      showLoading(false);
    }
  }

  document.getElementById("btnResetStats").onclick = resetStats;
  document.getElementById("btnSubmitLevel").onclick = submitLevelUp;
  document.getElementById("btnResetSkills").onclick = resetSkills;
  document.getElementById("btnSubmitSkills").onclick = submitSkills;

  async function runMain() {
    try {
      userStats = await callApi("/status");
      const skillRes = await fetch(`${API_BASE}/skills_full`);
      allSkills = await skillRes.json();
      skillAlloc = {};
      allSkills.forEach(skill => skillAlloc[skill.id] = userStats.skills?.[skill.id] ?? 0);
      resetSkills();
      renderStats();
      renderSkills();
    } catch (err) {
      console.error("runMain 錯誤：", err);
      alert("載入錯誤，請重試");
    }
  }

  window.addEventListener("message", async (e) => {
    if (e.data?.token) {
      authToken = e.data.token;
      await runMain();
    }
  });
</script>
</body>
</html>
