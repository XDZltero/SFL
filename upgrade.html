<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‡ç´šèˆ‡æŠ€èƒ½é é¢</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/style.css" rel="stylesheet"/>
  <link href="css/normalStyle.css" rel="stylesheet"/>
</head>
<body>
<div id="initialOverlay">è¼‰å…¥ä¸­...</div>

<div id="loading-placeholder"></div>
<script src="js/loading.js"></script>
<script>
  fetch("loadingOverlay.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("loading-placeholder").innerHTML = html;
      document.getElementById("initialOverlay")?.remove();
      if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
    });
</script>

<h1 class="fancy-title">ğŸ§© å‡ç´šèˆ‡æŠ€èƒ½ç®¡ç†</h1>
<hr>

<h2 class="fancy-subtitle"><span class="emoji">ğŸ“Š</span> åˆ†é…èƒ½åŠ›é»</h2>
<div class="card" style="display: flex; gap: 40px; align-items: flex-start;">
  <div>
    <strong>ç›®å‰èƒ½åŠ›å€¼ï¼š</strong>
    <ul id="currentStats"></ul>
  </div>
  <div>
    <div><strong>å‰©é¤˜èƒ½åŠ›é»æ•¸ï¼š<span id="remainingPoints" class="remaining-points">0</span></strong></div>
    <div id="base_stats"></div>
    <div class="btn-group">
      <button class="square-btn" onclick="resetStats()">é‡ç½®</button>
      <button class="square-btn" onclick="submitLevelUp()">âœ… ç¢ºèªå‡ç´š</button>
    </div>
  </div>
</div>

<hr>

<h2 class="fancy-subtitle"><span class="emoji">ğŸŒ€</span> æŠ€èƒ½é»åˆ†é…</h2>
<div class="card">
  <div><strong>å‰©é¤˜æŠ€èƒ½é»æ•¸ï¼š<span id="remainingSkillPoints" class="remaining-points">0</span></strong></div>
  <div class="btn-row">
    <button class="square-btn" onclick="resetSkills()">é‡ç½®æŠ€èƒ½</button>
    <button class="square-btn" onclick="submitSkills()">âœ… å„²å­˜æŠ€èƒ½</button>
  </div>
  <div id="skillList"></div>
</div>

<script type="module">
  const API_BASE = "https://sfl-9cb8.onrender.com";
  const baseStatsEl = document.getElementById("base_stats");
  const remainingPointsEl = document.getElementById("remainingPoints");

  let userId = null;
  let userStats = {};
  let alloc = { hp: 0, attack: 0, luck: 0, atk_speed: 0 };

  const statFields = [
    { key: "hp", label: "ç”Ÿå‘½å€¼ï¼ˆ+5ï¼‰" },
    { key: "attack", label: "æ”»æ“ŠåŠ›" },
    { key: "luck", label: "é‹æ°£å€¼" },
    { key: "atk_speed", label: "æ”»æ“Šé€Ÿåº¦" }
  ];

  function showLoading(show) {
    const loading = document.getElementById("loadingOverlay");
    if (!loading) return;
    loading.style.display = show ? "flex" : "none";
  }

  function renderStats() {
    if (!userStats.base_stats) return;
    const stats = userStats.base_stats;
    document.getElementById("currentStats").innerHTML = `
      <li>ç”Ÿå‘½å€¼ï¼š${stats.hp}</li>
      <li>æ”»æ“ŠåŠ›ï¼š${stats.attack}</li>
      <li>é‹æ°£å€¼ï¼š${stats.luck}</li>
      <li>æ”»æ“Šé€Ÿåº¦ï¼š${stats.atk_speed}</li>
    `;

    let html = "";
    statFields.forEach(({ key, label }) => {
      html += `
        <div class="stat-control">
          <label>${label}ï¼š</label>
          <button onclick="adjust('${key}', -1)">-</button>
          <span id="val_${key}">${alloc[key]}</span>
          <button onclick="adjust('${key}', 1)">+</button>
        </div>
      `;
    });
    baseStatsEl.innerHTML = html;
    remainingPointsEl.innerText = userStats.stat_points;
  }

  function adjust(stat, delta) {
    const current = alloc[stat];
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    const remaining = userStats.stat_points - totalAlloc;

    if (delta > 0 && remaining > 0) {
      alloc[stat]++;
    } else if (delta < 0 && current > 0) {
      alloc[stat]--;
    }

    document.getElementById(`val_${stat}`).innerText = alloc[stat];
    remainingPointsEl.innerText = userStats.stat_points - Object.values(alloc).reduce((a, b) => a + b, 0);
  }

  function resetStats() {
    Object.keys(alloc).forEach(k => {
      alloc[k] = 0;
      document.getElementById(`val_${k}`).innerText = "0";
    });
    remainingPointsEl.innerText = userStats.stat_points;
  }

  async function submitLevelUp() {
    const totalAlloc = Object.values(alloc).reduce((a, b) => a + b, 0);
    if (totalAlloc === 0) return alert("è«‹å…ˆåˆ†é…èƒ½åŠ›é»ï¼");
    if (!confirm("æ˜¯å¦ç¢ºå®šåˆ†é…èƒ½åŠ›é»ï¼Ÿ")) return;

    showLoading(true);
    try {
      const res = await fetch(`${API_BASE}/levelup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user: userId, allocate: alloc })
      });

      const data = await res.json();
      if (res.ok) {
        alert("èƒ½åŠ›å€¼å·²åˆ†é…å®Œç•¢ï¼");
        await loadStatus();
        resetStats();
      } else {
        alert(data.error || "å‡ç´šå¤±æ•—");
      }
    } catch (err) {
      alert(`éŒ¯èª¤ï¼š${err.message}`);
    } finally {
      showLoading(false);
    }
  }

  let skillAlloc = {};
  let remainingSkillPoints = 0;
  let originalSkills = {};
  let allSkills = [];

  async function loadAllSkills() {
    try {
      const skillRes = await fetch(`${API_BASE}/skills_full`);
      const userRes = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);

      allSkills = await skillRes.json();
      userStats = await userRes.json();

      skillAlloc = {};
      remainingSkillPoints = userStats.skill_points;
      originalSkills = { ...userStats.skills };

      allSkills.forEach(skill => {
        skillAlloc[skill.id] = userStats.skills?.[skill.id] ?? 0;
      });

      renderStats();
      renderSkills();
    } catch (err) {
      alert(`è¼‰å…¥æŠ€èƒ½éŒ¯èª¤ï¼š${err.message}`);
    }
  }

  function renderSkills() {
    const container = document.getElementById("skillList");
    container.innerHTML = "";

    allSkills.sort((a, b) => (a.sort || 999) - (b.sort || 999)).forEach((skill, index) => {
      const currentLevel = skillAlloc[skill.id] ?? 0;
      const isLocked = userStats.level < skill.learnlvl;
      const typeMap = { atk: "ã€è¼¸å‡ºå‹ã€‘", heal: "ã€æ²»ç™‚å‹ã€‘", buff: "ã€å¢ç›Šå‹ã€‘" };
      const elemMap = { pyro: "ç«", hydro: "æ°´", nature: "è‡ªç„¶", electro: "é›·", light: "å…‰", dark: "æš—", all: "å…¨", none: "ç„¡" };

      const row = document.createElement("div");
      row.className = "skill-card";

      const effectiveMultiplier = (skill.multiplier + (currentLevel - 1) * (skill.multiplierperlvl || 0)).toFixed(2);
      row.innerHTML = `
        <strong>${typeMap[skill.type] || "ã€å…¶ä»–ã€‘"} ${skill.name}</strong>
        <p>${skill.description}</p>
        <p>ç­‰ç´šä¸Šé™ï¼š${skill.maxlvl} ã€€å†·å»ï¼š${skill.cd} å›åˆ</p>
        <p>å€ç‡ï¼š${effectiveMultiplier} å±¬æ€§ï¼š${skill.element.map(e => elemMap[e] || e).join("/")}</p>
      `;

      const controls = document.createElement("div");
      controls.className = "skill-controls";

      const minus = document.createElement("button");
      minus.textContent = "-";
      minus.disabled = currentLevel === 0 || isLocked;
      minus.onclick = () => {
        if (skillAlloc[skill.id] > 0) {
          skillAlloc[skill.id]--;
          remainingSkillPoints++;
          renderSkills();
        }
      };

      const value = document.createElement("span");
      value.textContent = currentLevel;
      value.style.margin = "0 8px";
      value.style.color = "#ffd93d";
      value.style.fontWeight = "bold";

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.disabled = isLocked || currentLevel >= skill.maxlvl || remainingSkillPoints <= 0;
      plus.onclick = () => {
        if (skillAlloc[skill.id] < skill.maxlvl && remainingSkillPoints > 0) {
          skillAlloc[skill.id]++;
          remainingSkillPoints--;
          renderSkills();
        }
      };

      controls.appendChild(minus);
      controls.appendChild(value);
      controls.appendChild(plus);
      row.appendChild(controls);

      if (isLocked) {
        const tip = document.createElement("span");
        tip.style.color = "red";
        tip.style.marginLeft = "10px";
        tip.textContent = `ç­‰ç´šé”è‡³ ${skill.learnlvl} ç­‰è§£é–`;
        row.appendChild(tip);
      }

      container.appendChild(row);
    });

    document.getElementById("remainingSkillPoints").innerText = remainingSkillPoints;
  }

  function resetSkills() {
    allSkills.forEach(skill => {
      skillAlloc[skill.id] = 0;
    });
    const spentPoints = Object.values(userStats.skills || {}).reduce((sum, val) => sum + (val || 0), 0);
    remainingSkillPoints = userStats.skill_points + spentPoints;
    renderSkills();
  }

  async function submitSkills() {
    showLoading(true);
    try {
      const payload = { user: userId, skills: skillAlloc };
      const res = await fetch(`${API_BASE}/skills_save`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (res.ok) {
        alert("æŠ€èƒ½å„²å­˜æˆåŠŸï¼");
        await loadStatus();
        await loadAllSkills();
      } else {
        alert(data.error || "å„²å­˜å¤±æ•—");
      }
    } catch (err) {
      alert(`éŒ¯èª¤ï¼š${err.message}`);
    } finally {
      showLoading(false);
    }
  }

  async function runMain() {
    showLoading(true);
    try {
      const res = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
      const data = await res.json();
      userStats = data;
      renderStats();
      await loadAllSkills();
      showLoading(false);
    } catch (err) {
      console.error(err);
      alert("è¼‰å…¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
      showLoading(false);
    }
  }

  // å¾ container æ³¨å…¥ä½¿ç”¨è€…è³‡è¨Šå¾Œé–‹å§‹
  window.addEventListener("message", async (e) => {
    if (e.data?.user) {
      userId = e.data.user;
      await runMain();
    }
  });

  // å…è¨± container å‘¼å«
  window.resetStats = resetStats;
  window.submitLevelUp = submitLevelUp;
  window.resetSkills = resetSkills;
  window.submitSkills = submitSkills;
</script>
</body>
</html>
