<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>次元商店</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/inventory.css" rel="stylesheet"/>
  <link href="css/shop.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">載入中...</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <h1 class="fancy-title">次元商店</h1>

  <div class="user-section-row">
    <div class="user-currency half">
      <h2 class="fancy-subtitle">👤 玩家訊息</h2>
      <div id="userInfoDisplay">載入中...</div>
    </div>
  
    <div class="user-currency half">
      <h2 class="fancy-subtitle">💰 持有交換道具</h2>
      <div id="userCurrencyDisplay">載入中...</div>
    </div>
  </div>
  
  <!-- 重置時間顯示 -->
  <div class="reset-timer">
    <h3>⏰ 商店重置時間</h3>
    <div id="resetTimerDisplay">載入中...</div>
    <div style="margin-top: 15px; text-align: center;">
      <div id="lastRefreshTime" style="margin-top: 5px; font-size: 0.8em; color: #888;"></div>
    </div>
  </div>
  
  <!-- 分類篩選 -->
  <div class="shop-filters">
    <button class="filter-btn active" data-category="all">全部商品 <span class="category-count" id="count-all">0</span></button>
    <button class="filter-btn" data-category="reset_free">定期免費 <span class="category-count" id="count-reset_free">0</span></button>
    <button class="filter-btn" data-category="level_pack">等級禮包 <span class="category-count" id="count-level_pack">0</span></button>
    <button class="filter-btn" data-category="world_boss">世界王 <span class="category-count" id="count-world_boss">0</span></button>
  </div>
  
  <!-- 商品展示區 -->
  <div class="items-section">
    <h2 class="fancy-subtitle">🛒 商品列表</h2>
    <div class="item-grid" id="shopItemGrid"></div>
  </div>
  
  <!-- 購買確認對話框 -->
  <div id="dialogContainer"></div>
  <div id="loadingSpinner" class="loading-spinner">處理中...</div>

  <script type="module">
    import { auth, SecureAPI, PerformanceMonitor } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const API_BASE = "https://sfl-9cb8.onrender.com";
    let shopItems = [];
    let userItems = {};
    let userPurchases = {};
    let itemMeta = {};
    let userData = {}; 
    let currentFilter = 'all';

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      const spinner = document.getElementById("loadingSpinner");
      if (loading) loading.style.display = show ? "flex" : "none";
      if (spinner) spinner.style.display = show ? "block" : "none";
    }

    // ==========================================
    // 📅 精確時間處理函數 (參考 world_boss.html)
    // ==========================================
    
    /**
     * 獲取精確的台北時間
     */
    function getTaipeiTime() {
      const now = new Date();
      return new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
    }
    
    /**
     * 格式化日期為 YYYY-MM-DD 格式
     */
    function formatDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    /**
     * 格式化週數為 YYYY-WXX 格式
     */
    function formatWeekString(date) {
      const year = date.getFullYear();
      const startOfYear = new Date(year, 0, 1);
      const startOfWeek = startOfYear.getDay() || 7;
      const dayOfYear = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000)) + 1;
      const weekNum = Math.ceil((dayOfYear - startOfWeek + 1) / 7);
      return `${year}-W${String(weekNum).padStart(2, '0')}`;
    }
    
    /**
     * 格式化月份為 YYYY-MM 格式
     */
    function formatMonthString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    // ==========================================
    // 🔒 嚴格的購買時間驗證函數
    // ==========================================
    
    /**
     * 檢查商品是否可以購買（包含嚴格的時間驗證）
     */
    function validatePurchaseWithTimeCheck(item, userPurchases, userData, userItems) {
      const currentTime = getTaipeiTime();
      const purchases = userPurchases.purchases || {};
      const itemPurchases = purchases[item.id] || {
        total_purchased: 0,
        daily_purchased: 0,
        weekly_purchased: 0,
        monthly_purchased: 0,
        last_purchase_time: 0,
        last_daily_period: '',
        last_weekly_period: '',
        last_monthly_period: ''
      };
      
      const userLevel = userData.level || 1;
      const requiredLevel = item.required_level || 1;
      
      console.log(`🔍 驗證商品購買：${item.name} (ID: ${item.id})`);
      console.log(`📊 購買記錄:`, itemPurchases);
      
      // ✅ 1. 等級檢查
      if (userLevel < requiredLevel) {
        return {
          canPurchase: false,
          reason: `等級不足 (需要Lv.${requiredLevel}，目前Lv.${userLevel})`,
          errorType: 'LEVEL_INSUFFICIENT'
        };
      }
      
      // ✅ 2. 帳號總限購檢查
      if (item.limit_per_account > -1 && itemPurchases.total_purchased >= item.limit_per_account) {
        return {
          canPurchase: false,
          reason: `已達帳號總限購數量 (${itemPurchases.total_purchased}/${item.limit_per_account})`,
          errorType: 'ACCOUNT_LIMIT_REACHED'
        };
      }
      
      // ✅ 3. 重置週期限購檢查（含時間驗證）
      if (item.reset_type !== "none" && item.limit_per_reset > 0) {
        const timeValidation = validateResetPeriod(item, itemPurchases, currentTime);
        
        if (!timeValidation.canPurchase) {
          return {
            canPurchase: false,
            reason: timeValidation.reason,
            errorType: timeValidation.errorType,
            nextResetTime: timeValidation.nextResetTime
          };
        }
      }
      
      // ✅ 4. 道具數量檢查
      for (const [costItem, costAmount] of Object.entries(item.cost || {})) {
        const owned = userItems[costItem] || 0;
        if (owned < costAmount) {
          const itemName = itemMeta[costItem]?.name || costItem;
          return {
            canPurchase: false,
            reason: `${itemName} 數量不足 (需要${costAmount}，擁有${owned})`,
            errorType: 'INSUFFICIENT_ITEMS'
          };
        }
      }
      
      // ✅ 5. 目標道具上限檢查
      if (item.type !== "bundle" && item.item_id) {
        const currentAmount = userItems[item.item_id] || 0;
        if (currentAmount + item.quantity > 999) {
          return {
            canPurchase: false,
            reason: `購買後會超過999個上限 (目前${currentAmount}，購買${item.quantity})`,
            errorType: 'ITEM_LIMIT_EXCEEDED'
          };
        }
      }
      
      return {
        canPurchase: true,
        reason: "可以購買",
        currentPeriods: {
          date: formatDateString(currentTime),
          week: formatWeekString(currentTime),
          month: formatMonthString(currentTime)
        }
      };
    }
    
    /**
     * 驗證重置週期是否允許購買
     */
    function validateResetPeriod(item, itemPurchases, currentTime) {
      const resetType = item.reset_type;
      const limitPerReset = item.limit_per_reset;
      
      const currentDate = formatDateString(currentTime);
      const currentWeek = formatWeekString(currentTime);
      const currentMonth = formatMonthString(currentTime);
      
      console.log(`⏰ 檢查重置週期：${resetType}`);
      console.log(`📅 當前時間週期 - 日:${currentDate} 週:${currentWeek} 月:${currentMonth}`);
      
      switch (resetType) {
        case 'daily':
          const lastDaily = itemPurchases.last_daily_period || '';
          const dailyPurchased = itemPurchases.daily_purchased || 0;
          
          console.log(`📅 每日檢查 - 上次週期:${lastDaily} 購買次數:${dailyPurchased}/${limitPerReset}`);
          
          if (lastDaily === currentDate) {
            if (dailyPurchased >= limitPerReset) {
              return {
                canPurchase: false,
                reason: `今日已達購買上限 (${dailyPurchased}/${limitPerReset})`,
                errorType: 'DAILY_LIMIT_REACHED',
                nextResetTime: getNextDayResetTime(currentTime)
              };
            }
          }
          break;
          
        case 'weekly':
          const lastWeekly = itemPurchases.last_weekly_period || '';
          const weeklyPurchased = itemPurchases.weekly_purchased || 0;
          
          console.log(`📅 每週檢查 - 上次週期:${lastWeekly} 購買次數:${weeklyPurchased}/${limitPerReset}`);
          
          if (lastWeekly === currentWeek) {
            if (weeklyPurchased >= limitPerReset) {
              return {
                canPurchase: false,
                reason: `本週已達購買上限 (${weeklyPurchased}/${limitPerReset})`,
                errorType: 'WEEKLY_LIMIT_REACHED',
                nextResetTime: getNextWeekResetTime(currentTime)
              };
            }
          }
          break;
          
        case 'monthly':
          const lastMonthly = itemPurchases.last_monthly_period || '';
          const monthlyPurchased = itemPurchases.monthly_purchased || 0;
          
          console.log(`📅 每月檢查 - 上次週期:${lastMonthly} 購買次數:${monthlyPurchased}/${limitPerReset}`);
          
          if (lastMonthly === currentMonth) {
            if (monthlyPurchased >= limitPerReset) {
              return {
                canPurchase: false,
                reason: `本月已達購買上限 (${monthlyPurchased}/${limitPerReset})`,
                errorType: 'MONTHLY_LIMIT_REACHED',
                nextResetTime: getNextMonthResetTime(currentTime)
              };
            }
          }
          break;
      }
      
      return { canPurchase: true };
    }

    // ==========================================
    // ⏰ 下次重置時間計算函數
    // ==========================================
    
    function getNextDayResetTime(currentTime) {
      const nextDay = new Date(currentTime);
      nextDay.setDate(nextDay.getDate() + 1);
      nextDay.setHours(0, 0, 0, 0);
      return nextDay;
    }
    
    function getNextWeekResetTime(currentTime) {
      const nextMonday = new Date(currentTime);
      const daysUntilMonday = (1 + 7 - nextMonday.getDay()) % 7;
      if (daysUntilMonday === 0 && nextMonday.getHours() >= 0) {
        nextMonday.setDate(nextMonday.getDate() + 7);
      } else {
        nextMonday.setDate(nextMonday.getDate() + daysUntilMonday);
      }
      nextMonday.setHours(0, 0, 0, 0);
      return nextMonday;
    }
    
    function getNextMonthResetTime(currentTime) {
      const nextMonth = new Date(currentTime);
      if (currentTime.getDate() === 1 && currentTime.getHours() >= 0) {
        nextMonth.setMonth(nextMonth.getMonth() + 1);
      } else if (currentTime.getDate() > 1) {
        nextMonth.setMonth(nextMonth.getMonth() + 1);
      }
      nextMonth.setDate(1);
      nextMonth.setHours(0, 0, 0, 0);
      return nextMonth;
    }

    // ==========================================
    // 🔧 重新定義 canPurchaseItem 函數（使用時間驗證）
    // ==========================================
    
    function canPurchaseItem(item) {
      return validatePurchaseWithTimeCheck(item, userPurchases, userData, userItems);
    }

    function isFreeItem(item) {
      return item.type === 'free' || 
             (item.cost && Object.keys(item.cost).length === 0);
    }

    async function loadShopData() {
      try {
        const [shopRes, itemsRes, userItemsRes, userRes] = await Promise.all([
          fetch("parameter/shop_items.json"),
          SecureAPI.getStaticData('items_table'),
          SecureAPI.get(`${API_BASE}/user_items`, true),
          SecureAPI.getStatus(true)
        ]);

        shopItems = await shopRes.json();
        
        if (Array.isArray(itemsRes)) {
          itemMeta = itemsRes.reduce((acc, item) => {
            acc[item.id] = item;
            return acc;
          }, {});
        } else {
          itemMeta = itemsRes;
        }

        userItems = userItemsRes.ok ? await userItemsRes.json() : {};
        userData = await userRes.json();
        
        const resetResult = await performShopEntryResetCheck();
        
        if (resetResult.resetCount > 0) {
          const resetMessages = resetResult.resetItems.map(item => 
            `📦 ${item.item_name}：${item.reset_types.join('、')}`
          ).join('\n');
          
          const notification = `🔄 商店重置完成！\n\n以下商品已重置：\n${resetMessages}`;
          
          setTimeout(() => {
            if (confirm(`${notification}\n\n點擊確定查看最新商品狀態`)) {
              renderShopItems();
            }
          }, 1000);
        } else if (resetResult.error) {
          console.error("❌ 重置檢查發生錯誤:", resetResult.error);
        }
        
      } catch (error) {
        console.error("載入商店資料失敗:", error);
        alert("載入商店資料失敗，請重新整理頁面");
        throw error;
      }
    }

    function updateUserInfoDisplay() {
      const userLevel = userData.level || 1;
      const userNickname = userData.nickname || "未知玩家";
      
      document.getElementById("userInfoDisplay").innerHTML = `
        <div class="currency-item">
          <span class="currency-name">暱稱:</span>
          <span class="currency-amount">${userNickname}</span>
        </div>
        <div class="currency-item">
          <span class="currency-name">等級:</span>
          <span class="currency-amount">Lv.${userLevel}</span>
        </div>
      `;
    }

    function updateResetTimerDisplay() {
      const now = getTaipeiTime();
      
      const nextMonday = new Date(now);
      const daysUntilMonday = (1 + 7 - nextMonday.getDay()) % 7;
      if (daysUntilMonday === 0 && nextMonday.getHours() >= 0) {
        nextMonday.setDate(nextMonday.getDate() + 7);
      } else {
        nextMonday.setDate(nextMonday.getDate() + daysUntilMonday);
      }
      nextMonday.setHours(0, 0, 0, 0);
      
      const nextMonth = new Date(now);
      if (now.getDate() === 1 && now.getHours() >= 0) {
        nextMonth.setMonth(nextMonth.getMonth() + 1);
      } else if (now.getDate() > 1) {
        nextMonth.setMonth(nextMonth.getMonth() + 1);
      }
      nextMonth.setDate(1);
      nextMonth.setHours(0, 0, 0, 0);
      
      const nextDay = new Date(now);
      nextDay.setDate(nextDay.getDate() + 1);
      nextDay.setHours(0, 0, 0, 0);
      
      const formatTimeRemaining = (targetDate) => {
        const diff = targetDate - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) return `${days}天 ${hours}小時`;
        if (hours > 0) return `${hours}小時 ${minutes}分`;
        return `${minutes}分鐘`;
      };
      
      document.getElementById("resetTimerDisplay").innerHTML = `
        <div class="timer-item">🗓️ 週重置 (週一 00:00): ${formatTimeRemaining(nextMonday)}</div>
        <div class="timer-item">📅 月重置 (1號 00:00): ${formatTimeRemaining(nextMonth)}</div>
        <div class="timer-item">🌅 日重置 (明天 00:00): ${formatTimeRemaining(nextDay)}</div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #888;">
          ℹ️ 商品限購會在你下次進入商店時自動重置
        </div>
      `;
    }

    function updateUserCurrencyDisplay() {
      const currencies = ['world_boss_token', 'daily_coin'];
      let html = '';
      
      currencies.forEach(currency => {
        const meta = itemMeta[currency];
        const amount = userItems[currency] || 0;
        const name = meta ? meta.name : currency;
        
        html += `
          <div class="currency-item">
            <span class="currency-name">${name}:</span>
            <span class="currency-amount">${amount}</span>
          </div>
        `;
      });
      
      document.getElementById("userCurrencyDisplay").innerHTML = html;
    }

    function renderShopItems() {
      const filteredItems = currentFilter === 'all' 
        ? shopItems 
        : shopItems.filter(item => item.category === currentFilter);
    
      const sortedItems = filteredItems.sort((a, b) => {
        const aCanPurchase = canPurchaseItem(a).canPurchase;
        const bCanPurchase = canPurchaseItem(b).canPurchase;
        
        if (aCanPurchase !== bCanPurchase) {
          return bCanPurchase ? 1 : -1;
        }
        
        return a.sort - b.sort;
      });
    
      let html = '';
      
      sortedItems.forEach(item => {
        const { canPurchase, reason, levelRestricted } = canPurchaseItem(item);
        const purchases = userPurchases.purchases || {};
        const itemPurchases = purchases[item.id] || {};
        const userLevel = userData.level || 1;
        const requiredLevel = item.required_level || 1;
        
        let cardClass = 'shop-item-card';
        if (!canPurchase) cardClass += ' sold-out';
        if (item.type === 'free') cardClass += ' free';
        if (item.type === 'bundle') cardClass += ' bundle';
        if (levelRestricted) cardClass += ' level-restricted';
        
        let rarityClass = '';
        let rarityLabel = '';
        if (item.special === 1) {
          rarityClass = 'rare';
          rarityLabel = '【稀有】';
        } else if (item.special === 2) {
          rarityClass = 'super-rare';
          rarityLabel = '【超稀有】';
        } else if (item.special === 3) {
          rarityClass = 'mythical';
          rarityLabel = '【罕見】';
        }
        
        if (item.type === 'bundle') {
          rarityLabel = '【禮包】' + rarityLabel;
        }
        
        let receivedItemsHtml = '';
        if (item.type === 'bundle' && item.items) {
          const chineseItemsList = item.items.map(itemData => {
            const chineseName = getItemChineseName(itemData.item_id);
            return `${chineseName} x${itemData.quantity}`;
          }).join('、');
          
          receivedItemsHtml = `<div class="shop-item-desc">📦 禮包內容：${chineseItemsList}</div>`;
        } else if (item.item_id) {
          const chineseName = getItemChineseName(item.item_id);
          receivedItemsHtml = `<div class="shop-item-desc">📦 獲得：${chineseName} x${item.quantity}</div>`;
        }
        
        let levelRequirementHtml = '';
        if (requiredLevel > 1) {
          const levelStatusClass = userLevel >= requiredLevel ? 'level-met' : 'level-not-met';
          const levelIcon = userLevel >= requiredLevel ? '✅' : '❌';
          levelRequirementHtml = `
            <div class="level-requirement ${levelStatusClass}">
              ${levelIcon} 等級需求：Lv.${requiredLevel}<br>(目前：Lv.${userLevel})
            </div>
          `;
        }
        
        let costHtml = '';
        const itemIsFree = isFreeItem(item);
        if (itemIsFree) {
          costHtml = '<div class="cost-item"><span style="color: #4CAF50;">💰 免費領取</span></div>';
        } else {
          Object.entries(item.cost).forEach(([costItem, costAmount]) => {
            const chineseName = getItemChineseName(costItem);
            const owned = userItems[costItem] || 0;
            const sufficient = owned >= costAmount;
        
            costHtml += `
              <div class="cost-item">
                <span class="cost-name">${chineseName}:</span>
                <div>
                  <span class="cost-amount">${costAmount}</span><br>
                  <span class="cost-owned ${sufficient ? '' : 'cost-insufficient'}">(擁有: ${owned})</span>
                </div>
              </div>
            `;
          });
        }
    
        const totalPurchased = itemPurchases.total_purchased || 0;
        const resetPurchased = itemPurchases[`${item.reset_type}_purchased`] || 0;
        
        const isUnlimited = (item.unlimited || item.limit_per_account === -1) && 
                           (item.limit_per_reset === -1 || item.reset_type === 'none');
    
        let limitDisplay = '';
        
        if (isUnlimited) {
          limitDisplay = `
            <div class="shop-item-limit unlimited">
              ♾️ 無限購買 | 已購買：${totalPurchased} 次
            </div>
          `;
        } else {
          let limitInfo = [];
          
          if (item.limit_per_account !== -1) {
            limitInfo.push(`總購買：${totalPurchased}/${item.limit_per_account}`);
          }
          
          if (item.reset_type !== 'none' && item.limit_per_reset !== -1) {
            const resetTypeName = getResetTypeName(item.reset_type);
            limitInfo.push(`${resetTypeName}：${resetPurchased}/${item.limit_per_reset}`);
          }
          
          if (item.limit_per_account === -1 && item.reset_type !== 'none' && item.limit_per_reset !== -1) {
            const resetTypeName = getResetTypeName(item.reset_type);
            limitInfo = [`${resetTypeName}限購：${resetPurchased}/${item.limit_per_reset}`];
          }
          
          limitDisplay = `
            <div class="shop-item-limit ${item.reset_type}">
              📦 ${limitInfo.join(' | ')}
            </div>
          `;
        }
        
        html += `
          <div class="${cardClass} ${rarityClass}">
            <div class="shop-item-name">${rarityLabel}${item.name}</div>
            <div class="shop-item-desc">${item.description}</div>
            ${receivedItemsHtml}
            ${levelRequirementHtml}
            
            ${limitDisplay}
            
            <div class="shop-item-cost">
              ${costHtml}
            </div>
            
            ${!canPurchase ? 
              `<div style="color: #ff6b6b; font-weight: bold; text-align: center; margin: 10px 0;">❌ ${reason}</div>` :
              `<button class="square-btn" onclick="openPurchaseDialog('${item.id}')" style="width: 100%; margin-top: 10px;">
                ${itemIsFree ? '🎁 免費領取' : item.type === 'bundle' ? '📦 購買禮包' : '💰 購買'}
              </button>`
            }
          </div>
        `;
      });
    
      document.getElementById("shopItemGrid").innerHTML = html || '<div class="shop-item-card">此分類暫無商品</div>';
      
      updateCategoryCounts();
    }

    function updateCategoryCounts() {
      const categories = ['all', 'reset_free', 'level_pack', 'world_boss'];
      
      categories.forEach(category => {
        const count = category === 'all' 
          ? shopItems.length 
          : shopItems.filter(item => item.category === category).length;
        
        const countEl = document.getElementById(`count-${category}`);
        if (countEl) {
          countEl.textContent = count;
        }
      });
    }

    async function openPurchaseDialog(itemId) {
      const item = shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      // 🔒 使用嚴格時間驗證
      const { canPurchase, reason, nextResetTime } = canPurchaseItem(item);
      
      if (!canPurchase) {
        let errorMessage = `❌ 無法購買：${reason}`;
        
        // 如果有下次重置時間，顯示給用戶
        if (nextResetTime) {
          const resetTime = nextResetTime.toLocaleString('zh-TW');
          errorMessage += `\n\n⏰ 下次可購買時間：${resetTime}`;
        }
        
        alert(errorMessage);
        return;
      }
      
      const dialog = document.getElementById("dialogContainer");
      const userLevel = userData.level || 1;
      const requiredLevel = item.required_level || 1;
      
      let receivedItemsSummary = '';
      if (item.type === 'bundle' && item.items) {
        receivedItemsSummary = '<h4>📦 禮包內容</h4>';
        item.items.forEach(itemData => {
          const chineseName = getItemChineseName(itemData.item_id);
          const currentAmount = userItems[itemData.item_id] || 0;
          
          receivedItemsSummary += `
            <div class="cost-item">
              <span>${chineseName}:</span>
              <span>+${itemData.quantity} (總計: ${currentAmount + itemData.quantity})</span>
            </div>
          `;
        });
      } else if (item.item_id) {
        const chineseName = getItemChineseName(item.item_id);
        const currentAmount = userItems[item.item_id] || 0;
        
        receivedItemsSummary = `
          <h4>📦 購買物品</h4>
          <div><strong>${item.name}</strong></div>
          <div>數量：${item.quantity}</div>
          <div>購買後總計：${currentAmount} + ${item.quantity} = ${currentAmount + item.quantity}</div>
        `;
      }
      
      let levelInfoHtml = '';
      if (requiredLevel > 1) {
        levelInfoHtml = `
          <div class="purchase-summary">
            <h4>👤 等級要求</h4>
            <div class="cost-item">
              <span>需要等級：</span>
              <span style="color: #4CAF50;">Lv.${requiredLevel} ✅</span>
            </div>
            <div class="cost-item">
              <span>目前等級：</span>
              <span style="color: #00ffff;">Lv.${userLevel}</span>
            </div>
          </div>
        `;
      }
      
      let costSummary = '';
      const itemIsFree = isFreeItem(item);
      
      if (itemIsFree) {
        costSummary = '<div style="color: #4CAF50; text-align: center; font-weight: bold;">🎁 此為免費道具</div>';
      } else {
        Object.entries(item.cost).forEach(([costItem, costAmount]) => {
          const chineseName = getItemChineseName(costItem);
          const owned = userItems[costItem] || 0;
          
          costSummary += `
            <div class="cost-item">
              <span>消耗 ${chineseName}:</span>
              <span>${costAmount} (剩餘: ${owned - costAmount})</span>
            </div>
          `;
        });
      }
      
      let html = `
        <div class='purchase-dialog'>
          <h3>💰 ${item.type === 'bundle' ? '禮包購買' : '購買'}確認</h3>
          
          ${levelInfoHtml}
          
          <div class="purchase-summary">
            ${receivedItemsSummary}
          </div>
          
          <div class="purchase-summary">
            <h4>💸 消耗道具</h4>
            ${costSummary}
          </div>
          
          <div class="btn-group">
            <button class="square-btn" onclick="confirmPurchaseWithTimeValidation('${itemId}')" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
              ✅ 確認${itemIsFree ? '領取' : item.type === 'bundle' ? '購買禮包' : '購買'}
            </button>
            <button class="square-btn" onclick="closeDialog()">❌ 取消</button>
          </div>
        </div>
      `;
      
      dialog.innerHTML = html;
      dialog.style.display = "flex";
      document.body.style.overflow = "hidden";
      document.body.classList.add("dialog-open");
    }

    // ==========================================
    // 💰 修改後的確認購買函數（含嚴格時間驗證）
    // ==========================================
    
    async function confirmPurchaseWithTimeValidation(itemId) {
      showLoading(true);
      
      try {
        const item = shopItems.find(i => i.id === itemId);
        if (!item) {
          throw new Error('找不到商品資料');
        }
        
        // 🔒 購買前最後一次嚴格驗證
        const validation = validatePurchaseWithTimeCheck(item, userPurchases, userData, userItems);
        
        if (!validation.canPurchase) {
          let errorMessage = `❌ 無法購買：${validation.reason}`;
          
          if (validation.nextResetTime) {
            const resetTime = validation.nextResetTime.toLocaleString('zh-TW');
            errorMessage += `\n\n⏰ 下次可購買時間：${resetTime}`;
          }
          
          alert(errorMessage);
          return;
        }
        
        console.log(`✅ 購買前驗證通過，發送購買請求`);
        
        // 發送購買請求到後端，包含時間驗證資訊
        const response = await SecureAPI.post(`${API_BASE}/shop_purchase`, {
          item_id: itemId,
          purchase_time: getTaipeiTime().getTime(),
          time_validation: {
            current_periods: validation.currentPeriods,
            validation_passed: true
          }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // 🎉 購買成功處理
          let successMessage = '';
          
          const purchaseInfo = result.purchase_info || {};
          const itemName = purchaseInfo.item_name || '未知商品';
          const purchaseType = purchaseInfo.purchase_type || '購買';
          
          successMessage = `✅ 成功${purchaseType} ${itemName}`;
          
          const totalItemsReceived = purchaseInfo.total_items_received || {};
          if (Object.keys(totalItemsReceived).length > 0) {
            const chineseItemsList = [];
            
            for (const [receivedItemId, quantity] of Object.entries(totalItemsReceived)) {
              const chineseName = getItemChineseName(receivedItemId);
              chineseItemsList.push(`${chineseName} x${quantity}`);
            }
            
            if (chineseItemsList.length > 0) {
              successMessage += `\n\n📦 獲得道具：\n${chineseItemsList.join('\n')}`;
            }
          }
          
          // 顯示購買限制資訊
          if (result.purchase_limits) {
            const limits = result.purchase_limits;
            successMessage += `\n\n📊 購買記錄：`;
            
            if (limits.total_purchased !== undefined) {
              successMessage += `\n總購買：${limits.total_purchased}`;
              if (item.limit_per_account > -1) {
                successMessage += `/${item.limit_per_account}`;
              }
            }
            
            if (limits.period_purchased !== undefined && item.reset_type !== 'none') {
              const resetTypeName = getResetTypeName(item.reset_type);
              successMessage += `\n${resetTypeName}購買：${limits.period_purchased}/${item.limit_per_reset}`;
            }
          }
          
          alert(successMessage);
          
          // 🔄 更新本地資料
          userItems = result.user_items || userItems;
          userPurchases = result.purchases || userPurchases;
          
          updateUserCurrencyDisplay();
          renderShopItems();
          closeDialog();
          
          console.log(`🎉 購買完成：${itemName}`);
          
        } else {
          // ❌ 購買失敗處理
          let errorMessage = `❌ 購買失敗：${result.error || result.message}`;
          
          if (result.error_type) {
            switch (result.error_type) {
              case 'TIME_VALIDATION_FAILED':
                errorMessage += '\n\n⏰ 時間驗證失敗，請重新整理頁面後再試';
                break;
              case 'CONCURRENT_PURCHASE':
                errorMessage += '\n\n⚠️ 檢測到併發購買，請稍後再試';
                break;
              default:
                break;
            }
          }
          
          alert(errorMessage);
        }
        
      } catch (error) {
        console.error("購買錯誤:", error);
        alert(`❌ 購買過程發生錯誤：${error.message}`);
      } finally {
        showLoading(false);
      }
    }

    function getItemChineseName(itemId) {
      const meta = itemMeta[itemId];
      return meta ? meta.name : itemId;
    }

    function closeDialog() {
      document.body.style.overflow = "";
      document.body.classList.remove("dialog-open");
      document.getElementById("dialogContainer").style.display = "none";
    }

    function switchFilter(category) {
      currentFilter = category;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
      
      renderShopItems();
    }

    function getResetTypeName(resetType) {
      const names = {
        'daily': '每日',
        'weekly': '每週',
        'monthly': '每月',
        'none': '永久'
      };
      return names[resetType] || resetType;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchFilter(btn.dataset.category);
        });
      });
    });
	
	async function checkShopReset() {
	  try {
		console.log("🏪 檢查商店重置...");
		const response = await SecureAPI.post(`${API_BASE}/shop_check_reset`, {});
		const result = await response.json();
		
		if (response.ok && result.success) {
		  // 如果有重置發生，顯示通知
		  if (result.reset_occurred && result.reset_items && result.reset_items.length > 0) {
			const resetMessage = `🔄 商店重置完成！\n\n重置項目：\n${result.reset_items.map(item => `• ${item}`).join('\n')}`;
			setTimeout(() => alert(resetMessage), 500);
		  }
		  
		  // 更新購買記錄
		  userPurchases = result.purchases || userPurchases;
		  console.log("✅ 商店重置檢查完成");
		  
		} else {
		  console.warn("❌ 商店重置檢查失敗:", result.error);
		}
		
	  } catch (error) {
		console.error("❌ 商店重置檢查錯誤:", error);
	  }
	}

    // 🚀 全域函數更新
    window.openPurchaseDialog = openPurchaseDialog;
    window.confirmPurchaseWithTimeValidation = confirmPurchaseWithTimeValidation;
    window.closeDialog = closeDialog;

    async function runMain() {
      showLoading(true);
      
      try {
	  
		console.log("🏪 載入商店資料...");
    
		await checkShopReset();
		
		const [shopRes, itemsRes, userItemsRes, userRes] = await Promise.all([
		  fetch("parameter/shop_items.json"),
		  SecureAPI.getStaticData('items_table'),
		  SecureAPI.get(`${API_BASE}/user_items`),
		  SecureAPI.getStatus()
		]);
		
        await loadShopData();
        
        updateUserInfoDisplay();
        updateUserCurrencyDisplay();
        renderShopItems();
        updateResetTimerDisplay();
        
        setInterval(updateResetTimerDisplay, 60000);
        
        console.log('🏪 商店頁面初始化完成（含嚴格時間驗證）');
        
      } catch (error) {
        console.error("初始化錯誤:", error);
        alert("頁面初始化失敗，請重新整理");
      } finally {
        showLoading(false);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (window.parent && window.parent.postMessage) {
        console.log("🎵 商店頁面：請求切換到商店音樂");
        window.parent.postMessage({ command: "switchToShopMusic" }, "*");
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        runMain();
      } else {
        window.parent.location.href = "/SFL/login.html";
      }
    });
  </script>
</body>
</html>
