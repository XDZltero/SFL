<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ•…äº‹èˆ‡è¨­å®š</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/inventory.css" rel="stylesheet"/>
  <link href="css/story.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">è¼‰å…¥ä¸­...</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <h1 class="fancy-title">ã€Œè¨˜éŒ„è‘—å±¬æ–¼ä½ çš„æ•…äº‹ã€</h1>
  
  <div class="main-container">
    <!-- ğŸ”§ ä¿®æ”¹1ï¼šå°‡è¨­å®šå€åŸŸç§»åˆ°æ•…äº‹å€åŸŸä¸Šé¢ -->
    <div class="section settings-section">
      <div class="settings-header">
        <h2 class="fancy-subtitle">âš™ï¸ ä¸–ç•Œè¨­å®š</h2>
        <!-- ğŸ”§ ä¿®æ”¹3ï¼šè¨­å®šæŒ‰éˆ•é è¿‘æ¨™é¡Œä¸¦é¡¯ç¤ºå®Œæ•´æ–‡å­— -->
        <button class="settings-toggle-btn" onclick="toggleSettings()">
          <span id="settingsToggleText">ğŸ“‹ é¡¯ç¤ºè¨­å®šè³‡æ–™</span>
        </button>
      </div>
      <div class="settings-grid" id="settingsGrid">
        <!-- è¨­å®šé …ç›®å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æ•…äº‹å€åŸŸ -->
    <div class="section">
      <h2 class="fancy-subtitle">ğŸ“– ä¸»ç·šæ•…äº‹</h2>
      <div class="story-list" id="storyList">
        <!-- æ•…äº‹é …ç›®å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- æ•…äº‹å°è©±æ¡† -->
  <div class="story-dialog" id="storyDialog">
    <div class="story-dialog-content">
      <!-- ğŸ”§ ä¿®æ”¹1ï¼šå‰å‰æŒ‰éˆ•ç¾åœ¨æœƒå›ºå®šåœ¨è¦–çª—å³ä¸Šè§’ -->
      <button class="story-close-btn" onclick="closeStoryDialog()">Ã—</button>
      <h3 class="story-dialog-title" id="storyDialogTitle">è¼‰å…¥ä¸­...</h3>
      <div class="story-dialog-body" id="storyDialogBody">
        è¼‰å…¥æ•…äº‹å…§å®¹...
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, SecureAPI } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    let storyData = [];
    let userClearLog = {};
    let settingsVisible = false;

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (loading) loading.style.display = show ? "flex" : "none";
    }

    // è¼‰å…¥æ•…äº‹è³‡æ–™
    async function loadStoryData() {
      try {
        const response = await fetch("parameter/story.json");
        storyData = await response.json();
        console.log("âœ… æ•…äº‹è³‡æ–™è¼‰å…¥å®Œæˆ");
      } catch (error) {
        console.error("âŒ è¼‰å…¥æ•…äº‹è³‡æ–™å¤±æ•—:", error);
        throw error;
      }
    }

    // è¼‰å…¥ä½¿ç”¨è€…é€²åº¦
    async function loadUserProgress() {
      try {
        const statusRes = await SecureAPI.getStatus();
        const userData = await statusRes.json();
        userClearLog = userData.ClearLog || {};
        console.log("âœ… ä½¿ç”¨è€…é€²åº¦è¼‰å…¥å®Œæˆ:", userClearLog);
      } catch (error) {
        console.error("âŒ è¼‰å…¥ä½¿ç”¨è€…é€²åº¦å¤±æ•—:", error);
        throw error;
      }
    }

    // æª¢æŸ¥è§£é–æ¢ä»¶
    function checkUnlockRequirement(story) {
      const req = story.unlock_requirements;
      
      // å¦‚æœæ²’æœ‰è¦æ±‚ï¼Œç›´æ¥è§£é–
      if (!req.dungeon || req.clear_count === 0) {
        return { unlocked: true, message: "" };
      }
      
      const userClearCount = userClearLog[req.dungeon] || 0;
      const unlocked = userClearCount >= req.clear_count;
      
      let message = "";
      if (!unlocked) {
        // æ ¹æ“šå‰¯æœ¬IDæ‰¾åˆ°å‰¯æœ¬åç¨±
        const dungeonNames = {
          "dungeon_moss": "è…çˆ›æ²¼æ¾¤åœ°",
          "dungeon_skycity": "å¤©ç©ºä¹‹åŸ", 
          "dungeon_ironcity": "é‹¼éµéƒ½å¸‚",
          "dungeon_magictown": "ç´«é­”ä¹‹åŸ",
          "dungeon_pandora_nightmare": "æ½˜æœµæ‹‰ï¼šå¤¢é­˜å¹»å¢ƒ",
          "dungeon_siant": "æ½˜æœµæ‹‰ï¼šè–å¤©æ•™æœƒ",
          "dungeon_obelisk": "æ¬¡å…ƒç•Œï¼šç¬¬ä¸€è¦å¡"
        };
        
        const dungeonName = dungeonNames[req.dungeon] || req.dungeon;
        message = `éœ€è¦é€šé—œã€Œ${dungeonName}ã€${req.clear_count}æ¬¡ (ç›®å‰: ${userClearCount}/${req.clear_count})`;
      }
      
      return { unlocked, message };
    }

    // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
    function renderStoryList() {
      const storyList = document.getElementById("storyList");
      const stories = storyData.filter(item => item.category === "story")
                               .sort((a, b) => a.sort - b.sort);
      
      let html = "";
      
      stories.forEach(story => {
        const unlockStatus = checkUnlockRequirement(story);
        const isLocked = !unlockStatus.unlocked;
        
        html += `
          <div class="story-item ${isLocked ? 'locked' : ''}" ${!isLocked ? `onclick="openStory('${story.id}')"` : ''}>
            <div class="story-title">${story.title}</div>
            ${isLocked ? 
              `<div class="story-unlock-requirement">ğŸ”’ ${unlockStatus.message}</div>` :
              `<div class="story-preview">é»æ“Šé–±è®€é€™å€‹æ•…äº‹ç« ç¯€...</div>`
            }
          </div>
        `;
      });
      
      storyList.innerHTML = html || '<div class="story-item locked"><div class="story-title">æš«ç„¡æ•…äº‹å…§å®¹</div></div>';
    }

    // æ¸²æŸ“è¨­å®šåˆ—è¡¨
    function renderSettingsList() {
      const settingsGrid = document.getElementById("settingsGrid");
      const settings = storyData.filter(item => item.category === "settings")
                                .sort((a, b) => a.sort - b.sort);
      
      let html = "";
      
      settings.forEach(setting => {
        const unlockStatus = checkUnlockRequirement(setting);
        const isLocked = !unlockStatus.unlocked;
        
        html += `
          <div class="settings-item ${isLocked ? 'locked' : ''}" ${!isLocked ? `onclick="openStory('${setting.id}')"` : ''}>
            <div class="settings-title">${setting.title}</div>
            ${isLocked ? `<div style="font-size: 0.8em; color: #ff6b6b; margin-top: 5px;">ğŸ”’ ${unlockStatus.message}</div>` : ''}
          </div>
        `;
      });
      
      settingsGrid.innerHTML = html || '<div class="settings-item"><div class="settings-title">æš«ç„¡è¨­å®šå…§å®¹</div></div>';
    }

    // è™•ç†æ•…äº‹å…§å®¹ï¼Œè§£ææ›è¡Œå’Œåœ–ç‰‡
    function processStoryContent(content) {
      // å…ˆè™•ç†æ›è¡Œç¬¦è™Ÿ
      let processed = content.replace(/\\n/g, '\n');
      
      // åˆ†å‰²å…§å®¹ï¼Œè™•ç†åœ–ç‰‡
      const parts = processed.split('\n\n');
      let html = '';
      
      parts.forEach(part => {
        const trimmed = part.trim();
        if (!trimmed) return;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡URL
        if (trimmed.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)) {
          html += `<img src="${trimmed}" alt="æ•…äº‹æ’åœ–" loading="lazy" />`;
        } else {
          // è™•ç†æ–‡å­—å…§å®¹ï¼Œä¿ç•™æ›è¡Œ
          const textWithBreaks = trimmed.replace(/\n/g, '<br>');
          html += `<p>${textWithBreaks}</p>`;
        }
      });
      
      return html;
    }

    // é–‹å•Ÿæ•…äº‹å°è©±æ¡†
    function openStory(storyId) {
      const story = storyData.find(item => item.id === storyId);
      if (!story) return;
      
      const unlockStatus = checkUnlockRequirement(story);
      if (!unlockStatus.unlocked) {
        alert(`ğŸ”’ ${unlockStatus.message}`);
        return;
      }
      
      document.getElementById("storyDialogTitle").textContent = story.title;
      document.getElementById("storyDialogBody").innerHTML = processStoryContent(story.content);
      document.getElementById("storyDialog").style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    // é—œé–‰æ•…äº‹å°è©±æ¡†
    function closeStoryDialog() {
      document.getElementById("storyDialog").style.display = "none";
      document.body.style.overflow = "";
    }

    // ğŸ”§ ä¿®æ”¹3ï¼šæ›´æ–°åˆ‡æ›è¨­å®šé¡¯ç¤ºçš„å‡½æ•¸ï¼Œæ¢å¾©åŸä¾†çš„æ–‡å­—é¡¯ç¤º
    function toggleSettings() {
      const settingsGrid = document.getElementById("settingsGrid");
      const toggleText = document.getElementById("settingsToggleText");
      
      settingsVisible = !settingsVisible;
      
      if (settingsVisible) {
        settingsGrid.classList.add("show");
        toggleText.textContent = "ğŸ“‹ éš±è—è¨­å®šè³‡æ–™";
      } else {
        settingsGrid.classList.remove("show");
        toggleText.textContent = "ğŸ“‹ é¡¯ç¤ºè¨­å®šè³‡æ–™";
      }
    }

    // å…¨åŸŸå‡½æ•¸
    window.openStory = openStory;
    window.closeStoryDialog = closeStoryDialog;
    window.toggleSettings = toggleSettings;

    // é»æ“Šå°è©±æ¡†å¤–éƒ¨é—œé–‰
    document.getElementById("storyDialog").addEventListener("click", (e) => {
      if (e.target.id === "storyDialog") {
        closeStoryDialog();
      }
    });

    // ESCéµé—œé–‰å°è©±æ¡†
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && document.getElementById("storyDialog").style.display === "flex") {
        closeStoryDialog();
      }
    });

    // ä¸»è¦åˆå§‹åŒ–å‡½æ•¸
    async function initStoryPage() {
      showLoading(true);
      
      try {
        // ğŸµ éŸ³æ¨‚åˆ‡æ›å·²ç¶“åœ¨é é¢è¼‰å…¥æ™‚è™•ç†ï¼Œé€™è£¡ä¸å†é‡è¤‡è«‹æ±‚
        
        // ä¸¦è¡Œè¼‰å…¥è³‡æ–™
        await Promise.all([
          loadStoryData(),
          loadUserProgress()
        ]);
        
        // æ¸²æŸ“é é¢
        renderStoryList();
        renderSettingsList();
        
        console.log("ğŸ‰ æ•…äº‹é é¢åˆå§‹åŒ–å®Œæˆ");
        
      } catch (error) {
        console.error("âŒ æ•…äº‹é é¢åˆå§‹åŒ–å¤±æ•—:", error);
        alert("è¼‰å…¥æ•…äº‹è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
      } finally {
        showLoading(false);
      }
    }

    window.addEventListener("beforeunload", () => {
      try {
        window.parent.postMessage({
          command: "restoreMainMusic"
        }, "*");
        console.log("ğŸµ é›¢é–‹æ•…äº‹é é¢ï¼Œæ¢å¾©ä¸»éŸ³æ¨‚");
      } catch (error) {
        console.warn("ğŸµ æ¢å¾©ä¸»éŸ³æ¨‚å¤±æ•—:", error);
      }
    });

    function requestStoryMusic() {
      try {
        window.parent.postMessage({
          command: "switchToStoryMusic"
        }, "*");
        console.log("ğŸµ æ•…äº‹é é¢å·²è«‹æ±‚åˆ‡æ›åˆ°æ•…äº‹éŸ³æ¨‚");
      } catch (error) {
        console.warn("ğŸµ è«‹æ±‚æ•…äº‹éŸ³æ¨‚å¤±æ•—:", error);
      }
    }

    // ğŸµ é é¢è¼‰å…¥å®Œæˆå¾Œç«‹å³åˆ‡æ›éŸ³æ¨‚
    document.addEventListener("DOMContentLoaded", () => {
      requestStoryMusic();
    });
    
    // ğŸµ å¦‚æœ DOM å·²ç¶“è¼‰å…¥å®Œæˆï¼Œç«‹å³åŸ·è¡Œ
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", requestStoryMusic);
    } else {
      // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
      requestStoryMusic();
    }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, (user) => {
      if (user) {
        initStoryPage();
      } else {
        window.parent.location.href = "/SFL/login.html";
      }
    });
  </script>
</body>
</html>
