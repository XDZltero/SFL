<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>主頁</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      padding-top: 60px;
    }

    #topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #f5f5f5;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      font-size: 0.95em;
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }

    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 1.5em;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    pre {
      background: #eee;
      padding: 1em;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <span>👤 玩家名稱：<span id="userNickname">載入中...</span></span>
    <button onclick="logout()">🔓 登出</button>
  </div>

  <div id="loadingOverlay">⏳ 載入中，請稍候...</div>

  <h1>主畫面</h1>

  <pre id="statusBlock">正在載入角色資料...</pre>

  <div>
    <button onclick="location.href='upgrade.html'">🧠 技能與升級頁面</button>
    <button onclick="location.href='inventory.html'">🎒 背包與裝備管理</button>
  </div>

  <div>
    <h3>＜副本＞</h3>
    怪物 ID：<input id="monster_id" placeholder="輸入怪物 ID" />
    <button onclick="goToBattle()">戰鬥開始</button>
  </div>

  <!-- 🔽 核心邏輯改為 module 模式 -->
  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    const statusBlock = document.getElementById("statusBlock");
    const loading = document.getElementById("loadingOverlay");
    const nicknameSpan = document.getElementById("userNickname");

    let levelExp = {};

    function showLoading(show) {
      loading.style.display = show ? "flex" : "none";
    }

    function percent(val) {
      return Math.round(val * 100) + "%";
    }

    function calcTotal(base, equip) {
      return base + (equip || 0);
    }

    function formatStats(data) {
      const b = data.base_stats;
      const e = data.equipment_stats || {}; // 若未來有裝備加成可加進來
      const total_hp = calcTotal(b.hp, e.hp);
      const total_atk = calcTotal(b.attack, e.attack);
      const total_shield = calcTotal(b.shield, e.shield);
      const total_luck = calcTotal(b.luck, e.luck);
      const total_accuracy = calcTotal(b.accuracy, e.accuracy);
      const total_evade = calcTotal(b.evade, e.evade);
      const levelMaxExp = levelExp[data.level] || 1;
      const progress = percent(data.exp / levelMaxExp);

      return `玩家名稱: ${data.nickname}
等級: ${data.level}
經驗值: ${data.exp} (${progress})
生命值: ${total_hp} (${b.hp} + ${e.hp || 0})
攻擊力: ${total_atk} (${b.attack} + ${e.attack || 0})
護盾值: ${total_shield} (${b.shield} + ${e.shield || 0})
幸運值: ${total_luck} (${b.luck} + ${e.luck || 0})
命中率: ${percent(total_accuracy)} (${b.accuracy} + ${e.accuracy || 0})
迴避率: ${percent(total_evade)} (${b.evade} + ${e.evade || 0})
攻擊速度: ${b.atk_speed}
物理傷害加成: ${data.buffs?.phys_bonus ?? 0}
魔法傷害加成: ${data.buffs?.magic_bonus ?? 0}
剩餘能力值點數: ${data.stat_points}
剩餘技能點: ${data.skill_points}`;
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "/SFL/login.html";
      });
    }
    window.logout = logout;

    function goToBattle() {
      const user = firebase.auth().currentUser;
      const monster = document.getElementById("monster_id").value.trim();
      if (!user || !monster) {
        alert("請輸入怪物 ID");
        return;
      }
    
      window.location.href = `battle.html?user=${encodeURIComponent(user.email)}&monster=${encodeURIComponent(monster)}`;
    }
    
    // ⬅️ 記得加入這行！讓 HTML 能呼叫
    window.goToBattle = goToBattle;

    async function loadStatus() {
      showLoading(true);

      try {
        // 取得等級經驗表
        const expRes = await fetch("level_exp.json");
        levelExp = await expRes.json();

        const user = firebase.auth().currentUser;
        if (!user) {
          window.location.href = "/SFL/login.html";
          return;
        }

        const email = user.email;
        const res = await fetch(`${API_BASE}/status?user=${encodeURIComponent(email)}`);
        const data = await res.json();

        nicknameSpan.innerText = data.nickname || email;
        statusBlock.innerText = formatStats(data);
      } catch (err) {
        console.error("載入失敗", err);
        statusBlock.innerText = "❌ 載入角色資料失敗，請稍後再試。";
      } finally {
        showLoading(false);
      }
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) loadStatus();
      else window.location.href = "/SFL/login.html";
    });
  </script>
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("footer-placeholder").innerHTML = html;
      })
      .catch(err => console.warn("載入 footer 失敗", err));
  </script>
</body>
</html>
