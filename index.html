<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SFL</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/indexIntro.css" rel="stylesheet" />

  <!-- Firebase åˆå§‹åŒ–æ¨¡çµ„ -->
  <script type="module" src="js/firebase-init.js"></script>
</head>
<body>
  <!-- èƒŒæ™¯ç²’å­ -->
  <div class="particles" id="particles"></div>

  <!-- åˆå§‹é®ç½© -->
  <div id="loadingOverlay">
    <h1 class="game-title">SFL</h1>
    <p class="game-subtitle">æº–å‚™é€²å…¥æ–‡å­—å†’éšªä¸–ç•Œ</p>
    <button class="start-button" id="startButton">é»æ“Šé–‹å§‹</button>
    <div class="loading-animation" id="loadingAnimation" style="display: none;">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
    <div class="version-info">v1.0.0 | BETAç‰ˆ</div>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div id="gameContent">
    <div id="topbar">
      <div class="user-info">
        <span>ğŸ‘¤ ç©å®¶åç¨±ï¼š<span id="userEmail">è¼‰å…¥ä¸­...</span></span>
      </div>
      <div class="topbar-right">
        <div class="controls" id="controlButtons"></div>
        <div class="audio-controls">
          <button id="toggleSound">ğŸ”Š</button>
          <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.05" />
        </div>
      </div>
    </div>

    <audio id="bgm" loop>
      <source src="https://d6sxwifruvavjc3u.public.blob.vercel-storage.com/MainBGM-7xSR0UHxcWpAzsEaWxPzP5oJQYoK44.mp3" type="audio/mpeg" />
    </audio>

    <iframe id="mainFrame" src="main_page.html"></iframe>
  </div>

  <!-- é å°¾ -->
  <div id="container-footer">
    ğŸ“¦ ç‰ˆæœ¬ï¼šv1.0.0
    ï½œ ğŸ”— <a href="https://discord.gg/C8MZXcqZZn" target="_blank">åŠ å…¥ Discord</a>
    ï½œ ğŸ•’ æœ€å¾Œæ›´æ–°ï¼š2025-05-31
    ï½œ ğŸ§‘â€ğŸ’» é–‹ç™¼è€…ï¼š<a href="https://www.youtube.com/@XD_Zltero" target="_blank">èŠå§†é†¬</a>
  </div>

  <!-- è¡Œç‚ºè…³æœ¬ -->
  <script type="module">
    import { auth, signOut } from "./js/firebase-init.js";
    let currentBgm = "main";

    // ğŸµ éŸ³æ¨‚è³‡æºé…ç½®
    const musicSources = {
      main: "https://d6sxwifruvavjc3u.public.blob.vercel-storage.com/MainBGM-7xSR0UHxcWpAzsEaWxPzP5oJQYoK44.mp3",
      boss: "https://d6sxwifruvavjc3u.public.blob.vercel-storage.com/Last_Boss_Battle_theme_v2-zrhJSBVfzYfK17ro58EyHtmr0smIxi.mp3",
      worldBoss: "https://d6sxwifruvavjc3u.public.blob.vercel-storage.com/World_Boss_Battle_theme-1iojoQSoKrHoSGqZX5R6NrXmPwGAJ0.mp3",
      story: "https://d6sxwifruvavjc3u.public.blob.vercel-storage.com/StoryPage-XBTqYtVyxoO0C48l0UPrKtutWNgB2t.mp3"
    };

    // ğŸµ éŸ³æ¨‚åˆ‡æ›å‡½æ•¸
    function switchMusic(musicType) {
      if (currentBgm === musicType) return;  
        currentBgm = musicType;
        bgm.pause();
        
        if (musicSources[musicType]) {
          bgm.src = musicSources[musicType];
        } else {
          console.warn(`âš ï¸ æ‰¾ä¸åˆ°éŸ³æ¨‚é¡å‹ï¼š${musicType}ï¼Œä½¿ç”¨ä¸»éŸ³æ¨‚`);
          bgm.src = musicSources.main;
          currentBgm = "main";
        }
        
        bgm.load();
        
        // ğŸµ æ ¹æ“šéŸ³æ¨‚é¡å‹èª¿æ•´éŸ³é‡
        let targetVolume = volumeSlider.value;
        // if (musicType === "story") {
        //   targetVolume = volumeSlider.value * 0.7; // æ•…äº‹æ¨¡å¼éŸ³é‡é™ä½30%ï¼Œç‡Ÿé€ å®‰éœé–±è®€æ°›åœ
        // }
        
        bgm.volume = targetVolume;
        bgm.muted = muted;
        bgm.play().catch(error => {
          console.warn("éŸ³æ¨‚æ’­æ”¾å¤±æ•—:", error);
        });
      }

    // ğŸµ éŸ³æ¨‚æ§åˆ¶è¨Šæ¯ç›£è½
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (!data || !data.command) return;
      
      switch (data.command) {
        case "switchToBossMusic":
          switchMusic("boss");
          break;
          
        case "switchToWorldBossMusic": // ğŸ†• ä¸–ç•Œç‹éŸ³æ¨‚
          switchMusic("worldBoss");
          break;
          
        case "restoreMainMusic":
          switchMusic("main");
          break;

        case "switchToStoryMusic": // ğŸ†• æ–°å¢æ•…äº‹éŸ³æ¨‚æŒ‡ä»¤
          switchMusic("story");
          break;
      
        default:
          console.log("æœªçŸ¥çš„éŸ³æ¨‚æŒ‡ä»¤:", data.command);
      }
    });

    // Cookie æ“ä½œå‡½æ•¸
    function setCookie(name, value, days = 30) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
  
    // BGM æ§åˆ¶
    const bgm = document.getElementById("bgm");
    const toggleBtn = document.getElementById("toggleSound");
    const volumeSlider = document.getElementById("volumeSlider");

    // å¾ cookie è®€å–è¨­å®šï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼
    const savedMuted = getCookie('bgm_muted');
    const savedVolume = getCookie('bgm_volume');
    
    let muted = savedMuted === 'true';
    const initialVolume = savedVolume ? parseFloat(savedVolume) : 0.05;

    // è¨­å®šåˆå§‹ç‹€æ…‹
    volumeSlider.value = initialVolume;
    toggleBtn.textContent = muted ? "ğŸ”‡" : "ğŸ”Š";

    // ç•¶éŸ³é »åŠ è¼‰å®Œæˆå¾Œè¨­ç½®éŸ³é‡å’ŒéœéŸ³ç‹€æ…‹
    bgm.addEventListener('loadeddata', () => {
      bgm.volume = initialVolume;
      bgm.muted = muted;
    });

    // ä¹Ÿå¯ä»¥åœ¨ canplay äº‹ä»¶ä¸­è¨­ç½®ï¼Œç¢ºä¿éŸ³é »å¯ä»¥æ’­æ”¾æ™‚å°±æœ‰æ­£ç¢ºè¨­å®š
    bgm.addEventListener('canplay', () => {
      bgm.volume = initialVolume;
      bgm.muted = muted;
    });
  
    toggleBtn.onclick = () => {
      muted = !muted;
      bgm.muted = muted;
      toggleBtn.textContent = muted ? "ğŸ”‡" : "ğŸ”Š";
      
      // å„²å­˜éœéŸ³ç‹€æ…‹åˆ° cookie
      setCookie('bgm_muted', muted);
    };
  
    volumeSlider.oninput = () => {
      bgm.volume = volumeSlider.value;
      
      // å„²å­˜éŸ³é‡åˆ° cookie
      setCookie('bgm_volume', volumeSlider.value);
    };
  
    function createParticles() {
      const container = document.getElementById("particles");
      const count = 50;
      for (let i = 0; i < count; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = Math.random() * 100 + "%";
        p.style.animationDelay = Math.random() * 6 + "s";
        p.style.animationDuration = (Math.random() * 3 + 3) + "s";
        container.appendChild(p);
      }
    }
  
    function startGame() {
      document.getElementById("startButton").style.display = "none";
      document.getElementById("loadingAnimation").style.display = "flex";
      
      // ç¢ºä¿éŸ³é‡å’ŒéœéŸ³ç‹€æ…‹è¨­ç½®æ­£ç¢º
      bgm.volume = volumeSlider.value;
      bgm.muted = muted;
      
      bgm.play().catch(() => {});
      setTimeout(() => {
        document.getElementById("loadingOverlay").classList.add("fade-out");
        setTimeout(() => {
          document.getElementById("gameContent").classList.add("show");
        }, 500);
      }, 2000);
    }
  
    const iframe = document.getElementById("mainFrame");
    const controlButtons = document.getElementById("controlButtons");
  
    function loadPage(page) {
      // ğŸµ æ ¹æ“šé é¢è‡ªå‹•åˆ‡æ›éŸ³æ¨‚
      if (page.includes("world_boss.html")) {
        switchMusic("worldBoss");
      } else if (page.includes("story.html")) { // ğŸ†• é€²å…¥æ•…äº‹é é¢ç«‹å³åˆ‡æ›éŸ³æ¨‚
        console.log("ğŸµ é€²å…¥æ•…äº‹é é¢ï¼Œåˆ‡æ›åˆ°æ•…äº‹éŸ³æ¨‚");
        switchMusic("story");
      } else if (page.includes("dungeon_layer") && currentBgm === "boss") {
        // ä¿æŒ boss éŸ³æ¨‚
      } else if (!page.includes("dungeon_layer") && 
                 !page.includes("story.html") && 
                 !page.includes("world_boss.html") && 
                 currentBgm !== "main") {
        // ğŸµ é›¢é–‹ç‰¹æ®Šé é¢æ™‚æ¢å¾©ä¸»éŸ³æ¨‚
        switchMusic("main");
      }
    
      iframe.src = page;
      updateTopbar(page);
    }
    window.loadPage = loadPage;
  
    function updateTopbar(pagePath) {
      controlButtons.innerHTML = "";
      
      if (pagePath.includes("world_boss")) {
        // ğŸ†• ä¸–ç•Œç‹é é¢å°ˆç”¨æŒ‰éˆ•
        controlButtons.innerHTML = `
          <button onclick="loadPage('main_page.html')">ğŸ”™ è¿”å›ä¸»é </button>
          <button onclick="refreshWorldBoss()">ğŸ”„ åˆ·æ–°æˆ°æ³</button>
          <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
        `;
      } else if (pagePath.includes("story") || pagePath.includes("upgrade") || pagePath.includes("inventory") || pagePath.includes("dungeons") || pagePath.includes("shop")) {
        controlButtons.innerHTML = `
          <button onclick="loadPage('main_page.html')">ğŸ”™ è¿”å›ä¸»é </button>
          <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
        `;
      } else if (pagePath.includes("dungeon_layer")) {
        controlButtons.innerHTML = `
          <button onclick="loadPage('dungeons.html')">ğŸ”™ é›¢é–‹å‰¯æœ¬</button>
          <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
        `;
      } else {
        controlButtons.innerHTML = `<button onclick="logout()">ğŸ”“ ç™»å‡º</button>`;
      }
    }

    // ğŸ†• ä¸–ç•Œç‹é é¢åˆ·æ–°åŠŸèƒ½
    window.refreshWorldBoss = function() {
      if (iframe.src.includes("world_boss.html")) {
        iframe.contentWindow.postMessage({ command: "forceRefresh" }, "*");
      }
    };
  
    iframe.addEventListener("load", () => {
      try {
        updateTopbar(iframe.contentWindow.location.pathname);
      } catch {
        updateTopbar(iframe.src);
      }
    });
  
    window.logout = function () {
      signOut(auth).then(() => {
        window.location.href = "/SFL/login.html";
      });
    };
  
    const userEmailSpan = document.getElementById("userEmail");
    window.addEventListener("message", (e) => {
      if (e.data?.nickname) {
        document.getElementById("userEmail").textContent = e.data.nickname;
      }
    });

    window.addEventListener("message", (e) => {
      if (e.data?.user) {
        currentUserInfo = e.data; // åŒ…å« nickname å’Œ user
        // æ›´æ–° topbar
        document.getElementById("userEmail").innerText = e.data.nickname || e.data.user;
      }
    });

    iframe.addEventListener("load", () => {
      try {
        updateTopbar(iframe.contentWindow.location.pathname);
      } catch {
        updateTopbar(iframe.src);
      }
    });
    
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "/SFL/login.html";
      }
    });
  
    document.addEventListener("DOMContentLoaded", () => {
      createParticles();
      updateTopbar("main_page.html");
      document.getElementById("startButton").addEventListener("click", startGame);
      loadPage("main_page.html");
    });

    // ğŸµ éŸ³æ¨‚é è¼‰å…¥
    function preloadMusic() {
      Object.entries(musicSources).forEach(([key, src]) => {
        if (key !== "main") { // ä¸»éŸ³æ¨‚å·²ç¶“é è¼‰å…¥äº†
          const audio = new Audio();
          audio.preload = "metadata";
          audio.src = src;
          console.log(`ğŸµ é è¼‰å…¥éŸ³æ¨‚ï¼š${key}`);
        }
      });
    }

    // åœ¨é©ç•¶æ™‚æ©Ÿé è¼‰å…¥éŸ³æ¨‚
    setTimeout(preloadMusic, 3000);

   // å˜—è©¦ä¿®å¾©æ‰‹æ©Ÿè¦–çª—
   function adjustMobileLayout() {
      // æª¢æŸ¥æ˜¯å¦ç‚ºç§»å‹•è¨­å‚™
      function isMobile() {
        return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      
      if (!isMobile()) return;
      
      const topbar = document.getElementById('topbar');
      const mainFrame = document.getElementById('mainFrame');
      const footer = document.getElementById('container-footer');
      
      if (!topbar || !mainFrame) return;
      
      // å‹•æ…‹è¨ˆç®— topbar çš„å¯¦éš›é«˜åº¦
      function calculateActualTopbarHeight() {
        // ç²å– topbar çš„å¯¦éš›æ¸²æŸ“é«˜åº¦
        const topbarRect = topbar.getBoundingClientRect();
        const actualHeight = topbarRect.height;
        
        // ç¢ºä¿æœ€å°é«˜åº¦
        const minHeight = window.innerWidth <= 480 ? 48 : 50;
        return Math.max(actualHeight, minHeight);
      }
      
      // èª¿æ•´ mainFrame ä½ç½®
      function adjustMainFrame() {
        const actualTopbarHeight = calculateActualTopbarHeight();
        const footerHeight = footer ? footer.offsetHeight : 40;
        
        // è¨­ç½® mainFrame çš„ top å’Œ height
        mainFrame.style.top = actualTopbarHeight + 'px';
        mainFrame.style.height = `calc(100vh - ${actualTopbarHeight}px - ${footerHeight}px)`;
        
        console.log(`èª¿æ•´å¾Œçš„ topbar é«˜åº¦: ${actualTopbarHeight}px`);
      }
      
      // åˆå§‹èª¿æ•´
      adjustMainFrame();
      
      // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(adjustMainFrame, 100);
      });
      
      // ç›£è½è¨­å‚™æ–¹å‘è®ŠåŒ–
      window.addEventListener('orientationchange', function() {
        setTimeout(adjustMainFrame, 300); // çµ¦ä¸€é»æ™‚é–“è®“ä½ˆå±€ç©©å®š
      });
      
      // é‡å° iframe å…§å®¹ä¹Ÿé€²è¡Œèª¿æ•´
      mainFrame.addEventListener('load', function() {
        try {
          const iframeDoc = mainFrame.contentDocument || mainFrame.contentWindow.document;
          const iframeContent = iframeDoc.getElementById('content');
          
          if (iframeContent) {
            // ç§»é™¤å¯èƒ½é€ æˆé–“éš™çš„ margin
            iframeContent.style.marginTop = '0';
            iframeContent.style.paddingTop = '10px';
            
            // ç¢ºä¿ iframe body æ²’æœ‰é¡å¤–çš„ margin
            const iframeBody = iframeDoc.body;
            if (iframeBody) {
              iframeBody.style.marginTop = '0';
              iframeBody.style.paddingTop = '0';
            }
          }
        } catch (e) {
          // è·¨åŸŸé™åˆ¶ï¼Œç„¡æ³•å­˜å– iframe å…§å®¹
          console.log('ç„¡æ³•å­˜å– iframe å…§å®¹ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶');
        }
      });
    }
    
    // DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', adjustMobileLayout);
    } else {
      adjustMobileLayout();
    }
    
    // ç‚ºäº†è™•ç†å‹•æ…‹è¼‰å…¥çš„å…§å®¹ï¼Œä¹Ÿå¯ä»¥åœ¨é©ç•¶æ™‚æ©Ÿæ‰‹å‹•èª¿ç”¨
    window.adjustMobileLayout = adjustMobileLayout;
    
    // é¡å¤–çš„è¼”åŠ©å‡½æ•¸ï¼šæª¢æ¸¬å’Œä¿®å¾©å¸¸è¦‹çš„ç§»å‹•ç«¯å•é¡Œ
    function fixMobileViewport() {
      // ç¢ºä¿ viewport è¨­ç½®æ­£ç¢º
      let viewport = document.querySelector('meta[name="viewport"]');
      if (!viewport) {
        viewport = document.createElement('meta');
        viewport.name = 'viewport';
        document.head.appendChild(viewport);
      }
      
      // è¨­ç½®é©åˆç§»å‹•è¨­å‚™çš„ viewport
      viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
      
      // é˜²æ­¢ iOS Safari çš„æ»¾å‹•åå½ˆ
      document.body.style.overflowX = 'hidden';
      
      // é˜²æ­¢é›™æ“Šç¸®æ”¾
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    }
    
    // åŸ·è¡Œç§»å‹•ç«¯ä¿®å¾©
    fixMobileViewport();
    
    // é‡å°ç‰¹å®šå•é¡Œçš„ä¿®å¾©
    function fixSpecificIssues() {
      // ä¿®å¾© iPhone Safari çš„ç‹€æ…‹åˆ—å•é¡Œ
      if (/iPhone|iPod/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent)) {
        // æª¢æŸ¥æ˜¯å¦ç‚ºå…¨å±æ¨¡å¼
        const isStandalone = window.navigator.standalone;
        const isFullScreen = window.innerHeight === screen.height;
        
        if (isStandalone || isFullScreen) {
          // å…¨å±æ¨¡å¼ä¸‹èª¿æ•´é ‚éƒ¨é–“è·
          document.body.style.paddingTop = '20px'; // ç‹€æ…‹åˆ—é«˜åº¦
        }
      }
      
      // ä¿®å¾© Android Chrome çš„åœ°å€åˆ—éš±è—å•é¡Œ
      if (/Android/.test(navigator.userAgent) && /Chrome/.test(navigator.userAgent)) {
        // ç›£è½è¦–çª—é«˜åº¦è®ŠåŒ–ï¼ˆé€šå¸¸æ˜¯åœ°å€åˆ—éš±è—/é¡¯ç¤ºï¼‰
        let initialHeight = window.innerHeight;
        window.addEventListener('resize', function() {
          if (Math.abs(window.innerHeight - initialHeight) > 100) {
            // é‡æ–°èª¿æ•´ä½ˆå±€
            setTimeout(adjustMobileLayout, 100);
          }
        });
      }
    }
    
    // åŸ·è¡Œç‰¹å®šä¿®å¾©
    setTimeout(fixSpecificIssues, 500);
  </script>
</body>
</html>
