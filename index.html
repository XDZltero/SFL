<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸»é </title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  
  <link href="css/style.css" rel="stylesheet"/></head>
</head>
<body>
  <div id="topbar">
    <span>ğŸ‘¤ ç©å®¶åç¨±ï¼š<span id="userNickname">è¼‰å…¥ä¸­...</span></span>
    <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
  </div>

  <script src="js/loading.js"></script>
  <div id="loading-placeholder"></div>
  <script>
  fetch("loadingOverlay.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("loading-placeholder").innerHTML = html;
      if (typeof startPageLoadingProgress === "function") {
        startPageLoadingProgress();
      }
    });
  </script>

  <h1>ä¸»ç•«é¢</h1>

  <pre id="statusBlock">æ­£åœ¨è¼‰å…¥è§’è‰²è³‡æ–™...</pre>

  <div>
    <button onclick="location.href='upgrade.html'">ğŸ§  æŠ€èƒ½èˆ‡å‡ç´šé é¢</button>
    <button onclick="location.href='inventory.html'">ğŸ’ èƒŒåŒ…èˆ‡è£å‚™ç®¡ç†</button>
  </div>

  <div>
    <h3>ï¼œå‰¯æœ¬ï¼</h3>
    <button onclick="location.href='dungeons.html'">ğŸ—¡ï¸ å‰å¾€å‰¯æœ¬å…¥å£</button>
    æ€ªç‰© IDï¼š<input id="monster_id" placeholder="è¼¸å…¥æ€ªç‰© ID" />
    <button onclick="goToBattle()">æˆ°é¬¥é–‹å§‹</button>
  </div>

  <!-- ğŸ”½ æ ¸å¿ƒé‚è¼¯æ”¹ç‚º module æ¨¡å¼ -->
  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    const statusBlock = document.getElementById("statusBlock");
    const loading = document.getElementById("loadingOverlay");
    const nicknameSpan = document.getElementById("userNickname");

    let levelExp = {};

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      if (!loading) return; // â›” å°šæœªè¼‰å…¥å°±ä¸è¦å‹•
      loading.style.display = show ? "flex" : "none";
    }

    function percent(val) {
      return Math.round(val * 100) + "%";
    }

    function calcTotal(base, equip) {
      return base + (equip || 0);
    }

    function formatStats(data) {
      const b = data.base_stats;
      const e = data.equipment_stats || {}; // è‹¥æœªä¾†æœ‰è£å‚™åŠ æˆå¯åŠ é€²ä¾†
      const total_hp = calcTotal(b.hp, e.hp);
      const total_atk = calcTotal(b.attack, e.attack);
      const total_shield = calcTotal(b.shield, e.shield);
      const total_luck = calcTotal(b.luck, e.luck);
      const total_accuracy = calcTotal(b.accuracy, e.accuracy);
      const total_evade = calcTotal(b.evade, e.evade);
      const levelMaxExp = levelExp[data.level] || 1;
      const progress = percent(data.exp / levelMaxExp);

      return `ç©å®¶åç¨±: ${data.nickname}
ç­‰ç´š: ${data.level}
ç¶“é©—å€¼: ${data.exp} (${progress})
ç”Ÿå‘½å€¼: ${total_hp} (${b.hp} + ${e.hp || 0})
æ”»æ“ŠåŠ›: ${total_atk} (${b.attack} + ${e.attack || 0})
è­·ç›¾å€¼: ${total_shield} (${b.shield} + ${e.shield || 0})
å¹¸é‹å€¼: ${total_luck} (${b.luck} + ${e.luck || 0})
å‘½ä¸­ç‡: ${percent(total_accuracy)} (${b.accuracy} + ${e.accuracy || 0})
è¿´é¿ç‡: ${percent(total_evade)} (${b.evade} + ${e.evade || 0})
æ”»æ“Šé€Ÿåº¦: ${b.atk_speed}
é¡å¤–å‚·å®³åŠ æˆ: ${b.other_bonus ?? 0}
å‰©é¤˜èƒ½åŠ›å€¼é»æ•¸: ${data.stat_points}
å‰©é¤˜æŠ€èƒ½é»: ${data.skill_points}`;
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = "/SFL/login.html";
      });
    }
    window.logout = logout;

    function goToBattle() {
      const user = firebase.auth().currentUser;
      const monster = document.getElementById("monster_id").value.trim();
      if (!user || !monster) {
        alert("è«‹è¼¸å…¥æ€ªç‰© ID");
        return;
      }
    
      window.location.href = `battle.html?user=${encodeURIComponent(user.email)}&monster=${encodeURIComponent(monster)}`;
    }
    
    // â¬…ï¸ è¨˜å¾—åŠ å…¥é€™è¡Œï¼è®“ HTML èƒ½å‘¼å«
    window.goToBattle = goToBattle;

    async function loadStatus() {
      showLoading(true);

      try {
        // å–å¾—ç­‰ç´šç¶“é©—è¡¨
        const expRes = await fetch("parameter/level_exp.json");
        levelExp = await expRes.json();

        const user = firebase.auth().currentUser;
        if (!user) {
          window.location.href = "/SFL/login.html";
          return;
        }

        const email = user.email;
        const res = await fetch(`${API_BASE}/status?user=${encodeURIComponent(email)}`);
        const data = await res.json();

        nicknameSpan.innerText = data.nickname || email;
        statusBlock.innerText = formatStats(data);
      } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—", err);
        statusBlock.innerText = "âŒ è¼‰å…¥è§’è‰²è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      } finally {
        showLoading(false);
      }
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) loadStatus();
      else window.location.href = "/SFL/login.html";
    });
  </script>
  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("footer-placeholder").innerHTML = html;
      })
      .catch(err => console.warn("è¼‰å…¥ footer å¤±æ•—", err));
  </script>
</body>
</html>
