<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>å‰¯æœ¬æˆ°é¬¥</title>
<link rel="icon" href="favicon.ico" />
<link href="css/style.css" rel="stylesheet"/>
<link href="css/dungeon_layer_winning.css" rel="stylesheet"/>
<link href="css/dungeon_layer.css" rel="stylesheet"/>
<style>
.section::before {
  animation: none !important;
  background: none !important;
}

/* å®Œå…¨é›¶é–“éš™çš„è©³ç´°èªªæ˜å®¹å™¨ */
.stat-item-container {
  position: relative;
  margin: 0;
  padding: 0;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0;
  padding: 8px 12px;
  background: rgba(0, 255, 255, 0.05);
  border: 1px solid rgba(0, 255, 255, 0.1);
  border-bottom: none; /* ç§»é™¤åº•éƒ¨é‚Šæ¡†é¿å…é‡è¤‡ */
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  font-size: 0.9em;
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
}

/* æœ€å¾Œä¸€å€‹é …ç›®æ·»åŠ åº•éƒ¨é‚Šæ¡† */
.stat-item-container:last-child .stat-item {
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

/* ç¬¬ä¸€å€‹é …ç›®çš„åœ“è§’ */
.stat-item-container:first-child .stat-item {
  border-radius: 6px 6px 0 0;
}

/* æœ€å¾Œä¸€å€‹é …ç›®çš„åœ“è§’ï¼ˆå¦‚æœæ²’æœ‰å±•é–‹è©³ç´°èªªæ˜ï¼‰ */
.stat-item-container:last-child .stat-item {
  border-radius: 0 0 6px 6px;
}

/* åªæœ‰ä¸€å€‹é …ç›®æ™‚çš„å®Œæ•´åœ“è§’ */
.stat-item-container:first-child:last-child .stat-item {
  border-radius: 6px;
}

.stat-item:hover {
  background: rgba(0, 255, 255, 0.1);
  border-color: rgba(0, 255, 255, 0.3);
  transform: translateX(2px);
  z-index: 2;
}

.stat-item span:first-child {
  color: #ffd93d;
  text-shadow: 0 0 5px rgba(255, 217, 61, 0.5);
  flex: 1;
}

.stat-item span:last-child {
  color: #00ffff;
  text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
  font-weight: 700;
  text-align: right;
}

/* å®Œå…¨é›¶é–“éš™çš„è©³ç´°èªªæ˜å®¹å™¨ */
.stat-detail {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  background: linear-gradient(135deg, rgba(0, 255, 255, 0.08), rgba(0, 255, 255, 0.02));
  border-left: 1px solid rgba(0, 255, 255, 0.1);
  border-right: 1px solid rgba(0, 255, 255, 0.1);
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
  margin: 0;
  padding: 0;
  border-top: none;
}

.stat-detail.expanded {
  max-height: 200px;
}

.stat-detail-content {
  padding: 10px 12px;
  font-size: 0.75em;
  color: #b8e6ff;
  line-height: 1.5;
  text-shadow: 0 0 3px rgba(184, 230, 255, 0.6);
  margin: 0;
  /* ç¢ºä¿å…§å®¹ä¸æœƒåœ¨æ”¶èµ·æ™‚é¡¯ç¤º */
  opacity: 0;
  transform: translateY(-8px);
  transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s;
}

.stat-detail.expanded .stat-detail-content {
  opacity: 1;
  transform: translateY(0);
}

/* æ€ªç‰©å±¬æ€§å®Œå…¨é›¶é–“éš™è¨­è¨ˆ */
.monster-stat-container {
  position: relative;
  margin: 0;
  padding: 0;
}

.monster-stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px;
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.2);
  border-bottom: none;
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  font-size: 0.85em;
  transition: all 0.3s ease;
  margin: 0;
  cursor: pointer;
}

/* æœ€å¾Œä¸€å€‹æ€ªç‰©é …ç›®æ·»åŠ åº•éƒ¨é‚Šæ¡† */
.monster-stat-container:last-child .monster-stat-item {
  border-bottom: 1px solid rgba(255, 107, 107, 0.2);
}

/* ç¬¬ä¸€å€‹æ€ªç‰©é …ç›®çš„åœ“è§’ */
.monster-stat-container:first-child .monster-stat-item {
  border-radius: 6px 6px 0 0;
}

/* æœ€å¾Œä¸€å€‹æ€ªç‰©é …ç›®çš„åœ“è§’ */
.monster-stat-container:last-child .monster-stat-item {
  border-radius: 0 0 6px 6px;
}

/* åªæœ‰ä¸€å€‹æ€ªç‰©é …ç›®æ™‚çš„å®Œæ•´åœ“è§’ */
.monster-stat-container:first-child:last-child .monster-stat-item {
  border-radius: 6px;
}

.monster-stat-item:hover {
  background: rgba(255, 107, 107, 0.2);
  border-color: rgba(255, 107, 107, 0.4);
  transform: translateX(2px);
  z-index: 2;
}

.monster-stat-item span:first-child {
  color: #ffd93d;
  text-shadow: 0 0 5px rgba(255, 217, 61, 0.5);
}

.monster-stat-item span:last-child {
  color: #fff8b0;
  text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
  font-weight: 700;
}

.monster-element-detail {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  background: linear-gradient(135deg, rgba(255, 107, 107, 0.08), rgba(255, 107, 107, 0.02));
  border-left: 1px solid rgba(255, 107, 107, 0.2);
  border-right: 1px solid rgba(255, 107, 107, 0.2);
  border-bottom: 1px solid rgba(255, 107, 107, 0.2);
  margin: 0;
  padding: 0;
  border-top: none;
}

.monster-element-detail.expanded {
  max-height: 300px;
}

.monster-element-detail-content {
  padding: 10px 12px;
  font-size: 0.8em;
  color: #ffd1d1;
  line-height: 1.5;
  text-shadow: 0 0 3px rgba(255, 209, 209, 0.3);
  white-space: pre-line;
  opacity: 0;
  transform: translateY(-8px);
  transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s;
}

.monster-element-detail.expanded .monster-element-detail-content {
  opacity: 1;
  transform: translateY(0);
}

/* BOSSæ¨¡å¼é©é… */
body.boss-mode .monster-stat-item {
  background: rgba(255, 69, 0, 0.15);
  border-color: rgba(255, 69, 0, 0.3);
}

body.boss-mode .monster-stat-item:hover {
  background: rgba(255, 69, 0, 0.25);
  border-color: rgba(255, 69, 0, 0.5);
}

body.boss-mode .monster-stat-item span:last-child {
  color: #ffd700;
  text-shadow: 0 0 6px rgba(255, 215, 0, 0.8);
}

body.boss-mode .monster-element-detail {
  background: linear-gradient(135deg, rgba(255, 69, 0, 0.1), rgba(255, 69, 0, 0.05));
  border-left-color: rgba(255, 69, 0, 0.3);
  border-right-color: rgba(255, 69, 0, 0.3);
  border-bottom-color: rgba(255, 69, 0, 0.3);
}

body.boss-mode .monster-element-detail-content {
  color: #ffb84d;
  text-shadow: 0 0 5px rgba(255, 184, 77, 0.4);
}

/* BOSSè£é£¾æ¨™é¡Œ */
.boss-title-decoration {
  text-align: center;
  font-size: 1.2em;
  font-weight: 900;
  color: #ff4500;
  text-shadow: 0 0 15px rgba(255, 69, 0, 0.8);
  margin-bottom: 8px;
  padding: 5px;
  background: linear-gradient(135deg, rgba(255, 69, 0, 0.1), rgba(255, 69, 0, 0.05));
  border-radius: 6px;
  border: 1px solid rgba(255, 69, 0, 0.3);
}

/* å±•é–‹æ§åˆ¶æŒ‰éˆ• */
.detail-toggle-btn {
  background: rgba(0, 255, 255, 0.1);
  border: 1px solid rgba(0, 255, 255, 0.3);
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 0.7em;
  color: #00ffff;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  white-space: nowrap;
  flex-shrink: 0;
}

.detail-toggle-btn:hover {
  background: rgba(0, 255, 255, 0.2);
  transform: scale(1.02);
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
}

.detail-toggle-btn.active {
  background: rgba(0, 255, 255, 0.25);
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  border-color: rgba(0, 255, 255, 0.6);
}

/* å±•é–‹æ™‚åœ“è§’è™•ç† - ä½¿ç”¨é¡åˆ¥æ§åˆ¶ */
.stat-item-container.has-expanded .stat-item {
  border-radius: 6px 6px 0 0 !important;
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.stat-detail.expanded {
  border-radius: 0 0 6px 6px;
  border-bottom: 1px solid rgba(0, 255, 255, 0.1);
}

.monster-stat-container.has-expanded .monster-stat-item {
  border-radius: 6px 6px 0 0 !important;
  border-bottom: 1px solid rgba(255, 107, 107, 0.2);
}

.monster-element-detail.expanded {
  border-radius: 0 0 6px 6px;
  border-bottom: 1px solid rgba(255, 107, 107, 0.2);
}

/* BOSSæ¨¡å¼ä¸‹çš„å±•é–‹æ¨£å¼ */
body.boss-mode .monster-stat-container.has-expanded .monster-stat-item {
  border-bottom-color: rgba(255, 69, 0, 0.3);
}

body.boss-mode .monster-element-detail.expanded {
  border-bottom-color: rgba(255, 69, 0, 0.3);
}

/* ç©å®¶ä¿¡æ¯å®¹å™¨é›¶é–“è· */
.player-info-container {
  margin: 0;
  padding: 0;
}

/* ç©å®¶åç¨±å’ŒæŒ‰éˆ•çš„å®¹å™¨ */
.player-name-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px 0;
  gap: 15px;
}

.player-name {
  color: #00ffff;
  text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
  font-family: 'Orbitron', sans-serif;
  font-size: 1.3em;
  margin: 0;
  flex: 1;
}

/* æ€ªç‰©ä¿¡æ¯å®¹å™¨é›¶é–“è· */
.monster-info-container {
  margin: 0;
  padding: 0;
}

.monster-name {
  color: #ff6b6b;
  text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
  text-align: center;
  margin: 10px 0;
  font-family: 'Orbitron', sans-serif;
  font-size: 1.3em;
}

.monster-image {
  display: block;
  margin: 10px auto;
  border-radius: 8px;
  border: 2px solid rgba(255, 107, 107, 0.3);
}

.monster-description {
  color: #ffd1d1;
  text-align: center;
  margin: 10px 0;
  padding: 10px;
  background: rgba(255, 107, 107, 0.05);
  border-radius: 6px;
  line-height: 1.4;
}

/* å®Œå…¨æ¶ˆé™¤æ‰€æœ‰é–“éš™ */
.stats-container > *,
.monster-stats > * {
  margin: 0;
  padding: 0;
}

.stats-container,
.monster-stats {
  margin: 0;
  padding: 0;
}

/* ç¢ºä¿å±•é–‹å…§å®¹ä¸æœƒå½±éŸ¿å…¶ä»–å…ƒç´  */
.stat-item-container,
.monster-stat-container {
  isolation: isolate;
  margin: 0;
  padding: 0;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
  .detail-toggle-btn {
    padding: 5px 8px;
    font-size: 0.6em;
  }
  
  .player-name-container {
    gap: 10px;
    margin: 8px 0;
  }
  
  .player-name {
    font-size: 1.1em;
  }
  
  .stat-detail-content,
  .monster-element-detail-content {
    font-size: 0.7em;
    padding: 8px 10px;
  }
  
  .stat-detail.expanded {
    max-height: 150px;
  }
  
  .monster-element-detail.expanded {
    max-height: 250px;
  }
  
  .stat-item,
  .monster-stat-item {
    padding: 6px 8px;
    font-size: 0.8em;
  }
  
  .monster-name {
    font-size: 1.1em;
    margin: 8px 0;
  }
}

/* è¶…å°è¢å¹•é©é… */
@media (max-width: 480px) {
  .player-name-container {
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  
  .detail-toggle-btn {
    width: auto;
    padding: 6px 10px;
    font-size: 0.65em;
  }
  
  .player-name {
    text-align: center;
    font-size: 1em;
  }
}
</style>
</head>
<body>
<!-- å‹åˆ©ç‰¹æ•ˆé®ç½© -->
<div id="victoryOverlay" class="victory-overlay">
  <div class="fireworks" id="fireworksContainer"></div>
  <div class="victory-content">
    <div class="victory-icon">ğŸ†</div>
    <div class="victory-title">Victory</div>
    <div class="victory-message">ğŸŒŸæˆåŠŸé€šé—œå‰¯æœ¬ğŸŒŸ</div>
    <button class="effect-button" onclick="hideVictoryEffect()">ç¹¼çºŒ</button>
  </div>
</div>

<!-- å¤±æ•—ç‰¹æ•ˆé®ç½© -->
<div id="defeatOverlay" class="defeat-overlay">
  <div class="debris" id="debrisContainer"></div>
  <div class="defeat-content">
    <div class="defeat-icon">ğŸ’€</div>
    <div class="defeat-title">æˆ°æ•—</div>
    <div class="defeat-message" id="defeatMessage">å¤±æ•—ä¹ƒæˆåŠŸä¹‹æ¯ï¼Œå†æ¥å†å²ï¼</div>
    <button class="effect-button" onclick="hideDefeatEffect()">ç¹¼çºŒ</button>
  </div>
</div>

<!-- é é¢è¼‰å…¥é®ç½© -->
<div id="loadingOverlay">
<div class="particles" id="pageParticles"></div>
<div class="battle-loading-container">
<div class="battle-icon">ğŸ°</div>
<div class="battle-title normal-title">é€²å…¥å‰¯æœ¬</div>
<div class="loading-text" id="pageLoadingText">æ­£åœ¨è¼‰å…¥å‰¯æœ¬è³‡æ–™...</div>
<div class="progress-container">
<div class="progress-bar" id="pageProgressBar"></div>
</div>
<div class="progress-text" id="pageProgressText">0%</div>
<div class="battle-tips">
        ğŸ—¡ï¸ å‡ç´šå¡ç‰‡é€šé—œæœƒæ›´å®¹æ˜“ï¼<br/>
        ğŸ“Š è¨˜å¾—é…ç½®èƒ½åŠ›é»èˆ‡æŠ€èƒ½ï¼
      </div>
</div>
</div>

<!-- æˆ°é¬¥è¼‰å…¥é®ç½© -->
<div id="battleLoadingOverlay">
<div class="particles" id="particles"></div>
<div class="battle-loading-container">
<div class="battle-icon" id="battleIcon">âš”ï¸</div>
<div class="battle-title" id="battleTitle">æˆ°é¬¥æº–å‚™ä¸­</div>
<div class="loading-text" id="loadingText">æ­£åœ¨åˆ†ææˆ°æ³...</div>
<div class="progress-container" id="progressContainer">
<div class="progress-bar" id="progressBar"></div>
</div>
<div class="progress-text" id="progressText">0%</div>
<div class="battle-tips" id="battleTips">
        ğŸ’¡ æˆ°é¬¥å°æç¤ºï¼šå–„ç”¨å±¬æ€§å…‹åˆ¶é—œä¿‚å¯ä»¥æé«˜å‹ç‡ï¼<br/>
        ğŸ›¡ï¸ è¨˜å¾—åˆ‡æ›ä¸åŒæŠ€èƒ½ä¾†æ‡‰å°ä¸åŒé—œå¡
      </div>
</div>
</div>

<div id="content">
<div class="section" id="userInfo">ğŸ§ è§’è‰²è³‡è¨Šè¼‰å…¥ä¸­...</div>
<div class="section" id="monsterInfo">ğŸ‘¹ æ€ªç‰©è³‡è¨Šè¼‰å…¥ä¸­...</div>
<div class="section"><strong>ğŸ“œ æˆ°é¬¥ç´€éŒ„</strong><pre id="logArea"></pre></div>
</div>

<div id="footer">
<button id="battleBtn" onclick="startBattle()">é–‹å§‹æˆ°é¬¥</button>
<button id="retryBtn" style="display:none" onclick="retryBattle()">å†æˆ°ä¸€æ¬¡</button>
<button id="nextBtn" style="display:none">ä¸‹ä¸€å±¤</button>
<button id="leaveBtn" onclick="leaveDungeon()" style="display:none">é›¢é–‹å‰¯æœ¬</button>
</div>

<script type="module">
import { auth, SecureAPI, PerformanceMonitor } from "./js/firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const API_BASE = "https://sfl-9cb8.onrender.com";

// å…¨å±€è®Šé‡
let currentDungeon = null;
let currentLayer = null;
let currentMonster = null;
let userStatus = null;
let dungeonData = null;
let detailsExpanded = false;

// è©³ç´°èªªæ˜ tooltips
const tooltips = {
  level: "è§’è‰²çš„ç•¶å‰ç­‰ç´šã€‚ç­‰ç´šå·®è·æœƒå½±éŸ¿æˆ°é¬¥å‚·å®³ï¼šæœ€å¤š7ç­‰å·®è·æ™‚å‚·å®³è®Šç‚º1.5å€æˆ–0.5å€ã€‚",
  exp: "è§’è‰²çš„ç¶“é©—å€¼èˆ‡å‡ç´šé€²åº¦ã€‚é€éæˆ°é¬¥ç²å¾—ç¶“é©—å€¼ï¼Œç´¯ç©è¶³å¤ ç¶“é©—å€¼å¾Œæœƒè‡ªå‹•å‡ç´šã€‚ä¸åŒæ€ªç‰©çµ¦äºˆçš„ç¶“é©—å€¼ä¸åŒï¼Œé«˜ç­‰ç´šæ€ªç‰©çµ¦äºˆæ›´å¤šç¶“é©—å€¼ã€‚",
  hp: "ç©å®¶çš„ç¸½ç”Ÿå‘½å€¼ï¼Œæ±ºå®šè§’è‰²çš„ç”Ÿå­˜èƒ½åŠ›ã€‚ç•¶ç”Ÿå‘½å€¼é™è‡³0æ™‚æˆ°é¬¥å¤±æ•—ã€‚",
  attack: "æ±ºå®šå°æ•µäººé€ æˆå‚·å®³çš„åŸºç¤æ•¸å€¼ã€‚æ”»æ“ŠåŠ›è¶Šé«˜ï¼Œå‚·å®³è¶Šå¤§ã€‚æœƒå—åˆ°å±¬æ€§å…‹åˆ¶ã€æŠ€èƒ½å€ç‡ã€ç­‰ç´šå·®è·ç­‰å› ç´ å½±éŸ¿ã€‚",
  shield: "æ¸›å°‘å—åˆ°å‚·å®³çš„é˜²è­·å€¼ã€‚æ¯é»è­·ç›¾å€¼æ¸›å°‘0.1%å‚·å®³ï¼Œæœ€å¤š99%ã€‚å¯é€éè­·ç›¾ç©¿é€é™ä½æ•ˆæœï¼Œæä¾›ç©©å®šçš„å‚·å®³æ¸›å…ã€‚",
  luck: "å½±éŸ¿è¿´é¿ç‡ã€ç‰©å“æ‰è½ç‡çš„å¹¸é‹å€¼ã€‚æ¯é»å¹¸é‹æä¾›é¡å¤–0.2%è¿´é¿ç‡åŠ æˆ(ä¸ç›´æ¥é¡¯ç¤ºåœ¨è¿´é¿ç‡ä¸Š)ï¼ŒåŒæ™‚æå‡ç‰©å“æ‰è½åŠé¡å¤–æ‰è½æ©Ÿç‡ã€‚",
  accuracy: "æ”»æ“Šå‘½ä¸­æ•µäººçš„æ©Ÿç‡ï¼Œæœƒèˆ‡æ•µäººè¿´é¿ç‡ç›¸æŠ—(å‘½ä¸­ç‡-è¿´é¿ç‡)ã€‚å‘½ä¸­ç‡ä¸è¶³æœƒå°è‡´å¤±å»æœ¬æ¬¡æ”»æ“Šå‚·å®³ã€‚",
  evade: "é–ƒé¿æ•µäººæ”»æ“Šçš„æ©Ÿç‡ï¼Œæ•¸å€¼è¶Šé«˜è¶Šå®¹æ˜“å®Œå…¨ç„¡è¦–æ•µäººçš„æ”»æ“Šï¼Œæœ€é«˜99%ã€‚è¿´é¿æˆåŠŸæ™‚å®Œå…¨ç„¡è¦–è©²æ¬¡æ”»æ“Šå‚·å®³ã€‚",
  atk_speed: "æ±ºå®šæˆ°é¬¥ä¸­çš„å‡ºæ‰‹é †åºèˆ‡é »ç‡ã€‚æ”»æ“Šé€Ÿåº¦é«˜çš„ä¸€æ–¹æœƒå„ªå…ˆè¡Œå‹•ï¼Œä¸¦å¯èƒ½åœ¨ä¸€å›åˆå…§é€²è¡Œå¤šæ¬¡æ”»æ“Šã€‚é€Ÿåº¦å·®è·è¶Šå¤§ï¼Œå„ªå‹¢æ–¹çš„è¡Œå‹•æ¬¡æ•¸è¶Šå¤šã€‚ä¸¦ä¸”é€²è€ŒåŠ å¿«æŠ€èƒ½å†·å»å›åˆã€‚",
  other_bonus: "é¡å¤–å‚·å®³åŠ æˆï¼ŒæŒ‰ç™¾åˆ†æ¯”å¢åŠ æœ€çµ‚å‚·å®³ã€‚é€™æ˜¯ä¸€å€‹å€ç‡åŠ æˆï¼Œæœƒåœ¨æ‰€æœ‰å…¶ä»–è¨ˆç®—å®Œæˆå¾Œå¥—ç”¨ã€‚",
  penetrate: "ç„¡è¦–æ•µäººè­·ç›¾å€¼çš„èƒ½åŠ›ã€‚ç©¿é€å€¼æœƒç›´æ¥æ‰£é™¤æ•µäººçš„æœ‰æ•ˆè­·ç›¾å€¼ï¼Œæ˜¯çªç ´é«˜é˜²ç¦¦æ•µäººçš„é—œéµå±¬æ€§ã€‚æ¯é»ç©¿é€å¯ç„¡è¦–1é»æ•µäººè­·ç›¾ã€‚",
  stat_points: "å¯ç”¨æ–¼æå‡åŸºç¤èƒ½åŠ›å€¼çš„é»æ•¸ã€‚æ¯å‡ç´šç²å¾—5é»ã€‚å¯åˆ†é…åˆ°ç”Ÿå‘½å€¼(+5/é»)ã€æ”»æ“ŠåŠ›(+1/é»)æˆ–å¹¸é‹å€¼(+1/é»)ã€‚",
  skill_points: "å¯ç”¨æ–¼å‡ç´šæŠ€èƒ½çš„é»æ•¸ã€‚æ¯å‡ç´šç²å¾—3é»ã€‚"
};

// URL åƒæ•¸è§£æ
function getURLParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    dungeon: params.get("dungeon"),
    layer: params.get("layer")
  };
}

// å·¥å…·å‡½æ•¸
function percent(val) {
  return (val * 100).toFixed(1) + '%';
}

function showLoading(show) {
  const loading = document.getElementById("loadingOverlay");
  if (loading) loading.style.display = show ? "flex" : "none";
}

function showBattleLoading(show, isBoss = false) {
  const battleLoading = document.getElementById("battleLoadingOverlay");
  if (!battleLoading) return;
  
  battleLoading.style.display = show ? "flex" : "none";
  
  if (show) {
    battleLoading.className = isBoss ? "boss-battle" : "";
    const title = document.getElementById("battleTitle");
    const icon = document.getElementById("battleIcon");
    const tips = document.getElementById("battleTips");
    
    if (isBoss) {
      if (title) title.textContent = "BOSSæˆ°é¬¥æº–å‚™ä¸­";
      if (icon) icon.textContent = "ğŸ‘‘";
      if (tips) tips.innerHTML = "âš”ï¸ BOSSæˆ°é¬¥å³å°‡é–‹å§‹ï¼<br/>ğŸ”¥ é‹ç”¨ä½ çš„æœ€å¼·æŠ€èƒ½çµ„åˆï¼";
      title?.classList.add("boss");
      icon?.classList.add("boss");
      tips?.classList.add("boss");
    } else {
      if (title) title.textContent = "æˆ°é¬¥æº–å‚™ä¸­";
      if (icon) icon.textContent = "âš”ï¸";
      if (tips) tips.innerHTML = "ğŸ’¡ æˆ°é¬¥å°æç¤ºï¼šå–„ç”¨å±¬æ€§å…‹åˆ¶é—œä¿‚å¯ä»¥æé«˜å‹ç‡ï¼<br/>ğŸ›¡ï¸ è¨˜å¾—åˆ‡æ›ä¸åŒæŠ€èƒ½ä¾†æ‡‰å°ä¸åŒé—œå¡";
      title?.classList.remove("boss");
      icon?.classList.remove("boss");
      tips?.classList.remove("boss");
    }
  }
}

const elementMap = {
  "none": "ç„¡",
  "phy": "ç‰©ç†", 
  "pyro": "ç«",
  "hydro": "æ°´",
  "electro": "é›·",
  "nature": "è‡ªç„¶",
  "light": "å…‰",
  "dark": "æš—",
  "all": "å…¨"
};

// å±¬æ€§å…‹åˆ¶èªªæ˜ç”Ÿæˆ
function generateElementDescription(elements) {
  const descriptions = [];
  
  elements.forEach(element => {
    switch(element) {
      case "pyro":
      case "ç«":
        descriptions.push("ğŸ”¥ ç«å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼šæ°´å±¬æ€§ã€å…¨å±¬æ€§ (+25% å‚·å®³)");
        descriptions.push("åŠ£å‹¢ï¼šè‡ªç„¶å±¬æ€§ (-25% å‚·å®³)");
        break;
      case "hydro":
      case "æ°´":
        descriptions.push("ğŸ’§ æ°´å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼š é›·å±¬æ€§ã€å…¨å±¬æ€§ (+25% å‚·å®³)");
        descriptions.push("åŠ£å‹¢ï¼š ç«å±¬æ€§ (-25% å‚·å®³)");
        break;
      case "electro":
      case "é›·":
        descriptions.push("âš¡ é›·å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼šè‡ªç„¶å±¬æ€§ã€å…¨å±¬æ€§ (+25% å‚·å®³)");
        descriptions.push("åŠ£å‹¢ï¼šæ°´å±¬æ€§ (-25% å‚·å®³)");
        break;
      case "nature":
      case "è‡ªç„¶":
        descriptions.push("ğŸŒ¿ è‡ªç„¶å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼šç«å±¬æ€§ã€å…¨å±¬æ€§ (+25% å‚·å®³)");
        descriptions.push("åŠ£å‹¢ï¼šé›·å±¬æ€§ (-25% å‚·å®³)");
        break;
      case "light":
      case "å…‰":
        descriptions.push("âœ¨ å…‰å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼šæš—å±¬æ€§ã€å…¨å±¬æ€§ (+25% å‚·å®³)");
        break;
      case "dark":
      case "æš—":
        descriptions.push("ğŸŒ‘ æš—å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼šå…‰å±¬æ€§ã€å…¨å±¬æ€§ (+25% å‚·å®³)");
        break;
      case "all":
      case "å…¨":
        descriptions.push("ğŸŒŸ å…¨å±¬æ€§");
        descriptions.push("  â”” åŠ£å‹¢ï¼šå…¶ä»–å±¬æ€§ (-25% å‚·å®³)");
        break;
      case "none":
      case "ç„¡":
        descriptions.push("âšª ç„¡å±¬æ€§");
        descriptions.push("å„ªå‹¢ï¼šå…¨å±¬æ€§ (+25% å‚·å®³)");
        break;
      default:
        descriptions.push(`${elementMap[element] || element}å±¬æ€§`);
    }
  });
  
  if (elements.length > 1) {
    descriptions.push("");
    descriptions.push("ã€è¤‡æ•¸å±¬æ€§æ©Ÿåˆ¶ã€‘");
    descriptions.push("â€¢ æ“æœ‰å¤šå€‹å±¬æ€§æ™‚ï¼Œå‚·å®³è¨ˆç®—å°‡å–æ‰€æœ‰å±¬æ€§å…‹åˆ¶é—œä¿‚å¹³å‡å€¼");
    descriptions.push("â€¢ ä¾‹å¦‚ï¼šç«æ°´é›™å±¬æ€§æ€ªç‰©è¢«é›·å±¬æ€§æ”»æ“Šæ™‚");
    descriptions.push("  - é›·â†’ç«ï¼š100%å‚·å®³(ç„¡å…‹åˆ¶)");
    descriptions.push("  - é›·â†’æ°´ï¼š125%å‚·å®³(å…‹åˆ¶)");
    descriptions.push("  - æœ€çµ‚å‚·å®³ï¼š(100% + 125%) Ã· 2 = 112.5%");
  }
  
  return descriptions.join("\n");
}

// è©³ç´°èªªæ˜å±•é–‹/æ”¶èµ·æ§åˆ¶
function toggleDetails() {
  detailsExpanded = !detailsExpanded;
  const button = document.querySelector('.detail-toggle-btn');
  
  if (button) {
    button.textContent = detailsExpanded ? 'æ”¶èµ·è©³ç´°èªªæ˜' : 'é¡¯ç¤ºè©³ç´°èªªæ˜';
    button.classList.toggle('active', detailsExpanded);
  }
  
  // æ§åˆ¶ç©å®¶è©³ç´°èªªæ˜
  const playerDetails = document.querySelectorAll('.stat-detail');
  const playerContainers = document.querySelectorAll('.stat-item-container');
  
  playerDetails.forEach((detail, index) => {
    detail.classList.toggle('expanded', detailsExpanded);
    // ç‚ºåŒ…å«è©³ç´°èªªæ˜çš„å®¹å™¨æ·»åŠ é¡åˆ¥
    if (playerContainers[index] && detail.querySelector('.stat-detail-content')) {
      playerContainers[index].classList.toggle('has-expanded', detailsExpanded);
    }
  });
  
  // æ§åˆ¶æ€ªç‰©å±¬æ€§è©³ç´°èªªæ˜
  const monsterDetail = document.querySelector('.monster-element-detail');
  const monsterContainer = monsterDetail?.closest('.monster-stat-container');
  
  if (monsterDetail) {
    monsterDetail.classList.toggle('expanded', detailsExpanded);
    if (monsterContainer) {
      monsterContainer.classList.toggle('has-expanded', detailsExpanded);
    }
  }
}

// è¨­å®šå…¨åŸŸå‡½æ•¸
window.toggleDetails = toggleDetails;

// æ ¼å¼åŒ–ç©å®¶ç‹€æ…‹
function formatStats(data) {
  const b = data.base_stats;
  const e = data.equipment_bonus || {};
  
  const getValue = (key) => (b[key] || 0) + (e[key] || 0);
  const getFormatted = (key) => {
    const isPercent = ["evade", "accuracy", "other_bonus"].includes(key);
    const total = getValue(key);
    const base = b[key] || 0;
    const bonus = e[key] || 0;
    
    if (isPercent) {
      return {
        total: `${percent(total)}`,
        detail: `${percent(base)} + ${percent(bonus)}`
      };
    } else {
      return {
        total: total.toString(),
        detail: `${base} + ${bonus}`
      };
    }
  };

  const statsList = [
    { key: "level", label: "ç­‰ç´š", value: data.level },
    { key: "exp", label: "ç¶“é©—å€¼", value: `${data.exp}` },
    { key: "hp", label: "ç”Ÿå‘½å€¼" },
    { key: "attack", label: "æ”»æ“ŠåŠ›" },
    { key: "shield", label: "è­·ç›¾å€¼" },
    { key: "luck", label: "å¹¸é‹å€¼" },
    { key: "accuracy", label: "å‘½ä¸­ç‡" },
    { key: "evade", label: "è¿´é¿ç‡" },
    { key: "atk_speed", label: "æ”»æ“Šé€Ÿåº¦" },
    { key: "other_bonus", label: "é¡å¤–å‚·å®³åŠ æˆ" },
    { key: "penetrate", label: "è­·ç›¾ç©¿é€" },
    { key: "stat_points", label: "å‰©é¤˜èƒ½åŠ›å€¼é»æ•¸", value: data.stat_points },
    { key: "skill_points", label: "å‰©é¤˜æŠ€èƒ½é»", value: data.skill_points }
  ];

  let html = `
    <div class="player-info-container">
      <div class="player-name-container">
        <h3 class="player-name">ğŸ‘¤ ${data.nickname}</h3>
        <button class="detail-toggle-btn" onclick="toggleDetails()">${detailsExpanded ? 'æ”¶èµ·è©³ç´°èªªæ˜' : 'é¡¯ç¤ºè©³ç´°èªªæ˜'}</button>
      </div>
      <div class="stats-container">
  `;
  
  statsList.forEach(({ key, label, value }) => {
    html += `<div class="stat-item-container">`;
    
    if (value !== undefined) {
      html += `<div class="stat-item">
                 <span>${label}:</span>
                 <span>${value}</span>
               </div>`;
    } else if (["hp", "attack", "shield", "penetrate", "luck", "accuracy", "evade", "atk_speed", "other_bonus"].includes(key)) {
      const formatted = getFormatted(key);
      html += `<div class="stat-item">
                 <span>${label}:</span>
                 <span>${formatted.total} (${formatted.detail})</span>
               </div>`;
    }
    
    if (tooltips[key]) {
      html += `<div class="stat-detail ${detailsExpanded ? 'expanded' : ''}">
                 <div class="stat-detail-content">${tooltips[key]}</div>
               </div>`;
    }
    
    html += `</div>`;
  });
  
  html += `
      </div>
    </div>`;
  return html;
}

// æ ¼å¼åŒ–æ€ªç‰©è³‡è¨Š
function formatMonsterInfo(mon, isLastLayer) {
  const description = (mon.info || '').replace(/\/n/g, '\n');
  
  const elementText = Array.isArray(mon.element) 
    ? mon.element.map(e => elementMap[e] || e).join("ã€") 
    : (elementMap[mon.element] || mon.element);

  let containerClass = "monster-info-container";
  let bossTitle = "";
  
  if (isLastLayer) {
    containerClass += " boss";
    bossTitle = '<div class="boss-title-decoration">BOSS</div>';
  }

  const monsterPenetrate = mon.stats.penetrate || 0;
  const elements = Array.isArray(mon.element) ? mon.element : [mon.element];
  const elementDescription = generateElementDescription(elements);

  const html = `
    <div class="${containerClass}">
      ${bossTitle}
      <h2 class="monster-name">${mon.name}</h2>
      <img src="${mon.image_url}" class="monster-image" width="200">
      <div class="monster-description">${description}</div>
      <div class="monster-stats">
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>ç­‰ç´šï¼š</span>
            <span>${mon.level}</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>å±¬æ€§ï¼š</span>
            <span>${elementText}</span>
          </div>
          <div class="monster-element-detail ${detailsExpanded ? 'expanded' : ''}">
            <div class="monster-element-detail-content">${elementDescription}</div>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>ç”Ÿå‘½å€¼ï¼š</span>
            <span>${mon.stats.hp}</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>æ”»æ“ŠåŠ›ï¼š</span>
            <span>${mon.stats.attack}</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>è­·ç›¾å€¼ï¼š</span>
            <span>${mon.stats.shield}</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>å‘½ä¸­ç‡ï¼š</span>
            <span>${Math.round(mon.stats.accuracy * 100)}%</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>è¿´é¿ç‡ï¼š</span>
            <span>${Math.round(mon.stats.evade * 100)}%</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>æ”»æ“Šé€Ÿåº¦ï¼š</span>
            <span>${mon.stats.atk_speed}</span>
          </div>
        </div>
        <div class="monster-stat-container">
          <div class="monster-stat-item">
            <span>è­·ç›¾ç©¿é€ï¼š</span>
            <span>${monsterPenetrate}</span>
          </div>
        </div>
      </div>
    </div>
  `;
  
  return html;
}

// è¼‰å…¥å‰¯æœ¬è³‡æ–™
async function loadDungeonData() {
  try {
    const response = await fetch("parameter/dungeons.json");
    dungeonData = await response.json();
    return dungeonData;
  } catch (error) {
    console.error("è¼‰å…¥å‰¯æœ¬è³‡æ–™å¤±æ•—:", error);
    throw error;
  }
}

// è¼‰å…¥ä½¿ç”¨è€…ç‹€æ…‹
async function loadUserStatus() {
  try {
    const response = await SecureAPI.get(`${API_BASE}/status`);
    userStatus = await response.json();
    return userStatus;
  } catch (error) {
    console.error("è¼‰å…¥ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—:", error);
    throw error;
  }
}

// è¼‰å…¥æ€ªç‰©è³‡æ–™
async function loadMonster(monsterId) {
  try {
    const response = await SecureAPI.get(`${API_BASE}/monster?id=${monsterId}`);
    currentMonster = await response.json();
    return currentMonster;
  } catch (error) {
    console.error("è¼‰å…¥æ€ªç‰©è³‡æ–™å¤±æ•—:", error);
    throw error;
  }
}

// æˆ°é¬¥å‡½æ•¸
async function startBattle() {
  if (!currentMonster || !userStatus) {
    alert("æˆ°é¬¥è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™");
    return;
  }

  const isLastLayer = parseInt(currentLayer) === dungeonData.find(d => d.id === currentDungeon).monsters.length;
  
  showBattleLoading(true, isLastLayer);
  
  // æ¨¡æ“¬æˆ°é¬¥è¼‰å…¥éç¨‹
  await new Promise(resolve => {
    let progress = 0;
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    
    const interval = setInterval(() => {
      progress += Math.random() * 15 + 5;
      if (progress > 100) progress = 100;
      
      if (progressBar) progressBar.style.width = progress + "%";
      if (progressText) progressText.textContent = Math.round(progress) + "%";
      
      if (progress >= 100) {
        clearInterval(interval);
        resolve();
      }
    }, 100);
  });

  try {
    const response = await SecureAPI.post(`${API_BASE}/battle_dungeon`, {
      dungeon: currentDungeon,
      layer: parseInt(currentLayer)
    });
    
    const result = await response.json();
    
    showBattleLoading(false);
    
    if (response.ok) {
      handleBattleResult(result);
    } else {
      alert(result.error || "æˆ°é¬¥å¤±æ•—");
    }
  } catch (error) {
    showBattleLoading(false);
    console.error("æˆ°é¬¥éŒ¯èª¤:", error);
    alert("æˆ°é¬¥éç¨‹ç™¼ç”ŸéŒ¯èª¤");
  }
}

// è™•ç†æˆ°é¬¥çµæœ
function handleBattleResult(result) {
  const logArea = document.getElementById("logArea");
  if (logArea && result.battle_log) {
    // ä¿®å¾©ï¼šæ­£ç¢ºè™•ç†æˆ°é¬¥ç´€éŒ„ï¼Œé¿å… [object object] é¡¯ç¤º
    if (Array.isArray(result.battle_log)) {
      logArea.textContent = result.battle_log.join('\n');
    } else if (typeof result.battle_log === 'string') {
      logArea.textContent = result.battle_log;
    } else {
      logArea.textContent = JSON.stringify(result.battle_log, null, 2);
    }
  }

  const battleBtn = document.getElementById("battleBtn");
  const retryBtn = document.getElementById("retryBtn");
  const nextBtn = document.getElementById("nextBtn");
  const leaveBtn = document.getElementById("leaveBtn");

  if (result.success) {
    // ä¿®å¾©ï¼šåªæœ‰BOSSé—œå¡å‹åˆ©æ‰é¡¯ç¤ºå‹åˆ©ç‰¹æ•ˆ
    if (result.is_last_layer) {
      showVictoryEffect();
    }
    
    if (battleBtn) battleBtn.style.display = "none";
    if (retryBtn) retryBtn.style.display = "none";
    
    if (result.is_last_layer) {
      // BOSSé—œå¡å®Œæˆ
      if (nextBtn) {
        nextBtn.textContent = "è¿”å›å‰¯æœ¬åˆ—è¡¨";
        nextBtn.onclick = () => window.parent.loadPage("dungeons.html");
        nextBtn.style.display = "inline-block";
      }
    } else {
      // æ™®é€šé—œå¡å®Œæˆï¼Œå¯é€²å…¥ä¸‹ä¸€å±¤
      if (nextBtn) {
        nextBtn.textContent = "ä¸‹ä¸€å±¤";
        nextBtn.onclick = () => {
          const nextLayer = parseInt(currentLayer) + 1;
          window.parent.loadPage(`dungeon_layer.html?dungeon=${currentDungeon}&layer=${nextLayer}`);
        };
        nextBtn.style.display = "inline-block";
      }
    }
    
    if (leaveBtn) leaveBtn.style.display = "inline-block";
    
    // æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹
    if (result.user) {
      userStatus = result.user;
      document.getElementById("userInfo").innerHTML = formatStats(userStatus);
      
      // é‡æ–°æ‡‰ç”¨å±•é–‹ç‹€æ…‹
      setTimeout(() => {
        if (detailsExpanded) {
          const playerContainers = document.querySelectorAll('.stat-item-container');
          const playerDetails = document.querySelectorAll('.stat-detail');
          
          playerDetails.forEach((detail, index) => {
            if (detail.classList.contains('expanded') && playerContainers[index]) {
              playerContainers[index].classList.add('has-expanded');
            }
          });
        }
      }, 50);
    }
    
  } else {
    // æˆ°é¬¥å¤±æ•—
    showDefeatEffect();
    
    if (battleBtn) battleBtn.style.display = "none";
    if (retryBtn) retryBtn.style.display = "inline-block";
    if (nextBtn) nextBtn.style.display = "none";
    if (leaveBtn) leaveBtn.style.display = "inline-block";
  }
}

// é‡è©¦æˆ°é¬¥
function retryBattle() {
  const battleBtn = document.getElementById("battleBtn");
  const retryBtn = document.getElementById("retryBtn");
  const nextBtn = document.getElementById("nextBtn");
  const leaveBtn = document.getElementById("leaveBtn");
  
  if (battleBtn) battleBtn.style.display = "inline-block";
  if (retryBtn) retryBtn.style.display = "none";
  if (nextBtn) nextBtn.style.display = "none";
  if (leaveBtn) leaveBtn.style.display = "none";
  
  // æ¸…ç©ºæˆ°é¬¥è¨˜éŒ„
  const logArea = document.getElementById("logArea");
  if (logArea) logArea.textContent = "";
}

// é›¢é–‹å‰¯æœ¬
function leaveDungeon() {
  window.parent.loadPage("dungeons.html");
}

// ç‰¹æ•ˆå‡½æ•¸
function showVictoryEffect() {
  const overlay = document.getElementById("victoryOverlay");
  if (overlay) {
    overlay.style.display = "flex";
    createFireworks();
  }
}

function hideVictoryEffect() {
  const overlay = document.getElementById("victoryOverlay");
  if (overlay) overlay.style.display = "none";
}

function showDefeatEffect() {
  const overlay = document.getElementById("defeatOverlay");
  if (overlay) {
    overlay.style.display = "flex";
    createDebris();
  }
}

function hideDefeatEffect() {
  const overlay = document.getElementById("defeatOverlay");
  if (overlay) overlay.style.display = "none";
}

// ç…™ç«æ•ˆæœ
function createFireworks() {
  const container = document.getElementById("fireworksContainer");
  if (!container) return;
  
  container.innerHTML = "";
  
  for (let i = 0; i < 10; i++) {
    setTimeout(() => {
      const firework = document.createElement("div");
      firework.className = "firework";
      firework.style.left = Math.random() * 100 + "%";
      firework.style.top = Math.random() * 100 + "%";
      container.appendChild(firework);
      
      setTimeout(() => {
        if (firework.parentNode) {
          firework.parentNode.removeChild(firework);
        }
      }, 2000);
    }, i * 200);
  }
}

// ç¢ç‰‡æ•ˆæœ
function createDebris() {
  const container = document.getElementById("debrisContainer");
  if (!container) return;
  
  container.innerHTML = "";
  
  for (let i = 0; i < 15; i++) {
    const debris = document.createElement("div");
    debris.className = "debris-piece";
    debris.style.left = Math.random() * 100 + "%";
    debris.style.animationDelay = Math.random() * 2 + "s";
    container.appendChild(debris);
  }
}

// è¨­å®šå…¨åŸŸå‡½æ•¸
window.startBattle = startBattle;
window.retryBattle = retryBattle;
window.leaveDungeon = leaveDungeon;
window.hideVictoryEffect = hideVictoryEffect;
window.hideDefeatEffect = hideDefeatEffect;

// åˆå§‹åŒ–
async function initDungeonLayer() {
  showLoading(true);
  
  try {
    const params = getURLParams();
    currentDungeon = params.dungeon;
    currentLayer = params.layer;
    
    if (!currentDungeon || currentLayer === null) {
      throw new Error("ç¼ºå°‘å‰¯æœ¬åƒæ•¸");
    }
    
    // ä¸¦è¡Œè¼‰å…¥è³‡æ–™
    await Promise.all([
      loadDungeonData(),
      loadUserStatus()
    ]);
    
    // æ‰¾åˆ°å°æ‡‰çš„å‰¯æœ¬
    const dungeon = dungeonData.find(d => d.id === currentDungeon);
    if (!dungeon) {
      throw new Error("æ‰¾ä¸åˆ°æŒ‡å®šå‰¯æœ¬");
    }
    
    // ç¢ºå®šæ€ªç‰©ID
    const layerIndex = parseInt(currentLayer);
    const isLastLayer = layerIndex === dungeon.monsters.length;
    const monsterId = isLastLayer ? dungeon.bossId : dungeon.monsters[layerIndex];
    
    if (!monsterId) {
      throw new Error("æ‰¾ä¸åˆ°å°æ‡‰å±¤æ•¸çš„æ€ªç‰©");
    }
    
    // è¼‰å…¥æ€ªç‰©è³‡æ–™
    await loadMonster(monsterId);
    
    // è¨­å®šBOSSæ¨¡å¼
    if (isLastLayer) {
      document.body.classList.add("boss-mode");
      
      // é€šçŸ¥çˆ¶æ¡†æ¶åˆ‡æ›éŸ³æ¨‚
      window.parent.postMessage({
        command: "switchToBossMusic"
      }, "*");
    }
    
    // æ¸²æŸ“ä»‹é¢
    document.getElementById("userInfo").innerHTML = formatStats(userStatus);
    document.getElementById("monsterInfo").innerHTML = formatMonsterInfo(currentMonster, isLastLayer);
    
    // ç¢ºä¿æ­£ç¢ºæ‡‰ç”¨å±•é–‹ç‹€æ…‹
    setTimeout(() => {
      const playerContainers = document.querySelectorAll('.stat-item-container');
      const playerDetails = document.querySelectorAll('.stat-detail');
      
      playerDetails.forEach((detail, index) => {
        if (detail.classList.contains('expanded') && playerContainers[index]) {
          playerContainers[index].classList.add('has-expanded');
        }
      });
      
      const monsterDetail = document.querySelector('.monster-element-detail');
      const monsterContainer = monsterDetail?.closest('.monster-stat-container');
      
      if (monsterDetail?.classList.contains('expanded') && monsterContainer) {
        monsterContainer.classList.add('has-expanded');
      }
    }, 50);
    
  } catch (error) {
    console.error("åˆå§‹åŒ–å¤±æ•—:", error);
    alert("è¼‰å…¥å‰¯æœ¬å¤±æ•—ï¼š" + error.message);
    window.parent.loadPage("dungeons.html");
  } finally {
    showLoading(false);
  }
}

// ç›£è½ç™»å…¥ç‹€æ…‹
onAuthStateChanged(auth, (user) => {
  if (user) {
    initDungeonLayer();
  } else {
    window.parent.location.href = "/SFL/login.html";
  }
});

// é é¢è¼‰å…¥ç²’å­æ•ˆæœ
function createPageParticles() {
  const particlesContainer = document.getElementById("pageParticles");
  if (!particlesContainer) return;
  particlesContainer.innerHTML = "";
  for (let i = 0; i < 30; i++) {
    const particle = document.createElement("div");
    particle.className = "particle";
    particle.style.left = Math.random() * 100 + "%";
    particle.style.animationDelay = Math.random() * 4 + "s";
    particle.style.animationDuration = (Math.random() * 2 + 3) + "s";
    particle.style.background = `rgba(${Math.random() > 0.5 ? '56, 239, 125' : '17, 153, 142'}, 0.7)`;
    particlesContainer.appendChild(particle);
  }
}

function startPageLoadingProgress() {
  const progressBar = document.getElementById("pageProgressBar");
  const progressText = document.getElementById("pageProgressText");
  const loadingText = document.getElementById("pageLoadingText");
  if (!progressBar || !progressText || !loadingText) return;

  const messages = [
    "æ­£åœ¨è¼‰å…¥å‰¯æœ¬è³‡æ–™...",
    "ç²å–ç©å®¶ç‹€æ…‹...",
    "è¼‰å…¥æ€ªç‰©è³‡è¨Š...",
    "æº–å‚™æˆ°é¬¥ç’°å¢ƒ...",
    "è¼‰å…¥å®Œæˆï¼"
  ];

  let progress = 0;
  let messageIndex = 0;
  const progressInterval = setInterval(() => {
    progress += Math.random() * 20 + 10;
    if (progress > 100) progress = 100;

    progressBar.style.width = progress + "%";
    progressText.textContent = Math.round(progress) + "%";

    if (messageIndex < messages.length - 1 && progress > (messageIndex + 1) * 20) {
      messageIndex++;
      loadingText.textContent = messages[messageIndex];
    }

    if (progress >= 100) {
      clearInterval(progressInterval);
      loadingText.textContent = messages[messages.length - 1];
    }
  }, 300);

  window.pageLoadingInterval = progressInterval;
}

createPageParticles();
startPageLoadingProgress();
</script>
</body>
</html>
