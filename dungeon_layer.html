<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‰¯æœ¬æˆ°é¬¥</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; padding-top: 60px; }
    #topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #f5f5f5;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #ccc;
    }
    #monsterInfo, #result { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="topbar">
    <span>ğŸ‘¤ ç©å®¶åç¨±ï¼š<span id="userEmail">è¼‰å…¥ä¸­...</span></span>
    <div>
      <button onclick="location.href='index.html'">ğŸ”™ è¿”å›ä¸»é </button>
      <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
    </div>
  </div>
  <h1>âš”ï¸ å‰¯æœ¬æˆ°é¬¥</h1>
  <div id="monsterInfo">è®€å–ä¸­...</div>
  <div id="battleArea" style="display:none;">
    <button onclick="startBattle()">é–‹å§‹æˆ°é¬¥</button>
  </div>
  <div id="result"></div>

  <script type="module">
    const API_BASE = "https://sfl-9cb8.onrender.com";
    const emailSpan = document.getElementById("userEmail");
    const monsterInfo = document.getElementById("monsterInfo");
    const battleArea = document.getElementById("battleArea");
    const result = document.getElementById("result");
    let userId = null;

    const urlParams = new URLSearchParams(location.search);
    const dungeonId = urlParams.get("dungeon");
    const layer = parseInt(urlParams.get("layer"));

    function logout() {
      firebase.auth().signOut().then(() => location.href = "/SFL/login.html");
    }

    async function startBattle() {
      result.innerHTML = "ğŸŒ€ æˆ°é¬¥ä¸­...";
      const res = await fetch(`${API_BASE}/battle_dungeon`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user: userId, dungeon: dungeonId, layer })
      });
      const data = await res.json();
      if (!data.success) {
        result.innerHTML = `ğŸ’€ æˆ°æ•—ï¼š${data.message || "ä½ è¢«æ‰“æ•—äº†"}<br><br><button onclick="location.href='dungeons.html'">é›¢é–‹å‰¯æœ¬</button>`;
      } else {
        const isLastLayer = data.is_last_layer;
        result.innerHTML = `âœ… å‹åˆ©ï¼<br><br>
          <button onclick="location.reload()">å†æˆ°ä¸€æ¬¡</button>
          ${isLastLayer ? `<button onclick="leave()">é›¢é–‹å‰¯æœ¬</button>` : `<button onclick="next()">å‰å¾€ä¸‹ä¸€å±¤</button>`}`;
      }
    }
    window.startBattle = startBattle;

    function leave() {
      location.href = "dungeons.html";
    }

    function next() {
      location.href = `dungeon_layer.html?dungeon=${dungeonId}&layer=${layer + 1}`;
    }
    window.leave = leave;
    window.next = next;

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) return location.href = "/SFL/login.html";
      userId = user.email;

      try {
        const res = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
        const userData = await res.json();
        emailSpan.innerText = userData.nickname || userId;

        const dungeonRes = await fetch("parameter/dungeons.json");
        const dungeons = await dungeonRes.json();
        const dungeon = dungeons.find(d => d.id === dungeonId);
        if (!dungeon) return monsterInfo.innerText = "âŒ æ‰¾ä¸åˆ°å‰¯æœ¬";

        const monsters = dungeon.monsters;
        const isBoss = layer === monsters.length;
        const monsterId = isBoss ? dungeon.bossId : monsters[layer];
        if (!monsterId) return monsterInfo.innerText = "âŒ è©²å±¤æ€ªç‰©ä¸å­˜åœ¨";

        const progress = userData.progress?.[dungeonId] ?? 0;
        if (layer !== progress) {
          alert("âš ï¸ è«‹å¾å‰¯æœ¬å…¥å£æ­£å¸¸é€²å…¥è©²å±¤ï¼");
          location.href = "dungeons.html";
          return;
        }

        const monDoc = await fetch(`${API_BASE}/monster?id=${monsterId}`);
        const mon = await monDoc.json();
        monsterInfo.innerHTML = `
          <h2>${mon.name}</h2>
          <img src="$pic/{mon.image_url}" width="150" />
          <p>${mon.info}</p>
          <ul>
            <li>HPï¼š${mon.stats.hp}</li>
            <li>æ”»æ“Šï¼š${mon.stats.attack}</li>
            <li>å‘½ä¸­ç‡ï¼š${(mon.stats.accuracy * 100).toFixed(1)}%</li>
            <li>è¿´é¿ç‡ï¼š${(mon.stats.evade * 100).toFixed(1)}%</li>
          </ul>
        `;
        battleArea.style.display = "block";
      } catch (e) {
        console.error("éŒ¯èª¤ï¼š", e);
        emailSpan.innerText = userId;
        monsterInfo.innerText = "âŒ è¼‰å…¥è³‡æ–™å¤±æ•—";
      }
    });
  </script>
</body>
</html>
