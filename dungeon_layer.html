<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å‰¯æœ¬æˆ°é¬¥</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; padding-top: 60px; }
    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      background: #f5f5f5; padding: 10px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #ccc; font-size: 0.95em;
    }
    #monsterInfo, #battleArea, #result {
      margin-top: 20px;
    }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); color: white; font-size: 1.5em;
      display: none; justify-content: center; align-items: center; z-index: 9999;
    }
    button { padding: 8px 14px; margin: 5px; }
  </style>
</head>
<body>
<div id="topbar">
  <span>ğŸ•¤ ç©å®¶åç¨±ï¼š<span id="nickname">...</span></span>
  <div>
    <button onclick="window.location.href='dungeons.html'">ğŸ”™ é›¢é–‹å‰¯æœ¬</button>
    <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
  </div>
</div>
<div id="loadingOverlay">â³ è¼‰å…¥ä¸­...</div>
<h1>ğŸ–” å‰¯æœ¬æˆ°é¬¥</h1>
<div id="monsterInfo"></div>
<div id="battleArea" style="display:none;"></div>
<div id="result"></div>
<script type="module">
const API_BASE = "https://sfl-9cb8.onrender.com";
const loading = document.getElementById("loadingOverlay");
const params = new URLSearchParams(location.search);
const dungeon = params.get("dungeon");
let layer = parseInt(params.get("layer"));
let userId = null;

function showLoading(show) {
  loading.style.display = show ? "flex" : "none";
}

function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "/SFL/login.html";
  });
}
window.logout = logout;

function percent(val) {
  return Math.round(val * 100) + "%";
}

async function waitForUser() {
  return new Promise(resolve => {
    const unsub = firebase.auth().onAuthStateChanged(user => {
      unsub(); resolve(user);
    });
  });
}

async function loadMonster() {
  showLoading(true);
  const res = await fetch("parameter/dungeons.json");
  const all = await res.json();
  const dungeonData = all.find(d => d.id === dungeon);
  if (!dungeonData) return alert("æ‰¾ä¸åˆ°å‰¯æœ¬");

  const isBoss = layer === dungeonData.monsters.length;
  const monsterId = isBoss ? dungeonData.bossId : dungeonData.monsters[layer];
  const monRes = await fetch(`${API_BASE}/monster?id=${monsterId}`);
  const mon = await monRes.json();

  const info = document.getElementById("monsterInfo");
  info.innerHTML = `<h2>${mon.name}</h2>
    <img src="${mon.image_url}" width="150"><p>${mon.info}</p>
    <ul>
      <li>â™¥ï¸ HPï¼š${mon.stats.hp}</li>
      <li>âš”ï¸ æ”»æ“Šï¼š${mon.stats.attack}</li>
      <li>âœ‰ï¸ å‘½ä¸­ç‡ï¼š${percent(mon.stats.accuracy)}</li>
      <li>ğŸ›¡ï¸ è¿´é¿ï¼š${percent(mon.stats.evade)}</li>
    </ul>
    <button onclick="startBattle()">é–‹å§‹æˆ°é¬¥</button>`;
}

window.startBattle = async function() {
  showLoading(true);
  document.getElementById("result").innerText = "";
  const res = await fetch(`${API_BASE}/battle_dungeon`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user: userId, dungeon, layer })
  });
  const data = await res.json();

  const area = document.getElementById("battleArea");
  area.style.display = "block";
  area.innerHTML = data.result.join("<br>");

  const result = document.getElementById("result");
  if (!data.success) {
    result.innerHTML = `ğŸ’€ æˆ°æ•—ï¼š${data.message}<br>
      <button onclick="window.location.href='dungeons.html'">é›¢é–‹å‰¯æœ¬</button>`;
  } else {
    result.innerHTML = `âœ… æˆ°é¬¥å‹åˆ©ï¼<br>`;
    if (!data.is_last_layer) {
      result.innerHTML += `<button onclick="nextLayer()">â†’ å‰å¾€ç¬¬${layer+2}å±¤</button>`;
    } else {
      result.innerHTML += `<b>âœ¨ é€šé—œå‰¯æœ¬ï¼</b><br>`;
    }
    result.innerHTML += `<button onclick="window.location.href='dungeons.html'">é›¢é–‹</button>`;
  }
  showLoading(false);
}

window.nextLayer = function() {
  location.href = `dungeon_layer.html?dungeon=${dungeon}&layer=${layer+1}`;
};

(async () => {
  const user = await waitForUser();
  if (!user) return location.href = "/SFL/login.html";
  userId = user.email;
  document.getElementById("nickname").innerText = user.displayName || user.email;
  await loadMonster();
  showLoading(false);
})();
</script>
</body>
</html>
