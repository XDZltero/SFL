<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å‰¯æœ¬æˆ°é¬¥</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; padding-top: 60px; }
    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      background: #f5f5f5; padding: 10px;
      display: flex; justify-content: space-between;
      border-bottom: 1px solid #ccc;
      font-size: 0.95em;
    }
    #monsterInfo { margin-bottom: 20px; }
    #battleArea { display: none; }
    #result { font-weight: bold; margin-top: 1em; }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); color: white;
      font-size: 1.5em; display: none;
      justify-content: center; align-items: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="topbar">
    ğŸ‘¤ ç©å®¶åç¨±ï¼š<span id="userNickname">è¼‰å…¥ä¸­...</span>
    <div>
      <button onclick="location.href='dungeons.html'">ğŸ”™ é›¢é–‹å‰¯æœ¬</button>
      <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
    </div>
  </div>
  <div id="loadingOverlay">â³ è¼‰å…¥ä¸­...</div>

  <h1>âš”ï¸ å‰¯æœ¬æˆ°é¬¥</h1>
  <div id="monsterInfo"></div>
  <div id="battleArea">
    <button onclick="startBattle()">é–‹å§‹æˆ°é¬¥</button>
    <div id="result"></div>
    <button id="nextBtn" style="display:none">â–¶ï¸ ä¸‹ä¸€å±¤</button>
  </div>

  <script type="module">
    const API = "https://sfl-9cb8.onrender.com";
    const params = new URLSearchParams(location.search);
    const dungeon = params.get("dungeon");
    let layer = parseInt(params.get("layer") || "0");
    let userId = null;

    const loading = document.getElementById("loadingOverlay");
    const monsterDiv = document.getElementById("monsterInfo");
    const resultDiv = document.getElementById("result");
    const nextBtn = document.getElementById("nextBtn");

    function showLoading(show) {
      loading.style.display = show ? "flex" : "none";
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        location.href = "/SFL/login.html";
      });
    }
    window.logout = logout;

    async function fetchUser(userId) {
      const res = await fetch(`${API}/status?user=${encodeURIComponent(userId)}`);
      return await res.json();
    }

    async function fetchMonster(monsterId) {
      const res = await fetch(`${API}/monster?id=${encodeURIComponent(monsterId)}`);
      return await res.json();
    }

    async function loadLayer() {
      showLoading(true);
      try {
        const user = await fetchUser(userId);
        document.getElementById("userNickname").innerText = user.nickname || userId;

        const dungeonRes = await fetch("parameter/dungeons.json");
        const all = await dungeonRes.json();
        const current = all.find(d => d.id === dungeon);
        if (!current) throw new Error("å‰¯æœ¬ä¸å­˜åœ¨");

        const monsterId = (layer === current.monsters.length) ? current.bossId : current.monsters[layer];
        const mon = await fetchMonster(monsterId);

        monsterDiv.innerHTML = `
          <h2>${mon.name}</h2>
          <img src="${mon.image_url}" width="150"><br>
          <p>${mon.info}</p>
          <ul>
            <li>â¤ï¸ HPï¼š${mon.stats.hp}</li>
            <li>âš”ï¸ æ”»æ“Šï¼š${mon.stats.attack}</li>
            <li>ğŸ¯ å‘½ä¸­ç‡ï¼š${Math.round(mon.stats.accuracy * 100)}%</li>
            <li>ğŸ›¡ï¸ è¿´é¿ï¼š${Math.round(mon.stats.evade * 100)}%</li>
          </ul>
        `;

        document.getElementById("battleArea").style.display = "block";
      } catch (err) {
        monsterDiv.innerHTML = "âŒ è¼‰å…¥è³‡æ–™å¤±æ•—";
        console.error(err);
      } finally {
        showLoading(false);
      }
    }

    window.startBattle = async function () {
      showLoading(true);
      resultDiv.innerText = "";
      nextBtn.style.display = "none";
      try {
        const res = await fetch(`${API}/battle_dungeon`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: userId, dungeon, layer })
        });
        const data = await res.json();

        const log = data.battle_log || data.result;
        if (!Array.isArray(log)) {
          throw new Error("ä¼ºæœå™¨æœªå›å‚³æˆ°é¬¥ç´€éŒ„");
        }

        resultDiv.innerText = data.result.join("\n");

        if (data.success && !data.is_last_layer) {
          nextBtn.style.display = "inline-block";
          nextBtn.onclick = () => {
            window.location.href = `dungeon_layer.html?dungeon=${dungeon}&layer=${layer + 1}`;
          };
        } else if (!data.success) {
          resultDiv.innerHTML += `\nğŸ’€ ${data.message}`;
        }
      } catch (err) {
        console.error("ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
        resultDiv.innerText = "âŒ éŒ¯èª¤ï¼šç„¡æ³•å®Œæˆæˆ°é¬¥";
      } finally {
        showLoading(false);
      }
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        userId = user.email;
        loadLayer();
      } else {
        location.href = "/SFL/login.html";
      }
    });
  </script>
</body>
</html>
