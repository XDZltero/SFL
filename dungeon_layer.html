<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‰¯æœ¬æˆ°é¬¥</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    body { font-family: sans-serif; padding: 20px; padding-top: 60px; }
    #topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #f5f5f5;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }
    #monsterInfo, #result { margin-top: 20px; }
  </style>
</head>
<body>
  <div id="topbar">
    <span>ğŸ‘¤ ç©å®¶åç¨±ï¼š<span id="userEmail">è¼‰å…¥ä¸­...</span></span>
    <div>
      <button onclick="location.href='index.html'">ğŸ”™ è¿”å›ä¸»é </button>
      <button onclick="logout()">ğŸ”“ ç™»å‡º</button>
    </div>
  </div>

  <h1>âš”ï¸ å‰¯æœ¬æˆ°é¬¥</h1>
  <div id="monsterInfo">è®€å–æ€ªç‰©è³‡æ–™ä¸­...</div>
  <div id="battleArea" style="display:none;">
    <button onclick="startBattle()">é–‹å§‹æˆ°é¬¥</button>
  </div>
  <div id="result"></div>

  <script type="module">
    const emailSpan = document.getElementById("userEmail");
    const monsterInfo = document.getElementById("monsterInfo");
    const battleArea = document.getElementById("battleArea");
    const result = document.getElementById("result");
    const db = firebase.firestore();
    const API_BASE = "https://sfl-9cb8.onrender.com";

    let userId = null;

    const urlParams = new URLSearchParams(location.search);
    const dungeonId = urlParams.get("dungeon");
    const layer = parseInt(urlParams.get("layer"));

    function logout() {
      firebase.auth().signOut().then(() => {
        location.href = "/SFL/login.html";
      });
    }
    window.logout = logout;

    async function startBattle() {
      battleArea.style.display = "none";
      result.innerText = "ğŸŒ€ æˆ°é¬¥ä¸­...";

      const res = await fetch(`${API_BASE}/battle_dungeon`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user: userId, dungeon: dungeonId, layer })
      });

      const data = await res.json();
      if (!data.success) {
        result.innerHTML = `ğŸ’€ æˆ°é¬¥å¤±æ•—ï¼š${data.message || "ä½ è¢«æ‰“æ•—äº†"}<br><br><button onclick="location.href='dungeons.html'">é›¢é–‹å‰¯æœ¬</button>`;
      } else {
        const isLastLayer = data.is_last_layer;
        result.innerHTML = `âœ… å‹åˆ©ï¼ä½ æ“Šæ•—äº†æ€ªç‰©ï¼<br><br>
          <button onclick="location.reload()">å†æˆ°ä¸€æ¬¡</button>
          ${isLastLayer 
            ? "<button onclick=\"leaveAndReset()\">é›¢é–‹å‰¯æœ¬</button>"
            : `<button onclick="goNext()">å‰å¾€ä¸‹ä¸€å±¤</button>`}`;
      }
    }
    window.startBattle = startBattle;

    async function goNext() {
      const progressRef = db.collection("progress").doc(userId);
      const doc = await progressRef.get();
      const current = doc.exists ? doc.data() : {};
      current[dungeonId] = layer + 1;
      await progressRef.set(current);
      location.href = `dungeon_layer.html?dungeon=${dungeonId}&layer=${layer + 1}`;
    }
    window.goNext = goNext;

    async function leaveAndReset() {
      const progressRef = db.collection("progress").doc(userId);
      const doc = await progressRef.get();
      const current = doc.exists ? doc.data() : {};
      current[dungeonId] = 0;
      await progressRef.set(current);
      location.href = `dungeons.html`;
    }
    window.leaveAndReset = leaveAndReset;

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) return location.href = "/SFL/login.html";
      userId = user.email;
      const nicknameData = await fetch(`${API_BASE}/status?user=${encodeURIComponent(userId)}`);
      const nameData = await nicknameData.json();
      emailSpan.innerText = nameData.nickname || userId;

      // å‰¯æœ¬è³‡æ–™èˆ‡æ€ªç‰©é©—è­‰
      const dungeonRes = await fetch("parameter/dungeons.json");
      const dungeons = await dungeonRes.json();
      const dungeon = dungeons.find(d => d.id === dungeonId);
      if (!dungeon) return monsterInfo.innerText = "âŒ æ‰¾ä¸åˆ°è©²å‰¯æœ¬";

      const monsters = dungeon.monsters;
      const isBoss = layer === monsters.length;
      const monsterId = isBoss ? dungeon.bossId : monsters[layer];
      if (!monsterId) return monsterInfo.innerText = "âŒ è©²å±¤æ€ªç‰©ä¸å­˜åœ¨";

      const progressDoc = await db.collection("progress").doc(userId).get();
      const progressData = progressDoc.exists ? progressDoc.data() : {};
      const expectedLayer = progressData[dungeonId] ?? 0;
      if (layer !== expectedLayer) {
        alert("âš ï¸ æŒ‘æˆ°å¤±æ•—ï¼Œè«‹å¾å‰¯æœ¬é¦–é æ­£å¸¸é€²å…¥ï¼");
        location.href = "dungeons.html";
        return;
      }

      const monDoc = await db.collection("monsters").doc(monsterId).get();
      const mon = monDoc.exists ? monDoc.data() : null;
      if (!mon) return monsterInfo.innerText = "âŒ æ‰¾ä¸åˆ°æ€ªç‰©è³‡æ–™";

      monsterInfo.innerHTML = `
        <h2>${mon.name}</h2>
        <img src="${mon.image_url}" width="150" />
        <p>${mon.info}</p>
        <ul>
          <li>HPï¼š${mon.stats.hp}</li>
          <li>æ”»æ“Šï¼š${mon.stats.attack}</li>
          <li>å‘½ä¸­ç‡ï¼š${(mon.stats.accuracy * 100).toFixed(1)}%</li>
          <li>è¿´é¿ç‡ï¼š${(mon.stats.evade * 100).toFixed(1)}%</li>
        </ul>
      `;
      battleArea.style.display = "block";
    });
  </script>

  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("footer-placeholder").innerHTML = html;
      });
  </script>
</body>
</html>
