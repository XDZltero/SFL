<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>副本戰鬥</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; padding-top: 60px; }
    #topbar {
      position: fixed; top: 0; left: 0; right: 0;
      background: #f5f5f5; padding: 10px;
      display: flex; justify-content: space-between;
      border-bottom: 1px solid #ccc;
      font-size: 0.95em;
    }
    #monsterInfo { margin-bottom: 20px; }
    #battleArea { display: none; }
    #result { font-weight: bold; margin-top: 1em; }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); color: white;
      font-size: 1.5em; display: none;
      justify-content: center; align-items: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="topbar">
    👤 玩家名稱：<span id="userNickname">載入中...</span>
    <div>
      <button onclick="location.href='dungeons.html'">🔙 離開副本</button>
      <button onclick="logout()">🔓 登出</button>
    </div>
  </div>
  <div id="loadingOverlay">⏳ 載入中...</div>

  <h1>⚔️ 副本戰鬥</h1>
  <div id="monsterInfo"></div>
  <div id="battleArea">
    <button onclick="startBattle()">開始戰鬥</button>
    <div id="result"></div>
    <button id="nextBtn" style="display:none">▶️ 下一層</button>
  </div>

  <script type="module">
    const API = "https://sfl-9cb8.onrender.com";
    const params = new URLSearchParams(location.search);
    const dungeon = params.get("dungeon");
    let layer = parseInt(params.get("layer") || "0");
    let userId = null;

    const loading = document.getElementById("loadingOverlay");
    const monsterDiv = document.getElementById("monsterInfo");
    const resultDiv = document.getElementById("result");
    const nextBtn = document.getElementById("nextBtn");

    function showLoading(show) {
      loading.style.display = show ? "flex" : "none";
    }

    function logout() {
      firebase.auth().signOut().then(() => {
        location.href = "/SFL/login.html";
      });
    }
    window.logout = logout;

    async function fetchUser(userId) {
      const res = await fetch(`${API}/status?user=${encodeURIComponent(userId)}`);
      return await res.json();
    }

    async function fetchMonster(monsterId) {
      const res = await fetch(`${API}/monster?id=${encodeURIComponent(monsterId)}`);
      return await res.json();
    }

    async function loadLayer() {
      showLoading(true);
      try {
        const user = await fetchUser(userId);
        document.getElementById("userNickname").innerText = user.nickname || userId;

        const dungeonRes = await fetch("parameter/dungeons.json");
        const all = await dungeonRes.json();
        const current = all.find(d => d.id === dungeon);
        if (!current) throw new Error("副本不存在");

        const monsterId = (layer === current.monsters.length) ? current.bossId : current.monsters[layer];
        const mon = await fetchMonster(monsterId);

        monsterDiv.innerHTML = `
          <h2>${mon.name}</h2>
          <img src="${mon.image_url}" width="150"><br>
          <p>${mon.info}</p>
          <ul>
            <li>❤️ HP：${mon.stats.hp}</li>
            <li>⚔️ 攻擊：${mon.stats.attack}</li>
            <li>🎯 命中率：${Math.round(mon.stats.accuracy * 100)}%</li>
            <li>🛡️ 迴避：${Math.round(mon.stats.evade * 100)}%</li>
          </ul>
        `;

        document.getElementById("battleArea").style.display = "block";
      } catch (err) {
        monsterDiv.innerHTML = "❌ 載入資料失敗";
        console.error(err);
      } finally {
        showLoading(false);
      }
    }

    window.startBattle = async function () {
      showLoading(true);
      resultDiv.innerText = "";
      nextBtn.style.display = "none";
      try {
        const res = await fetch(`${API}/battle_dungeon`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: userId, dungeon, layer })
        });
        const data = await res.json();

        const log = data.battle_log || data.result;
        if (!Array.isArray(log)) {
          throw new Error("伺服器未回傳戰鬥紀錄");
        }

        resultDiv.innerText = data.result.join("\n");

        if (data.success && !data.is_last_layer) {
          nextBtn.style.display = "inline-block";
          nextBtn.onclick = () => {
            window.location.href = `dungeon_layer.html?dungeon=${dungeon}&layer=${layer + 1}`;
          };
        } else if (!data.success) {
          resultDiv.innerHTML += `\n💀 ${data.message}`;
        }
      } catch (err) {
        console.error("發生錯誤：", err);
        resultDiv.innerText = "❌ 錯誤：無法完成戰鬥";
      } finally {
        showLoading(false);
      }
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        userId = user.email;
        loadLayer();
      } else {
        location.href = "/SFL/login.html";
      }
    });
  </script>
</body>
</html>
