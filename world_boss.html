<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>ä¸–ç•Œç‹æŒ‘æˆ°</title>
<link rel="icon" href="favicon.ico" />
<link href="css/style.css" rel="stylesheet"/>
<link href="css/dungeon_layer_winning.css" rel="stylesheet"/>
<link href="css/dungeon_layer.css" rel="stylesheet"/>
<link href="css/world_boss.css" rel="stylesheet"/>
</head>
<body class="world-boss-mode">

<!-- ä¸–ç•Œç‹è¡€é‡æ¢ -->
<div class="world-boss-hp-container">
  <div class="world-boss-title">ğŸŒ ä¸–ç•Œç‹æŒ‘æˆ° ğŸŒ</div>
  <div class="world-hp-bar-container">
    <div class="world-hp-bar" id="worldHpBar" style="width: 100%;">
      <div class="world-hp-text" id="worldHpText">è¼‰å…¥ä¸­...</div>
    </div>
  </div>
  <div class="world-boss-stats">
    <div class="world-stat-item">æ”»æ“Šæ¬¡æ•¸: <span class="world-stat-value" id="totalAttacks">-</span></div>
    <div class="world-stat-item">åƒèˆ‡ç©å®¶: <span class="world-stat-value" id="uniquePlayers">-</span></div>
    <div class="world-stat-item">ç­‰ç´š: <span class="world-stat-value" id="bossLevel">80</span></div>
    <div class="world-stat-item">éšæ®µ: <span class="world-stat-value" id="currentPhase">1 / 3</span></div>
  </div>
</div>

<!-- éšæ®µæŒ‡ç¤ºå™¨ -->
<div class="phase-indicator" id="phaseIndicator">
  è¼‰å…¥éšæ®µè³‡è¨Š...
</div>

<!-- å€’æ•¸è¨ˆæ™‚å™¨ -->
<div class="countdown-timer">
  <div class="countdown-label">â° æŒ‘æˆ°é–‹æ”¾å€’æ•¸</div>
  <div class="countdown-value" id="countdownDisplay">è¨ˆç®—ä¸­...</div>
</div>

<!-- é é¢è¼‰å…¥é®ç½© -->
<div id="loadingOverlay">
  <div class="particles" id="pageParticles"></div>
  <div class="battle-loading-container">
    <div class="battle-icon">ğŸ²</div>
    <div class="battle-title normal-title">è¼‰å…¥ä¸–ç•Œç‹</div>
    <div class="loading-text" id="pageLoadingText">æ­£åœ¨é€£æ¥ä¸–ç•Œç‹æˆ°å ´...</div>
    <div class="progress-container">
      <div class="progress-bar" id="pageProgressBar"></div>
    </div>
    <div class="progress-text" id="pageProgressText">0%</div>
    <div class="battle-tips">
      ğŸŒ å…¨ä¸–ç•Œçš„å†’éšªè€…æ­£åœ¨ä¸€èµ·æˆ°é¬¥ï¼<br/>
      âš”ï¸ æ¯ä¸€æ¬¡æ”»æ“Šéƒ½é—œä¹äººé¡çš„å‘½é‹
    </div>
  </div>
</div>

<!-- ä¸»è¦å…§å®¹å€åŸŸ -->
<div class="world-boss-container">
  <!-- å·¦å´é¢æ¿ï¼šç©å®¶æŒ‘æˆ°å€åŸŸ -->
  <div class="left-panel">
    <!-- æ™‚é–“é™åˆ¶æç¤ºï¼ˆé€±æ—¥é¡¯ç¤ºï¼‰ -->
    <div class="time-restriction-notice" id="timeRestriction" style="display: none;">
      <div class="restriction-title">â° æŒ‘æˆ°æ™‚é–“é™åˆ¶</div>
      <div class="restriction-message">
        ä¸–ç•Œç‹æ¯é€±æ—¥é€²è¡Œä¼‘æ•´ï¼Œç„¡æ³•æŒ‘æˆ°<br>
        æŒ‘æˆ°å°‡æ–¼ä¸‹é€±ä¸€ 00:00 é‡æ–°é–‹æ”¾
      </div>
    </div>

    <!-- ç©å®¶æŒ‘æˆ°å¡ç‰‡ -->
    <div class="player-challenge-card">

      <div class="player-level-info" style="text-align: center; margin-bottom: 15px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 8px;">
        <div style="color: #ffd93d; font-size: 1.1em; font-weight: 600;">
          â­ ä½ çš„ç­‰ç´šï¼š<span id="playerLevel">è¼‰å…¥ä¸­...</span>
        </div>
        <div style="color: #00ffff; font-size: 0.9em; margin-top: 5px;">
          ä¸–ç•Œç‹æŒ‘æˆ°éœ€æ±‚ï¼š30 ç­‰ä»¥ä¸Š
        </div>
      </div>
    
      <!-- ğŸš€ æ–°å¢ï¼šç­‰ç´šä¸è¶³æç¤ºï¼ˆé è¨­éš±è—ï¼‰ -->
      <div class="level-requirement-notice" id="levelRequirementNotice" style="display: none;">
        <div class="restriction-title">âš¡ ç­‰ç´šé™åˆ¶</div>
        <div class="restriction-message">
          éœ€è¦é”åˆ° <strong>30 ç­‰</strong> æ‰èƒ½æŒ‘æˆ°ä¸–ç•Œç‹<br>
          ä½ ç›®å‰æ˜¯ <span id="currentLevelDisplay">-</span> ç­‰ï¼Œé‚„éœ€è¦ <span id="levelShortage">-</span> ç­‰
        </div>
      </div>
      
      <div class="player-damage-stats">
        <div class="damage-title">ğŸ† ä½ çš„ç´¯ç©å‚·å®³</div>
        <div class="total-damage" id="playerTotalDamage">0</div>
        <div class="damage-rank" id="playerRank">æ’å: æœªåƒèˆ‡</div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #ccc;">
          æŒ‘æˆ°æ¬¡æ•¸: <span id="challengeCount">0</span> æ¬¡
        </div>
      </div>
      
      <div class="challenge-button-area">
        <button class="world-challenge-btn" id="challengeBtn" onclick="challengeWorldBoss()">
          ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ
        </button>
        <div class="cooldown-info" id="cooldownInfo" style="display: none;">
          å†·å»ä¸­ï¼Œè«‹ç­‰å¾…ï¼š<span id="cooldownTimer">00:00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸–ç•Œç‹è³‡è¨Š -->
    <div class="section world-boss-info-container">
      <div class="world-boss-name" id="bossName">è¼‰å…¥ä¸­...</div>
      <div class="world-boss-phase" id="phaseDescription">è¼‰å…¥éšæ®µè³‡è¨Š...</div>
      <img src="" class="world-boss-image" id="bossImage" width="250">
      <div class="world-boss-description" id="bossDescription">è¼‰å…¥ä¸­...</div>
    </div>

  <!-- å³å´é¢æ¿ï¼šæ’è¡Œæ¦œ -->
  <div class="right-panel">
    <div class="leaderboard-card">
      <div class="leaderboard-title">ğŸ† å‚·å®³æ’è¡Œæ¦œ</div>
      <div class="leaderboard-list" id="leaderboardList">
        <div style="text-align: center; color: #888; padding: 20px;">
          è¼‰å…¥æ’è¡Œæ¦œä¸­...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å‹åˆ©/æˆ°é¬¥çµæœé®ç½© -->
<div class="victory-overlay" id="battleResultOverlay" style="display: none;">
  <div class="victory-content">
    <div class="victory-icon" id="battleResultIcon">âš”ï¸</div>
    <div class="victory-title" id="battleResultTitle">æˆ°é¬¥çµæœ</div>
    <div class="victory-message" id="battleResultMessage">çµæœè¨Šæ¯</div>
    <button class="effect-button" onclick="closeBattleResult()">ç¢ºå®š</button>
  </div>
</div>

<script type="module">
import { auth, SecureAPI, PerformanceMonitor } from "./js/firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const API_BASE = "https://sfl-9cb8.onrender.com";

let worldBossData = null;
let playerData = null;
let leaderboardData = [];
let cooldownTimer = null;
let currentUserNickname = "";
let userLevel = 0;
const REQUIRED_LEVEL = 30;
  
// éšæ®µé…ç½®
const PHASES = {
  1: {
    name: "ã€ç¬¬ä¸€éšæ®µã€‘è³‡æ–™è¼‰å…¥ä¸­",
    description: "è³‡æ–™è¼‰å…¥ä¸­...",
    hp_threshold: 100
  },
  2: {
    name: "ã€ç¬¬äºŒéšæ®µã€‘è³‡æ–™è¼‰å…¥ä¸­",
    description: "è³‡æ–™è¼‰å…¥ä¸­...",
    hp_threshold: 60
  },
  3: {
    name: "ã€ç¬¬ä¸‰éšæ®µã€‘è³‡æ–™è¼‰å…¥ä¸­",
    description: "è³‡æ–™è¼‰å…¥ä¸­...",
    hp_threshold: 30
  }
};

// è¼‰å…¥é é¢åˆå§‹åŒ–
function createPageParticles() {
  const particlesContainer = document.getElementById("pageParticles");
  if (!particlesContainer) return;
  particlesContainer.innerHTML = "";
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement("div");
    particle.className = "particle";
    particle.style.left = Math.random() * 100 + "%";
    particle.style.animationDelay = Math.random() * 4 + "s";
    particle.style.animationDuration = (Math.random() * 2 + 3) + "s";
    particle.style.background = `rgba(${Math.random() > 0.5 ? '255, 215, 0' : '255, 140, 0'}, 0.8)`;
    particlesContainer.appendChild(particle);
  }
}

// è¼‰å…¥ä½¿ç”¨è€…ç­‰ç´šè³‡è¨Š
async function loadUserLevel() {
  try {
    const statusRes = await SecureAPI.getStatus(false);
    const userData = await statusRes.json();
    
    userLevel = userData.level || 1;
    currentUserNickname = userData.nickname || userData.user_id;
    
    // æ›´æ–°ç­‰ç´šé¡¯ç¤º
    document.getElementById("playerLevel").textContent = userLevel;
    
    // æª¢æŸ¥ç­‰ç´šé™åˆ¶
    checkLevelRequirement();
    
    console.log(`âœ… ä½¿ç”¨è€…ç­‰ç´šè¼‰å…¥ï¼š${userLevel}`);
    
  } catch (error) {
    console.error('è¼‰å…¥ä½¿ç”¨è€…ç­‰ç´šå¤±æ•—:', error);
    document.getElementById("playerLevel").textContent = "è¼‰å…¥å¤±æ•—";
  }
}

function checkLevelRequirement() {
  const challengeBtnEl = document.getElementById("challengeBtn");
  const levelNoticeEl = document.getElementById("levelRequirementNotice");
  const currentLevelEl = document.getElementById("currentLevelDisplay");
  const levelShortageEl = document.getElementById("levelShortage");
  
  if (userLevel < REQUIRED_LEVEL) {
    // ç­‰ç´šä¸è¶³
    if (levelNoticeEl) levelNoticeEl.style.display = "block";
    if (currentLevelEl) currentLevelEl.textContent = userLevel;
    if (levelShortageEl) levelShortageEl.textContent = REQUIRED_LEVEL - userLevel;
    
    if (challengeBtnEl) {
      challengeBtnEl.disabled = true;
      challengeBtnEl.textContent = `âš¡ éœ€è¦ ${REQUIRED_LEVEL} ç­‰`;
      challengeBtnEl.dataset.levelLocked = "true";
      
      // è¨­å®šç‰¹æ®Šæ¨£å¼
      challengeBtnEl.style.background = "linear-gradient(135deg, #6c757d 0%, #495057 100%)";
      challengeBtnEl.style.color = "#adb5bd";
      challengeBtnEl.style.cursor = "not-allowed";
    }
    
  } else {
    // ç­‰ç´šè¶³å¤ 
    if (levelNoticeEl) levelNoticeEl.style.display = "none";
    if (challengeBtnEl) challengeBtnEl.dataset.levelLocked = "false";
    
    // æ¢å¾©æ­£å¸¸æ¨£å¼ï¼ˆå¦‚æœæ²’æœ‰å…¶ä»–é™åˆ¶ï¼‰
    if (!isWeekend() && challengeBtnEl && !challengeBtnEl.dataset.cooling) {
      challengeBtnEl.disabled = false;
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
      challengeBtnEl.style.background = "";
      challengeBtnEl.style.color = "";
      challengeBtnEl.style.cursor = "";
    }
  }
}

function handleWorldBossError(error, context = "æœªçŸ¥æ“ä½œ") {
  console.error(`ä¸–ç•Œç‹${context}å¤±æ•—:`, error);
  
  // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›ä¸åŒçš„æ¢å¾©å»ºè­°
  if (error.message.includes('fetch') || error.message.includes('network')) {
    showBattleResult(false, "ç¶²è·¯éŒ¯èª¤", 
      "é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦\n\nå¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹é‡æ–°æ•´ç†é é¢");
    
    // è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
    setTimeout(() => {
      if (confirm("æ˜¯å¦è‡ªå‹•é‡æ–°è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™ï¼Ÿ")) {
        loadWorldBossData();
      }
    }, 3000);
    
  } else if (error.message.includes('token') || error.message.includes('auth')) {
    showBattleResult(false, "èªè­‰éŒ¯èª¤", 
      "ç™»å…¥ç‹€æ…‹å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥");
    
    setTimeout(() => {
      window.parent.location.href = "/SFL/login.html";
    }, 2000);
    
  } else {
    showBattleResult(false, "ç³»çµ±éŒ¯èª¤", 
      `${context}æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦\n\néŒ¯èª¤è¨Šæ¯ï¼š${error.message}`);
  }
}
  
function startPageLoadingProgress() {
  const progressBar = document.getElementById("pageProgressBar");
  const progressText = document.getElementById("pageProgressText");
  const loadingText = document.getElementById("pageLoadingText");
  if (!progressBar || !progressText || !loadingText) return;

  const messages = [
    "æ­£åœ¨é€£æ¥ä¸–ç•Œç‹æˆ°å ´...",
    "è¼‰å…¥å…¨çƒæˆ°é¬¥è³‡æ–™...", 
    "åŒæ­¥ä¸–ç•Œç‹ç‹€æ…‹...",
    "è¼‰å…¥æ’è¡Œæ¦œè³‡æ–™...",
    "é€£æ¥å®Œæˆï¼"
  ];

  let progress = 0;
  let messageIndex = 0;
  const progressInterval = setInterval(() => {
    progress += Math.random() * 15 + 10;
    if (progress > 100) progress = 100;

    progressBar.style.width = progress + "%";
    progressText.textContent = Math.round(progress) + "%";

    if (messageIndex < messages.length - 1 && progress > (messageIndex + 1) * 20) {
      messageIndex++;
      loadingText.textContent = messages[messageIndex];
    }

    if (progress >= 100) {
      clearInterval(progressInterval);
      loadingText.textContent = messages[messages.length - 1];
    }
  }, 300);

  window.pageLoadingInterval = progressInterval;
}

function showLoading(show) {
  const loading = document.getElementById("loadingOverlay");
  if (!loading) return;
  loading.style.display = show ? "flex" : "none";
}

function hidePageLoading() {
  if (window.pageLoadingInterval) {
    clearInterval(window.pageLoadingInterval);
  }
  setTimeout(() => {
    showLoading(false);
  }, 1000);
}

// æ™‚é–“ç›¸é—œå‡½æ•¸
function isWeekend() {
  const now = new Date();
  const taipeiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  return taipeiTime.getDay() === 0; // é€±æ—¥
}

function getNextMondayCountdown() {
  const now = new Date();
  const taipeiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  
  // æ‰¾ä¸‹é€±ä¸€ 00:00
  const nextMonday = new Date(taipeiTime);
  const daysUntilMonday = (7 - taipeiTime.getDay() + 1) % 7;
  nextMonday.setDate(taipeiTime.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
  nextMonday.setHours(0, 0, 0, 0);
  
  const diff = nextMonday - taipeiTime;
  
  if (diff <= 0) return "00:00:00";
  
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// å€’æ•¸è¨ˆæ™‚å™¨
function updateCountdown() {
  const countdownEl = document.getElementById("countdownDisplay");
  const timeRestrictionEl = document.getElementById("timeRestriction");
  const challengeBtnEl = document.getElementById("challengeBtn");
  
  if (isWeekend()) {
    countdownEl.textContent = getNextMondayCountdown();
    timeRestrictionEl.style.display = "block";
    if (!challengeBtnEl.dataset.levelLocked || challengeBtnEl.dataset.levelLocked === "false") {
      challengeBtnEl.disabled = true;
      challengeBtnEl.textContent = "â° é€±æ—¥ä¼‘æ•´ä¸­";
    }
  } else {
    timeRestrictionEl.style.display = "none";
    countdownEl.textContent = "æŒ‘æˆ°é–‹æ”¾ä¸­";
    
    // ğŸš€ æ–°å¢ï¼šé‡æ–°æª¢æŸ¥ç­‰ç´šé™åˆ¶
    checkLevelRequirement();
  }
}

// æ›´æ–°å†·å»æ™‚é–“é¡¯ç¤º
function updateCooldownDisplay(cooldownEndTime) {
  const cooldownInfoEl = document.getElementById("cooldownInfo");
  const cooldownTimerEl = document.getElementById("cooldownTimer");
  const challengeBtnEl = document.getElementById("challengeBtn");
  
  if (!cooldownEndTime) {
    cooldownInfoEl.style.display = "none";
    challengeBtnEl.dataset.cooling = "false";
    
    // ğŸš€ æ–°å¢ï¼šæª¢æŸ¥ç­‰ç´šé™åˆ¶
    if (userLevel < REQUIRED_LEVEL) {
      checkLevelRequirement();
    } else if (!isWeekend()) {
      challengeBtnEl.disabled = false;
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
    }
    return;
  }
  
  const now = Date.now();
  const remaining = cooldownEndTime - now;
  
  if (remaining <= 0) {
    cooldownInfoEl.style.display = "none";
    challengeBtnEl.dataset.cooling = "false";
    
    // ğŸš€ æ–°å¢ï¼šæª¢æŸ¥ç­‰ç´šé™åˆ¶
    if (userLevel < REQUIRED_LEVEL) {
      checkLevelRequirement();
    } else if (!isWeekend()) {
      challengeBtnEl.disabled = false;
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
    }
    
    if (cooldownTimer) {
      clearInterval(cooldownTimer);
      cooldownTimer = null;
    }
    return;
  }
  
  const minutes = Math.floor(remaining / (1000 * 60));
  const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
  
  cooldownInfoEl.style.display = "block";
  cooldownTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  challengeBtnEl.disabled = true;
  challengeBtnEl.dataset.cooling = "true";
  challengeBtnEl.textContent = "â° å†·å»ä¸­";
}

// éšæ®µç³»çµ±
function getCurrentPhase(currentHp, maxHp) {
  const percentage = (currentHp / maxHp) * 100;
  
  // ä½¿ç”¨ API è³‡æ–™ä¸­çš„ hp_threshold
  if (worldBossData?.phases) {
    const phases = worldBossData.phases;
    
    // å¾æœ€ä½éšæ®µé–‹å§‹æª¢æŸ¥
    if (percentage <= (phases["3"]?.hp_threshold || 30)) return 3;
    if (percentage <= (phases["2"]?.hp_threshold || 60)) return 2;
    return 1;
  }
  
  // é™ç´šè™•ç†ï¼šä½¿ç”¨ç¡¬ç·¨ç¢¼å€¼
  if (percentage > 60) return 1;
  if (percentage > 30) return 2;
  return 3;
}

function updatePhaseDisplay(phase) {
  const phaseIndicatorEl = document.getElementById("phaseIndicator");
  const phaseDescriptionEl = document.getElementById("phaseDescription");
  const currentPhaseEl = document.getElementById("currentPhase");
  
  const phaseInfo = worldBossData?.phases?.[phase.toString()];
  if (phaseInfo) {
    phaseIndicatorEl.textContent = phaseInfo.name;
    phaseDescriptionEl.textContent = phaseInfo.description;
    currentPhaseEl.textContent = `${phase} / 3`;
  } else {
    phaseIndicatorEl.textContent = `ã€ç¬¬${phase}éšæ®µã€‘`;
    phaseDescriptionEl.textContent = "éšæ®µè³‡æ–™è¼‰å…¥ä¸­...";
    currentPhaseEl.textContent = `${phase} / 3`;
  }
}

// æ›´æ–°ä¸–ç•Œç‹è¡€é‡å’Œéšæ®µ
function updateWorldBossHP(current, max) {
  const hpBar = document.getElementById("worldHpBar");
  const hpText = document.getElementById("worldHpText");
  
  const percentage = Math.max(0, (current / max) * 100);
  hpBar.style.width = percentage + "%";
  hpText.textContent = `${current.toLocaleString()} / ${max.toLocaleString()} (${percentage.toFixed(1)}%)`;
  
  // æ›´æ–°éšæ®µ
  const currentPhase = getCurrentPhase(current, max);
  updatePhaseDisplay(currentPhase);
}

// æ›´æ–°ç©å®¶å‚·å®³é¡¯ç¤º
function updatePlayerDamage(damage, rank, challengeCount = 0) {
  const damageEl = document.getElementById("playerTotalDamage");
  const rankEl = document.getElementById("playerRank");
  const countEl = document.getElementById("challengeCount");
  
  damageEl.textContent = damage.toLocaleString();
  rankEl.textContent = rank > 0 ? `æ’å: #${rank}` : "æ’å: æœªåƒèˆ‡";
  countEl.textContent = challengeCount;
}

// æ›´æ–°æ’è¡Œæ¦œ
function updateLeaderboard(leaderboard) {
  const listEl = document.getElementById("leaderboardList");
  
  if (!leaderboard || leaderboard.length === 0) {
    listEl.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">æš«ç„¡æ’è¡Œæ¦œè³‡æ–™</div>';
    return;
  }
  
  // ğŸ¯ é™åˆ¶åªé¡¯ç¤ºå‰10å
  const top10 = leaderboard.slice(0, 10);
  
  let html = '';
  top10.forEach((player, index) => {
    const rank = index + 1;
    const isCurrentPlayer = player.nickname === currentUserNickname;
    const isTop3 = rank <= 3;
    
    let rankClass = '';
    if (rank === 1) rankClass = 'top-1';
    else if (rank === 2) rankClass = 'top-2';
    else if (rank === 3) rankClass = 'top-3';
    
    let itemClass = 'leaderboard-item';
    if (isTop3) itemClass += ' top-3';
    if (isCurrentPlayer) itemClass += ' current-player';
    
    html += `
      <div class="${itemClass}">
        <div class="rank-number ${rankClass}">#${rank}</div>
        <div class="player-name">${player.nickname}${isCurrentPlayer ? ' (ä½ )' : ''}</div>
        <div class="damage-amount">${player.total_damage.toLocaleString()}</div>
      </div>
    `;
  });
  
  // ğŸ¯ å¦‚æœç•¶å‰ç©å®¶ä¸åœ¨å‰10åï¼Œé¡å¤–é¡¯ç¤ºè‡ªå·±çš„æ’å
  if (currentUserNickname) {
    const currentPlayerInTop10 = top10.find(p => p.nickname === currentUserNickname);
    
    if (!currentPlayerInTop10 && playerData && playerData.rank > 10) {
      // æ‰¾åˆ°ç•¶å‰ç©å®¶åœ¨å®Œæ•´æ’è¡Œæ¦œä¸­çš„è³‡æ–™
      const currentPlayerData = leaderboard.find(p => p.nickname === currentUserNickname);
      
      if (currentPlayerData) {
        html += `
          <div class="leaderboard-divider" style="margin: 15px 0; border-top: 1px solid rgba(255,215,0,0.3); text-align: center; padding-top: 10px;">
            <span style="color: #ffd700; font-size: 0.9em;">--- ä½ çš„æ’å ---</span>
          </div>
          <div class="leaderboard-item current-player">
            <div class="rank-number">#${playerData.rank}</div>
            <div class="player-name">${currentPlayerData.nickname} (ä½ )</div>
            <div class="damage-amount">${currentPlayerData.total_damage.toLocaleString()}</div>
          </div>
        `;
      }
    }
  }
  
  // ğŸ¯ æ·»åŠ é¡¯ç¤ºèªªæ˜
  if (leaderboard.length > 10) {
    html += `
      <div style="text-align: center; color: #888; padding: 15px 10px; font-size: 0.85em; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
        é¡¯ç¤ºå‰ 10 å / å…± ${leaderboard.length} ååƒèˆ‡è€…
      </div>
    `;
  }
  
  listEl.innerHTML = html;
}

// è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™
async function loadWorldBossData() {
  try {
    PerformanceMonitor.startTiming('loadWorldBoss');
    
    // ğŸš€ å…ˆæª¢æŸ¥ä¸–ç•Œç‹æ˜¯å¦å·²åˆå§‹åŒ–
    try {
      const initCheckRes = await SecureAPI.get(`${API_BASE}/world_boss_init_check`);
      const initResult = await initCheckRes.json();
      if (!initResult.initialized) {
        console.warn('ä¸–ç•Œç‹æœªåˆå§‹åŒ–:', initResult.error);
        showBattleResult(false, "ç³»çµ±éŒ¯èª¤", "ä¸–ç•Œç‹ç³»çµ±å°šæœªåˆå§‹åŒ–ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡");
        return;
      }
    } catch (initError) {
      console.warn('ä¸–ç•Œç‹åˆå§‹åŒ–æª¢æŸ¥å¤±æ•—:', initError);
    }
    
    // ğŸš€ å„ªåŒ–ï¼šä¸¦è¡Œè¼‰å…¥ä½†æœ‰è¶…æ™‚ä¿è­·
    const timeout = 10000; // 10ç§’è¶…æ™‚
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('è«‹æ±‚è¶…æ™‚')), timeout)
    );
    
    const [bossRes, leaderboardRes, playerRes] = await Promise.race([
      Promise.all([
        SecureAPI.get(`${API_BASE}/world_boss_status`),
        SecureAPI.get(`${API_BASE}/world_boss_leaderboard?limit=50`),
        SecureAPI.get(`${API_BASE}/world_boss_player_data`)
      ]),
      timeoutPromise
    ]);
    
    // è™•ç†ä¸–ç•Œç‹ç‹€æ…‹
    if (bossRes.ok) {
      worldBossData = await bossRes.json();
      if (worldBossData.phases) {
        console.log('âœ… éšæ®µè³‡æ–™è¼‰å…¥æˆåŠŸ:', Object.keys(worldBossData.phases));
      } else {
        console.warn('âš ï¸ éšæ®µè³‡æ–™è¼‰å…¥å¤±æ•—');
      }
      
      updateWorldBossInfo(worldBossData);
      updateWorldBossStats(worldBossData);
      
      console.log(`ğŸ“Š ä¸–ç•Œç‹çµ±è¨ˆ - ç¸½æ”»æ“Š: ${worldBossData.total_participants}, ç¨ç‰¹ç©å®¶: ${worldBossData.unique_players}`);
    } else {
      throw new Error(`è¼‰å…¥ä¸–ç•Œç‹ç‹€æ…‹å¤±æ•—: ${bossRes.status}`);
    }
    
    // è™•ç†æ’è¡Œæ¦œ
    if (leaderboardRes.ok) {
      const leaderboardResult = await leaderboardRes.json();
      updateLeaderboard(leaderboardResult.leaderboard || []);
    } else {
      console.warn('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', leaderboardRes.status);
      updateLeaderboard([]);
    }
    
    // è™•ç†ç©å®¶è³‡æ–™
    if (playerRes.ok) {
      playerData = await playerRes.json();
      updatePlayerDamage(playerData.total_damage, playerData.rank, playerData.challenge_count);
      
      // å¦‚æœæœ‰å†·å»æ™‚é–“ï¼Œé–‹å§‹å€’æ•¸
      if (playerData.cooldown_end_time) {
        startCooldownTimer(playerData.cooldown_end_time);
      }
    } else {
      console.warn('è¼‰å…¥ç©å®¶æ•¸æ“šå¤±æ•—:', playerRes.status);
      updatePlayerDamage(0, 0, 0);
    }
    
    console.log('âœ… ä¸–ç•Œç‹è³‡æ–™è¼‰å…¥å®Œæˆ');
    
  } catch (error) {
    console.error('è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™å¤±æ•—:', error);
    
    // ğŸš€ æ”¹é€²çš„éŒ¯èª¤è™•ç†
    if (error.message.includes('è¶…æ™‚')) {
      showBattleResult(false, "é€£ç·šè¶…æ™‚", "è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†é é¢");
    } else if (error.message.includes('fetch')) {
      showBattleResult(false, "ç¶²è·¯éŒ¯èª¤", "ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
    } else {
      showBattleResult(false, "è¼‰å…¥éŒ¯èª¤", "è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
    }
    
    // è¨­ç½®éŒ¯èª¤ç‹€æ…‹çš„é¡¯ç¤º
    document.getElementById("bossName").textContent = "è¼‰å…¥å¤±æ•—";
    document.getElementById("leaderboardList").innerHTML = 
      '<div style="text-align: center; color: #ff6b6b; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
    
  } finally {
    PerformanceMonitor.endTiming('loadWorldBoss');
  }
}


function updateWorldBossInfo(boss) {
  document.getElementById("bossName").innerHTML = boss.name.replace(/\n/g, "<br>");
  document.getElementById("bossImage").src = boss.image;
  document.getElementById("bossDescription").textContent = boss.description;
  document.getElementById("bossLevel").textContent = boss.level;
  
  // ğŸš€ çµ±ä¸€ä½¿ç”¨æ–°çš„çµ±è¨ˆæ›´æ–°å‡½æ•¸
  updateGlobalStats(boss);
  
  updateWorldBossHP(boss.current_hp, boss.max_hp);
  
  const currentPhase = getCurrentPhase(boss.current_hp, boss.max_hp);
  updatePhaseDisplay(currentPhase);
}

function updateWorldBossStats(boss) {
  // æ›´æ–°ä¸»è¦çµ±è¨ˆè³‡è¨Š
  document.getElementById("totalAttacks").textContent = (boss.total_participants || 0).toLocaleString();
  document.getElementById("bossLevel").textContent = boss.level;
  document.getElementById("currentPhase").textContent = `${boss.current_phase || 1} / 3`;
  
  // é¡¯ç¤ºè©³ç´°çµ±è¨ˆè³‡è¨Š
  const statsContainer = document.querySelector('.world-boss-stats');
  if (statsContainer && boss.unique_players !== undefined) {
    // æ¸…é™¤ç¾æœ‰çµ±è¨ˆä¸¦é‡æ–°å»ºç«‹
    statsContainer.innerHTML = `
      <div class="world-stat-item">ç¸½æ”»æ“Šæ¬¡æ•¸: <span class="world-stat-value" id="totalAttacks">${(boss.total_participants || 0).toLocaleString()}</span></div>
      <div class="world-stat-item">åƒèˆ‡ç©å®¶: <span class="world-stat-value" id="uniquePlayers">${(boss.unique_players || 0).toLocaleString()}</span></div>
      <div class="world-stat-item">ç­‰ç´š: <span class="world-stat-value" id="bossLevel">${boss.level}</span></div>
      <div class="world-stat-item">éšæ®µ: <span class="world-stat-value" id="currentPhase">${boss.current_phase || 1} / 3</span></div>
    `;
  }
}

// é–‹å§‹å†·å»è¨ˆæ™‚å™¨
function startCooldownTimer(endTime) {
  if (cooldownTimer) {
    clearInterval(cooldownTimer);
  }
  
  cooldownTimer = setInterval(() => {
    updateCooldownDisplay(endTime);
  }, 1000);
  
  updateCooldownDisplay(endTime);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(success, title, message, damage = 0) {
  const overlay = document.getElementById("battleResultOverlay");
  const icon = document.getElementById("battleResultIcon");
  const titleEl = document.getElementById("battleResultTitle");
  const messageEl = document.getElementById("battleResultMessage");
  
  if (success) {
    if (title.includes("å®Œç¾æ”»æ“Š")) {
      overlay.style.background = "linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 165, 0, 0.9), rgba(255, 140, 0, 0.95))";
    } else if (title.includes("å¼·åŠ›æ”»æ“Š")) {
      overlay.style.background = "linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 130, 0.85), rgba(148, 0, 211, 0.9))";
    } else if (title.includes("æœ‰æ•ˆæ”»æ“Š")) {
      overlay.style.background = "linear-gradient(135deg, rgba(0, 100, 255, 0.9), rgba(0, 150, 255, 0.85), rgba(30, 144, 255, 0.9))";
    } else {
      overlay.style.background = "linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 140, 0, 0.8), rgba(255, 69, 0, 0.9))";
    }
    
    // ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨ Array.from() æ­£ç¢ºè™•ç† Unicode å­—ç¬¦
    const titleChars = Array.from(title);
    icon.textContent = titleChars[0]; // é€™æ¨£èƒ½æ­£ç¢ºå–å¾—å®Œæ•´çš„ emoji
    
    titleEl.textContent = title;
    messageEl.innerHTML = message;
  } else {
    icon.textContent = "âŒ";
    titleEl.textContent = title || "æŒ‘æˆ°å¤±æ•—";
    messageEl.textContent = message || "æŒ‘æˆ°éç¨‹ç™¼ç”ŸéŒ¯èª¤";
    overlay.style.background = "linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(220, 20, 60, 0.8), rgba(75, 0, 130, 0.9))";
  }
  
  overlay.style.display = "flex";
}

function closeBattleResult() {
  document.getElementById("battleResultOverlay").style.display = "none";
}

// æŒ‘æˆ°ä¸–ç•Œç‹
async function challengeWorldBoss() {
  // å‰ç«¯ç­‰ç´šæª¢æŸ¥
  if (userLevel < REQUIRED_LEVEL) {
    showBattleResult(false, "ç­‰ç´šä¸è¶³", 
      `éœ€è¦é”åˆ° ${REQUIRED_LEVEL} ç­‰æ‰èƒ½æŒ‘æˆ°ä¸–ç•Œç‹\nä½ ç›®å‰æ˜¯ ${userLevel} ç­‰ï¼Œé‚„éœ€è¦ ${REQUIRED_LEVEL - userLevel} ç­‰`);
    return;
  }
  
  if (isWeekend()) {
    showBattleResult(false, "æ™‚é–“é™åˆ¶", "ä¸–ç•Œç‹æ–¼é€±æ—¥ä¼‘æ•´ï¼Œè«‹æ–¼é€±ä¸€å†ä¾†æŒ‘æˆ°ï¼");
    return;
  }
  
  const challengeBtnEl = document.getElementById("challengeBtn");
  if (challengeBtnEl.disabled) return;
  
  challengeBtnEl.disabled = true;
  challengeBtnEl.textContent = "âš”ï¸ æˆ°é¬¥ä¸­...";
  
  try {
    const response = await SecureAPI.post(`${API_BASE}/world_boss_challenge`, {});
    const result = await response.json();
    
    if (response.ok && result.success) {
      const message = `
        <div style="text-align: left; line-height: 1.6;">
          <div style="margin-bottom: 15px;">
            <div style="font-size: 1.3em; color: #ffd700; margin-bottom: 8px;">
              ${result.reward_tier} - ${result.tier_description}
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
              é€ æˆå‚·å®³ï¼š<span style="color: #ff6b6b; font-weight: bold;">${result.damage_dealt.toLocaleString()}</span><br>
              å‚·å®³ç™¾åˆ†æ¯”ï¼š<span style="color: #00ffff; font-weight: bold;">${result.damage_percentage.toFixed(4)}%</span><br>
              ç²å¾—ç¶“é©—ï¼š<span style="color: #ffd700; font-weight: bold;">+${result.exp_gained.toLocaleString()}</span>
            </div>
            <div style="background: rgba(0,255,255,0.1); padding: 8px; border-radius: 6px;">
              ç´¯ç©å‚·å®³ï¼š${result.total_damage.toLocaleString()}<br>
              ç•¶å‰æ’åï¼š#${result.current_rank}<br>
              <span style="color: #ffd700;">ğŸ¯ é€™æ˜¯ä½ çš„ç¬¬ ${playerData.challenge_count + 1} æ¬¡æ”»æ“Š</span>
            </div>
          </div>
        </div>
      `;
      
      // ğŸš€ æ ¹æ“šçå‹µç­‰ç´šé¡¯ç¤ºä¸åŒçš„æ¨™é¡Œå’Œåœ–ç¤º
      let title = "âš”ï¸ æˆ°é¬¥æˆåŠŸï¼";
      
      switch(result.reward_tier) {
        case "Sç´šå‚·å®³":
          title = "ğŸŒŸ å®Œç¾æ”»æ“Šï¼";
          break;
        case "Aç´šå‚·å®³":
          title = "ğŸ’¥ å¼·åŠ›æ”»æ“Šï¼";
          break;
        case "Bç´šå‚·å®³":
          title = "âš”ï¸ æœ‰æ•ˆæ”»æ“Šï¼";
          break;
        case "Cç´šå‚·å®³":
          title = "ğŸ›¡ï¸ æˆåŠŸå‘½ä¸­ï¼";
          break;
      }
      
      showBattleResult(true, title, message, result.damage_dealt);
      
      // ğŸš€ å„ªåŒ–ï¼šç›´æ¥ä½¿ç”¨å¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–°é¡¯ç¤ºï¼Œé¿å…é¡å¤–APIèª¿ç”¨
      updatePlayerDamage(result.total_damage, result.current_rank, playerData.challenge_count + 1);
      
      // ğŸš€ å„ªåŒ–ï¼šä½¿ç”¨å¾Œç«¯è¿”å›çš„ä¸–ç•Œç‹è¡€é‡è³‡æ–™æ›´æ–°é¡¯ç¤º
      if (result.world_boss_hp) {
        updateWorldBossHP(result.world_boss_hp.current, result.world_boss_hp.max);
      }
      
      // ğŸš€ æ‰¹æ¬¡æ›´æ–°ï¼šåªåœ¨å¿…è¦æ™‚æ‰é‡æ–°è¼‰å…¥å®Œæ•´è³‡æ–™
      setTimeout(async () => {
        try {
          // åªé‡æ–°è¼‰å…¥æ’è¡Œæ¦œï¼Œå› ç‚ºå…¶ä»–è³‡æ–™å·²ç¶“å¾æˆ°é¬¥çµæœç²å¾—
          const leaderboardRes = await SecureAPI.get(`${API_BASE}/world_boss_leaderboard?limit=50`);
          if (leaderboardRes.ok) {
            const leaderboardResult = await leaderboardRes.json();
            updateLeaderboard(leaderboardResult.leaderboard || []);
          }
        } catch (updateError) {
          console.warn('æ›´æ–°æ’è¡Œæ¦œå¤±æ•—:', updateError);
        }
      }, 500); // æ¸›å°‘å»¶é²
      
      // é–‹å§‹å†·å»è¨ˆæ™‚
      startCooldownTimer(result.cooldown_end_time);
      
    } else {
      // è™•ç†ç­‰ç´šä¸è¶³éŒ¯èª¤
      if (result.required_level && result.current_level) {
        showBattleResult(false, "ç­‰ç´šé™åˆ¶", 
          `éœ€è¦é”åˆ° ${result.required_level} ç­‰æ‰èƒ½æŒ‘æˆ°ä¸–ç•Œç‹\nä½ ç›®å‰æ˜¯ ${result.current_level} ç­‰ï¼Œé‚„éœ€è¦å‡ ${result.level_shortage} ç­‰`);
      } else {
        showBattleResult(false, "æŒ‘æˆ°å¤±æ•—", result.error || "æœªçŸ¥éŒ¯èª¤");
      }
      
      // é‡æ–°æª¢æŸ¥ç­‰ç´šé™åˆ¶ç‹€æ…‹
      checkLevelRequirement();
    }
    
  } catch (error) {
    console.error('æŒ‘æˆ°ä¸–ç•Œç‹å¤±æ•—:', error);
    showBattleResult(false, "é€£ç·šéŒ¯èª¤", "æŒ‘æˆ°éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
    
    // é‡æ–°æª¢æŸ¥ç­‰ç´šé™åˆ¶ç‹€æ…‹
    checkLevelRequirement();
  }
}


// å°ˆé–€æ›´æ–°çµ±è¨ˆè³‡è¨Šçš„å‡½æ•¸
function updateGlobalStats(bossData) {
  // ğŸ¯ æ­£ç¢ºçš„å¾Œç«¯è³‡æ–™ â†’ å‰ç«¯å…ƒç´ å°æ‡‰
  const dataMapping = {
    // å¾Œç«¯ API æ¬„ä½ â†’ å‰ç«¯ DOM å…ƒç´  ID
    'total_participants': 'totalAttacks',      // ç¸½æ”»æ“Šæ¬¡æ•¸
    'unique_players': 'uniquePlayers',         // ç¨ç‰¹ç©å®¶æ•¸
    'level': 'bossLevel',                      // ä¸–ç•Œç‹ç­‰ç´š
    'current_phase': 'currentPhase'            // ç•¶å‰éšæ®µ
  };
  
  // ğŸš€ å®‰å…¨æ›´æ–°å‡½æ•¸
  const updateElement = (elementId, value) => {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = value;
      return true;
    } else {
      console.warn(`âš ï¸ æ‰¾ä¸åˆ°å…ƒç´ : ${elementId}`);
      return false;
    }
  };
  
  // ğŸ“Š åŸ·è¡Œè³‡æ–™æ›´æ–°ï¼ˆæŒ‰ç…§æ­£ç¢ºçš„å°æ‡‰é—œä¿‚ï¼‰
  updateElement('totalAttacks', (bossData.total_participants || 0).toLocaleString());
  updateElement('uniquePlayers', (bossData.unique_players || 0).toLocaleString());
  updateElement('bossLevel', bossData.level || 100);
  updateElement('currentPhase', `${bossData.current_phase || 1} / 3`);
  
  console.log(`ğŸ“Š çµ±è¨ˆæ›´æ–°å®Œæˆ:`);
  console.log(`  - ç¸½æ”»æ“Šæ¬¡æ•¸: ${(bossData.total_participants || 0).toLocaleString()}`);
  console.log(`  - ç¨ç‰¹ç©å®¶: ${(bossData.unique_players || 0).toLocaleString()}`);
  console.log(`  - ç¸½å‚·å®³: ${(bossData.total_damage_dealt || 0).toLocaleString()}`);
}
  
// é›¢é–‹ä¸–ç•Œç‹æˆ°å ´
function leaveWorldBoss() {
  window.parent.postMessage({ command: "restoreMainMusic" }, "*");
  setTimeout(() => {
    window.parent.loadPage('main_page.html');
  }, 300);
}

// ğŸ”§ ç®¡ç†å“¡åŠŸèƒ½ï¼šé‡ç½®ä¸–ç•Œç‹ï¼ˆé–‹ç™¼/æ¸¬è©¦ç”¨ï¼‰
async function resetWorldBoss() {
  if (!confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®ä¸–ç•Œç‹å—ï¼Ÿ\né€™å°‡é‡ç½®è¡€é‡å’Œæ‰€æœ‰çµ±è¨ˆæ•¸æ“šï¼\n\næ˜¯å¦åŒæ™‚æ¸…é™¤æ’è¡Œæ¦œï¼Ÿ\né»ç¢ºå®š=æ¸…é™¤æ’è¡Œæ¦œï¼Œå–æ¶ˆ=ä¿ç•™æ’è¡Œæ¦œ')) {
    return;
  }
  
  const clearLeaderboard = confirm('æ˜¯å¦æ¸…é™¤æ’è¡Œæ¦œï¼Ÿ\nç¢ºå®š=æ¸…é™¤ï¼Œå–æ¶ˆ=ä¿ç•™');
  
  try {
    const response = await SecureAPI.post(`${API_BASE}/world_boss_reset`, {
      clear_leaderboard: clearLeaderboard
    });
    const result = await response.json();
    
    if (response.ok) {
      showBattleResult(true, "é‡ç½®æˆåŠŸ", `ä¸–ç•Œç‹å·²é‡ç½®ï¼\n${clearLeaderboard ? 'æ’è¡Œæ¦œå·²æ¸…é™¤' : 'æ’è¡Œæ¦œå·²ä¿ç•™'}`);
      setTimeout(() => {
        loadWorldBossData();
      }, 2000);
    } else {
      showBattleResult(false, "é‡ç½®å¤±æ•—", result.error);
    }
  } catch (error) {
    showBattleResult(false, "é‡ç½®éŒ¯èª¤", "é‡ç½®éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
  }
}

// ğŸ”§ é–‹ç™¼è€…æ¨¡å¼æª¢æ¸¬
const isDeveloper = window.location.hostname === 'localhost' || 
                   window.location.search.includes('debug=true') ||
                   window.location.search.includes('admin=true');

// å¼·åˆ¶åˆ·æ–°åŠŸèƒ½ï¼ˆçˆ¶è¦–çª—èª¿ç”¨ï¼‰
window.addEventListener('message', (event) => {
  if (event.data && event.data.command === 'forceRefresh') {
    console.log('æ”¶åˆ°å¼·åˆ¶åˆ·æ–°æŒ‡ä»¤');
    loadWorldBossData();
  }
});

// å…¨åŸŸå‡½æ•¸
window.challengeWorldBoss = challengeWorldBoss;
window.leaveWorldBoss = leaveWorldBoss;
window.closeBattleResult = closeBattleResult;
window.resetWorldBoss = resetWorldBoss; // ç®¡ç†å“¡åŠŸèƒ½

// åˆå§‹åŒ–
function initWorldBoss() {
  // é€šçŸ¥çˆ¶è¦–çª—åˆ‡æ›éŸ³æ¨‚
  window.parent.postMessage({ command: "switchToWorldBossMusic" }, "*");
  
  createPageParticles();
  startPageLoadingProgress();
  
  // ğŸ”§ é–‹ç™¼è€…æ¨¡å¼ï¼šæ·»åŠ ç®¡ç†å“¡æ§åˆ¶
  if (isDeveloper) {
    const challengeArea = document.querySelector('.challenge-button-area');
    if (challengeArea) {
      const adminBtn = document.createElement('button');
      adminBtn.textContent = 'ğŸ”§ é‡ç½®ä¸–ç•Œç‹ (ç®¡ç†å“¡)';
      adminBtn.style.cssText = `
        background: linear-gradient(135deg, #dc3545, #c82333);
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        font-family: 'Orbitron', sans-serif;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
        width: 100%;
        font-size: 0.9em;
      `;
      adminBtn.onclick = resetWorldBoss;
      challengeArea.appendChild(adminBtn);
      
      console.log('ğŸ”§ é–‹ç™¼è€…æ¨¡å¼å·²å•Ÿç”¨ï¼Œç®¡ç†å“¡åŠŸèƒ½å¯ç”¨');
    }
  }
  
  // è¼‰å…¥ä½¿ç”¨è€…ç­‰ç´šå’Œä¸–ç•Œç‹è³‡æ–™
  setTimeout(async () => {
    await loadUserLevel();  // å…ˆè¼‰å…¥ä½¿ç”¨è€…ç­‰ç´š
    await loadWorldBossData();
    hidePageLoading();
  }, 2000);
  
  // é–‹å§‹å€’æ•¸è¨ˆæ™‚å™¨
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

// ç›£è½ç™»å…¥ç‹€æ…‹
onAuthStateChanged(auth, async (user) => {
  if (user) {
    initWorldBoss();
  } else {
    window.parent.location.href = "/SFL/login.html";
  }
});
</script>
</body>
</html>
