<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>ä¸–ç•Œç‹æŒ‘æˆ°</title>
<link rel="icon" href="favicon.ico" />
<link href="css/style.css" rel="stylesheet"/>
<link href="css/dungeon_layer_winning.css" rel="stylesheet"/>
<link href="css/dungeon_layer.css" rel="stylesheet"/>
<link href="css/world_boss.css" rel="stylesheet"/>
</head>
<body class="world-boss-mode">

<!-- ä¸–ç•Œç‹è¡€é‡æ¢ -->
<div class="world-boss-hp-container">
  <div class="world-boss-title">ğŸŒ ä¸–ç•Œç‹æŒ‘æˆ° ğŸŒ</div>
  <div class="world-hp-bar-container">
    <div class="world-hp-bar" id="worldHpBar" style="width: 100%;">
      <div class="world-hp-text" id="worldHpText">è¼‰å…¥ä¸­...</div>
    </div>
  </div>
  <div class="world-boss-stats">
    <div class="world-stat-item">åƒèˆ‡è€…: <span class="world-stat-value" id="participantCount">-</span></div>
    <div class="world-stat-item">ç­‰ç´š: <span class="world-stat-value" id="bossLevel">80</span></div>
    <div class="world-stat-item">éšæ®µ: <span class="world-stat-value" id="currentPhase">1 / 3</span></div>
  </div>
</div>

<!-- éšæ®µæŒ‡ç¤ºå™¨ -->
<div class="phase-indicator" id="phaseIndicator">
  è¼‰å…¥éšæ®µè³‡è¨Š...
</div>

<!-- å€’æ•¸è¨ˆæ™‚å™¨ -->
<div class="countdown-timer">
  <div class="countdown-label">â° æŒ‘æˆ°é–‹æ”¾å€’æ•¸</div>
  <div class="countdown-value" id="countdownDisplay">è¨ˆç®—ä¸­...</div>
</div>

<!-- é é¢è¼‰å…¥é®ç½© -->
<div id="loadingOverlay">
  <div class="particles" id="pageParticles"></div>
  <div class="battle-loading-container">
    <div class="battle-icon">ğŸ²</div>
    <div class="battle-title normal-title">è¼‰å…¥ä¸–ç•Œç‹</div>
    <div class="loading-text" id="pageLoadingText">æ­£åœ¨é€£æ¥ä¸–ç•Œç‹æˆ°å ´...</div>
    <div class="progress-container">
      <div class="progress-bar" id="pageProgressBar"></div>
    </div>
    <div class="progress-text" id="pageProgressText">0%</div>
    <div class="battle-tips">
      ğŸŒ å…¨ä¸–ç•Œçš„å†’éšªè€…æ­£åœ¨ä¸€èµ·æˆ°é¬¥ï¼<br/>
      âš”ï¸ æ¯ä¸€æ¬¡æ”»æ“Šéƒ½é—œä¹äººé¡çš„å‘½é‹
    </div>
  </div>
</div>

<!-- ä¸»è¦å…§å®¹å€åŸŸ -->
<div class="world-boss-container">
  <!-- å·¦å´é¢æ¿ï¼šç©å®¶æŒ‘æˆ°å€åŸŸ -->
  <div class="left-panel">
    <!-- æ™‚é–“é™åˆ¶æç¤ºï¼ˆé€±æ—¥é¡¯ç¤ºï¼‰ -->
    <div class="time-restriction-notice" id="timeRestriction" style="display: none;">
      <div class="restriction-title">â° æŒ‘æˆ°æ™‚é–“é™åˆ¶</div>
      <div class="restriction-message">
        ä¸–ç•Œç‹æ¯é€±æ—¥é€²è¡Œä¼‘æ•´ï¼Œç„¡æ³•æŒ‘æˆ°<br>
        æŒ‘æˆ°å°‡æ–¼ä¸‹é€±ä¸€ 00:00 é‡æ–°é–‹æ”¾
      </div>
    </div>

    <!-- ç©å®¶æŒ‘æˆ°å¡ç‰‡ -->
    <div class="player-challenge-card">
      <div class="player-damage-stats">
        <div class="damage-title">ğŸ† ä½ çš„ç´¯ç©å‚·å®³</div>
        <div class="total-damage" id="playerTotalDamage">0</div>
        <div class="damage-rank" id="playerRank">æ’å: æœªåƒèˆ‡</div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #ccc;">
          æŒ‘æˆ°æ¬¡æ•¸: <span id="challengeCount">0</span> æ¬¡
        </div>
      </div>
      
      <div class="challenge-button-area">
        <button class="world-challenge-btn" id="challengeBtn" onclick="challengeWorldBoss()">
          ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ
        </button>
        <div class="cooldown-info" id="cooldownInfo" style="display: none;">
          å†·å»ä¸­ï¼Œè«‹ç­‰å¾…ï¼š<span id="cooldownTimer">00:00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸–ç•Œç‹è³‡è¨Š -->
    <div class="section world-boss-info-container">
      <div class="world-boss-name" id="bossName">è¼‰å…¥ä¸­...</div>
      <div class="world-boss-phase" id="phaseDescription">è¼‰å…¥éšæ®µè³‡è¨Š...</div>
      <img src="" class="world-boss-image" id="bossImage" width="250">
      <div class="world-boss-description" id="bossDescription">è¼‰å…¥ä¸­...</div>
    </div>

  <!-- å³å´é¢æ¿ï¼šæ’è¡Œæ¦œ -->
  <div class="right-panel">
    <div class="leaderboard-card">
      <div class="leaderboard-title">ğŸ† å‚·å®³æ’è¡Œæ¦œ</div>
      <div class="leaderboard-list" id="leaderboardList">
        <div style="text-align: center; color: #888; padding: 20px;">
          è¼‰å…¥æ’è¡Œæ¦œä¸­...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å‹åˆ©/æˆ°é¬¥çµæœé®ç½© -->
<div class="victory-overlay" id="battleResultOverlay" style="display: none;">
  <div class="victory-content">
    <div class="victory-icon" id="battleResultIcon">âš”ï¸</div>
    <div class="victory-title" id="battleResultTitle">æˆ°é¬¥çµæœ</div>
    <div class="victory-message" id="battleResultMessage">çµæœè¨Šæ¯</div>
    <button class="effect-button" onclick="closeBattleResult()">ç¢ºå®š</button>
  </div>
</div>

<script type="module">
import { auth, SecureAPI, PerformanceMonitor } from "./js/firebase-init.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const API_BASE = "https://sfl-9cb8.onrender.com";

let worldBossData = null;
let playerData = null;
let leaderboardData = [];
let cooldownTimer = null;
let currentUserNickname = "";

// éšæ®µé…ç½®
const PHASES = {
  1: {
    name: "ã€ç¬¬ä¸€éšæ®µã€‘è³‡æ–™è¼‰å…¥ä¸­",
    description: "è³‡æ–™è¼‰å…¥ä¸­...",
    hp_threshold: 100
  },
  2: {
    name: "ã€ç¬¬äºŒéšæ®µã€‘è³‡æ–™è¼‰å…¥ä¸­",
    description: "è³‡æ–™è¼‰å…¥ä¸­...",
    hp_threshold: 60
  },
  3: {
    name: "ã€ç¬¬ä¸‰éšæ®µã€‘è³‡æ–™è¼‰å…¥ä¸­",
    description: "è³‡æ–™è¼‰å…¥ä¸­...",
    hp_threshold: 30
  }
};

// è¼‰å…¥é é¢åˆå§‹åŒ–
function createPageParticles() {
  const particlesContainer = document.getElementById("pageParticles");
  if (!particlesContainer) return;
  particlesContainer.innerHTML = "";
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement("div");
    particle.className = "particle";
    particle.style.left = Math.random() * 100 + "%";
    particle.style.animationDelay = Math.random() * 4 + "s";
    particle.style.animationDuration = (Math.random() * 2 + 3) + "s";
    particle.style.background = `rgba(${Math.random() > 0.5 ? '255, 215, 0' : '255, 140, 0'}, 0.8)`;
    particlesContainer.appendChild(particle);
  }
}

function startPageLoadingProgress() {
  const progressBar = document.getElementById("pageProgressBar");
  const progressText = document.getElementById("pageProgressText");
  const loadingText = document.getElementById("pageLoadingText");
  if (!progressBar || !progressText || !loadingText) return;

  const messages = [
    "æ­£åœ¨é€£æ¥ä¸–ç•Œç‹æˆ°å ´...",
    "è¼‰å…¥å…¨çƒæˆ°é¬¥è³‡æ–™...", 
    "åŒæ­¥ä¸–ç•Œç‹ç‹€æ…‹...",
    "è¼‰å…¥æ’è¡Œæ¦œè³‡æ–™...",
    "é€£æ¥å®Œæˆï¼"
  ];

  let progress = 0;
  let messageIndex = 0;
  const progressInterval = setInterval(() => {
    progress += Math.random() * 15 + 10;
    if (progress > 100) progress = 100;

    progressBar.style.width = progress + "%";
    progressText.textContent = Math.round(progress) + "%";

    if (messageIndex < messages.length - 1 && progress > (messageIndex + 1) * 20) {
      messageIndex++;
      loadingText.textContent = messages[messageIndex];
    }

    if (progress >= 100) {
      clearInterval(progressInterval);
      loadingText.textContent = messages[messages.length - 1];
    }
  }, 300);

  window.pageLoadingInterval = progressInterval;
}

function showLoading(show) {
  const loading = document.getElementById("loadingOverlay");
  if (!loading) return;
  loading.style.display = show ? "flex" : "none";
}

function hidePageLoading() {
  if (window.pageLoadingInterval) {
    clearInterval(window.pageLoadingInterval);
  }
  setTimeout(() => {
    showLoading(false);
  }, 1000);
}

// æ™‚é–“ç›¸é—œå‡½æ•¸
function isWeekend() {
  const now = new Date();
  const taipeiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  return taipeiTime.getDay() === 0; // é€±æ—¥
}

function getNextMondayCountdown() {
  const now = new Date();
  const taipeiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  
  // æ‰¾ä¸‹é€±ä¸€ 00:00
  const nextMonday = new Date(taipeiTime);
  const daysUntilMonday = (7 - taipeiTime.getDay() + 1) % 7;
  nextMonday.setDate(taipeiTime.getDate() + (daysUntilMonday === 0 ? 7 : daysUntilMonday));
  nextMonday.setHours(0, 0, 0, 0);
  
  const diff = nextMonday - taipeiTime;
  
  if (diff <= 0) return "00:00:00";
  
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diff % (1000 * 60)) / 1000);
  
  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// æ›´æ–°å€’æ•¸è¨ˆæ™‚å™¨
function updateCountdown() {
  const countdownEl = document.getElementById("countdownDisplay");
  const timeRestrictionEl = document.getElementById("timeRestriction");
  const challengeBtnEl = document.getElementById("challengeBtn");
  
  if (isWeekend()) {
    countdownEl.textContent = getNextMondayCountdown();
    timeRestrictionEl.style.display = "block";
    challengeBtnEl.disabled = true;
    challengeBtnEl.textContent = "â° é€±æ—¥ä¼‘æ•´ä¸­";
  } else {
    timeRestrictionEl.style.display = "none";
    countdownEl.textContent = "æŒ‘æˆ°é–‹æ”¾ä¸­";
    if (!challengeBtnEl.dataset.cooling) {
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
    }
  }
}

// æ›´æ–°å†·å»æ™‚é–“é¡¯ç¤º
function updateCooldownDisplay(cooldownEndTime) {
  const cooldownInfoEl = document.getElementById("cooldownInfo");
  const cooldownTimerEl = document.getElementById("cooldownTimer");
  const challengeBtnEl = document.getElementById("challengeBtn");
  
  if (!cooldownEndTime) {
    cooldownInfoEl.style.display = "none";
    challengeBtnEl.dataset.cooling = "false";
    if (!isWeekend()) {
      challengeBtnEl.disabled = false;
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
    }
    return;
  }
  
  const now = Date.now();
  const remaining = cooldownEndTime - now;
  
  if (remaining <= 0) {
    cooldownInfoEl.style.display = "none";
    challengeBtnEl.dataset.cooling = "false";
    if (!isWeekend()) {
      challengeBtnEl.disabled = false;
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
    }
    if (cooldownTimer) {
      clearInterval(cooldownTimer);
      cooldownTimer = null;
    }
    return;
  }
  
  const minutes = Math.floor(remaining / (1000 * 60));
  const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
  
  cooldownInfoEl.style.display = "block";
  cooldownTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  challengeBtnEl.disabled = true;
  challengeBtnEl.dataset.cooling = "true";
  challengeBtnEl.textContent = "â° å†·å»ä¸­";
}

// éšæ®µç³»çµ±
function getCurrentPhase(currentHp, maxHp) {
  const percentage = (currentHp / maxHp) * 100;
  
  // ä½¿ç”¨ API è³‡æ–™ä¸­çš„ hp_threshold
  if (worldBossData?.phases) {
    const phases = worldBossData.phases;
    
    // å¾æœ€ä½éšæ®µé–‹å§‹æª¢æŸ¥
    if (percentage <= (phases["3"]?.hp_threshold || 30)) return 3;
    if (percentage <= (phases["2"]?.hp_threshold || 60)) return 2;
    return 1;
  }
  
  // é™ç´šè™•ç†ï¼šä½¿ç”¨ç¡¬ç·¨ç¢¼å€¼
  if (percentage > 60) return 1;
  if (percentage > 30) return 2;
  return 3;
}

function updatePhaseDisplay(phase) {
  const phaseIndicatorEl = document.getElementById("phaseIndicator");
  const phaseDescriptionEl = document.getElementById("phaseDescription");
  const currentPhaseEl = document.getElementById("currentPhase");
  
  const phaseInfo = worldBossData?.phases?.[phase.toString()];
  if (phaseInfo) {
    phaseIndicatorEl.textContent = phaseInfo.name;
    phaseDescriptionEl.textContent = phaseInfo.description;
    currentPhaseEl.textContent = `${phase} / 3`;
  } else {
    phaseIndicatorEl.textContent = `ã€ç¬¬${phase}éšæ®µã€‘`;
    phaseDescriptionEl.textContent = "éšæ®µè³‡æ–™è¼‰å…¥ä¸­...";
    currentPhaseEl.textContent = `${phase} / 3`;
  }
}

// æ›´æ–°ä¸–ç•Œç‹è¡€é‡å’Œéšæ®µ
function updateWorldBossHP(current, max) {
  const hpBar = document.getElementById("worldHpBar");
  const hpText = document.getElementById("worldHpText");
  
  const percentage = Math.max(0, (current / max) * 100);
  hpBar.style.width = percentage + "%";
  hpText.textContent = `${current.toLocaleString()} / ${max.toLocaleString()} (${percentage.toFixed(1)}%)`;
  
  // æ›´æ–°éšæ®µ
  const currentPhase = getCurrentPhase(current, max);
  updatePhaseDisplay(currentPhase);
}

// æ›´æ–°ç©å®¶å‚·å®³é¡¯ç¤º
function updatePlayerDamage(damage, rank, challengeCount = 0) {
  const damageEl = document.getElementById("playerTotalDamage");
  const rankEl = document.getElementById("playerRank");
  const countEl = document.getElementById("challengeCount");
  
  damageEl.textContent = damage.toLocaleString();
  rankEl.textContent = rank > 0 ? `æ’å: #${rank}` : "æ’å: æœªåƒèˆ‡";
  countEl.textContent = challengeCount;
}

// æ›´æ–°æ’è¡Œæ¦œ
function updateLeaderboard(leaderboard) {
  const listEl = document.getElementById("leaderboardList");
  
  if (!leaderboard || leaderboard.length === 0) {
    listEl.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">æš«ç„¡æ’è¡Œæ¦œè³‡æ–™</div>';
    return;
  }
  
  // ğŸ¯ é™åˆ¶åªé¡¯ç¤ºå‰10å
  const top10 = leaderboard.slice(0, 10);
  
  let html = '';
  top10.forEach((player, index) => {
    const rank = index + 1;
    const isCurrentPlayer = player.nickname === currentUserNickname;
    const isTop3 = rank <= 3;
    
    let rankClass = '';
    if (rank === 1) rankClass = 'top-1';
    else if (rank === 2) rankClass = 'top-2';
    else if (rank === 3) rankClass = 'top-3';
    
    let itemClass = 'leaderboard-item';
    if (isTop3) itemClass += ' top-3';
    if (isCurrentPlayer) itemClass += ' current-player';
    
    html += `
      <div class="${itemClass}">
        <div class="rank-number ${rankClass}">#${rank}</div>
        <div class="player-name">${player.nickname}${isCurrentPlayer ? ' (ä½ )' : ''}</div>
        <div class="damage-amount">${player.total_damage.toLocaleString()}</div>
      </div>
    `;
  });
  
  // ğŸ¯ å¦‚æœç•¶å‰ç©å®¶ä¸åœ¨å‰10åï¼Œé¡å¤–é¡¯ç¤ºè‡ªå·±çš„æ’å
  if (currentUserNickname) {
    const currentPlayerInTop10 = top10.find(p => p.nickname === currentUserNickname);
    
    if (!currentPlayerInTop10 && playerData && playerData.rank > 10) {
      // æ‰¾åˆ°ç•¶å‰ç©å®¶åœ¨å®Œæ•´æ’è¡Œæ¦œä¸­çš„è³‡æ–™
      const currentPlayerData = leaderboard.find(p => p.nickname === currentUserNickname);
      
      if (currentPlayerData) {
        html += `
          <div class="leaderboard-divider" style="margin: 15px 0; border-top: 1px solid rgba(255,215,0,0.3); text-align: center; padding-top: 10px;">
            <span style="color: #ffd700; font-size: 0.9em;">--- ä½ çš„æ’å ---</span>
          </div>
          <div class="leaderboard-item current-player">
            <div class="rank-number">#${playerData.rank}</div>
            <div class="player-name">${currentPlayerData.nickname} (ä½ )</div>
            <div class="damage-amount">${currentPlayerData.total_damage.toLocaleString()}</div>
          </div>
        `;
      }
    }
  }
  
  // ğŸ¯ æ·»åŠ é¡¯ç¤ºèªªæ˜
  if (leaderboard.length > 10) {
    html += `
      <div style="text-align: center; color: #888; padding: 15px 10px; font-size: 0.85em; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
        é¡¯ç¤ºå‰ 10 å / å…± ${leaderboard.length} ååƒèˆ‡è€…
      </div>
    `;
  }
  
  listEl.innerHTML = html;
}

// è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™
async function loadWorldBossData() {
  try {
    PerformanceMonitor.startTiming('loadWorldBoss');
    
    // ğŸš€ å…ˆæª¢æŸ¥ä¸–ç•Œç‹æ˜¯å¦å·²åˆå§‹åŒ–
    try {
      const initCheckRes = await SecureAPI.get(`${API_BASE}/world_boss_init_check`);
      const initResult = await initCheckRes.json();
      if (!initResult.initialized) {
        console.warn('ä¸–ç•Œç‹æœªåˆå§‹åŒ–:', initResult.error);
      }
    } catch (initError) {
      console.warn('ä¸–ç•Œç‹åˆå§‹åŒ–æª¢æŸ¥å¤±æ•—:', initError);
    }
    
    // ä¸¦è¡Œè¼‰å…¥ä¸–ç•Œç‹è³‡æ–™å’Œæ’è¡Œæ¦œ
    const [bossRes, leaderboardRes, playerRes] = await Promise.all([
      SecureAPI.get(`${API_BASE}/world_boss_status`),
      // ğŸ¯ è«‹æ±‚æ›´å¤šæ•¸æ“šä»¥ä¾¿å‰ç«¯ç¯©é¸ï¼Œæˆ–è€…å¾Œç«¯é™åˆ¶ç‚º50åé¿å…æ€§èƒ½å•é¡Œ
      SecureAPI.get(`${API_BASE}/world_boss_leaderboard?limit=50`),
      SecureAPI.get(`${API_BASE}/world_boss_player_data`)
    ]);
    
    if (bossRes.ok) {
      worldBossData = await bossRes.json();
      if (worldBossData.phases) {
        console.log('âœ… éšæ®µè³‡æ–™è¼‰å…¥æˆåŠŸ:', Object.keys(worldBossData.phases));
      } else {
        console.warn('âš ï¸ éšæ®µè³‡æ–™è¼‰å…¥å¤±æ•—');
      }
      
      updateWorldBossInfo(worldBossData);
    } else {
      throw new Error(`è¼‰å…¥ä¸–ç•Œç‹ç‹€æ…‹å¤±æ•—: ${bossRes.status}`);
    }
    
    if (leaderboardRes.ok) {
      const leaderboardResult = await leaderboardRes.json();
      // ğŸ¯ å‚³å…¥å®Œæ•´çš„æ’è¡Œæ¦œæ•¸æ“šï¼Œè®“å‰ç«¯è™•ç†é¡¯ç¤ºé‚è¼¯
      updateLeaderboard(leaderboardResult.leaderboard || []);
    } else {
      console.warn('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', leaderboardRes.status);
      updateLeaderboard([]);
    }
    
    if (playerRes.ok) {
      playerData = await playerRes.json();
      updatePlayerDamage(playerData.total_damage, playerData.rank, playerData.challenge_count);
      
      // å¦‚æœæœ‰å†·å»æ™‚é–“ï¼Œé–‹å§‹å€’æ•¸
      if (playerData.cooldown_end_time) {
        startCooldownTimer(playerData.cooldown_end_time);
      }
    } else {
      console.warn('è¼‰å…¥ç©å®¶æ•¸æ“šå¤±æ•—:', playerRes.status);
      updatePlayerDamage(0, 0, 0);
    }
    
    console.log('âœ… ä¸–ç•Œç‹è³‡æ–™è¼‰å…¥å®Œæˆ');
    
  } catch (error) {
    console.error('è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™å¤±æ•—:', error);
    document.getElementById("bossName").textContent = "è¼‰å…¥å¤±æ•—";
    document.getElementById("leaderboardList").innerHTML = 
      '<div style="text-align: center; color: #ff6b6b; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
      
    // é¡¯ç¤ºéŒ¯èª¤æç¤º
    showBattleResult(false, "è¼‰å…¥éŒ¯èª¤", "ç„¡æ³•è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†é é¢");
  } finally {
    PerformanceMonitor.endTiming('loadWorldBoss');
  }
}

function updateWorldBossInfo(boss) {
  document.getElementById("bossName").innerHTML = boss.name.replace(/\n/g, "<br>");
  document.getElementById("bossImage").src = boss.image;
  document.getElementById("bossDescription").textContent = boss.description;
  document.getElementById("bossLevel").textContent = boss.level;
  document.getElementById("participantCount").textContent = boss.total_participants.toLocaleString();
  
  updateWorldBossHP(boss.current_hp, boss.max_hp);
  
  const currentPhase = getCurrentPhase(boss.current_hp, boss.max_hp);
  updatePhaseDisplay(currentPhase);
}

// é–‹å§‹å†·å»è¨ˆæ™‚å™¨
function startCooldownTimer(endTime) {
  if (cooldownTimer) {
    clearInterval(cooldownTimer);
  }
  
  cooldownTimer = setInterval(() => {
    updateCooldownDisplay(endTime);
  }, 1000);
  
  updateCooldownDisplay(endTime);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(success, title, message, damage = 0) {
  const overlay = document.getElementById("battleResultOverlay");
  const icon = document.getElementById("battleResultIcon");
  const titleEl = document.getElementById("battleResultTitle");
  const messageEl = document.getElementById("battleResultMessage");
  
  if (success) {
    // ğŸ¨ æ ¹æ“šæ¨™é¡Œè¨­å®šä¸åŒçš„èƒŒæ™¯é¡è‰²
    if (title.includes("å®Œç¾æ”»æ“Š")) {
      // Sç´š - é‡‘è‰²æ¼¸å±¤
      overlay.style.background = "linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 165, 0, 0.9), rgba(255, 140, 0, 0.95))";
    } else if (title.includes("å¼·åŠ›æ”»æ“Š")) {
      // Aç´š - ç´«è‰²æ¼¸å±¤
      overlay.style.background = "linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(75, 0, 130, 0.85), rgba(148, 0, 211, 0.9))";
    } else if (title.includes("æœ‰æ•ˆæ”»æ“Š")) {
      // Bç´š - è—è‰²æ¼¸å±¤
      overlay.style.background = "linear-gradient(135deg, rgba(0, 100, 255, 0.9), rgba(0, 150, 255, 0.85), rgba(30, 144, 255, 0.9))";
    } else {
      // Cç´šæˆ–é è¨­ - ç¶ è‰²æ¼¸å±¤
      overlay.style.background = "linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 140, 0, 0.8), rgba(255, 69, 0, 0.9))";
    }
    
    icon.textContent = title.charAt(0); // ä½¿ç”¨æ¨™é¡Œçš„ç¬¬ä¸€å€‹å­—ç¬¦ä½œç‚ºåœ–ç¤º
    titleEl.textContent = title;
    messageEl.innerHTML = message;
  } else {
    icon.textContent = "âŒ";
    titleEl.textContent = title || "æŒ‘æˆ°å¤±æ•—";
    messageEl.textContent = message || "æŒ‘æˆ°éç¨‹ç™¼ç”ŸéŒ¯èª¤";
    overlay.style.background = "linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(220, 20, 60, 0.8), rgba(75, 0, 130, 0.9))";
  }
  
  overlay.style.display = "flex";
}

function closeBattleResult() {
  document.getElementById("battleResultOverlay").style.display = "none";
}

// æŒ‘æˆ°ä¸–ç•Œç‹
async function challengeWorldBoss() {
  if (isWeekend()) {
    showBattleResult(false, "æ™‚é–“é™åˆ¶", "ä¸–ç•Œç‹æ–¼é€±æ—¥ä¼‘æ•´ï¼Œè«‹æ–¼é€±ä¸€å†ä¾†æŒ‘æˆ°ï¼");
    return;
  }
  
  const challengeBtnEl = document.getElementById("challengeBtn");
  if (challengeBtnEl.disabled) return;
  
  challengeBtnEl.disabled = true;
  challengeBtnEl.textContent = "âš”ï¸ æˆ°é¬¥ä¸­...";
  
  try {
    const response = await SecureAPI.post(`${API_BASE}/world_boss_challenge`, {});
    const result = await response.json();
    
    if (response.ok && result.success) {
      // ğŸš€ æ–°çš„æˆ°é¬¥æˆåŠŸé¡¯ç¤ºï¼ŒåŒ…å«å‚·å®³ç™¾åˆ†æ¯”å’Œçå‹µç­‰ç´š
      const message = `
        <div style="text-align: left; line-height: 1.6;">
          <div style="margin-bottom: 15px;">
            <div style="font-size: 1.3em; color: #ffd700; margin-bottom: 8px;">
              ${result.reward_tier} - ${result.tier_description}
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
              é€ æˆå‚·å®³ï¼š<span style="color: #ff6b6b; font-weight: bold;">${result.damage_dealt.toLocaleString()}</span><br>
              å‚·å®³ç™¾åˆ†æ¯”ï¼š<span style="color: #00ffff; font-weight: bold;">${result.damage_percentage.toFixed(4)}%</span><br>
              ç²å¾—ç¶“é©—ï¼š<span style="color: #ffd700; font-weight: bold;">+${result.exp_gained.toLocaleString()}</span>
            </div>
            <div style="background: rgba(0,255,255,0.1); padding: 8px; border-radius: 6px;">
              ç´¯ç©å‚·å®³ï¼š${result.total_damage.toLocaleString()}<br>
              ç•¶å‰æ’åï¼š#${result.current_rank}
            </div>
          </div>
        </div>
      `;
      
      // ğŸ¯ æ ¹æ“šçå‹µç­‰ç´šé¡¯ç¤ºä¸åŒçš„æ¨™é¡Œå’Œåœ–ç¤º
      let title = "âš”ï¸ æˆ°é¬¥æˆåŠŸï¼";
      let icon = "âš”ï¸";
      
      switch(result.reward_tier) {
        case "Sç´šå‚·å®³":
          title = "ğŸŒŸ å®Œç¾æ”»æ“Šï¼";
          icon = "ğŸŒŸ";
          break;
        case "Aç´šå‚·å®³":
          title = "ğŸ’¥ å¼·åŠ›æ”»æ“Šï¼";
          icon = "ğŸ’¥";
          break;
        case "Bç´šå‚·å®³":
          title = "âš”ï¸ æœ‰æ•ˆæ”»æ“Šï¼";
          icon = "âš”ï¸";
          break;
        case "Cç´šå‚·å®³":
          title = "ğŸ›¡ï¸ æˆåŠŸå‘½ä¸­ï¼";
          icon = "ğŸ›¡ï¸";
          break;
      }
      
      showBattleResult(true, title, message, result.damage_dealt);
      
      // æ›´æ–°é¡¯ç¤º
      updatePlayerDamage(result.total_damage, result.current_rank, playerData.challenge_count + 1);
      
      // é‡æ–°è¼‰å…¥æ’è¡Œæ¦œå’Œä¸–ç•Œç‹ç‹€æ…‹
      setTimeout(() => {
        loadWorldBossData();
      }, 1000);
      
      // é–‹å§‹å†·å»è¨ˆæ™‚
      startCooldownTimer(result.cooldown_end_time);
      
    } else {
      showBattleResult(false, "æŒ‘æˆ°å¤±æ•—", result.error || "æœªçŸ¥éŒ¯èª¤");
      challengeBtnEl.disabled = false;
      challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
    }
    
  } catch (error) {
    console.error('æŒ‘æˆ°ä¸–ç•Œç‹å¤±æ•—:', error);
    showBattleResult(false, "é€£ç·šéŒ¯èª¤", "æŒ‘æˆ°éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
    challengeBtnEl.disabled = false;
    challengeBtnEl.textContent = "ğŸŒ æŒ‘æˆ°ä¸–ç•Œç‹ ğŸŒ";
  }
}

// é›¢é–‹ä¸–ç•Œç‹æˆ°å ´
function leaveWorldBoss() {
  window.parent.postMessage({ command: "restoreMainMusic" }, "*");
  setTimeout(() => {
    window.parent.loadPage('main_page.html');
  }, 300);
}

// ğŸ”§ ç®¡ç†å“¡åŠŸèƒ½ï¼šé‡ç½®ä¸–ç•Œç‹ï¼ˆé–‹ç™¼/æ¸¬è©¦ç”¨ï¼‰
async function resetWorldBoss() {
  if (!confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®ä¸–ç•Œç‹å—ï¼Ÿ\né€™å°‡é‡ç½®è¡€é‡å’Œæ‰€æœ‰çµ±è¨ˆæ•¸æ“šï¼\n\næ˜¯å¦åŒæ™‚æ¸…é™¤æ’è¡Œæ¦œï¼Ÿ\né»ç¢ºå®š=æ¸…é™¤æ’è¡Œæ¦œï¼Œå–æ¶ˆ=ä¿ç•™æ’è¡Œæ¦œ')) {
    return;
  }
  
  const clearLeaderboard = confirm('æ˜¯å¦æ¸…é™¤æ’è¡Œæ¦œï¼Ÿ\nç¢ºå®š=æ¸…é™¤ï¼Œå–æ¶ˆ=ä¿ç•™');
  
  try {
    const response = await SecureAPI.post(`${API_BASE}/world_boss_reset`, {
      clear_leaderboard: clearLeaderboard
    });
    const result = await response.json();
    
    if (response.ok) {
      showBattleResult(true, "é‡ç½®æˆåŠŸ", `ä¸–ç•Œç‹å·²é‡ç½®ï¼\n${clearLeaderboard ? 'æ’è¡Œæ¦œå·²æ¸…é™¤' : 'æ’è¡Œæ¦œå·²ä¿ç•™'}`);
      setTimeout(() => {
        loadWorldBossData();
      }, 2000);
    } else {
      showBattleResult(false, "é‡ç½®å¤±æ•—", result.error);
    }
  } catch (error) {
    showBattleResult(false, "é‡ç½®éŒ¯èª¤", "é‡ç½®éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
  }
}

// ğŸ”§ é–‹ç™¼è€…æ¨¡å¼æª¢æ¸¬
const isDeveloper = window.location.hostname === 'localhost' || 
                   window.location.search.includes('debug=true') ||
                   window.location.search.includes('admin=true');

// å¼·åˆ¶åˆ·æ–°åŠŸèƒ½ï¼ˆçˆ¶è¦–çª—èª¿ç”¨ï¼‰
window.addEventListener('message', (event) => {
  if (event.data && event.data.command === 'forceRefresh') {
    console.log('æ”¶åˆ°å¼·åˆ¶åˆ·æ–°æŒ‡ä»¤');
    loadWorldBossData();
  }
});

// å…¨åŸŸå‡½æ•¸
window.challengeWorldBoss = challengeWorldBoss;
window.leaveWorldBoss = leaveWorldBoss;
window.closeBattleResult = closeBattleResult;
window.resetWorldBoss = resetWorldBoss; // ç®¡ç†å“¡åŠŸèƒ½

// åˆå§‹åŒ–
function initWorldBoss() {
  // é€šçŸ¥çˆ¶è¦–çª—åˆ‡æ›éŸ³æ¨‚
  window.parent.postMessage({ command: "switchToWorldBossMusic" }, "*");
  
  createPageParticles();
  startPageLoadingProgress();
  
  // ğŸ”§ é–‹ç™¼è€…æ¨¡å¼ï¼šæ·»åŠ ç®¡ç†å“¡æ§åˆ¶
  if (isDeveloper) {
    const challengeArea = document.querySelector('.challenge-button-area');
    if (challengeArea) {
      const adminBtn = document.createElement('button');
      adminBtn.textContent = 'ğŸ”§ é‡ç½®ä¸–ç•Œç‹ (ç®¡ç†å“¡)';
      adminBtn.style.cssText = `
        background: linear-gradient(135deg, #dc3545, #c82333);
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        color: white;
        font-family: 'Orbitron', sans-serif;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
        width: 100%;
        font-size: 0.9em;
      `;
      adminBtn.onclick = resetWorldBoss;
      challengeArea.appendChild(adminBtn);
      
      console.log('ğŸ”§ é–‹ç™¼è€…æ¨¡å¼å·²å•Ÿç”¨ï¼Œç®¡ç†å“¡åŠŸèƒ½å¯ç”¨');
    }
  }
  
  // è¼‰å…¥ä¸–ç•Œç‹è³‡æ–™
  setTimeout(async () => {
    await loadWorldBossData();
    hidePageLoading();
  }, 2000);
  
  // é–‹å§‹å€’æ•¸è¨ˆæ™‚å™¨
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

// éšæ®µè³‡æ–™é©—è­‰å‡½æ•¸
function validatePhaseData() {
  if (!worldBossData || !worldBossData.phases) {
    console.warn('éšæ®µè³‡æ–™æœªè¼‰å…¥æˆ–æ ¼å¼éŒ¯èª¤');
    return false;
  }
  
  const phases = worldBossData.phases;
  const requiredFields = ['name', 'description', 'hp_threshold'];
  
  for (const [phaseKey, phaseData] of Object.entries(phases)) {
    for (const field of requiredFields) {
      if (!phaseData[field] && phaseData[field] !== 0) {
        console.error(`éšæ®µ ${phaseKey} ç¼ºå°‘å¿…è¦æ¬„ä½: ${field}`);
        return false;
      }
    }
  }
  
  console.log('âœ… éšæ®µè³‡æ–™é©—è­‰é€šé');
  return true;
}
  
// è¼‰å…¥ä½¿ç”¨è€…æš±ç¨±
async function loadUserNickname() {
  try {
    const statusRes = await SecureAPI.getStatus(false);
    const userData = await statusRes.json();
    currentUserNickname = userData.nickname || userData.user_id;
  } catch (error) {
    console.warn('è¼‰å…¥ä½¿ç”¨è€…æš±ç¨±å¤±æ•—:', error);
  }
}

// ç›£è½ç™»å…¥ç‹€æ…‹
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await loadUserNickname();
    initWorldBoss();
  } else {
    window.parent.location.href = "/SFL/login.html";
  }
});
</script>
</body>
</html>
