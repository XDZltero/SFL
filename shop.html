<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ¬¡å…ƒå•†åº—</title>
  <link rel="icon" href="favicon.ico" />
  <link href="css/inventory.css" rel="stylesheet"/>
  <link href="css/shop.css" rel="stylesheet"/>
</head>
<body>
  <div id="initialOverlay">è¼‰å…¥ä¸­...</div>
  <div id="loading-placeholder"></div>
  <script src="js/loading.js"></script>
  <script>
    fetch("loadingOverlay.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("loading-placeholder").innerHTML = html;
        document.getElementById("initialOverlay")?.remove();
        if (typeof startPageLoadingProgress === "function") startPageLoadingProgress();
      });
  </script>

  <h1 class="fancy-title">æ¬¡å…ƒå•†åº—</h1>

  <div class="user-section-row">
    <div class="user-currency half">
      <h2 class="fancy-subtitle">ğŸ‘¤ ç©å®¶è¨Šæ¯</h2>
      <div id="userInfoDisplay">è¼‰å…¥ä¸­...</div>
    </div>
  
    <div class="user-currency half">
      <h2 class="fancy-subtitle">ğŸ’° æŒæœ‰äº¤æ›é“å…·</h2>
      <div id="userCurrencyDisplay">è¼‰å…¥ä¸­...</div>
    </div>
  </div>
  
  <!-- é‡ç½®æ™‚é–“é¡¯ç¤º -->
  <div class="reset-timer">
    <h3>â° å•†åº—é‡ç½®æ™‚é–“</h3>
    <div id="resetTimerDisplay">è¼‰å…¥ä¸­...</div>
      <div style="margin-top: 15px; text-align: center;">
      <button class="square-btn" onclick="manualRefreshShop()" id="manualRefreshBtn" 
              style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); min-width: 150px;">
        ğŸ”„ æ‰‹å‹•åˆ·æ–°å•†åº—
      </button>
      <div id="lastRefreshTime" style="margin-top: 5px; font-size: 0.8em; color: #888;">
        
      </div>
    </div>
  </div>
  
  <!-- åˆ†é¡ç¯©é¸ -->
  <div class="shop-filters">
    <button class="filter-btn active" data-category="all">å…¨éƒ¨å•†å“ <span class="category-count" id="count-all">0</span></button>
    <button class="filter-btn" data-category="reset_free">å®šæœŸå…è²» <span class="category-count" id="count-reset_free">0</span></button>
    <button class="filter-btn" data-category="level_pack">ç­‰ç´šç¦®åŒ… <span class="category-count" id="count-level_pack">0</span></button>
    <button class="filter-btn" data-category="world_boss">ä¸–ç•Œç‹ <span class="category-count" id="count-world_boss">0</span></button>
  </div>
  
  <!-- å•†å“å±•ç¤ºå€ -->
  <div class="items-section">
    <h2 class="fancy-subtitle">ğŸ›’ å•†å“åˆ—è¡¨</h2>
    <div class="item-grid" id="shopItemGrid"></div>
  </div>
  
  <!-- è³¼è²·ç¢ºèªå°è©±æ¡† -->
  <div id="dialogContainer"></div>
  <div id="loadingSpinner" class="loading-spinner">è™•ç†ä¸­...</div>

  <script type="module">
    import { auth, SecureAPI, PerformanceMonitor } from "./js/firebase-init.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const API_BASE = "https://sfl-9cb8.onrender.com";
    let shopItems = [];
    let userItems = {};
    let userPurchases = {};
    let itemMeta = {};
    let userData = {}; 
    let currentFilter = 'all';

    // è·¨æ—¥æª¢æ¸¬å’Œè‡ªå‹•åˆ·æ–°ç³»çµ±
    let lastCheckDate = null;
    let dailyRefreshTimer = null;

    function showLoading(show) {
      const loading = document.getElementById("loadingOverlay");
      const spinner = document.getElementById("loadingSpinner");
      if (loading) loading.style.display = show ? "flex" : "none";
      if (spinner) spinner.style.display = show ? "block" : "none";
    }

    function isFreeItem(item) {
    // æª¢æŸ¥é¡å‹æ˜¯å¦ç‚º freeï¼Œæˆ–è€… cost æ˜¯ç©ºç‰©ä»¶
    return item.type === 'free' || 
           (item.cost && Object.keys(item.cost).length === 0);
  }

  // æª¢æŸ¥æ˜¯å¦è·¨æ—¥
function checkForDayChange() {
  const now = new Date();
  const taipei = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  const currentDate = taipei.toDateString(); // ä¾‹å¦‚: "Wed Jun 05 2025"
  
  if (lastCheckDate === null) {
    lastCheckDate = currentDate;
    return false;
  }
  
  if (lastCheckDate !== currentDate) {
    console.log(`ğŸ—“ï¸ æª¢æ¸¬åˆ°è·¨æ—¥ï¼š${lastCheckDate} â†’ ${currentDate}`);
    lastCheckDate = currentDate;
    return true;
  }
  
  return false;
}

    // å¼·åˆ¶åˆ·æ–°å•†åº—è³‡æ–™
async function forceRefreshShopData() {
  console.log("ğŸ”„ å¼·åˆ¶åˆ·æ–°å•†åº—è³‡æ–™ï¼ˆè·¨æ—¥é‡ç½®ï¼‰");
  
  try {
    showLoading(true);
    
    // æ¸…é™¤å¿«å–
    SecureAPI.clearCache();
    
    // é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™
    await loadShopData();
    
    // é‡æ–°æ¸²æŸ“ç•Œé¢
    updateUserInfoDisplay();
    updateUserCurrencyDisplay();
    renderShopItems();
    updateResetTimerDisplay();
    
    console.log("âœ… è·¨æ—¥åˆ·æ–°å®Œæˆ");
    
    // é¡¯ç¤ºé€šçŸ¥
    if (confirm("ğŸŒ… åµæ¸¬åˆ°æ–°çš„ä¸€å¤©ï¼å•†åº—è³‡æ–™å·²è‡ªå‹•æ›´æ–°ã€‚\n\næ¯æ—¥é™è³¼å•†å“å·²é‡ç½®ï¼Œé»æ“Šç¢ºå®šæŸ¥çœ‹æœ€æ–°ç‹€æ…‹ã€‚")) {
      // ä½¿ç”¨è€…ç¢ºèªå¾Œä¸éœ€è¦é¡å¤–å‹•ä½œ
    }
    
  } catch (error) {
    console.error("âŒ è·¨æ—¥åˆ·æ–°å¤±æ•—:", error);
    
    // åˆ·æ–°å¤±æ•—æ™‚çµ¦äºˆé¸é …
    if (confirm("âš ï¸ è‡ªå‹•åˆ·æ–°å¤±æ•—ï¼Œæ˜¯å¦è¦é‡æ–°æ•´ç†é é¢ï¼Ÿ")) {
      window.location.reload();
    }
  } finally {
    showLoading(false);
  }
}

// è¨­å®šç²¾ç¢ºçš„è·¨æ—¥ç›£æ§
function setupDailyRefreshMonitor() {
  // ğŸ•› æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è·¨æ—¥
  const checkInterval = setInterval(() => {
    if (checkForDayChange()) {
      // å»¶é²2åˆ†é˜åŸ·è¡Œåˆ·æ–°ï¼Œç¢ºä¿å¾Œç«¯é‡ç½®å®Œæˆ
      console.log("æª¢æ¸¬åˆ°è·¨æ—¥ï¼Œå°‡åœ¨2åˆ†é˜å¾Œåˆ·æ–°è³‡æ–™...");
      
      setTimeout(() => {
        forceRefreshShopData();
      }, 2 * 60 * 1000); // 2åˆ†é˜å¾ŒåŸ·è¡Œ
      
      // æ¸…é™¤æª¢æŸ¥è¨ˆæ™‚å™¨ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
      clearInterval(checkInterval);
      
      // 5åˆ†é˜å¾Œé‡æ–°å•Ÿå‹•ç›£æ§ï¼ˆçµ¦åˆ·æ–°ä¸€äº›æ™‚é–“ï¼‰
      setTimeout(() => {
        setupDailyRefreshMonitor();
      }, 5 * 60 * 1000);
    }
  }, 30000); // æ¯30ç§’æª¢æŸ¥
  
  console.log("è·¨æ—¥ç›£æ§å·²å•Ÿå‹•ï¼Œæ¯30ç§’æª¢æŸ¥ä¸€æ¬¡");
}

// ç²¾ç¢ºçš„é›¶é»åˆ·æ–°ï¼ˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆï¼‰
function setupMidnightRefresh() {
  const now = new Date();
  const taipei = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  
  // è¨ˆç®—åˆ°ä¸‹ä¸€å€‹ 00:02 çš„æ™‚é–“ï¼ˆçµ¦å¾Œç«¯é‡ç½®1åˆ†é˜æ™‚é–“ï¼‰
  const nextMidnight = new Date(taipei);
  nextMidnight.setDate(nextMidnight.getDate() + 1);
  nextMidnight.setHours(0, 2, 0, 0); // 00:02
  
  const timeUntilMidnight = nextMidnight - taipei;
  
  if (timeUntilMidnight > 0) {
    console.log(`â° å°‡åœ¨ ${Math.round(timeUntilMidnight / 1000 / 60)} åˆ†é˜å¾Œï¼ˆ00:02ï¼‰è‡ªå‹•åˆ·æ–°å•†åº—`);
    
    dailyRefreshTimer = setTimeout(() => {
      console.log("é›¶é»è‡ªå‹•åˆ·æ–°è§¸ç™¼");
      forceRefreshShopData();
      
      // ğŸ”„ é‡æ–°è¨­å®šæ˜å¤©çš„é›¶é»åˆ·æ–°
      setupMidnightRefresh();
    }, timeUntilMidnight);
  }
}

// é é¢å¯è¦‹æ€§ APIï¼šé é¢é‡æ–°å¯è¦‹æ™‚æª¢æŸ¥è·¨æ—¥
function setupVisibilityChangeDetection() {
  let lastVisibilityChange = Date.now();
  
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      const timeSinceHidden = Date.now() - lastVisibilityChange;
      
      // å¦‚æœé é¢éš±è—è¶…é10åˆ†é˜ï¼Œæª¢æŸ¥æ˜¯å¦è·¨æ—¥
      if (timeSinceHidden > 10 * 60 * 1000) {
        console.log("é é¢é‡æ–°å¯è¦‹ä¸”è¶…é10åˆ†é˜ï¼Œæª¢æŸ¥æ˜¯å¦è·¨æ—¥");
        
        if (checkForDayChange()) {
          console.log("é é¢å¯è¦‹æ€§æª¢æŸ¥ï¼šç™¼ç¾è·¨æ—¥ï¼ŒåŸ·è¡Œåˆ·æ–°");
          forceRefreshShopData();
        }
      }
    } else {
      lastVisibilityChange = Date.now();
    }
  });
}


    // è¼‰å…¥å•†åº—è³‡æ–™
    async function loadShopData() {
      try {
        const [shopRes, itemsRes, userItemsRes, purchasesRes, userRes] = await Promise.all([
          fetch("parameter/shop_items.json"),
          SecureAPI.getStaticData('items_table'),
          SecureAPI.get(`${API_BASE}/user_items`, true),
          SecureAPI.get(`${API_BASE}/shop_user_purchases`, true),
          SecureAPI.getStatus(true)
        ]);

        shopItems = await shopRes.json();
        
        if (Array.isArray(itemsRes)) {
          itemMeta = itemsRes.reduce((acc, item) => {
            acc[item.id] = item;
            return acc;
          }, {});
        } else {
          itemMeta = itemsRes;
        }

        userItems = userItemsRes.ok ? await userItemsRes.json() : {};
        userPurchases = purchasesRes.ok ? await purchasesRes.json() : {};
        userData = await userRes.json();
        
      } catch (error) {
        console.error("è¼‰å…¥å•†åº—è³‡æ–™å¤±æ•—:", error);
        alert("è¼‰å…¥å•†åº—è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
        throw error;
      }
    }

    async function manualRefreshShop() {
      const btn = document.getElementById("manualRefreshBtn");
      const lastRefreshEl = document.getElementById("lastRefreshTime");
      
      // é˜²æ­¢é‡è¤‡é»æ“Š
      if (btn.disabled) return;
      
      try {
        btn.disabled = true;
        btn.textContent = "ğŸ”„ åˆ·æ–°ä¸­...";
        btn.style.opacity = "0.6";
        
        showLoading(true);
        
        // æ¸…é™¤å¿«å–
        SecureAPI.clearCache();
        
        // é‡æ–°è¼‰å…¥è³‡æ–™
        await loadShopData();
        
        // é‡æ–°æ¸²æŸ“
        updateUserInfoDisplay();
        updateUserCurrencyDisplay();
        renderShopItems();
        updateResetTimerDisplay();
        
        // æ›´æ–°æœ€å¾Œåˆ·æ–°æ™‚é–“
        const now = new Date();
        const taipeiTime = now.toLocaleString("zh-TW", {
          timeZone: "Asia/Taipei",
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        lastRefreshEl.textContent = `æœ€å¾Œåˆ·æ–°ï¼š${taipeiTime}`;
        
        // ğŸ‰ æˆåŠŸæç¤º
        btn.textContent = "âœ… åˆ·æ–°å®Œæˆ";
        btn.style.background = "linear-gradient(135deg, #4CAF50 0%, #45a049 100%)";
        
        setTimeout(() => {
          btn.textContent = "ğŸ”„ æ‰‹å‹•åˆ·æ–°å•†åº—";
          btn.style.background = "";
        }, 2000);
        
        console.log("âœ… æ‰‹å‹•åˆ·æ–°å•†åº—å®Œæˆ");
        
      } catch (error) {
        console.error("âŒ æ‰‹å‹•åˆ·æ–°å¤±æ•—:", error);
        
        btn.textContent = "âŒ åˆ·æ–°å¤±æ•—";
        btn.style.background = "linear-gradient(135deg, #f44336 0%, #d32f2f 100%)";
        
        setTimeout(() => {
          btn.textContent = "ğŸ”„ æ‰‹å‹•åˆ·æ–°å•†åº—";
          btn.style.background = "";
        }, 3000);
        
        alert("åˆ·æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        
      } finally {
        showLoading(false);
        btn.disabled = false;
        btn.style.opacity = "1";
      }
    }

    function updateUserInfoDisplay() {
      const userLevel = userData.level || 1;
      const userNickname = userData.nickname || "æœªçŸ¥ç©å®¶";
      
      document.getElementById("userInfoDisplay").innerHTML = `
        <div class="currency-item">
          <span class="currency-name">æš±ç¨±:</span>
          <span class="currency-amount">${userNickname}</span>
        </div>
        <div class="currency-item">
          <span class="currency-name">ç­‰ç´š:</span>
          <span class="currency-amount">Lv.${userLevel}</span>
        </div>
      `;
    }

    // è¨ˆç®—é‡ç½®æ™‚é–“
    function calculateResetTimes() {
      const now = new Date();
      const taipei = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
      
      // è¨ˆç®—ä¸‹æ¬¡é€±é‡ç½® (é€±ä¸€ 00:00)
      const nextMonday = new Date(taipei);
      const daysUntilMonday = (1 + 7 - nextMonday.getDay()) % 7;
      if (daysUntilMonday === 0 && taipei.getHours() >= 0) {
        nextMonday.setDate(nextMonday.getDate() + 7);
      } else {
        nextMonday.setDate(nextMonday.getDate() + daysUntilMonday);
      }
      nextMonday.setHours(0, 0, 0, 0);
      
      // è¨ˆç®—ä¸‹æ¬¡æœˆé‡ç½® (1è™Ÿ 00:00)
      const nextMonth = new Date(taipei);
      if (taipei.getDate() === 1 && taipei.getHours() >= 0) {
        nextMonth.setMonth(nextMonth.getMonth() + 1);
      } else if (taipei.getDate() > 1) {
        nextMonth.setMonth(nextMonth.getMonth() + 1);
      }
      nextMonth.setDate(1);
      nextMonth.setHours(0, 0, 0, 0);
      
      // è¨ˆç®—ä¸‹æ¬¡æ—¥é‡ç½® (æ˜å¤© 00:00)
      const nextDay = new Date(taipei);
      nextDay.setDate(nextDay.getDate() + 1);
      nextDay.setHours(0, 0, 0, 0);
      
      return { nextMonday, nextMonth, nextDay };
    }

    // æ›´æ–°é‡ç½®æ™‚é–“é¡¯ç¤º
    function updateResetTimerDisplay() {
      const { nextMonday, nextMonth, nextDay } = calculateResetTimes();
      const now = new Date();
      
      const formatTimeRemaining = (targetDate) => {
        const diff = targetDate - now;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) return `${days}å¤© ${hours}å°æ™‚`;
        if (hours > 0) return `${hours}å°æ™‚ ${minutes}åˆ†`;
        return `${minutes}åˆ†é˜`;
      };
      
      document.getElementById("resetTimerDisplay").innerHTML = `
        <div class="timer-item">ğŸ—“ï¸ é€±é‡ç½® (é€±ä¸€ 00:00): ${formatTimeRemaining(nextMonday)}</div>
        <div class="timer-item">ğŸ“… æœˆé‡ç½® (1è™Ÿ 00:00): ${formatTimeRemaining(nextMonth)}</div>
        <div class="timer-item">ğŸŒ… æ—¥é‡ç½® (æ˜å¤© 00:00): ${formatTimeRemaining(nextDay)}</div>
      `;
    }

    // æ›´æ–°ç”¨æˆ¶è²¨å¹£é¡¯ç¤º
    function updateUserCurrencyDisplay() {
      const currencies = ['world_boss_token', 'daily_coin'];
      let html = '';
      
      currencies.forEach(currency => {
        const meta = itemMeta[currency];
        const amount = userItems[currency] || 0;
        const name = meta ? meta.name : currency;
        
        html += `
          <div class="currency-item">
            <span class="currency-name">${name}:</span>
            <span class="currency-amount">${amount}</span>
          </div>
        `;
      });
      
      document.getElementById("userCurrencyDisplay").innerHTML = html;
    }

    // ğŸ†• æª¢æŸ¥å•†å“æ˜¯å¦å¯è³¼è²·ï¼ˆåŒ…å«ç­‰ç´šé™åˆ¶ï¼‰
    function canPurchaseItem(item) {
      const purchases = userPurchases.purchases || {};
      const itemPurchases = purchases[item.id] || {};
      const userLevel = userData.level || 1;
      
      // ğŸ†• æª¢æŸ¥ç­‰ç´šé™åˆ¶
      const requiredLevel = item.required_level || 1;
      if (userLevel < requiredLevel) {
        return { 
          canPurchase: false, 
          reason: `ç­‰ç´šä¸è¶³ (éœ€è¦Lv.${requiredLevel}ï¼Œç›®å‰Lv.${userLevel})`,
          levelRestricted: true
        };
      }
      
      // æª¢æŸ¥ç¸½é™è³¼
      if (item.limit_per_account > -1 && itemPurchases.total_purchased >= item.limit_per_account) {
        return { canPurchase: false, reason: "å·²é”å¸³è™Ÿç¸½é™è³¼æ•¸é‡" };
      }
      
      // æª¢æŸ¥é‡ç½®é€±æœŸé™è³¼
      const resetKey = `${item.reset_type}_purchased`;
      if (itemPurchases[resetKey] >= item.limit_per_reset) {
        return { canPurchase: false, reason: `å·²é”${getResetTypeName(item.reset_type)}é™è³¼æ•¸é‡` };
      }

      // æª¢æŸ¥é‡ç½®é€±æœŸé™è³¼æ™‚è¦è€ƒæ…®è·¨æ—¥é‡ç½®
      const resetType = item.reset_type;
      if (resetType !== "none" && item.limit_per_reset > 0) {
        const resetKey = `${resetType}_purchased`;
        const lastPeriodKey = `last_${resetType}_period`;
        
        let currentPurchased = itemPurchases[resetKey] || 0;
        const lastPeriod = itemPurchases[lastPeriodKey] || "";
        const currentPeriod = getCurrentPeriod(resetType);
        
        //  å¦‚æœé€±æœŸå·²ç¶“æ”¹è®Šï¼Œé‡ç½®è¨ˆæ•¸
        if (lastPeriod !== currentPeriod && lastPeriod !== "") {
          console.log(`ğŸ”„ å‰ç«¯æª¢æ¸¬åˆ°é€±æœŸè®ŠåŒ– ${item.id}: ${lastPeriod} â†’ ${currentPeriod}`);
          currentPurchased = 0; // é‡ç½®ç‚º0
        }
        
        // ä½¿ç”¨é‡ç½®å¾Œçš„è¨ˆæ•¸é€²è¡Œæª¢æŸ¥
        if (currentPurchased >= item.limit_per_reset) {
          return { 
            canPurchase: false, 
            reason: `å·²é”${getResetTypeName(resetType)}é™è³¼æ•¸é‡` 
          };
        }
      }
      
      
      // æª¢æŸ¥é“å…·æ˜¯å¦è¶³å¤ 
      for (const [costItem, costAmount] of Object.entries(item.cost)) {
        const owned = userItems[costItem] || 0;
        if (owned < costAmount) {
          const itemName = itemMeta[costItem]?.name || costItem;
          return { canPurchase: false, reason: `${itemName} æ•¸é‡ä¸è¶³` };
        }
      }
      
      // æª¢æŸ¥ç›®æ¨™é“å…·æ˜¯å¦æœƒè¶…é999
      if (item.type !== "bundle") {
        const currentAmount = userItems[item.item_id] || 0;
        if (currentAmount + item.quantity > 999) {
          return { canPurchase: false, reason: "è³¼è²·å¾Œæœƒè¶…é999å€‹ä¸Šé™" };
        }
      }
      
      return { canPurchase: true, reason: "" };
    }

    // ç²å–é‡ç½®é¡å‹åç¨±
    function getResetTypeName(resetType) {
      const names = {
        'daily': 'æ¯æ—¥',
        'weekly': 'æ¯é€±',
        'monthly': 'æ¯æœˆ',
        'none': 'æ°¸ä¹…'
      };
      return names[resetType] || resetType;
    }

    // å–å¾—ç•¶å‰é€±æœŸçš„å‡½æ•¸
function getCurrentPeriod(resetType) {
  const now = new Date();
  const taipeiTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
  
  const year = taipeiTime.getFullYear();
  const month = String(taipeiTime.getMonth() + 1).padStart(2, '0');
  const day = String(taipeiTime.getDate()).padStart(2, '0');
  
  switch(resetType) {
    case 'daily':
      return `${year}-${month}-${day}`;
    
    case 'weekly':
      // è¨ˆç®— ISO é€±æ•¸
      const startOfYear = new Date(year, 0, 1);
      const startOfWeek = startOfYear.getDay() || 7; // é€±ä¸€ç‚º1ï¼Œé€±æ—¥ç‚º7
      const dayOfYear = Math.floor((taipeiTime - startOfYear) / (24 * 60 * 60 * 1000)) + 1;
      const weekNum = Math.ceil((dayOfYear - startOfWeek + 1) / 7);
      return `${year}-W${String(weekNum).padStart(2, '0')}`;
    
    case 'monthly':
      return `${year}-${month}`;
    
    default:
      return '';
  }
}

    // æ¸²æŸ“å•†å“å¡ç‰‡ï¼ˆæ”¯æ´ç­‰ç´šé™åˆ¶é¡¯ç¤ºï¼‰
    function renderShopItems() {
      const filteredItems = currentFilter === 'all' 
        ? shopItems 
        : shopItems.filter(item => item.category === currentFilter);
    
      const sortedItems = filteredItems.sort((a, b) => {
        const aCanPurchase = canPurchaseItem(a).canPurchase;
        const bCanPurchase = canPurchaseItem(b).canPurchase;
        
        if (aCanPurchase !== bCanPurchase) {
          return bCanPurchase ? 1 : -1;
        }
        
        return a.sort - b.sort;
      });
    
      let html = '';
      
      sortedItems.forEach(item => {
        const { canPurchase, reason, levelRestricted } = canPurchaseItem(item);
        const purchases = userPurchases.purchases || {};
        const itemPurchases = purchases[item.id] || {};
        const userLevel = userData.level || 1;
        const requiredLevel = item.required_level || 1;
        
        let cardClass = 'shop-item-card';
        if (!canPurchase) cardClass += ' sold-out';
        if (item.type === 'free') cardClass += ' free';
        if (item.type === 'bundle') cardClass += ' bundle';
        if (levelRestricted) cardClass += ' level-restricted';
        
        // ç‰¹æ®Šæ€§æ¨™è¨˜
        let rarityClass = '';
        let rarityLabel = '';
        if (item.special === 1) {
          rarityClass = 'rare';
          rarityLabel = 'ã€ç¨€æœ‰ã€‘';
        } else if (item.special === 2) {
          rarityClass = 'super-rare';
          rarityLabel = 'ã€è¶…ç¨€æœ‰ã€‘';
        } else if (item.special === 3) {
          rarityClass = 'mythical';
          rarityLabel = 'ã€ç½•è¦‹ã€‘';
        }
        
        if (item.type === 'bundle') {
          rarityLabel = 'ã€ç¦®åŒ…ã€‘' + rarityLabel;
        }
        
        // ç²å¾—ç‰©å“åˆ—è¡¨
        let receivedItemsHtml = '';
        if (item.type === 'bundle' && item.items) {
          const chineseItemsList = item.items.map(itemData => {
            const chineseName = getItemChineseName(itemData.item_id);
            return `${chineseName} x${itemData.quantity}`;
          }).join('ã€');
          
          receivedItemsHtml = `<div class="shop-item-desc">ğŸ“¦ ç¦®åŒ…å…§å®¹ï¼š${chineseItemsList}</div>`;
        } else if (item.item_id) {
          const chineseName = getItemChineseName(item.item_id);
          receivedItemsHtml = `<div class="shop-item-desc">ğŸ“¦ ç²å¾—ï¼š${chineseName} x${item.quantity}</div>`;
        }
        
        // ç­‰ç´šè¦æ±‚é¡¯ç¤º
        let levelRequirementHtml = '';
        if (requiredLevel > 1) {
          const levelStatusClass = userLevel >= requiredLevel ? 'level-met' : 'level-not-met';
          const levelIcon = userLevel >= requiredLevel ? 'âœ…' : 'âŒ';
          levelRequirementHtml = `
            <div class="level-requirement ${levelStatusClass}">
              ${levelIcon} ç­‰ç´šéœ€æ±‚ï¼šLv.${requiredLevel}<br>(ç›®å‰ï¼šLv.${userLevel})
            </div>
          `;
        }
        
        // æ¶ˆè²»é“å…·åˆ—è¡¨
        let costHtml = '';
        const itemIsFree = isFreeItem(item);
        if (itemIsFree) {
          costHtml = '<div class="cost-item"><span style="color: #4CAF50;">ğŸ’° å…è²»é ˜å–</span></div>';
        } else {
          Object.entries(item.cost).forEach(([costItem, costAmount]) => {
            const chineseName = getItemChineseName(costItem);
            const owned = userItems[costItem] || 0;
            const sufficient = owned >= costAmount;
        
            costHtml += `
              <div class="cost-item">
                <span class="cost-name">${chineseName}:</span>
                <div>
                  <span class="cost-amount">${costAmount}</span><br>
                  <span class="cost-owned ${sufficient ? '' : 'cost-insufficient'}">(æ“æœ‰: ${owned})</span>
                </div>
              </div>
            `;
          });
        }
    
        // ğŸ”¥ ä¿®å¾©ï¼šæ™ºèƒ½é™è³¼è³‡è¨Šé¡¯ç¤º
        const totalPurchased = itemPurchases.total_purchased || 0;
        
        // ğŸ”¥ é—œéµï¼šè¨ˆç®—ç•¶å‰é€±æœŸçš„å¯¦éš›è³¼è²·æ¬¡æ•¸
        let resetPurchased = itemPurchases[`${item.reset_type}_purchased`] || 0;
        if (item.reset_type !== 'none') {
          const lastPeriod = itemPurchases[`last_${item.reset_type}_period`] || "";
          const currentPeriod = getCurrentPeriod(item.reset_type);
          
          if (lastPeriod !== currentPeriod && lastPeriod !== "") {
            resetPurchased = 0; // è·¨é€±æœŸé‡ç½®é¡¯ç¤º
          }
        }
        
        const isUnlimited = (item.unlimited || item.limit_per_account === -1) && 
                           (item.limit_per_reset === -1 || item.reset_type === 'none');
    
        let limitDisplay = '';
        
        if (isUnlimited) {
          limitDisplay = `
            <div class="shop-item-limit unlimited">
              â™¾ï¸ ç„¡é™è³¼è²· | å·²è³¼è²·ï¼š${totalPurchased} æ¬¡
            </div>
          `;
        } else {
          let limitInfo = [];
          
          // å¸³è™Ÿç¸½é™åˆ¶
          if (item.limit_per_account !== -1) {
            limitInfo.push(`ç¸½è³¼è²·ï¼š${totalPurchased}/${item.limit_per_account}`);
          }
          
          // é‡ç½®é€±æœŸé™åˆ¶ï¼ˆä½¿ç”¨ä¿®æ­£å¾Œçš„è¨ˆæ•¸ï¼‰
          if (item.reset_type !== 'none' && item.limit_per_reset !== -1) {
            const resetTypeName = getResetTypeName(item.reset_type);
            limitInfo.push(`${resetTypeName}ï¼š${resetPurchased}/${item.limit_per_reset}`);
          }
          
          // ç‰¹æ®Šæƒ…æ³è™•ç†
          if (item.limit_per_account === -1 && item.reset_type !== 'none' && item.limit_per_reset !== -1) {
            const resetTypeName = getResetTypeName(item.reset_type);
            limitInfo = [`${resetTypeName}é™è³¼ï¼š${resetPurchased}/${item.limit_per_reset}`];
          }
          
          limitDisplay = `
            <div class="shop-item-limit ${item.reset_type}">
              ğŸ“¦ ${limitInfo.join(' | ')}
            </div>
          `;
        }
        
        html += `
          <div class="${cardClass} ${rarityClass}">
            <div class="shop-item-name">${rarityLabel}${item.name}</div>
            <div class="shop-item-desc">${item.description}</div>
            ${receivedItemsHtml}
            ${levelRequirementHtml}
            
            ${limitDisplay}
            
            <div class="shop-item-cost">
              ${costHtml}
            </div>
            
            ${!canPurchase ? 
              `<div style="color: #ff6b6b; font-weight: bold; text-align: center; margin: 10px 0;">âŒ ${reason}</div>` :
              `<button class="square-btn" onclick="openPurchaseDialog('${item.id}')" style="width: 100%; margin-top: 10px;">
                ${itemIsFree ? 'ğŸ å…è²»é ˜å–' : item.type === 'bundle' ? 'ğŸ“¦ è³¼è²·ç¦®åŒ…' : 'ğŸ’° è³¼è²·'}
              </button>`
            }
          </div>
        `;
      });
    
      document.getElementById("shopItemGrid").innerHTML = html || '<div class="shop-item-card">æ­¤åˆ†é¡æš«ç„¡å•†å“</div>';
      
      // æ›´æ–°åˆ†é¡è¨ˆæ•¸
      updateCategoryCounts();
    }

    // æ›´æ–°åˆ†é¡è¨ˆæ•¸
    function updateCategoryCounts() {
      const categories = ['all', 'reset_free', 'level_pack', 'world_boss'];
      
      categories.forEach(category => {
        const count = category === 'all' 
          ? shopItems.length 
          : shopItems.filter(item => item.category === category).length;
        
        const countEl = document.getElementById(`count-${category}`);
        if (countEl) {
          countEl.textContent = count;
        }
      });
    }

    // è³¼è²·å°è©±æ¡†ï¼ˆåŒ…å«ç­‰ç´šä¿¡æ¯ï¼‰
    async function openPurchaseDialog(itemId) {
      const item = shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      const { canPurchase, reason } = canPurchaseItem(item);
      
      if (!canPurchase) {
        alert(`ç„¡æ³•è³¼è²·ï¼š${reason}`);
        return;
      }
      
      const dialog = document.getElementById("dialogContainer");
      const userLevel = userData.level || 1;
      const requiredLevel = item.required_level || 1;
      
      // ğŸ†• ç”Ÿæˆç²å¾—ç‰©å“æ‘˜è¦ï¼ˆä½¿ç”¨ä¸­æ–‡åç¨±ï¼‰
      let receivedItemsSummary = '';
      if (item.type === 'bundle' && item.items) {
        receivedItemsSummary = '<h4>ğŸ“¦ ç¦®åŒ…å…§å®¹</h4>';
        item.items.forEach(itemData => {
          const chineseName = getItemChineseName(itemData.item_id);
          const currentAmount = userItems[itemData.item_id] || 0;
          
          receivedItemsSummary += `
            <div class="cost-item">
              <span>${chineseName}:</span>
              <span>+${itemData.quantity} (ç¸½è¨ˆ: ${currentAmount + itemData.quantity})</span>
            </div>
          `;
        });
      } else if (item.item_id) {
        const chineseName = getItemChineseName(item.item_id);
        const currentAmount = userItems[item.item_id] || 0;
        
        receivedItemsSummary = `
          <h4>ğŸ“¦ è³¼è²·ç‰©å“</h4>
          <div><strong>${item.name}</strong></div>
          <div>æ•¸é‡ï¼š${item.quantity}</div>
          <div>è³¼è²·å¾Œç¸½è¨ˆï¼š${currentAmount} + ${item.quantity} = ${currentAmount + item.quantity}</div>
        `;
      }
      
      // ç­‰ç´šä¿¡æ¯é¡¯ç¤º
      let levelInfoHtml = '';
      if (requiredLevel > 1) {
        levelInfoHtml = `
          <div class="purchase-summary">
            <h4>ğŸ‘¤ ç­‰ç´šè¦æ±‚</h4>
            <div class="cost-item">
              <span>éœ€è¦ç­‰ç´šï¼š</span>
              <span style="color: #4CAF50;">Lv.${requiredLevel} âœ…</span>
            </div>
            <div class="cost-item">
              <span>ç›®å‰ç­‰ç´šï¼š</span>
              <span style="color: #00ffff;">Lv.${userLevel}</span>
            </div>
          </div>
        `;
      }
      
      // ğŸ†• æ¶ˆè²»é“å…·æ‘˜è¦ï¼ˆä½¿ç”¨ä¸­æ–‡åç¨±ï¼‰
      let costSummary = '';
      const itemIsFree = isFreeItem(item);
      
      if (itemIsFree) {
        costSummary = '<div style="color: #4CAF50; text-align: center; font-weight: bold;">ğŸ æ­¤ç‚ºå…è²»é“å…·</div>';
      } else {
        Object.entries(item.cost).forEach(([costItem, costAmount]) => {
          const chineseName = getItemChineseName(costItem);
          const owned = userItems[costItem] || 0;
          
          costSummary += `
            <div class="cost-item">
              <span>æ¶ˆè€— ${chineseName}:</span>
              <span>${costAmount} (å‰©é¤˜: ${owned - costAmount})</span>
            </div>
          `;
        });
      }
      
      let html = `
        <div class='purchase-dialog'>
          <h3>ğŸ’° ${item.type === 'bundle' ? 'ç¦®åŒ…è³¼è²·' : 'è³¼è²·'}ç¢ºèª</h3>
          
          ${levelInfoHtml}
          
          <div class="purchase-summary">
            ${receivedItemsSummary}
          </div>
          
          <div class="purchase-summary">
            <h4>ğŸ’¸ æ¶ˆè€—é“å…·</h4>
            ${costSummary}
          </div>
          
          <div class="btn-group">
            <button class="square-btn" onclick="confirmPurchase('${itemId}')" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
              âœ… ç¢ºèª${itemIsFree ? 'é ˜å–' : item.type === 'bundle' ? 'è³¼è²·ç¦®åŒ…' : 'è³¼è²·'}
            </button>
            <button class="square-btn" onclick="closeDialog()">âŒ å–æ¶ˆ</button>
          </div>
        </div>
      `;
      
      dialog.innerHTML = html;
      dialog.style.display = "flex";
      document.body.style.overflow = "hidden";
      document.body.classList.add("dialog-open");
    }

    // ç¢ºèªè³¼è²·
    async function confirmPurchase(itemId) {
      showLoading(true);
      
      try {
        const response = await SecureAPI.post(`${API_BASE}/shop_purchase`, {
          item_id: itemId
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // ğŸ†• æ§‹å»ºå®Œå…¨ä¸­æ–‡åŒ–çš„æˆåŠŸè¨Šæ¯
          let successMessage = '';
          
          // å–å¾—è³¼è²·çš„å•†å“è³‡è¨Š
          const purchaseInfo = result.purchase_info || {};
          const itemName = purchaseInfo.item_name || 'æœªçŸ¥å•†å“';
          const purchaseType = purchaseInfo.purchase_type || 'è³¼è²·';
          const successfulPurchases = purchaseInfo.successful_purchases || 1;
          
          // åŸºæœ¬æˆåŠŸè¨Šæ¯
          successMessage = `âœ… æˆåŠŸ${purchaseType} ${itemName}`;
          
          // å¦‚æœæ˜¯æ‰¹é‡è³¼è²·
          if (successfulPurchases > 1) {
            successMessage += ` x${successfulPurchases}`;
          }
          
          // ğŸ†• è™•ç†ç²å¾—çš„é“å…·ï¼ˆå®Œå…¨ä¸­æ–‡åŒ–ï¼‰
          const totalItemsReceived = purchaseInfo.total_items_received || {};
          if (Object.keys(totalItemsReceived).length > 0) {
            const chineseItemsList = [];
            
            for (const [itemId, quantity] of Object.entries(totalItemsReceived)) {
              const chineseName = getItemChineseName(itemId);
              chineseItemsList.push(`${chineseName} x${quantity}`);
            }
            
            if (chineseItemsList.length > 0) {
              successMessage += `\n\nğŸ“¦ ç²å¾—é“å…·ï¼š\n${chineseItemsList.join('\n')}`;
            }
          }
          
          // éƒ¨åˆ†æˆåŠŸæé†’
          const requestedPurchases = 1;
          if (successfulPurchases < requestedPurchases) {
            successMessage += `\n\nâš ï¸ æ³¨æ„ï¼šåƒ…å®Œæˆ ${successfulPurchases}/${requestedPurchases} æ¬¡è³¼è²·`;
          }
          
          // é¡¯ç¤ºå®Œå…¨ä¸­æ–‡åŒ–çš„æˆåŠŸè¨Šæ¯
          alert(successMessage);
          
          // æ›´æ–°æœ¬åœ°è³‡æ–™
          userItems = result.user_items || userItems;
          userPurchases = result.purchases || userPurchases;
          
          // é‡æ–°æ¸²æŸ“
          updateUserCurrencyDisplay();
          renderShopItems();
          closeDialog();
          
        } else {
          alert(`âŒ è³¼è²·å¤±æ•—ï¼š${result.error || result.message}`);
        }
        
      } catch (error) {
        console.error("è³¼è²·éŒ¯èª¤:", error);
        alert("âŒ è³¼è²·éç¨‹ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        showLoading(false);
      }
    }
    // å°‡é“å…·IDè½‰æ›ç‚ºä¸­æ–‡åç¨±
    function getItemChineseName(itemId) {
      const meta = itemMeta[itemId];
      return meta ? meta.name : itemId;
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–é“å…·åˆ—è¡¨ç‚ºä¸­æ–‡
    function formatItemsListInChinese(itemsObject) {
      if (!itemsObject || Object.keys(itemsObject).length === 0) {
        return '';
      }
      
      const itemsList = [];
      for (const [itemId, quantity] of Object.entries(itemsObject)) {
        const chineseName = getItemChineseName(itemId);
        itemsList.push(`${chineseName} x${quantity}`);
      }
      
      return itemsList.join('ã€');
    }

    // é—œé–‰å°è©±æ¡†
    function closeDialog() {
      document.body.style.overflow = "";
      document.body.classList.remove("dialog-open");
      document.getElementById("dialogContainer").style.display = "none";
    }

    // ç¯©é¸åˆ‡æ›
    function switchFilter(category) {
      currentFilter = category;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
      
      renderShopItems();
    }

    // ç¶å®šç¯©é¸æŒ‰éˆ•äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchFilter(btn.dataset.category);
        });
      });
    });

    // å…¨åŸŸå‡½æ•¸
    window.openPurchaseDialog = openPurchaseDialog;
    window.confirmPurchase = confirmPurchase;
    window.closeDialog = closeDialog;

    // ä¸»è¦åˆå§‹åŒ–å‡½æ•¸
    async function runMain() {
      showLoading(true);
      
      try {
        await loadShopData();
        updateUserInfoDisplay(); // ğŸ†• æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
        updateUserCurrencyDisplay();
        renderShopItems();
        updateResetTimerDisplay();
        
        // æ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡é‡ç½®æ™‚é–“
        setInterval(updateResetTimerDisplay, 60000);

        // ğŸ†• å•Ÿå‹•è·¨æ—¥ç›£æ§ç³»çµ±
        setupDailyRefreshMonitor();
        setupMidnightRefresh();
        setupVisibilityChangeDetection();
        
        console.log('å•†åº—é é¢åˆå§‹åŒ–å®Œæˆ');
        
      } catch (error) {
        console.error("åˆå§‹åŒ–éŒ¯èª¤:", error);
        alert("é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
      } finally {
        showLoading(false);
      }
    }

    // é é¢å¸è¼‰æ™‚æ¸…ç†è¨ˆæ™‚å™¨
    window.addEventListener('beforeunload', () => {
      if (dailyRefreshTimer) {
        clearTimeout(dailyRefreshTimer);
      }
    });

    // ğŸ›’ å•†åº—é é¢éŸ³æ¨‚æ§åˆ¶
    document.addEventListener('DOMContentLoaded', function() {
      // é é¢è¼‰å…¥å®Œæˆæ™‚åˆ‡æ›åˆ°å•†åº—éŸ³æ¨‚
      if (window.parent && window.parent.postMessage) {
        console.log("ğŸµ å•†åº—é é¢ï¼šè«‹æ±‚åˆ‡æ›åˆ°å•†åº—éŸ³æ¨‚");
        window.parent.postMessage({ command: "switchToShopMusic" }, "*");
      }
    });

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, (user) => {
      if (user) {
        runMain();
      } else {
        window.parent.location.href = "/SFL/login.html";
      }
    });

    window.manualRefreshShop = manualRefreshShop;
  </script>
</body>
</html>
