<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SFL - ç™»å…¥</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      overflow: hidden;
      position: relative;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* å‹•æ…‹èƒŒæ™¯æ•ˆæœ */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.3) 0%, transparent 50%);
      animation: backgroundFlow 20s ease-in-out infinite;
      z-index: -2;
    }
    
    @keyframes backgroundFlow {
      0%, 100% { transform: rotate(0deg) scale(1); }
      33% { transform: rotate(120deg) scale(1.1); }
      66% { transform: rotate(240deg) scale(0.9); }
    }

    /* ç²’å­èƒŒæ™¯æ•ˆæœ */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(0, 255, 255, 0.6);
      border-radius: 50%;
      animation: float 6s infinite linear;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) scale(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) scale(1);
        opacity: 0;
      }
    }

    /* ç™»å…¥å®¹å™¨ */
    .login-container {
      background: linear-gradient(135deg, rgba(15, 15, 35, 0.8) 0%, rgba(25, 25, 55, 0.6) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-container::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.05) 50%, transparent 70%);
      animation: sectionShine 4s ease-in-out infinite;
    }
    
    @keyframes sectionShine {
      0%, 100% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
    }

    /* æ¨™é¡Œ */
    .game-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 2rem;
      background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00, #00ffff);
      background-size: 400% 400%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 3s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      letter-spacing: 0.1em;
      position: relative;
      z-index: 1;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* ç™»å…¥æŒ‰éˆ• */
    .login-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 15px 40px;
      border-radius: 25px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
      width: 100%;
      margin: 20px 0;
      z-index: 1;
    }

    .login-button::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; right: 0; bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .login-button:hover::before {
      left: 100%;
    }

    .login-button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6);
    }

    .login-button:disabled {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      cursor: not-allowed;
      transform: none;
    }

    .login-button:disabled:hover {
      transform: none;
      box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
    }

    /* æš±ç¨±è¼¸å…¥å€ */
    .nickname-section {
      display: none;
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }

    .nickname-section p {
      color: #ffd93d;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .nickname-input {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 10px;
      padding: 15px;
      width: 100%;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      font-size: 1em;
      margin-bottom: 15px;
    }

    .nickname-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .nickname-input:focus {
      outline: none;
      border-color: rgba(0, 255, 255, 0.6);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    /* ç‹€æ…‹è¨Šæ¯ */
    .status-message {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      color: #00ffff;
      font-weight: 600;
      position: relative;
      z-index: 1;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-message.success {
      background: rgba(0, 255, 0, 0.1);
      border-color: rgba(0, 255, 0, 0.3);
      color: #00ff00;
    }

    .status-message.error {
      background: rgba(255, 0, 0, 0.1);
      border-color: rgba(255, 0, 0, 0.3);
      color: #ff6b6b;
    }

    /* è¼‰å…¥å‹•ç•« */
    .loading-dots {
      display: inline-block;
    }

    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    /* æ‰‹å‹•è·³è½‰æŒ‰éˆ• */
    .manual-redirect {
      display: none;
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }

    .manual-button {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      color: white;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      width: 100%;
    }

    .manual-button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 10px 30px rgba(76, 175, 80, 0.6);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 480px) {
      .login-container {
        margin: 20px;
        padding: 30px 25px;
      }
      
      .game-title {
        font-size: 2rem;
      }
      
      .login-button, .manual-button {
        font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
      }
      
      .nickname-input {
        font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
      }
    }
  </style>
</head>
<body>
  <!-- ç²’å­èƒŒæ™¯ -->
  <div class="particles" id="particles"></div>

  <div class="login-container">
    <h1 class="game-title">SFL</h1>
    
    <button class="login-button" id="loginButton" onclick="signInWithGoogle()">
      ä½¿ç”¨ Google ç™»å…¥
    </button>

    <div class="nickname-section" id="nicknameSection">
      <p>ğŸ‘‹ æ­¡è¿æ–°å†’éšªè€…ï¼è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼š</p>
      <input class="nickname-input" id="nickname" placeholder="è¼¸å…¥æš±ç¨±" />
      <button class="login-button" onclick="completeRegistration()">å®Œæˆè¨»å†Š</button>
    </div>

    <div class="manual-redirect" id="manualRedirect">
      <button class="manual-button" onclick="manualJump()">é€²å…¥éŠæˆ²</button>
    </div>

    <div class="status-message" id="statusMessage">
      æº–å‚™ç™»å…¥ç³»çµ±
    </div>
  </div>

  <script>
    const API_BASE = "https://sfl-9cb8.onrender.com";

    // å‰µå»ºç²’å­æ•ˆæœ
    function createParticles() {
      const container = document.getElementById("particles");
      const count = 50;
      for (let i = 0; i < count; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = Math.random() * 100 + "%";
        p.style.animationDelay = Math.random() * 6 + "s";
        p.style.animationDuration = (Math.random() * 3 + 3) + "s";
        container.appendChild(p);
      }
    }

    // æª¢æ¸¬ç§»å‹•è¨­å‚™
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(navigator.userAgent) ||
             (window.innerWidth <= 768 && 'ontouchstart' in window);
    }

    // æ›´æ–°ç‹€æ…‹è¨Šæ¯
    function updateStatus(message, type = 'normal') {
      const statusEl = document.getElementById("statusMessage");
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    function showLoading(show, message = "è™•ç†ä¸­") {
      const loginBtn = document.getElementById("loginButton");
      if (show) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = `<span class="loading-dots">${message}</span>`;
      } else {
        loginBtn.disabled = false;
        loginBtn.textContent = "ä½¿ç”¨ Google ç™»å…¥";
      }
    }

    // é¡¯ç¤ºæ‰‹å‹•è·³è½‰æŒ‰éˆ•
    function showManualRedirect() {
      document.getElementById("manualRedirect").style.display = "block";
      document.getElementById("loginButton").style.display = "none";
      updateStatus("ç™»å…¥æˆåŠŸï¼è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é€²å…¥éŠæˆ²", "success");
    }

    // æ‰‹å‹•è·³è½‰
    function manualJump() {
      updateStatus("æ­£åœ¨è·³è½‰ï¼Œè«‹ç¨å¾Œ...", "success");
      
      const methods = [
        () => window.location.href = "/SFL/",
        () => window.location.replace("/SFL/"),
        () => window.location.assign("/SFL/")
      ];
      
      let methodIndex = 0;
      function tryNextMethod() {
        if (methodIndex < methods.length) {
          try {
            methods[methodIndex]();
            methodIndex++;
            setTimeout(() => {
              if (window.location.pathname.includes('login')) {
                tryNextMethod();
              }
            }, 2000);
          } catch (error) {
            methodIndex++;
            tryNextMethod();
          }
        } else {
          updateStatus("è‡ªå‹•è·³è½‰å¤±æ•—ï¼Œè«‹æ‰‹å‹•å‰å¾€ï¼šhttps://xdzltero.github.io/SFL/", "error");
        }
      }
      
      tryNextMethod();
    }

    // Google ç™»å…¥
    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('email');
      provider.addScope('profile');
      
      try {
        showLoading(true, "èªè­‰ä¸­");
        updateStatus("æ­£åœ¨é€£æ¥ Google æœå‹™...");
        
        let result;
        const isMobile = isMobileDevice();
        
        if (isMobile) {
          try {
            result = await firebase.auth().signInWithPopup(provider);
          } catch (popupError) {
            if (popupError.code === 'auth/popup-blocked' || 
                popupError.code === 'auth/popup-closed-by-user' ||
                popupError.code === 'auth/cancelled-popup-request') {
              updateStatus("æ”¹ç”¨é‡å°å‘æ–¹å¼ç™»å…¥...");
              await firebase.auth().signInWithRedirect(provider);
              return;
            } else {
              throw popupError;
            }
          }
        } else {
          result = await firebase.auth().signInWithPopup(provider);
        }
        
        if (result && result.user) {
          updateStatus("èªè­‰æˆåŠŸï¼", "success");
        }
        
      } catch (error) {
        console.error("ç™»å…¥éŒ¯èª¤:", error);
        updateStatus("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦", "error");
        
        if (error.code === 'auth/network-request-failed') {
          updateStatus("ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error");
        } else if (error.code === 'auth/too-many-requests') {
          updateStatus("è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
        
      } finally {
        showLoading(false);
      }
    }

    // è™•ç†é‡å°å‘çµæœ
    async function handleRedirectResult() {
      try {
        const result = await firebase.auth().getRedirectResult();
        if (result && result.user) {
          updateStatus("é‡å°å‘ç™»å…¥æˆåŠŸï¼", "success");
        }
      } catch (error) {
        console.error("é‡å°å‘éŒ¯èª¤:", error);
        updateStatus("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        showLoading(true, "é©—è­‰ä¸­");
        updateStatus("æ­£åœ¨é©—è­‰èº«ä»½...");
        
        try {
          const idToken = await user.getIdToken(true);
          
          const res = await fetch(`${API_BASE}/status`, {
            headers: {
              'Authorization': `Bearer ${idToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (res.ok) {
            updateStatus("é©—è­‰æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...", "success");
            
            setTimeout(() => {
              try {
                window.location.href = "/SFL/";
                setTimeout(() => {
                  if (window.location.pathname.includes('login')) {
                    window.location.replace("/SFL/");
                  }
                }, 500);
                
                setTimeout(() => {
                  if (window.location.pathname.includes('login')) {
                    showManualRedirect();
                  }
                }, 3000);
                
              } catch (error) {
                showManualRedirect();
              }
            }, 1000);
          } else {
            updateStatus("éœ€è¦å®Œæˆè¨»å†Šè¨­å®š");
            document.getElementById("nicknameSection").style.display = "block";
            window.__currentUserEmail = user.email;
            window.__currentIdToken = idToken;
          }
          
        } catch (err) {
          console.error("é©—è­‰éŒ¯èª¤:", err);
          updateStatus("é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
        } finally {
          showLoading(false);
        }
      } else {
        await handleRedirectResult();
      }
    });

    // å®Œæˆè¨»å†Š
    async function completeRegistration() {
      const email = window.__currentUserEmail;
      const idToken = window.__currentIdToken;
      const nickname = document.getElementById("nickname").value.trim();
    
      if (!nickname) {
        updateStatus("è«‹è¼¸å…¥æš±ç¨±", "error");
        return;
      }
    
      if (!email || !idToken) {
        updateStatus("ç™»å…¥è³‡è¨Šç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥", "error");
        return;
      }

      try {
        showLoading(true, "è¨»å†Šä¸­");
        updateStatus("æ­£åœ¨å»ºç«‹å¸³è™Ÿ...");
    
        const res = await fetch(`${API_BASE}/register`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            user: email, 
            nickname: nickname,
            idToken: idToken
          })
        });
    
        const data = await res.json();
    
        if (res.ok) {
          updateStatus("è¨»å†ŠæˆåŠŸï¼Œæ­£åœ¨è·³è½‰...", "success");
          
          setTimeout(() => {
            try {
              window.location.href = "/SFL/";
              setTimeout(() => {
                if (window.location.pathname.includes('login')) {
                  window.location.replace("/SFL/");
                }
              }, 500);
              
              setTimeout(() => {
                if (window.location.pathname.includes('login')) {
                  showManualRedirect();
                }
              }, 3000);
              
            } catch (error) {
              showManualRedirect();
            }
          }, 1000);
        } else {
          updateStatus(data.error || "è¨»å†Šå¤±æ•—", "error");
        }
    
      } catch (err) {
        console.error("è¨»å†ŠéŒ¯èª¤:", err);
        updateStatus("è¨»å†Šéç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
      } finally {
        showLoading(false);
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      createParticles();
      updateStatus("æº–å‚™ç™»å…¥ç³»çµ±");
    });
  </script>
</body>
</html>
