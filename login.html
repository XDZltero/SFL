<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SFL - ç™»å…¥</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjhRGQyr35YhQtIxwUsNVpFkN7_AFOGYE",
      authDomain: "sfl-api-f0290.firebaseapp.com",
      projectId: "sfl-api-f0290"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
<link href="css/login_css.css" rel="stylesheet"/>
</head>
<body>
  <!-- ç²’å­èƒŒæ™¯ -->
  <div class="particles" id="particles"></div>

  <div class="login-container">
    <h1 class="game-title">SFL</h1>
    
    <button class="login-button" id="loginButton" onclick="signInWithGoogle()">
      ä½¿ç”¨ Google ç™»å…¥
    </button>

    <div class="nickname-section" id="nicknameSection">
      <p>ğŸ‘‹ æ­¡è¿æ–°å†’éšªè€…ï¼è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼š</p>
      <input 
        class="nickname-input" 
        id="nickname" 
        placeholder="è¼¸å…¥æš±ç¨± (2~12å€‹è‹±æ–‡å­—æ¯ or 1~6å€‹ä¸­æ–‡å­—)" 
        maxlength="12"
        oninput="validateNickname()" 
      />
      <div class="nickname-counter" id="nicknameCounter">0 / 12</div>
      <div class="nickname-error" id="nicknameError"></div>
      <button class="login-button" id="registerButton" onclick="completeRegistration(event)">å®Œæˆè¨»å†Š</button>
    </div>

    <div class="manual-redirect" id="manualRedirect">
      <button class="manual-button" onclick="manualJump()">é€²å…¥éŠæˆ²</button>
    </div>

    <div class="status-message" id="statusMessage">
      æº–å‚™ç™»å…¥ç³»çµ±
    </div>
  </div>

  <script>
    const API_BASE = "https://sfl-9cb8.onrender.com";
    
    // ğŸ”’ é˜²é‡è¤‡é»æ“Šæ¨™èªŒ
    let isAuthInProgress = false;
    
    // æš±ç¨±é©—è­‰è¨­å®š
    const NICKNAME_CONFIG = {
      minLength: 2,
      maxLength: 12,
      allowedChars: /^[\u4e00-\u9fa5a-zA-Z0-9_\-\s]+$/, // ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—ã€åº•ç·šã€é€£å­—è™Ÿã€ç©ºæ ¼
    };

    // è¨ˆç®—å­—ç¬¦é•·åº¦ï¼ˆä¸­æ–‡ç®—1å€‹å­—ç¬¦ï¼‰
    function getCharacterCount(str) {
      return str.length;
    }

    // é©—è­‰æš±ç¨±
    function validateNickname() {
      const nicknameInput = document.getElementById("nickname");
      const counter = document.getElementById("nicknameCounter");
      const errorDiv = document.getElementById("nicknameError");
      const registerBtn = document.getElementById("registerButton");
      
      const nickname = nicknameInput.value.trim();
      const length = getCharacterCount(nickname);
      
      // æ›´æ–°å­—æ•¸çµ±è¨ˆ
      counter.textContent = `${length} / ${NICKNAME_CONFIG.maxLength}`;
      counter.style.color = length > NICKNAME_CONFIG.maxLength ? "#ff6b6b" : "#ffd93d";
      
      // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤æ¨£å¼
      nicknameInput.style.borderColor = "rgba(0, 255, 255, 0.3)";
      errorDiv.textContent = "";
      errorDiv.style.display = "none";
      
      let isValid = true;
      let errorMessage = "";
      
      if (nickname.length === 0) {
        // ç©ºç™½æ™‚ä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œä½†ç¦ç”¨è¨»å†Š
        isValid = false;
      } else if (length < NICKNAME_CONFIG.minLength) {
        isValid = false;
        errorMessage = `æš±ç¨±è‡³å°‘éœ€è¦ ${NICKNAME_CONFIG.minLength} å€‹å­—ç¬¦`;
      } else if (length > NICKNAME_CONFIG.maxLength) {
        isValid = false;
        errorMessage = `æš±ç¨±æœ€å¤š ${NICKNAME_CONFIG.maxLength} å€‹å­—ç¬¦`;
      } else if (!NICKNAME_CONFIG.allowedChars.test(nickname)) {
        isValid = false;
        errorMessage = "æš±ç¨±åªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—ã€åº•ç·šã€é€£å­—è™Ÿå’Œç©ºæ ¼";
      } else if (nickname.startsWith(" ") || nickname.endsWith(" ")) {
        isValid = false;
        errorMessage = "æš±ç¨±é–‹é ­å’Œçµå°¾ä¸èƒ½æœ‰ç©ºæ ¼";
      } else if (nickname.includes("  ")) {
        isValid = false;
        errorMessage = "æš±ç¨±ä¸èƒ½åŒ…å«é€£çºŒç©ºæ ¼";
      }
      
      // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
      if (errorMessage) {
        nicknameInput.style.borderColor = "rgba(255, 107, 107, 0.6)";
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = "block";
      }
      
      // æ§åˆ¶è¨»å†ŠæŒ‰éˆ•ç‹€æ…‹
      if (!isAuthInProgress) {
        registerBtn.disabled = !isValid;
        if (!isValid && nickname.length > 0) {
          registerBtn.style.opacity = "0.5";
        } else {
          registerBtn.style.opacity = "1";
        }
      }
      
      return isValid;
    }

    // å‰µå»ºç²’å­æ•ˆæœ
    function createParticles() {
      const container = document.getElementById("particles");
      const count = 50;
      for (let i = 0; i < count; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        p.style.left = Math.random() * 100 + "%";
        p.style.animationDelay = Math.random() * 6 + "s";
        p.style.animationDuration = (Math.random() * 3 + 3) + "s";
        container.appendChild(p);
      }
    }

    // æª¢æ¸¬ç§»å‹•è¨­å‚™
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(navigator.userAgent) ||
             (window.innerWidth <= 768 && 'ontouchstart' in window);
    }

    // æ›´æ–°ç‹€æ…‹è¨Šæ¯
    function updateStatus(message, type = 'normal') {
      const statusEl = document.getElementById("statusMessage");
      statusEl.textContent = message;
      statusEl.className = `status-message ${type}`;
    }

    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    function showLoading(show, message = "è™•ç†ä¸­") {
      const loginBtn = document.getElementById("loginButton");
      if (show) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = `<span class="loading-dots">${message}</span>`;
      } else {
        // ğŸ”’ åªæœ‰åœ¨æ²’æœ‰èªè­‰é€²è¡Œä¸­ä¸”ç”¨æˆ¶æœªç™»å…¥æ™‚æ‰é‡æ–°å•Ÿç”¨æŒ‰éˆ•
        try {
          const currentUser = firebase.auth().currentUser;
          if (!currentUser && !isAuthInProgress) {
            loginBtn.disabled = false;
            loginBtn.textContent = "ä½¿ç”¨ Google ç™»å…¥";
            loginBtn.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
          }
        } catch (error) {
          // Firebase å¯èƒ½é‚„æœªåˆå§‹åŒ–ï¼Œä¿æŒæŒ‰éˆ•ç¦ç”¨ç‹€æ…‹
          console.log("Firebase auth not ready:", error);
        }
      }
    }

    // é¡¯ç¤ºæ‰‹å‹•è·³è½‰æŒ‰éˆ•
    function showManualRedirect() {
      document.getElementById("manualRedirect").style.display = "block";
      
      // ğŸ”’ éš±è—ç™»å…¥æŒ‰éˆ•ï¼Œç¢ºä¿ä¸æœƒè¢«å†æ¬¡é»æ“Š
      const loginBtn = document.getElementById("loginButton");
      loginBtn.style.display = "none";
      
      updateStatus("ç™»å…¥æˆåŠŸï¼è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é€²å…¥éŠæˆ²", "success");
    }

    // æ‰‹å‹•è·³è½‰
    function manualJump() {
      const manualBtn = document.getElementById("manualRedirect").querySelector("button");
      
      // ğŸ”’ é˜²æ­¢é‡è¤‡é»æ“Š
      if (manualBtn.disabled) {
        return;
      }
      
      manualBtn.disabled = true;
      manualBtn.innerHTML = '<span class="loading-dots">è·³è½‰ä¸­</span>';
      
      updateStatus("æ­£åœ¨è·³è½‰ï¼Œè«‹ç¨å¾Œ...", "success");
      
      const methods = [
        () => window.location.href = "/SFL/",
        () => window.location.replace("/SFL/"),
        () => window.location.assign("/SFL/")
      ];
      
      let methodIndex = 0;
      function tryNextMethod() {
        if (methodIndex < methods.length) {
          try {
            methods[methodIndex]();
            methodIndex++;
            setTimeout(() => {
              if (window.location.pathname.includes('login')) {
                tryNextMethod();
              }
            }, 2000);
          } catch (error) {
            methodIndex++;
            tryNextMethod();
          }
        } else {
          updateStatus("è‡ªå‹•è·³è½‰å¤±æ•—ï¼Œè«‹æ‰‹å‹•å‰å¾€ï¼šhttps://xdzltero.github.io/SFL/", "error");
          // ğŸ”“ æ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—æ™‚é‡æ–°å•Ÿç”¨æŒ‰éˆ•
          manualBtn.disabled = false;
          manualBtn.textContent = "é‡è©¦è·³è½‰";
        }
      }
      
      tryNextMethod();
    }

    // Google ç™»å…¥
    async function signInWithGoogle() {
      const loginBtn = document.getElementById("loginButton");
      
      // ğŸ”’ é˜²æ­¢é‡è¤‡é»æ“Šï¼Œç«‹å³ç¦ç”¨æŒ‰éˆ•
      if (loginBtn.disabled || isAuthInProgress) {
        return;
      }
      
      isAuthInProgress = true;
      
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('email');
      provider.addScope('profile');
      
      try {
        showLoading(true, "èªè­‰ä¸­");
        updateStatus("æ­£åœ¨é€£æ¥ Google æœå‹™...");
        
        let result;
        const isMobile = isMobileDevice();
        
        if (isMobile) {
          try {
            result = await firebase.auth().signInWithPopup(provider);
          } catch (popupError) {
            if (popupError.code === 'auth/popup-blocked' || 
                popupError.code === 'auth/popup-closed-by-user' ||
                popupError.code === 'auth/cancelled-popup-request') {
              updateStatus("æ”¹ç”¨é‡å°å‘æ–¹å¼ç™»å…¥...");
              await firebase.auth().signInWithRedirect(provider);
              return;
            } else {
              throw popupError;
            }
          }
        } else {
          result = await firebase.auth().signInWithPopup(provider);
        }
        
        if (result && result.user) {
          updateStatus("èªè­‰æˆåŠŸï¼", "success");
          // ğŸ”’ ç™»å…¥æˆåŠŸå¾Œä¿æŒæŒ‰éˆ•ç¦ç”¨ç‹€æ…‹
          loginBtn.disabled = true;
          loginBtn.textContent = "âœ… èªè­‰æˆåŠŸ";
          loginBtn.style.background = "linear-gradient(135deg, #4CAF50 0%, #45a049 100%)";
        }
        
      } catch (error) {
        console.error("ç™»å…¥éŒ¯èª¤:", error);
        updateStatus("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦", "error");
        
        if (error.code === 'auth/network-request-failed') {
          updateStatus("ç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error");
        } else if (error.code === 'auth/too-many-requests') {
          updateStatus("è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
        
        // ğŸ”“ ç™»å…¥å¤±æ•—æ™‚é‡æ–°å•Ÿç”¨æŒ‰éˆ•
        isAuthInProgress = false;
        loginBtn.disabled = false;
        loginBtn.textContent = "ä½¿ç”¨ Google ç™»å…¥";
        loginBtn.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
        showLoading(false);
        
      } finally {
        // ä¸åœ¨é€™è£¡é‡æ–°å•Ÿç”¨æŒ‰éˆ•ï¼Œè®“ onAuthStateChanged è™•ç†æˆåŠŸçš„æƒ…æ³
      }
    }

    // è™•ç†é‡å°å‘çµæœ
    async function handleRedirectResult() {
      try {
        const result = await firebase.auth().getRedirectResult();
        if (result && result.user) {
          updateStatus("é‡å°å‘ç™»å…¥æˆåŠŸï¼", "success");
        }
      } catch (error) {
        console.error("é‡å°å‘éŒ¯èª¤:", error);
        updateStatus("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    // ç›£è½ç™»å…¥ç‹€æ…‹
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        // ğŸ”’ ç«‹å³é–ä½ç™»å…¥æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
        const loginBtn = document.getElementById("loginButton");
        loginBtn.disabled = true;
        loginBtn.textContent = "âœ… èªè­‰æˆåŠŸ";
        loginBtn.style.background = "linear-gradient(135deg, #4CAF50 0%, #45a049 100%)";
        isAuthInProgress = true;
        
        showLoading(true, "é©—è­‰ä¸­");
        updateStatus("æ­£åœ¨é©—è­‰èº«ä»½...");
        
        try {
          const idToken = await user.getIdToken(true);
          
          const res = await fetch(`${API_BASE}/status`, {
            headers: {
              'Authorization': `Bearer ${idToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (res.ok) {
            updateStatus("é©—è­‰æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...", "success");
            
            setTimeout(() => {
              try {
                window.location.href = "/SFL/";
                setTimeout(() => {
                  if (window.location.pathname.includes('login')) {
                    window.location.replace("/SFL/");
                  }
                }, 500);
                
                setTimeout(() => {
                  if (window.location.pathname.includes('login')) {
                    showManualRedirect();
                  }
                }, 3000);
                
              } catch (error) {
                showManualRedirect();
              }
            }, 1000);
          } else {
            updateStatus("éœ€è¦å®Œæˆè¨»å†Šè¨­å®š");
            document.getElementById("nicknameSection").style.display = "block";
            window.__currentUserEmail = user.email;
            window.__currentIdToken = idToken;
            
            // ğŸ”§ åˆå§‹åŒ–æš±ç¨±é©—è­‰
            setTimeout(() => {
              const nicknameInput = document.getElementById("nickname");
              if (nicknameInput) {
                nicknameInput.focus();
                validateNickname(); // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
              }
            }, 100);
          }
          
        } catch (err) {
          console.error("é©—è­‰éŒ¯èª¤:", err);
          updateStatus("é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
          // ğŸ”“ å¦‚æœé©—è­‰å¤±æ•—ï¼Œé‡æ–°å•Ÿç”¨æŒ‰éˆ•å’Œé‡ç½®æ¨™èªŒ
          isAuthInProgress = false;
          loginBtn.disabled = false;
          loginBtn.textContent = "ä½¿ç”¨ Google ç™»å…¥";
          loginBtn.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
        } finally {
          showLoading(false);
        }
      } else {
        isAuthInProgress = false;
        await handleRedirectResult();
      }
    });

    // å®Œæˆè¨»å†Š
    async function completeRegistration() {
      const email = window.__currentUserEmail;
      const idToken = window.__currentIdToken;
      const nickname = document.getElementById("nickname").value.trim();
      const registerBtn = event.target; // è¨»å†ŠæŒ‰éˆ•
    
      if (!nickname) {
        updateStatus("è«‹è¼¸å…¥æš±ç¨±", "error");
        return;
      }
    
      if (!email || !idToken) {
        updateStatus("ç™»å…¥è³‡è¨Šç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥", "error");
        return;
      }

      try {
        // ğŸ”’ ç¦ç”¨è¨»å†ŠæŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
        registerBtn.disabled = true;
        registerBtn.innerHTML = `<span class="loading-dots">è¨»å†Šä¸­</span>`;
        
        showLoading(true, "è¨»å†Šä¸­");
        updateStatus("æ­£åœ¨å»ºç«‹å¸³è™Ÿ...");
    
        const res = await fetch(`${API_BASE}/register`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            user: email, 
            nickname: nickname,
            idToken: idToken
          })
        });
    
        const data = await res.json();
    
        if (res.ok) {
          updateStatus("è¨»å†ŠæˆåŠŸï¼Œæ­£åœ¨è·³è½‰...", "success");
          registerBtn.textContent = "âœ… è¨»å†ŠæˆåŠŸ";
          registerBtn.style.background = "linear-gradient(135deg, #4CAF50 0%, #45a049 100%)";
          // ğŸ”’ è¨»å†ŠæˆåŠŸï¼Œä¿æŒæ¨™èªŒç‚º true
          
          setTimeout(() => {
            try {
              window.location.href = "/SFL/";
              setTimeout(() => {
                if (window.location.pathname.includes('login')) {
                  window.location.replace("/SFL/");
                }
              }, 500);
              
              setTimeout(() => {
                if (window.location.pathname.includes('login')) {
                  showManualRedirect();
                }
              }, 3000);
              
            } catch (error) {
              showManualRedirect();
            }
          }, 1000);
        } else {
          updateStatus(data.error || "è¨»å†Šå¤±æ•—", "error");
          // ğŸ”“ è¨»å†Šå¤±æ•—æ™‚é‡æ–°å•Ÿç”¨æŒ‰éˆ•å’Œé‡ç½®æ¨™èªŒ
          isAuthInProgress = false;
          registerBtn.disabled = false;
          registerBtn.textContent = "å®Œæˆè¨»å†Š";
          registerBtn.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
        }
    
      } catch (err) {
        console.error("è¨»å†ŠéŒ¯èª¤:", err);
        updateStatus("è¨»å†Šéç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
        // ğŸ”“ ç™¼ç”ŸéŒ¯èª¤æ™‚é‡æ–°å•Ÿç”¨æŒ‰éˆ•å’Œé‡ç½®æ¨™èªŒ
        isAuthInProgress = false;
        registerBtn.disabled = false;
        registerBtn.textContent = "å®Œæˆè¨»å†Š";
        registerBtn.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
      } finally {
        showLoading(false);
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      createParticles();
      updateStatus("æº–å‚™ç™»å…¥ç³»çµ±");
      
      // ğŸ”’ é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚æª¢æŸ¥èªè­‰ç‹€æ…‹
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && firebase.auth().currentUser && !isAuthInProgress) {
          // é é¢é‡æ–°å¯è¦‹ä¸”å·²ç™»å…¥ï¼Œä½†æ²’æœ‰åœ¨é€²è¡Œèªè­‰æµç¨‹
          // å¯èƒ½æ˜¯å¾ popup è¿”å›ï¼Œç¢ºä¿æŒ‰éˆ•ç‹€æ…‹æ­£ç¢º
          const loginBtn = document.getElementById("loginButton");
          if (!loginBtn.disabled) {
            loginBtn.disabled = true;
            loginBtn.textContent = "âœ… èªè­‰æˆåŠŸ";
            loginBtn.style.background = "linear-gradient(135deg, #4CAF50 0%, #45a049 100%)";
          }
        }
      });
    });
  </script>
</body>
</html>
